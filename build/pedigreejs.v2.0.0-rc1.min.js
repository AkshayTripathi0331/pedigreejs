var pedigreejs=function(e){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(a.push(o.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(e);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return n(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var r=25,i={};function o(e){try{if("array"===e.store_type)return!1;if("local"!==e.store_type&&"session"!==e.store_type&&void 0!==e.store_type)return!1;var t="test";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(e){return!1}}function s(e){return"PEDIGREE_"+e.btn_target+"_"}function d(e){return i[s(e)]}function l(e,t){return"local"===e.store_type?localStorage.getItem(t):sessionStorage.getItem(t)}function c(e,t,a){return"local"===e.store_type?localStorage.setItem(t,a):sessionStorage.setItem(t,a)}function u(e){for(var t=s(e),a="local"===e.store_type?localStorage:sessionStorage,n=[],r=0;r<a.length;r++)0==a.key(r).indexOf(t)&&n.push(a.key(r));for(var i=0;i<n.length;i++)a.removeItem(n[i])}function h(e){var t;return null!=(t=o(e)?l(e,s(e)+"COUNT"):i[s(e)+"COUNT"])?t:0}function f(e,t){o(e)?c(e,s(e)+"COUNT",t):i[s(e)+"COUNT"]=t}function p(e){if(e.dataset){var t=h(e);o(e)?c(e,s(e)+t,JSON.stringify(e.dataset)):(console.warn("Local storage not found/supported for this browser!",e.store_type),r=500,void 0===d(e)&&(i[s(e)]=[]),d(e).push(JSON.stringify(e.dataset))),t<r?t++:t=0,f(e,t)}}function m(e){if(!o(e))return d(e)&&d(e).length>0?d(e).length:-1;for(var t=r;t>0;t--)if(null!==l(e,s(e)+(t-1)))return t;return-1}function g(e){var t=h(e)-1;return-1==t&&(t=r),o(e)?JSON.parse(l(e,s(e)+t)):d(e)?JSON.parse(d(e)[t]):void 0}function _(e,t){if(void 0===t&&(t=h(e)-2),t<0){var a=a(e);t=a<r?a-1:r-1}return f(e,t+1),o(e)?JSON.parse(l(e,s(e)+t)):JSON.parse(d(e)[t])}function v(e,t){return void 0===t&&(t=h(e)),t>=r&&(t=0),f(e,parseInt(t)+1),o(e)?JSON.parse(l(e,s(e)+t)):JSON.parse(d(e)[t])}function y(e){o(e)&&function(e){"local"===e.store_type?localStorage.clear():sessionStorage.clear()}(e),i={}}function b(e,t,a,n){o(e)&&(c(e,s(e)+"_X",t),c(e,s(e)+"_Y",a),n&&c(e,s(e)+"_ZOOM",n))}function x(e){if(!o(e)||null===localStorage.getItem(s(e)+"_X")&&null===sessionStorage.getItem(s(e)+"_X"))return[null,null];var t=[parseInt(l(e,s(e)+"_X")),parseInt(l(e,s(e)+"_Y"))];return null!==l(s(e)+"_ZOOM")&&t.push(parseFloat(l(e,s(e)+"_ZOOM"))),t}var w=Object.freeze({__proto__:null,clear_pedigree_data:u,get_count:h,init_cache:p,nstore:m,current:g,last:function(e){if(o(e))for(var t=r;t>0;t--){var a=l(e,s(e)+(t-1));if(null!==a)return f(e,t),JSON.parse(a)}else{var n=d(e);if(n)return JSON.parse(n(n.length-1))}},previous:_,next:v,clear:y,setposition:b,getposition:x});function z(){var e=navigator.userAgent;return e.indexOf("MSIE ")>-1||e.indexOf("Trident/")>-1}function k(){return navigator.userAgent.match(/Edge/g)}function A(e){e[0].id&&e.sort((function(e,t){return e.id&&t.id?e.id>t.id?1:t.id>e.id?-1:0:0}));for(var t=["id","parent_node"],a=[],n=0;n<e.length;n++){var r={};for(var i in e[n])-1==t.indexOf(i)&&(r[i]=e[n][i]);a.push(r)}return a}function O(e,t,a,n,r){a?$('<div id="msgDialog">'+t+"</div>").dialog({modal:!0,title:e,width:350,buttons:{Yes:function(){$(this).dialog("close"),a(n,r)},No:function(){$(this).dialog("close")}}}):$('<div id="msgDialog">'+t+"</div>").dialog({title:e,width:350,buttons:[{text:"OK",click:function(){$(this).dialog("close")}}]})}function E(e){for(var t="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n=0;n<e;n++)t+=a.charAt(Math.floor(Math.random()*a.length));return t}function S(e,a,n,r,i){"undefined"===t(a.children)&&(a.children=R(e.dataset,a)),"undefined"===t(r)&&(r=[],i=1);var o=X(n),s=[];return $.each(a.children,(function(t,a){$.each(e.dataset,(function(t,n){if((a.name===n.mother||a.name===n.father)&&void 0===a.id){var r=Q(o,n.mother),i=Q(o,n.father);r=void 0!==r?r:Q(e.dataset,n.mother),i=void 0!==i?i:Q(e.dataset,n.father),function(e,t,a){for(var n=0;n<e.length;n++)if(e[n].mother===t&&e[n].father===a)return!0;return!1}(s,r,i)||s.push({mother:r,father:i})}}))})),$.merge(r,s),$.each(s,(function(t,n){var r=n.mother,s=n.father;r.children=[];var d={name:E(4),hidden:!0,parent:null,father:s,mother:r,children:R(e.dataset,r,s)},l=Y(e.dataset,r.name),c=Y(e.dataset,s.name);"id"in s||"id"in r||(i=F(a.children,i));var u=ee(e.dataset,l,c);u.fidx<u.midx?(s.id=i++,d.id=i++,r.id=i++):(r.id=i++,d.id=i++,s.id=i++),i=I(r,d,i,o,e),i=I(s,d,i,o,e),a.children.push(d)})),i=F(a.children,i),$.each(a.children,(function(t,a){i=S(e,a,n,r,i)[1]})),[r,i]}function I(e,t,a,n,r){if("parent_node"in e?e.parent_node.push(t):e.parent_node=[t],e.mztwin||e.dztwins)for(var i=P(r.dataset,e),o=0;o<i.length;o++){var s=Q(n,i[o].name);s&&(s.id=a++)}return a}function F(e,t){return e.sort((function(e,t){return e.mztwin&&t.mztwin&&e.mztwin==t.mztwin||e.dztwin&&t.dztwin&&e.dztwin==t.dztwin?0:e.mztwin||t.mztwin||e.dztwin||t.dztwin?1:0})),$.each(e,(function(e,a){void 0===a.id&&(a.id=t++)})),t}function D(e){return"undefined"!==t($(e).attr("proband"))&&!1!==$(e).attr("proband")}function N(e,t){for(var a=0;a<t.length;a++)-1==$.inArray(t[a],e)&&e.push(t[a])}function M(e,t,a){if(-1!=$.inArray(t.name,e)){N(e,C(a,t));var n=j(a,t);$.each(n,(function(t,n){-1==$.inArray(n.name,e)&&(e.push(n.name),N(e,C(a,n)))}))}}function C(e,t){for(var a=[],n=0;n<e.length;n++){var r=e[n];t.name===r.mother&&-1==$.inArray(r.father,a)?a.push(r.father):t.name===r.father&&-1==$.inArray(r.mother,a)&&a.push(r.mother)}return a}function T(e){var t=e[L(e)];if(!t){if(console.warn("No target defined"),0==e.length)throw"empty pedigree data set";t=e[0]}for(var a=[t.name],n=!0,r=0;n&&r<200;){r++;var i=a.length;$.each(e,(function(n,r){if(-1!=$.inArray(r.name,a)){for(var i=C(e,r),o=r.name===t.name||!r.noparents,s=0;s<i.length;s++)Q(e,i[s]).noparents||(o=!0);o&&(r.mother&&-1==$.inArray(r.mother,a)&&a.push(r.mother),r.father&&-1==$.inArray(r.father,a)&&a.push(r.father))}else!r.noparents&&(r.mother&&-1!=$.inArray(r.mother,a)||r.father&&-1!=$.inArray(r.father,a))&&a.push(r.name);M(a,r,e)})),n=i!=a.length}var o=$.map(e,(function(e,t){return e.name}));return $.map(o,(function(e,t){return-1==$.inArray(e,a)?e:null}))}function L(e){var t;return $.each(e,(function(e,a){if(D(a))return t=e})),t}function R(e,t,a){var n=[],r=[];return"F"===t.sex&&$.each(e,(function(e,i){t.name===i.mother&&(a&&a.name!=i.father||-1===$.inArray(i.name,r)&&(n.push(i),r.push(i.name)))})),n}function U(e,t,a){return void 0===t||!t.mother||t.noparents?[]:$.map(e,(function(e,n){return e.name===t.name||"noparents"in e||!e.mother||e.mother!==t.mother||e.father!==t.father||a&&e.sex!=a?null:e}))}function B(e,t,a){return $.map(e,(function(e,n){return e.name===t.name||"noparents"in e||!e.mother||e.mother!==t.mother||e.father!==t.father||a&&e.sex!=a?null:e}))}function P(e,t){var a=U(e,t),n=t.mztwin?"mztwin":"dztwin";return $.map(a,(function(e,a){return e.name!==t.name&&e[n]==t[n]?e:null}))}function G(e,t){return $.map(e,(function(e,a){return e.name!==t.name&&"noparents"in e&&e.mother===t.mother&&e.father===t.father?e:null}))}function j(e,t,a){return $.map(e,(function(e,n){return"noparents"in e||e.mother!==t.name&&e.father!==t.name||a&&e.sex!==a?null:e}))}function H(e,t){for(var a=Y(e,t),n=1;a>=0&&("mother"in e[a]||e[a].top_level);)a=Y(e,e[a].mother),n++;return n}function Y(e,t){var a=-1;return $.each(e,(function(e,n){if(t===n.name)return a=e})),a}function J(e,t,a){return $.map(e,(function(e,n){return e.depth!=t||e.data.hidden||-1!=$.inArray(e.data.name,a)?null:e})).sort((function(e,t){return e.x-t.x}))}function W(e,t){for(var a=[],n=0;n<t.length;n++)a.push({mother:Q(e,t[n].mother.name),father:Q(e,t[n].father.name)});return a}function q(e,t){var a=[];return function t(n){n.data&&(n=n.data),"mother"in n&&"father"in n&&!("noparents"in n)&&(t(Q(e,n.mother)),t(Q(e,n.father))),a.push(n)}(t),a}function V(e,t,a){if(e.depth!==t.depth)return!0;var n=q(a.dataset,e),r=q(a.dataset,t),i=$.map(n,(function(e,t){return e.name})),o=$.map(r,(function(e,t){return e.name})),s=!1;return $.each(i,(function(e,t){if(-1!==$.inArray(t,o))return s=!0,!1})),s}function X(e){var t=[];return function e(a){a.children&&a.children.forEach(e),t.push(a)}(e),t}function K(e,t,a){function n(r){if(r.children&&(r.children.forEach(n),void 0!==r.data.father)){var i=Q(a,r.data.father.name),o=Q(a,r.data.mother.name),s=(i.x+o.x)/2;if(Z(e,t.descendants(),s,r.depth,[r.data.name]))(r.x<i.x&&r.x<o.x||r.x>i.x&&r.x>o.x)&&(r.x=s);else{r.x=s;var d=r.x-s;if(2==r.children.length&&(r.children[0].data.hidden||r.children[1].data.hidden)){if(!r.children[0].data.hidden||!r.children[1].data.hidden){var l=r.children[0].data.hidden?r.children[1]:r.children[0],c=r.children[0].data.hidden?r.children[0]:r.children[1];(l.x<c.x&&s<c.x||l.x>c.x&&s>c.x)&&!Z(e,t.descendants(),s,l.depth,[l.data.name])&&(l.x=s)}}else if(1!=r.children.length||r.children[0].data.hidden){if(0!==d&&!function(e,t,a,n){for(var r=t.descendants(),i=$.map(r,(function(e,t){return e.data.name})),o=n.descendants(),s=0;s<r.length;s++){var d=r[s];if(t.data.name!==d.data.name)if(Z(e,o,d.x-a,d.depth,i))return!0}return!1}(e,r,d,t))if(1==r.children.length)r.children[0].x=s;else{var u=r.descendants();e.DEBUG&&console.log("ADJUSTING "+r.data.name+" NO. DESCENDANTS "+u.length+" diff="+d);for(var h=0;h<u.length;h++)r.data.name!==u[h].data.name&&(u[h].x-=d)}}else Z(e,t.descendants(),s,r.children[0].depth,[r.children[0].data.name])||(r.children[0].x=s)}}}n(t),n(t)}function Z(e,t,a,n,r){for(var i=0;i<t.length;i++)if(n==t[i].depth&&-1==$.inArray(t[i].data.name,r)&&Math.abs(a-t[i].x)<1.15*e.symbol_size)return!0;return!1}function Q(e,t){for(var a=0;a<e.length;a++){if(e[a].data&&t===e[a].data.name)return e[a];if(t===e[a].name)return e[a]}}function ee(e,t,a){for(var n=t,r=a;"mother"in e[n]&&"mother"in e[r]&&!("noparents"in e[n])&&!("noparents"in e[r]);)n=Y(e,e[n].mother),r=Y(e,e[r].mother);return{midx:n,fidx:r}}function te(e,t,a,n){var r=A(g(e)),i=Q(r,t);if(i){if($.isArray(a)||(a=[a]),n)for(var o=0;o<a.length;o++){var s=a[o];if(s in i&&1===a.length){if(i[s]===n)return;try{if(JSON.stringify(i[s])===JSON.stringify(n))return}catch(e){}}i[s]=n}else{for(var d=!1,l=0;l<a.length;l++){var c=a[l];c in i&&(delete i[c],d=!0)}if(!d)return}ot(r,i),e.dataset=r,at(e)}else console.warn("No person defined")}function ae(e){var t;$("#pedigree_data").remove(),$("body").append("<div id='pedigree_data'></div>");for(var a=0;a<e.dataset.length;a++){var n="<div class='row'><strong class='col-md-1 text-right'>"+e.dataset[a].name+"</strong><div class='col-md-11'>";for(t in e.dataset[a])"name"!==t&&("parent"===t?n+="<span>"+t+":"+e.dataset[a][t].name+"; </span>":"children"===t?void 0!==e.dataset[a][t][0]&&(n+="<span>"+t+":"+e.dataset[a][t][0].name+"; </span>"):n+="<span>"+t+":"+e.dataset[a][t]+"; </span>");$("#pedigree_data").append(n+"</div></div>")}for(t in $("#pedigree_data").append("<br /><br />"),e)"dataset"!==t&&$("#pedigree_data").append("<span>"+t+":"+e[t]+"; </span>")}var ne=Object.freeze({__proto__:null,isIE:z,isEdge:k,copy_dataset:A,getFormattedDate:function(e){var t=new Date;return e?("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2):t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)},messages:O,validate_age_yob:function(e,t,a){var n=(new Date).getFullYear(),r=parseInt(e)+parseInt(t);return(1==a||Math.abs(n-r)<=1)&&n>=r},capitaliseFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},makeid:E,buildTree:S,isProband:D,setProband:function(e,t,a){$.each(e,(function(e,n){t===n.name?n.proband=a:delete n.proband}))},get_partners:C,unconnected:T,getProbandIndex:L,getChildren:R,getSiblings:U,getAllSiblings:B,getTwins:P,getAdoptedSiblings:G,getAllChildren:j,getDepth:H,getIdxByName:Y,getNodesAtDepth:J,linkNodes:W,ancestors:q,consanguity:V,flatten:X,adjust_coords:K,overlap:Z,getNodeByName:Q,urlParam:function(e){var t=new RegExp("[?&]"+e+"=([^&#]*)").exec(window.location.href);return null===t?null:t[1]||0},get_grandparents_idx:ee,proband_attr:function(e,t,a){te(e,e.dataset[L(e.dataset)].name,t,a)},node_attr:te,proband_add_child:function(e,t,a,n,r){var i=A(g(e)),o=i[L(i)];if(o){var s=nt(i,o,t,1)[0];return s.age=a,s.yob=n,void 0!==r&&(s.breastfeeding=r),e.dataset=i,at(e),s.name}console.warn("No proband defined")},delete_node_by_name:function(e,t){var a=A(g(e)),n=Q(g(e),t);n?ct(a,n,e,(function(e,t){e.dataset=t,at(e)})):console.warn("No node defined")},exists:function(e,t){return void 0!==Q(g(e),t)},print_opts:ae});function re(e){for(var t=$.extend({btn_target:"pedigree_history"},e),a=[{fa:"fa-undo",title:"undo"},{fa:"fa-repeat",title:"redo"},{fa:"fa-refresh",title:"reset"},{fa:"fa-arrows-alt",title:"fullscreen"}],n="",r=0;r<a.length;r++)n+='<li">',n+='&nbsp;<i class="fa fa-lg '+a[r].fa+'" '+("fa-arrows-alt"==a[r].fa?'id="fullscreen" ':"")+' aria-hidden="true" title="'+a[r].title+'"></i>',n+="</li>";$("#"+t.btn_target).append(n),function(e){$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",(function(t){var a=g(e);null!=a&&(e.dataset=a),at(e)})),$("#fullscreen").on("click",(function(t){if(document.mozFullScreen||document.webkitFullScreen)document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen();else{var a=$("#"+e.targetDiv)[0];a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}})),$("#"+e.btn_target).on("click",(function(t){if(t.stopPropagation(),$(t.target).hasClass("disabled"))return!1;$(t.target).hasClass("fa-undo")?(e.dataset=_(e),$("#"+e.targetDiv).empty(),We(e)):$(t.target).hasClass("fa-repeat")?(e.dataset=v(e),$("#"+e.targetDiv).empty(),We(e)):$(t.target).hasClass("fa-refresh")&&$('<div id="msgDialog">Resetting the pedigree may result in loss of some data.</div>').dialog({title:"Confirm Reset",resizable:!1,height:"auto",width:400,modal:!0,buttons:{Continue:function(){!function(e,t){var a;if(t){var n=A(g(e));(a=n[L(n)]).name="ch1",a.mother="f21",a.father="m21",u(e)}else a={name:"ch1",sex:"F",mother:"f21",father:"m21",proband:!0,status:"0",display_name:"me"},y(e);delete e.dataset;var r=$("input[name='default_fam']:checked");r.length>0&&"extended2"==r.val()?e.dataset=[{name:"wZA",sex:"M",top_level:!0,status:"0",display_name:"paternal grandfather"},{name:"MAk",sex:"F",top_level:!0,status:"0",display_name:"paternal grandmother"},{name:"zwB",sex:"M",top_level:!0,status:"0",display_name:"maternal grandfather"},{name:"dOH",sex:"F",top_level:!0,status:"0",display_name:"maternal grandmother"},{name:"MKg",sex:"F",mother:"MAk",father:"wZA",status:"0",display_name:"paternal aunt"},{name:"xsm",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"paternal uncle"},{name:"m21",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"father"},{name:"f21",sex:"F",mother:"dOH",father:"zwB",status:"0",display_name:"mother"},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"},{name:"Spj",sex:"M",mother:"f21",father:"m21",noparents:!0,status:"0",display_name:"partner"},a,{name:"zhk",sex:"F",mother:"ch1",father:"Spj",status:"0",display_name:"daughter"},{name:"Knx",display_name:"son",sex:"M",mother:"ch1",father:"Spj",status:"0"},{name:"uuc",display_name:"maternal aunt",sex:"F",mother:"dOH",father:"zwB",status:"0"},{name:"xIw",display_name:"maternal uncle",sex:"M",mother:"dOH",father:"zwB",status:"0"}]:r.length>0&&"extended1"==r.val()?e.dataset=[{name:"m21",sex:"M",mother:null,father:null,status:"0",display_name:"father",noparents:!0},{name:"f21",sex:"F",mother:null,father:null,status:"0",display_name:"mother",noparents:!0},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"},{name:"Spj",sex:"M",mother:"f21",father:"m21",noparents:!0,status:"0",display_name:"partner"},a,{name:"zhk",sex:"F",mother:"ch1",father:"Spj",status:"0",display_name:"daughter"},{name:"Knx",display_name:"son",sex:"M",mother:"ch1",father:"Spj",status:"0"}]:e.dataset=[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},a];at(e)}(e,e.keep_proband_on_reset),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),$(document).trigger("fhChange",[e])}))}(t)}function ie(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement}var oe={breast_cancer:"breast_cancer_diagnosis_age",breast_cancer2:"breast_cancer2_diagnosis_age",ovarian_cancer:"ovarian_cancer_diagnosis_age",prostate_cancer:"prostate_cancer_diagnosis_age",pancreatic_cancer:"pancreatic_cancer_diagnosis_age"},se=["brca1","brca2","palb2","atm","chek2","rad51d","rad51c","brip1"],de=["er","pr","her2","ck14","ck56"],le=new Object;function ce(e){return 0!==$.trim($("#"+e).val()).length}function ue(){var e={};return ce("breast_prs_a")&&ce("breast_prs_z")&&(e.breast_cancer_prs={alpha:parseFloat($("#breast_prs_a").val()),zscore:parseFloat($("#breast_prs_z").val()),percent:parseFloat($("#breast_prs_percent").val())}),ce("ovarian_prs_a")&&ce("ovarian_prs_z")&&(e.ovarian_cancer_prs={alpha:parseFloat($("#ovarian_prs_a").val()),zscore:parseFloat($("#ovarian_prs_z").val()),percent:parseFloat($("#ovarian_prs_percent").val())}),console.log(e),function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}(e)?0:e}function he(e){for(var t=e.trim().split("\n"),a=[],n=[],r=function(e){var r=t[e].trim();if(r.startsWith("##")){if(r.startsWith("##CanRisk")&&r.indexOf(";")>-1)for(var i=r.split(";"),o=1;o<i.length;o++){2===i[o].split("=").length&&n.push(i[o])}return-1!==r.indexOf("CanRisk")||r.startsWith("##FamID")||n.push(r.replace("##","")),"continue"}var s=/\t/;r.indexOf("\t")<0&&(s=/\s+/,console.log("NOT TAB DELIM"));var d=$.map(r.split(s),(function(e,t){return e.trim()}));if(d.length>1){var l={famid:d[0],display_name:d[1],name:d[3],sex:d[6],status:d[8]};1==d[2]&&(l.proband=!0),"0"!==d[4]&&(l.father=d[4]),"0"!==d[5]&&(l.mother=d[5]),"0"!==d[7]&&(l.mztwin=d[7]),"0"!==d[9]&&(l.age=d[9]),"0"!==d[10]&&(l.yob=d[10]);var c=11;$.each(oe,(function(e,t){"0"!==d[c]&&(l[t]=d[c]),c++})),"0"!==d[c++]&&(l.ashkenazi=1);for(var u=0;u<se.length;u++){var h=d[c].split(":");"0"!==h[0]&&("S"!==h[0]&&"T"!==h[0]||"P"!==h[1]&&"N"!==h[1]?console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+h[0]+" "+h[1]):l[se[u]+"_gene_test"]={type:h[0],result:h[1]}),c++}for(var f=d[c].split(":"),p=0;p<f.length;p++)"0"!==f[p]&&("N"===f[p]||"P"===f[p]?l[de[p]+"_bc_pathology"]=f[p]:console.warn("UNRECOGNISED PATHOLOGY ON LINE "+(e+1)+": "+de[p]+" "+f[p]));a.unshift(l)}},i=0;i<t.length;i++)r(i);return[n,a]}function fe(e,t,a,n){var r="##CanRisk 1.0";t||(t="XXXX"),a&&(r+=a),void 0===n&&(n=!0);var i=$.map(e,(function(e,t){return"exclude"in e&&e.exclude?e.name:null})),o=L(e),s="F";if(o&&(s=e[o].sex),"M"!==s){var d=pe("menarche_age"),l=pe("parity"),c=pe("age_of_first_live_birth"),u=pe("oral_contraception"),h=pe("mht"),f=pe("bmi"),p=pe("alcohol_intake"),m=pe("age_of_menopause"),g=pe("mammographic_density"),_=pe("height"),v=pe("Age_Tubal_ligation"),y=pe("endometriosis");void 0!==d&&(r+="\n##menarche="+d),void 0!==l&&(r+="\n##parity="+l),void 0!==c&&(r+="\n##first_live_birth="+c),void 0!==u&&(r+="\n##oc_use="+u),void 0!==h&&(r+="\n##mht_use="+h),void 0!==f&&(r+="\n##BMI="+f),void 0!==p&&(r+="\n##alcohol="+p),void 0!==m&&(r+="\n##menopause="+m),void 0!==g&&(r+="\n##birads="+g),void 0!==_&&(r+="\n##height="+_),void 0!==v&&(r+="n"!==v&&"N"!==v?"\n##TL=Y":"\n##TL=N"),void 0!==y&&(r+="\n##endo="+y)}r+="\n##FamID\tName\tTarget\tIndivID\tFathID\tMothID\tSex\tMZtwin\tDead\tAge\tYob\tBC1\tBC2\tOC\tPRO\tPAN\tAshkn\tBRCA1\tBRCA2\tPALB2\tATM\tCHEK2\tRAD51D\tRAD51C\tBRIP1\tER:PR:HER2:CK14:CK56";for(var b=function(a){var o=e[a];if(-1!=$.inArray(o.name,i))return console.log("EXCLUDE: "+o.name),"continue";r+="\n"+t+"\t",r+=n?a+"\t":(o.display_name?o.display_name:"NA")+"\t",r+=("proband"in o?"1":0)+"\t",r+=o.name+"\t",r+=("father"in o&&!("noparents"in o)&&-1==$.inArray(o.mother,i)?o.father:0)+"\t",r+=("mother"in o&&!("noparents"in o)&&-1==$.inArray(o.mother,i)?o.mother:0)+"\t",r+=o.sex+"\t",r+=("mztwin"in o?o.mztwin:0)+"\t",r+=("status"in o?o.status:0)+"\t",r+=("age"in o?o.age:0)+"\t",r+=("yob"in o?o.yob:0)+"\t",$.each(oe,(function(e,t){r+=t in o?(t in o?o[t]:"AU")+"\t":"0\t"})),r+=("ashkenazi"in o?o.ashkenazi:0)+"\t";for(var s=0;s<se.length;s++)se[s]+"_gene_test"in o&&"-"!==o[se[s]+"_gene_test"].type&&"-"!==o[se[s]+"_gene_test"].result?(r+=o[se[s]+"_gene_test"].type+":",r+=o[se[s]+"_gene_test"].result+"\t"):r+="0:0\t";for(var d=0;d<de.length;d++)de[d]+"_bc_pathology"in o?(r+=o[de[d]+"_bc_pathology"],console.log("pathology "+o[de[d]+"_bc_pathology"]+" for "+o.display_name)):r+="0",d<de.length-1&&(r+=":")},x=0;x<e.length;x++)b(x);return console.log(r,le),r}function pe(e){var t=me(e);if(t in le)return le[t]}function me(e){return window.location.pathname.split("/").filter((function(e){return!!e})).pop()+"::"+e}var ge=Object.freeze({__proto__:null,cancers:oe,genetic_test:se,pathology_tests:de,get_meta:function(){var e,t=function(){var e="";$("#A6_4_3_check").parent().hasClass("off")||(e+=";OVARY2=y");$("#A6_4_7_check").parent().hasClass("off")||(e+=";MAST2=y");return e}();try{(e=ue()).breast_cancer_prs&&0!==e.breast_cancer_prs.alpha&&0!==e.breast_cancer_prs.zscore&&(t+="\n##PRS_BC=alpha="+e.breast_cancer_prs.alpha+",zscore="+e.breast_cancer_prs.zscore),e.ovarian_cancer_prs&&0!==e.ovarian_cancer_prs.alpha&&0!==e.ovarian_cancer_prs.zscore&&(t+="\n##PRS_OC=alpha="+e.ovarian_cancer_prs.alpha+",zscore="+e.ovarian_cancer_prs.zscore)}catch(t){console.warn("PRS",e)}return t},get_non_anon_pedigree:function(e,t){return fe(e,void 0,t,!1)},hasInput:ce,get_prs_values:ue,readCanRiskV1:he,get_pedigree:fe,show_risk_factor_store:function(){console.log("RISK_FACTOR_STORE::"),$.each(le,(function(e,t){console.log(e+" : "+t)}))},save_risk_factor:function(e,t){le[me(e)]=t},get_risk_factor:pe,remove_risk_factor:function(e){delete le[me(e)]},store_name:me});function _e(e){$("#load").change((function(t){Ae(t,e)})),$("#save").click((function(t){!function(e){var t=JSON.stringify(g(e));ze(e,t)}(e)})),$("#print").click((function(t){we(xe(e))})),$("#svg_download").click((function(t){$e(xe(e))})),$("#png_download").click((function(e){var t=ye($("svg"),"pedigree");$.when.apply($,[t]).done((function(){var e=ve(arguments,"pedigree");if(k()||z()){var t="<img src='"+e.img+"' alt='canvas image'/>",a=window.open();a.document.write(t)}else{var n=document.createElement("a");n.href=e.img,n.download="plot.png",n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}))}))}function ve(e,t){return $.grep(e,(function(e){return e&&e.name==t}))[0]}function ye(e,t,a){var n={iscanvg:!1,resolution:1,img_type:"image/png"};if(a||(a=n),$.each(n,(function(e,t){e in a||(a[e]=t)})),0===e.find(".pdf-white-bg").length){var r=d3.select(e.get(0));r.append("rect").attr("width","100%").attr("height","100%").attr("class","pdf-white-bg").attr("fill","white"),r.select(".pdf-white-bg").lower()}var i,o=$.Deferred();void 0!==window.XMLSerializer?i=(new XMLSerializer).serializeToString(e.get(0)):void 0!==e.xml&&(i=e.get(0).xml);var s="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(i))),d=document.createElement("canvas");d.width=e.width()*a.resolution,d.height=e.height()*a.resolution;var l=d.getContext("2d"),c=document.createElement("img");return c.onload=function(){z()?(i=(i=i.replace(/ font-size="\d?.\d*em"/g,"")).replace(/<text /g,'<text font-size="12px" '),canvg.Canvg.fromString(l,i,{scaleWidth:d.width,scaleHeight:d.height,ignoreDimensions:!0}).start(),console.log(t,a.img_type,"use canvg to create image")):(l.drawImage(c,0,0,d.width,d.height),console.log(t,a.img_type));o.resolve({name:t,resolution:a.resolution,img:d.toDataURL(a.img_type,1),w:d.width,h:d.height})},c.src=s,o.promise()}function be(e){var t=function(e,t){var a,n=[],r=0;for(t.lastIndex=0;a=t.exec(e);){if(++r>400)return console.error("getMatches: counter exceeded 800"),-1;n.push(a),t.lastIndex===a.index&&t.lastIndex++}return n}(e,/url\((&quot;|"|'){0,1}#(.*?)(&quot;|"|'){0,1}\)/g);return-1===t?"ERROR DISPLAYING PEDIGREE":($.each(t,(function(t,a){var n=a[1]?a[1]:"",r=a[2],i='id="'+r+'"',o="url\\("+n+"#"+r+n+"\\)",s=r+E(2);e=(e=e.replace(new RegExp(i,"g"),'id="'+s+'"')).replace(new RegExp(o,"g"),"url(#"+s+")")})),e)}function xe(e){var t=g(e);null!=t&&(e.dataset=t);var a=et(e),n=$("<div></div>"),r=$("#"+e.targetDiv).find("svg").clone().appendTo(n);if(e.width<a.width||e.height<a.height||a.width>595||a.height>842){var i=a.width,o=a.height+100,s=1;if(a.width>595||a.height>842){a.width>595&&(i=595),a.height>842&&(o=842);var d=i/a.width,l=o/a.height;s=d<l?d:l}r.attr("width",i),r.attr("height",o);var c=1.5*-e.symbol_size*s;r.find(".diagram").attr("transform","translate(0, "+c+") scale("+s+")")}return n}function $e(e){var t=document.createElement("a");t.href="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e.html()))),t.download="plot.svg",t.target="_blank",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function we(e,t){e.constructor!==Array&&(e=[e]);for(var a=.9*$(window).width(),n=$(window).height()-10,r=["/static/css/canrisk.css","https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"],i=window.open("","PrintMap","width="+a+",height="+n),o="",s=0;s<r.length;s++)o+='<link href="'+r[s]+'" rel="stylesheet" type="text/css" media="all">';o+="<style>body {font-size: "+$("body").css("font-size")+";}</style>";for(var d="",l=0;l<e.length;l++)0===l&&t&&(d+=t),d+=$(e[l]).html(),l<e.length-1&&(d+='<div class="page-break"> </div>');i.document.write(o),i.document.write(d),i.document.close(),i.focus(),setTimeout((function(){i.print(),i.close()}),300)}function ze(e,t,a,n){e.DEBUG&&console.log(t),a||(a="ped.txt"),n||(n="text/plain");var r=new Blob([t],{type:n});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(r,a);else{var i=document.createElement("a"),o=URL.createObjectURL(r);i.href=o,i.download=a,document.body.appendChild(i),i.click(),setTimeout((function(){document.body.removeChild(i),window.URL.revokeObjectURL(o)}),0)}}function ke(e){$.each(e.dataset,(function(e,t){if(!t.hidden&&"M"===t.sex&&!D(t)&&t[oe.breast_cancer2]){var a="Male family member ("+t.display_name+") with contralateral breast cancer found. Please note that as the risk models do not take this into account the second breast cancer is ignored.";console.error(a),delete t[oe.breast_cancer2],O("Warning",a)}}))}function Ae(e,t){var n=e.target.files[0];if(n){var r,i=new FileReader;i.onload=function(e){t.DEBUG&&console.log(e.target.result);try{if(e.target.result.startsWith("BOADICEA import pedigree file format 4.0"))t.dataset=Ee(e.target.result,4),ke(t);else if(e.target.result.startsWith("BOADICEA import pedigree file format 2.0"))t.dataset=Ee(e.target.result,2),ke(t);else if(e.target.result.startsWith("##")&&-1!==e.target.result.indexOf("CanRisk")){var n=function(e){var t=a(he(e),2),n=t[0],r=t[1];try{return[n,Se(r)]}catch(e){return console.error(e),[n,r]}}(e.target.result);r=n[0],t.dataset=n[1],ke(t)}else try{t.dataset=JSON.parse(e.target.result)}catch(a){t.dataset=Oe(e.target.result)}Ve(t)}catch(t){return console.error(t,e.target.result),void O("File Error",t.message?t.message:t)}console.log(t.dataset);try{at(t),void 0!==r&&(console.log(r),$(document).trigger("riskfactorChange",[t,r])),$(document).trigger("fhChange",[t]);try{acc_FamHist_ticked(),acc_FamHist_Leave(),RESULT.FLAG_FAMILY_MODAL=!0}catch(e){}}catch(e){O("File Error",e.message?e.message:e)}},i.onerror=function(e){O("File Error","File could not be read! Code "+e.target.error.code)},i.readAsText(n)}else console.error("File could not be read!");$("#load")[0].value=""}function Oe(e){for(var t,a=e.trim().split("\n"),n=[],r=0;r<a.length;r++){var i=$.map(a[r].trim().split(/\s+/),(function(e,t){return e.trim()}));if(i.length<5)throw"unknown format";var o="1"==i[4]?"M":"2"==i[4]?"F":"U",s={famid:i[0],display_name:i[1],name:i[1],sex:o};if("0"!==i[2]&&(s.father=i[2]),"0"!==i[3]&&(s.mother=i[3]),void 0!==t&&t!==s.famid){console.error("multiple family IDs found only using famid = "+t);break}if("2"==i[5]&&(s.affected=2),i.length>6){s.alleles="";for(var d=6;d<i.length;d+=2)s.alleles+=i[d]+"/"+i[d+1]+";"}n.unshift(s),t=i[0]}return Se(n)}function Ee(e,t){for(var a=e.trim().split("\n"),n=[],r=function(e){var r=$.map(a[e].trim().split(/\s+/),(function(e,t){return e.trim()}));if(r.length>1){var i={famid:r[0],display_name:r[1],name:r[3],sex:r[6],status:r[8]};1==r[2]&&(i.proband=!0),"0"!==r[4]&&(i.father=r[4]),"0"!==r[5]&&(i.mother=r[5]),"0"!==r[7]&&(i.mztwin=r[7]),"0"!==r[9]&&(i.age=r[9]),"0"!==r[10]&&(i.yob=r[10]);var o=11;if($.each(oe,(function(e,t){"0"!==r[o]&&(i[t]=r[o]),o++})),4===t){"0"!==r[o++]&&(i.ashkenazi=1);for(var s=0;s<5;s++)"0"!==r[(o+=2)-2]&&("S"!==r[o-2]&&"T"!==r[o-2]||"P"!==r[o-1]&&"N"!==r[o-1]?console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[o-2]+" "+r[o-1]):i[se[s]+"_gene_test"]={type:r[o-2],result:r[o-1]})}else 2===t&&("0"!==r[(o+=2)-2]&&("S"===r[o-2]||"T"===r[o-2]?"N"===r[o-1]?(i.brca1_gene_test={type:r[o-2],result:"N"},i.brca2_gene_test={type:r[o-2],result:"N"}):"1"===r[o-1]?(i.brca1_gene_test={type:r[o-2],result:"P"},i.brca2_gene_test={type:r[o-2],result:"N"}):"2"===r[o-1]?(i.brca1_gene_test={type:r[o-2],result:"N"},i.brca2_gene_test={type:r[o-2],result:"P"}):"3"===r[o-1]&&(i.brca1_gene_test={type:r[o-2],result:"P"},i.brca2_gene_test={type:r[o-2],result:"P"}):console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[o-2]+" "+r[o-1])),"0"!==r[o++]&&(i.ashkenazi=1));for(var d=0;d<de.length;d++)"0"!==r[o]&&("N"===r[o]||"P"===r[o]?i[de[d]+"_bc_pathology"]=r[o]:console.warn("UNRECOGNISED PATHOLOGY ON LINE "+(e+1)+": "+de[d]+" "+r[o])),o++;n.unshift(i)}},i=2;i<a.length;i++)r(i);try{return Se(n)}catch(e){return console.error(e),n}}function Se(e){for(var t=0;t<2;t++)for(var a=0;a<e.length;a++)n=e,r=e[a].name,i=void 0,o=void 0,i=Y(n,r),o=n[i].level?n[i].level:0,Fe(i,o,n);for(var n,r,i,o,s=0,d=0;d<e.length;d++)e[d].level&&e[d].level>s&&(s=e[d].level);for(var l=0;l<e.length;l++)if(1==H(e,e[l].name))if(e[l].level&&e[l].level==s)e[l].top_level=!0;else{e[l].noparents=!0;var c=Ie(e,e[l]);if(c>-1&&e[c].mother&&(e[l].mother=e[c].mother,e[l].father=e[c].father),!e[l].mother)for(var u=0;u<e.length;u++)e[l].level==e[u].level-1&&(c=Ie(e,e[u]))>-1&&(e[l].mother="F"===e[u].sex?e[u].name:e[c].name,e[l].father="M"===e[u].sex?e[u].name:e[c].name)}else delete e[l].top_level;return e}function Ie(e,t){for(var a=0;a<e.length;a++){var n=e[a];if(t.name===n.mother)return Y(e,n.father);if(t.name===n.father)return Y(e,n.mother)}return-1}function Fe(e,t,a){var n=["mother","father"];t++;for(var r=0;r<n.length;r++){var i=Y(a,a[e][n[r]]);if(i>=0){var o=a[Y(a,a[e].mother)],s=a[Y(a,a[e].father)];(!a[i].level||a[i].level<t)&&(o.level=t,s.level=t),o.level<s.level?o.level=s.level:s.level<o.level&&(s.level=o.level),Fe(i,t,a)}}}var De=Object.freeze({__proto__:null,add:_e,svg2img:ye,copy_svg:function(e){var t=xe(e),a=d3.select(t.get(0));return a.selectAll(".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection").remove(),a.selectAll("text").filter((function(){return 0===d3.select(this).text().length})).remove(),$(be(t.html()))},svg_download:$e,print:we,save_file:ze,load:Ae,readLinkage:Oe,readBoadiceaV4:Ee});function Ne(e){$("#age_yob_lock").removeClass("fa-lock fa-unlock-alt"),1==e?$("#age_yob_lock").addClass("fa-unlock-alt"):$("#age_yob_lock").addClass("fa-lock"),$("#id_age_"+e).removeClass("hidden"),$("#id_age_"+(1==e?"0":"1")).addClass("hidden")}function Me(e){$("#orig_ashk").is(":checked")?$.each(e,(function(e,t){t.proband&&(t.ashkenazi=1)})):$.each(e,(function(e,t){delete t.ashkenazi}))}function Ce(e){var t=g(e),a=$("#id_name").val(),n=A(t),r=Q(n,a);if(r){$("#"+e.targetDiv).empty();var i=$("#id_yob_0").val();i&&""!==i?r.yob=i:delete r.yob;var o=$("#id_status").find("input[type='radio']:checked");o.length>0&&(r.status=o.val());for(var s=["miscarriage","adopted_in","adopted_out","termination","stillbirth"],d=0;d<s.length;d++){var l=s[d],c=$("#id_"+l);c.length>0&&(console.log(c.is(":checked")),c.is(":checked")?r[l]=!0:delete r[l])}var u=$("#id_sex").find("input[type='radio']:checked");u.length>0&&(r.sex=u.val(),Le(r)),Me(n),$("#id_approx").is(":checked")?r.approx_diagnosis_age=!0:delete r.approx_diagnosis_age,$("#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible").each((function(){var e=this.name.indexOf("_diagnosis_age")>-1?this.name.substring(0,this.name.length-2):this.name;if($(this).val()){var t=$(this).val();e.indexOf("_diagnosis_age")>-1&&$("#id_approx").is(":checked")&&(t=Re(t)),r[e]=t}else delete r[e]})),$('#person_details input[type="checkbox"][name$="cancer"],input[type="checkbox"][name$="cancer2"]').each((function(){this.checked?r[$(this).attr("name")]=!0:delete r[$(this).attr("name")]})),$('#person_details select[name$="_bc_pathology"]').each((function(){"-"!==$(this).val()?r[$(this).attr("name")]=$(this).val():delete r[$(this).attr("name")]})),$('#person_details select[name$="_gene_test"]').each((function(){if("-"!==$(this).val()){var e=$('select[name="'+$(this).attr("name")+'_result"]');r[$(this).attr("name")]={type:$(this).val(),result:$(e).val()}}else delete r[$(this).attr("name")]}));try{$("#person_details").find("form").valid()}catch(e){console.warn("valid() not found")}ot(n,r),e.dataset=n,at(e)}else console.warn("person not found when saving details")}function Te(){$("#id_approx").is(":checked")?($("[id$='_diagnosis_age_0']").each((function(e){if(""!==$(this).val()){var t=this.name.substring(0,this.name.length-2);$("#id_"+t+"_1").val(Re($(this).val())).prop("selected",!0)}})),$("[id$='_diagnosis_age_0']").hide(),$("[id$='_diagnosis_age_1']").show()):($("[id$='_diagnosis_age_1']").each((function(e){if(""!==$(this).val()){var t=this.name.substring(0,this.name.length-2);$("#id_"+t+"_0").val($(this).val())}})),$("[id$='_diagnosis_age_0']").show(),$("[id$='_diagnosis_age_1']").hide())}function Le(e){$("#cancer .row").show(),"M"===e.sex?(delete e.ovarian_cancer_diagnosis_age,$("[id^='id_ovarian_cancer_diagnosis_age']").closest(".row").hide(),$("[id^='id_breast_cancer2_diagnosis_age']").prop("disabled",!0)):"F"===e.sex&&(delete e.prostate_cancer_diagnosis_age,$("[id^='id_prostate_cancer_diagnosis_age']").closest(".row").hide(),$("[id^='id_breast_cancer2_diagnosis_age']").prop("disabled",!1))}function Re(e){var t=10*Math.round((e-1)/10);return e<t?t-5:t+5}$(document).on("fhChange",(function(e,t){try{var a=$("#id_name").val();void 0===Q(g(t),a)?$("form > fieldset").prop("disabled",!0):$("form > fieldset").prop("disabled",!1)}catch(e){console.warn(e)}}));var Ue,Be,Pe=Object.freeze({__proto__:null,updateStatus:Ne,nodeclick:function(e){for(var a in $("form > fieldset").prop("disabled",!1),$("#person_details").find("input[type=text], input[type=number]").val(""),$("#person_details select").val("").prop("selected",!0),"M"===e.sex||"F"===e.sex?$('input[name=sex][value="'+e.sex+'"]').prop("checked",!0):$("input[name=sex]").prop("checked",!1),Le(e),"status"in e||(e.status=0),$('input[name=status][value="'+e.status+'"]').prop("checked",!0),Ne(e.status),"proband"in e?($("#id_proband").prop("checked",e.proband),$("#id_proband").prop("disabled",!0)):($("#id_proband").prop("checked",!1),$("#id_proband").prop("disabled",!("yob"in e))),"exclude"in e?$("#id_exclude").prop("checked",e.exclude):$("#id_exclude").prop("checked",!1),"yob"in e?$("#id_yob_0").val(e.yob):$("#id_yob_0").val("-"),$('select[name$="_bc_pathology"]').val("-"),$('select[name*="_gene_test"]').val("-"),$("input[id^='id_sex_']").prop("disabled",!(!e.parent_node||"U"===e.sex)),$("select[id$='_bc_pathology']").prop("disabled","M"===e.sex||"F"===e.sex&&!("breast_cancer_diagnosis_age"in e)),$("#id_approx").prop("checked",!!e.approx_diagnosis_age),Te(),e)"proband"!==a&&"sex"!==a&&($("#id_"+a).length?-1!==a.indexOf("_gene_test")&&null!==e[a]&&"object"===t(e[a])?($("#id_"+a).val(e[a].type),$("#id_"+a+"_result").val(e[a].result)):$("#id_"+a).val(e[a]):-1!==a.indexOf("_diagnosis_age")&&($("#id_approx").is(":checked")?$("#id_"+a+"_1").val(Re(e[a])).prop("selected",!0):$("#id_"+a+"_0").val(e[a])));try{$("#person_details").find("form").valid()}catch(e){console.warn("valid() not found")}},save_ashkn:function(e){var t=A(g(e));Me(t),e.dataset=t,at(e)},save:Ce,update_diagnosis_age_widget:Te});function Ge(e,t){var a=parseInt($("body").css("font-size")),n=d3.select(".diagram");n.append("rect").attr("class","popup_selection").attr("rx",6).attr("ry",6).attr("transform","translate(-1000,-100)").style("opacity",0).attr("width",7.9*a).attr("height",2*a).style("stroke","darkgrey").attr("fill","white");var r=n.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("font-size","1.em").attr("class","popup_selection fa-lg fa-square persontype").attr("transform","translate(-1000,-100)").attr("x",a/3).attr("y",1.5*a).text(" ").append("svg:title").text("add male"),i=n.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("font-size","1.em").attr("class","popup_selection fa-lg fa-circle persontype").attr("transform","translate(-1000,-100)").attr("x",1.7*a).attr("y",1.5*a).text(" ").append("svg:title").text("add female");n.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("font-size","1.em").attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-lg fa-unspecified popup_selection_rotate45 persontype").text(" ").append("svg:title").text("add unspecified"),n.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-2x fa-angle-up persontype dztwin").attr("x",4.6*a).attr("y",1.5*a).text(" ").append("svg:title").text("add dizygotic/fraternal twins"),n.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-2x fa-caret-up persontype mztwin").attr("x",6.2*a).attr("y",1.5*a).text("").append("svg:title").text("add monozygotic/identical twins");var o={};d3.selectAll(".persontype").on("click",(function(){var t,a,n=A(g(e)),r=d3.select(this).classed("mztwin"),i=d3.select(this).classed("dztwin");if(r||i?(a=o.node.datum().data.sex,t=r?"mztwin":"dztwin"):a=d3.select(this).classed("fa-square")?"M":d3.select(this).classed("fa-circle")?"F":"U","addsibling"===o.type)rt(n,o.node.datum().data,a,!1,t);else{if("addchild"!==o.type)return;nt(n,o.node.datum().data,t?"U":a,t?2:1,t)}e.dataset=n,at(e),d3.selectAll(".popup_selection").style("opacity",0),o={}})).on("mouseover",(function(){o.node&&o.node.select("rect").style("opacity",.2),d3.selectAll(".popup_selection").style("opacity",1),"addsibling"===o.type?d3.select(this).classed("fa-square")?r.text("add brother"):i.text("add sister"):"addchild"===o.type&&(d3.select(this).classed("fa-square")?r.text("add son"):i.text("add daughter"))})),d3.selectAll(".popup_selection").on("mouseout",(function(){void 0!==o.node&&-1==f.indexOf(o.node.datum())&&o.node.select("rect").style("opacity",0),d3.selectAll(".popup_selection").style("opacity",0)})),function(e){function t(){Ue=Be,d3.selectAll(".line_drag_selection").attr("stroke","darkred")}function a(t){if(Be&&Ue.data.name!==Be.data.name&&Ue.data.sex!==Be.data.sex){var a={name:E(4),sex:"U",mother:"F"===Ue.data.sex?Ue.data.name:Be.data.name,father:"F"===Ue.data.sex?Be.data.name:Ue.data.name},n=A(e.dataset);e.dataset=n;var r=Y(e.dataset,Ue.data.name)+1;e.dataset.splice(r,0,a),at(e)}He(0,0,0,0),d3.selectAll(".line_drag_selection").attr("stroke","black"),Ue=void 0}function n(t){d3.event.sourceEvent.stopPropagation();var a=d3.event.dx,n=d3.event.dy,r=parseFloat(d3.select(this).attr("x2"))+a,i=parseFloat(d3.select(this).attr("y2"))+n;He(e.symbol_size-10,0,r,i)}d3.select(".diagram").append("line").attr("class","line_drag_selection").attr("stroke-width",6).style("stroke-dasharray","2, 1").attr("stroke","black").call(d3.drag().on("start",t).on("drag",n).on("end",a)).append("svg:title").text("drag to create consanguineous partners"),He(0,0,0,0)}(e),t.append("rect").filter((function(t){return!(t.data.hidden&&!e.DEBUG)})).attr("class","indi_rect").attr("rx",6).attr("ry",6).attr("x",(function(t){return-.75*e.symbol_size})).attr("y",(function(t){return-e.symbol_size})).attr("width",1.5*e.symbol_size+"px").attr("height",2*e.symbol_size+"px").style("stroke","black").style("stroke-width",.7).style("opacity",0).attr("fill","lightgrey");var s=function(t){return l-.75*e.symbol_size},d=e.symbol_size-2,l=0,c={addchild:{text:"",title:"add child",fx:s,fy:d},addsibling:{text:"",title:"add sibling",fx:s,fy:d},addpartner:{text:"",title:"add partner",fx:s,fy:d},addparents:{text:"",title:"add parents",fx:-.75*e.symbol_size,fy:11-e.symbol_size},delete:{text:"X",title:"delete",fx:e.symbol_size/2-1,fy:12-e.symbol_size,styles:{"font-weight":"bold",fill:"darkred","font-family":"monospace"}}};e.edit&&(c.settings={text:"",title:"settings",fx:-a/2+2,fy:11-e.symbol_size});var u=function(a){var n=t.append("text").filter((function(t){return!(t.data.hidden&&!e.DEBUG||(void 0===t.data.mother||t.data.noparents)&&"addsibling"===a||void 0!==t.data.parent_node&&t.data.parent_node.length>1&&"addpartner"===a||void 0===t.data.parent_node&&"addchild"===a||void 0===t.data.noparents&&void 0===t.data.top_level&&"addparents"===a)})).attr("class",a).style("opacity",0).attr("font-family","FontAwesome").attr("xx",(function(e){return e.x})).attr("yy",(function(e){return e.y})).attr("x",c[a].fx).attr("y",c[a].fy).attr("font-size","0.9em").text(c[a].text);if("styles"in c[a])for(var r in c[a].styles)n.attr(r,c[a].styles[r]);n.append("svg:title").text(c[a].title),l+=17};for(var h in c)u(h);d3.selectAll(".addsibling, .addchild").on("mouseover",(function(){var e=d3.select(this).attr("class");d3.selectAll(".popup_selection").style("opacity",1),o={node:d3.select(this.parentNode),type:e};var t=parseInt(d3.select(this).attr("xx"))+parseInt(d3.select(this).attr("x")),n=parseInt(d3.select(this).attr("yy"))+parseInt(d3.select(this).attr("y"));d3.selectAll(".popup_selection").attr("transform","translate("+t+","+(n+2)+")"),d3.selectAll(".popup_selection_rotate45").attr("transform","translate("+(t+3*a)+","+(n+1.2*a)+") rotate(45)")})),d3.selectAll(".addchild, .addpartner, .addparents, .delete, .settings").on("click",(function(){d3.event.stopPropagation();var t,a=d3.select(this).attr("class"),n=d3.select(this.parentNode).datum();e.DEBUG&&console.log(a),"settings"===a?"function"==typeof e.edit?e.edit(e,n):function(e,t){$("#node_properties").dialog({autoOpen:!1,title:t.data.display_name,width:$(window).width()>400?450:$(window).width()-30});var a="<table id='person_details' class='table'>";a+="<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value="+(t.data.name?t.data.name:"")+"></td></tr>",a+="<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value="+(t.data.display_name?t.data.display_name:"")+"></td></tr>",a+="<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value="+(t.data.age?t.data.age:"")+"></td></tr>",a+="<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value="+(t.data.yob?t.data.yob:"")+"></td></tr>",a+='<tr><td colspan="2" id="id_sex"><label class="radio-inline"><input type="radio" name="sex" value="M" '+("M"===t.data.sex?"checked":"")+'>Male</label><label class="radio-inline"><input type="radio" name="sex" value="F" '+("F"===t.data.sex?"checked":"")+'>Female</label><label class="radio-inline"><input type="radio" name="sex" value="U">Unknown</label></td></tr>',a+='<tr><td colspan="2" id="id_status"><label class="checkbox-inline"><input type="radio" name="status" value="0" '+(0===parseInt(t.data.status)?"checked":"")+'>&thinsp;Alive</label><label class="checkbox-inline"><input type="radio" name="status" value="1" '+(1===parseInt(t.data.status)?"checked":"")+">&thinsp;Deceased</label></td></tr>",$("#id_status input[value='"+t.data.status+"']").prop("checked",!0);var n=["adopted_in","adopted_out","miscarriage","stillbirth","termination"];a+='<tr><td colspan="2"><strong>Reproduction:</strong></td></tr>',a+='<tr><td colspan="2">';for(var r=0;r<n.length;r++){var i=n[r];2===r&&(a+='</td></tr><tr><td colspan="2">'),a+='<label class="checkbox-inline"><input type="checkbox" id="id_'+i+'" name="'+i+'" value="0" '+(t.data[i]?"checked":"")+">&thinsp;"+Ye(i.replace("_"," "))+"</label>"}a+="</td></tr>";var o=["children","name","parent_node","top_level","id","noparents","level","age","sex","status","display_name","mother","father","yob","mztwin","dztwin"];$.merge(o,n),a+='<tr><td colspan="2"><strong>Age of Diagnosis:</strong></td></tr>',$.each(e.diseases,(function(n,r){o.push(r.type+"_diagnosis_age");var i='&thinsp;<span style="padding-left:5px;background:'+e.diseases[n].colour+'"></span>',s=t.data[r.type+"_diagnosis_age"];a+="<tr><td style='text-align:right'>"+Ye(r.type.replace("_"," "))+i+"&nbsp;</td><td><input class='form-control' id='id_"+r.type+"_diagnosis_age_0' max='110' min='0' name='"+r.type+"_diagnosis_age_0' style='width:5em' type='number' value='"+(void 0!==s?s:"")+"'></td></tr>"})),a+='<tr><td colspan="2" style="line-height:1px;"></td></tr>',$.each(t.data,(function(e,t){if(-1==$.inArray(e,o)){var n=Ye(e);!0===t||!1===t?a+="<tr><td style='text-align:right'>"+n+"&nbsp;</td><td><input type='checkbox' id='id_"+e+"' name='"+e+"' value="+t+" "+(t?"checked":"")+"></td></tr>":e.length>0&&(a+="<tr><td style='text-align:right'>"+n+"&nbsp;</td><td><input type='text' id='id_"+e+"' name='"+e+"' value="+t+"></td></tr>")}})),a+="</table>",$("#node_properties").html(a),$("#node_properties").dialog("open"),$("#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]").change((function(){Ce(e)}))}(e,n):"delete"===a?ct(t=A(g(e)),n.data,e,je):"addparents"===a?(t=A(g(e)),e.dataset=t,st(e,t,n.data.name),at(e)):"addpartner"===a&&(t=A(g(e)),dt(e,t,n.data.name),e.dataset=t,at(e)),$(document).trigger("fhChange",[e])}));var f=[];t.filter((function(e){return!e.data.hidden})).on("click",(function(t){d3.event.ctrlKey?-1==f.indexOf(t)?f.push(t):f.splice(f.indexOf(t),1):f=[t],"nodeclick"in e&&(e.nodeclick(t.data),d3.selectAll(".indi_rect").style("opacity",0),d3.selectAll(".indi_rect").filter((function(e){return-1!=f.indexOf(e)})).style("opacity",.5))})).on("mouseover",(function(t){d3.event.stopPropagation(),Be=t,Ue?Ue.data.name!==Be.data.name&&Ue.data.sex!==Be.data.sex&&d3.select(this).select("rect").style("opacity",.2):(d3.select(this).select("rect").style("opacity",.2),d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").style("opacity",1),d3.select(this).selectAll(".indi_details").style("opacity",0),He(e.symbol_size-10,0,e.symbol_size-2,0,t.x+","+(t.y+2)))})).on("mouseout",(function(t){if(!Ue){d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").style("opacity",0),-1==f.indexOf(t)&&d3.select(this).select("rect").style("opacity",0),d3.select(this).selectAll(".indi_details").style("opacity",1);var a=d3.mouse(this)[0],n=d3.mouse(this)[1];n<.8*e.symbol_size&&d3.selectAll(".popup_selection").style("opacity",0),Ue||(Math.abs(n)>.25*e.symbol_size||Math.abs(n)<-.25*e.symbol_size||a<.2*e.symbol_size)&&He(0,0,0,0)}}))}function je(e,t){e.dataset=t,at(e)}function He(e,t,a,n,r){r&&d3.selectAll(".line_drag_selection").attr("transform","translate("+r+")"),d3.selectAll(".line_drag_selection").attr("x1",e).attr("y1",t).attr("x2",a).attr("y2",n)}function Ye(e){return e.charAt(0).toUpperCase()+e.slice(1)}var Je={};function We(e){var t=$.extend({targetDiv:"pedigree_edit",dataset:[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},{name:"ch1",display_name:"me",sex:"F",mother:"f21",father:"m21",proband:!0}],width:600,height:400,symbol_size:35,zoomIn:1,zoomOut:1,diseases:[{type:"breast_cancer",colour:"#F68F35"},{type:"breast_cancer2",colour:"pink"},{type:"ovarian_cancer",colour:"#4DAA4D"},{type:"pancreatic_cancer",colour:"#4289BA"},{type:"prostate_cancer",colour:"#D5494A"}],labels:["stillbirth","age","yob","alleles"],keep_proband_on_reset:!1,font_size:".75em",font_family:"Helvetica",font_weight:700,background:"#EEE",node_background:"#fdfdfd",validate:!0,DEBUG:!1},e);0===$("#fullscreen").length&&(re(t),_e(t)),-1==m(t)&&p(t),function(e){var t=h(e),a=m(e),n="#"+e.btn_target;a<=t?$(n+" .fa-repeat").addClass("disabled"):$(n+" .fa-repeat").removeClass("disabled"),t>1?$(n+" .fa-undo").removeClass("disabled"):$(n+" .fa-undo").addClass("disabled")}(t),Ve(t),t.dataset=function(e){for(var t=0;t<e.length;t++)2==H(e,e[t].name)&&(e[t].top_level=!0);for(var a=[],n=[],r=0;r<e.length;r++){var i=e[r];if("top_level"in i&&-1==$.inArray(i.name,n)){n.push(i.name),a.push(i);for(var o=C(e,i),s=0;s<o.length;s++)-1==$.inArray(o[s],n)&&(n.push(o[s]),a.push(Q(e,o[s])))}}for(var d=$.map(e,(function(e,t){return"top_level"in e&&e.top_level?null:e})),l=a.length;l>0;--l)d.unshift(a[l-1]);return d}(t.dataset),t.DEBUG&&ae(t);var a=Qe(t),n=d3.select("#"+t.targetDiv).append("svg:svg").attr("width",a.width).attr("height",a.height);n.append("rect").attr("width","100%").attr("height","100%").attr("rx",6).attr("ry",6).style("stroke","darkgrey").style("fill",t.background).style("stroke-width",1);var r=x(t),i=r[0],o=r[1],s=1;3==r.length&&(s=r[2]),null!==i&&null!==o||(i=t.symbol_size/2,o=2.5*-t.symbol_size);var d=n.append("g").attr("class","diagram").attr("transform","translate("+i+","+o+") scale("+s+")"),l={name:"hidden_root",id:0,hidden:!0,children:$.map(t.dataset,(function(e,t){return"top_level"in e&&e.top_level?e:null}))},c=S(t,l,l)[0],u=d3.hierarchy(l);Je[t.targetDiv]=u;var f=et(t);t.DEBUG&&console.log("opts.width="+a.width+" width="+f.width+" opts.height="+a.height+" height="+f.height);var g=d3.tree().separation((function(e,t){return e.parent===t.parent||e.data.hidden||t.data.hidden?1.2:2.2})).size([f.width,f.height])(u.sort((function(e,t){return e.data.id-t.data.id}))),_=g.descendants();if($.map(t.dataset,(function(e,t){return e.hidden?null:e})).length!=t.dataset.length)throw qe("NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET");K(t,g,_);var v=W(_,c);!function(e,t){for(var a=0;a<t.length;a++){var n=Ze(e,t[a]);n&&console.log("CLASH :: "+t[a].mother.data.name+" "+t[a].father.data.name,n)}}(t,v);var y=d.selectAll(".node").data(g.descendants()).enter().append("g").attr("transform",(function(e,t){return"translate("+e.x+","+e.y+")"}));y.append("path").filter((function(e){return!e.data.hidden})).attr("shape-rendering","geometricPrecision").attr("transform",(function(e){return"U"!=e.data.sex||e.data.miscarriage||e.data.termination?"":"rotate(45)"})).attr("d",d3.symbol().size((function(e){return t.symbol_size*t.symbol_size+2})).type((function(e){return e.data.miscarriage||e.data.termination?d3.symbolTriangle:"F"==e.data.sex?d3.symbolCircle:d3.symbolSquare}))).style("stroke",(function(e){return e.data.age&&e.data.yob&&!e.data.exclude?"#303030":"grey"})).style("stroke-width",(function(e){return e.data.age&&e.data.yob&&!e.data.exclude?".3em":".1em"})).style("stroke-dasharray",(function(e){return e.data.exclude?"3, 3":null})).style("fill","none"),y.append("clipPath").attr("id",(function(e){return e.data.name})).append("path").filter((function(e){return!(e.data.hidden&&!t.DEBUG)})).attr("class","node").attr("transform",(function(e){return"U"!=e.data.sex||e.data.miscarriage||e.data.termination?"":"rotate(45)"})).attr("d",d3.symbol().size((function(e){return e.data.hidden?t.symbol_size*t.symbol_size/5:t.symbol_size*t.symbol_size})).type((function(e){return e.data.miscarriage||e.data.termination?d3.symbolTriangle:"F"==e.data.sex?d3.symbolCircle:d3.symbolSquare}))),y.selectAll("pienode").data((function(e){var a=0,n=$.map(t.diseases,(function(n,r){return Ke(t.diseases[r].type,e.data)?(a++,1):0}));return 0===a&&(n=[1]),[$.map(n,(function(t,n){return{cancer:t,ncancers:a,id:e.data.name,sex:e.data.sex,proband:e.data.proband,hidden:e.data.hidden,affected:e.data.affected,exclude:e.data.exclude}}))]})).enter().append("g").selectAll("path").data(d3.pie().value((function(e){return e.cancer}))).enter().append("path").attr("clip-path",(function(e){return"url(#"+e.data.id+")"})).attr("class","pienode").attr("d",d3.arc().innerRadius(0).outerRadius(t.symbol_size)).style("fill",(function(e,a){return e.data.exclude?"lightgrey":0===e.data.ncancers?e.data.affected?"darkgrey":t.node_background:t.diseases[a].colour})),y.append("path").filter((function(e){return!e.data.hidden&&(e.data.adopted_in||e.data.adopted_out)})).attr("d",(function(e){var a=-.66*t.symbol_size,n=-.64*t.symbol_size,r=t.symbol_size/4;return Xe(a,n,r,t)+Xe(-a,n,-r,t)})).style("stroke",(function(e){return e.data.age&&e.data.yob&&!e.data.exclude?"#303030":"grey"})).style("stroke-width",(function(e){return".1em"})).style("stroke-dasharray",(function(e){return e.data.exclude?"3, 3":null})).style("fill","none"),y.append("line").filter((function(e){return 1==e.data.status})).style("stroke","black").attr("x1",(function(e,a){return-.6*t.symbol_size})).attr("y1",(function(e,a){return.6*t.symbol_size})).attr("x2",(function(e,a){return.6*t.symbol_size})).attr("y2",(function(e,a){return-.6*t.symbol_size})),tt(t,y,".25em",-.4*t.symbol_size,-.1*t.symbol_size,(function(e){return t.DEBUG?("display_name"in e.data?e.data.display_name:e.data.name)+"  "+e.data.id:"display_name"in e.data?e.data.display_name:""}));for(var w=parseInt(function(e){var t=e.font_size;if(t===parseInt(t,10))return t;if(t.indexOf("px")>-1)return t.replace("px","");if(-1===t.indexOf("em"))return t;return t=parseFloat(t.replace("em","")),parseFloat(getComputedStyle($("#"+e.targetDiv).get(0)).fontSize)*t-1}(t))+4,k=function(e){var a=t.labels[e];tt(t,y,".25em",-.7*t.symbol_size,(function(t){if(t.data[a])return t.y_offset=0!==e&&t.y_offset?t.y_offset+w:2.25*w,t.y_offset}),(function(e){if(e.data[a]){if("alleles"===a){for(var t="",n=e.data.alleles.split(";"),r=0;r<n.length;r++)""!==n[r]&&(t+=n[r]+";");return t}return"age"===a?e.data[a]+"y":"stillbirth"===a?"SB":e.data[a]}}),"indi_details")},A=0;A<t.labels.length;A++)k(A);for(var O=function(e){var a=t.diseases[e].type;tt(t,y,".25em",-t.symbol_size,(function(e){for(var n=e.y_offset?e.y_offset+w:2.2*w,r=0;r<t.diseases.length&&a!==t.diseases[r].type;r++)Ke(t.diseases[r].type,e.data)&&(n+=w-1);return n}),(function(e){var t=a.replace("_"," ").replace("cancer","ca.");return a+"_diagnosis_age"in e.data?t+": "+e.data[a+"_diagnosis_age"]:""}),"indi_details")},I=0;I<t.diseases.length;I++)O(I);Ge(t,y);var F={},D=function(e,t,a,n,r,i){for(var o=function e(t,a){return t+1<a?e(++t):t},s="",d=0;d<e.length;d++){var l=o(d,e.length),c=e[d]-t-i,u=e[l]+t+i;r.x>c&&r.x<u&&(r.y=n),s+="L"+c+","+(a-i)+"L"+c+","+(n-i)+"L"+u+","+(n-i)+"L"+u+","+(a-i),d=l}return s};c=d.selectAll(".partner").data(v).enter().insert("path","g").attr("fill","none").attr("stroke","#000").attr("shape-rendering","auto").attr("d",(function(e,a){var n,r,i,o=V(Q(_,e.mother.data.name),Q(_,e.father.data.name),t),s=e.mother.data.divorced&&e.mother.data.divorced===e.father.data.name,d=e.mother.x<e.father.x?e.mother.x:e.father.x,l=e.mother.x<e.father.x?e.father.x:e.mother.x,c=e.mother.y,u=Ze(t,e),h="";if(u){e.mother.depth in F?F[e.mother.depth]+=4:F[e.mother.depth]=4,c-=F[e.mother.depth],r=F[e.mother.depth]+t.symbol_size/2+2;for(var f=e.mother.data.parent_node,p=f[0],m=0;m<f.length;m++)f[m].father.name===e.father.data.name&&f[m].mother.name===e.mother.data.name&&(p=f[m].name);(i=Q(_,p)).y=c,u.sort((function(e,t){return e-t})),n=c-t.symbol_size/2-3,h=D(u,r,c,n,i,0)}var g="";if(s&&!u&&(g="M"+(d+.66*(l-d)+6)+","+(c-6)+"L"+(d+.66*(l-d)-6)+","+(c+6)+"M"+(d+.66*(l-d)+10)+","+(c-6)+"L"+(d+.66*(l-d)-2)+","+(c+6)),o){c=e.mother.x<e.father.x?e.mother.y:e.father.y,n=e.mother.x<e.father.x?e.father.y:e.mother.y;return Math.abs(c-n)>.1?"M"+d+","+c+"L"+l+","+n+"M"+d+","+(c-3)+"L"+l+","+(n-3):"M"+d+","+c+h+"L"+l+","+c+"M"+d+","+(c-3)+(u?D(u,r,c,n,i,3):"")+"L"+l+","+(c-3)+g}return"M"+d+","+c+h+"L"+l+","+c+g})),d.selectAll(".link").data(u.links(g.descendants())).enter().filter((function(e){return t.DEBUG||void 0===e.target.data.noparents&&null!==e.source.parent&&!e.target.data.hidden})).insert("path","g").attr("fill","none").attr("stroke-width",(function(e,a){return void 0!==e.target.data.noparents||null===e.source.parent||e.target.data.hidden?1:t.DEBUG?2:1})).attr("stroke",(function(e,t){return void 0!==e.target.data.noparents||null===e.source.parent||e.target.data.hidden?"pink":"#000"})).attr("stroke-dasharray",(function(e,a){if(!e.target.data.adopted_in)return null;var n=Math.abs(e.source.y-(e.source.y+e.target.y)/2),r=[n,0,Math.abs(e.source.x-e.target.x),0];P(t.dataset,e.target.data).length>=1&&(n*=3);for(var i=0;i<n;i+=10)$.merge(r,[5,5]);return r})).attr("shape-rendering",(function(e,t){return e.target.data.mztwin||e.target.data.dztwin?"geometricPrecision":"auto"})).attr("d",(function(e,a){if(e.target.data.mztwin||e.target.data.dztwin){var n=P(t.dataset,e.target.data);if(n.length>=1){var r=0,i=e.target.x;e.target.x;for(var o=0;o<n.length;o++){var s=Q(_,n[o].name).x;i>s&&(i=s),r+=s}var d=(e.target.x+r)/(n.length+1),l=(e.source.y+e.target.y)/2,c="";if(i===e.target.x&&e.target.data.mztwin){var u=(d+e.target.x)/2,h=(l+(e.target.y-t.symbol_size/2))/2;c="M"+u+","+h+"L"+(d+(d-u))+" "+h}return"M"+e.source.x+","+e.source.y+"V"+l+"H"+d+"L"+e.target.x+" "+(e.target.y-t.symbol_size/2)+c}}if(e.source.data.mother){var f=Q(_,e.source.data.mother.name),p=Q(_,e.source.data.father.name);if(f.depth!==p.depth)return"M"+e.source.x+","+(f.y+p.y)/2+"H"+e.target.x+"V"+e.target.y}return"M"+e.source.x+","+e.source.y+"V"+(e.source.y+e.target.y)/2+"H"+e.target.x+"V"+e.target.y}));var N=L(t.dataset);if(void 0!==N){var M=Q(_,t.dataset[N].name),T="triangle"+E(3);d.append("svg:defs").append("svg:marker").attr("id",T).attr("refX",6).attr("refY",6).attr("markerWidth",20).attr("markerHeight",20).attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").style("fill","black"),d.append("line").attr("x1",M.x-t.symbol_size).attr("y1",M.y+t.symbol_size).attr("x2",M.x-t.symbol_size/2).attr("y2",M.y+t.symbol_size/2).attr("stroke-width",1).attr("stroke","black").attr("marker-end","url(#"+T+")")}return s=d3.zoom().scaleExtent([t.zoomIn,t.zoomOut]).on("zoom",(function(){var e=d3.event.transform;if(z()&&e.x.toString().length>10)return;var a=[e.x+parseInt(i),e.y+parseInt(o)];1==e.k?b(t,a[0],a[1]):b(t,a[0],a[1],e.k);d.attr("transform","translate("+a[0]+","+a[1]+") scale("+e.k+")")})),n.call(s),t}function qe(e){return console.error(e),new Error(e)}function Ve(e){if(e.validate){if("function"==typeof e.validate)return e.DEBUG&&console.log("CALLING CONFIGURED VALIDATION FUNCTION"),e.validate.call(this,e);for(var t,a=[],n=[],r=0;r<e.dataset.length;r++){if(!r.hidden&&(e.dataset[r].mother||e.dataset[r].father)){(t=e.dataset[r].display_name)||(t="unnamed"),t+=" (IndivID: "+e.dataset[r].name+")";var i=e.dataset[r].mother,o=e.dataset[r].father;if(!i||!o)throw qe("Missing parent for "+t);var s=Y(e.dataset,i),d=Y(e.dataset,o);if(-1===s)throw qe("The mother (IndivID: "+i+") of family member "+t+" is missing from the pedigree.");if(-1===d)throw qe("The father (IndivID: "+o+") of family member "+t+" is missing from the pedigree.");if("F"!==e.dataset[s].sex)throw qe("The mother of family member "+t+" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.");if("M"!==e.dataset[d].sex)throw qe("The father of family member "+t+" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.")}if(!e.dataset[r].name)throw qe(t+" has no IndivID.");if($.inArray(e.dataset[r].name,a)>-1)throw qe("IndivID for family member "+t+" is not unique.");a.push(e.dataset[r].name),-1===$.inArray(e.dataset[r].famid,n)&&e.dataset[r].famid&&n.push(e.dataset[r].famid)}if(n.length>1)throw qe("More than one family found: "+n.join(", ")+".");var l=T(e.dataset);l.length>0&&console.warn("individuals unconnected to pedigree ",l)}}function Xe(e,t,a,n){return"M"+(e+a)+","+t+"L"+e+" "+t+"L"+e+" "+(t+1.28*n.symbol_size)+"L"+e+" "+(t+1.28*n.symbol_size)+"L"+(e+a)+","+(t+1.28*n.symbol_size)}function Ke(e,t){var a=!1;return t&&$.each(t,(function(t,n){if(0===t.indexOf(e+"_")||t===e)return a=!0})),a}function Ze(e,t){var a,n,r=X(Je[e.targetDiv]);if("name"in t){if(!("mother"in(t=Q(r,t.name)).data))return null;a=Q(r,t.data.mother),n=Q(r,t.data.father)}else a=t.mother,n=t.father;var i=a.x<n.x?a.x:n.x,o=a.x<n.x?n.x:a.x,s=a.y,d=$.map(r,(function(e,t){return!e.data.hidden&&e.data.name!==a.data.name&&e.data.name!==n.data.name&&e.y==s&&e.x>i&&e.x<o?e.x:null}));return d.length>0?d:null}function Qe(e){return{width:ie()?window.innerWidth:e.width,height:ie()?window.innerHeight:e.height}}function et(e){for(var t=Qe(e),a=0,n={},r=0;r<e.dataset.length;r++){var i=H(e.dataset,e.dataset[r].name),o=j(e.dataset,e.dataset[r]),s=1+(o.length>0?.55+.25*o.length:0)+(e.dataset[r].father?.25:0);i in n?n[i]+=s:n[i]=s,n[i]>a&&(a=n[i])}var d=Object.keys(n).length*e.symbol_size*3.5;return{width:t.width-e.symbol_size>a*e.symbol_size*1.65?t.width-e.symbol_size:a*e.symbol_size*1.65,height:t.height-e.symbol_size>d?t.height-e.symbol_size:d}}function tt(e,t,a,n,r,i,o){t.filter((function(t){return!(t.data.hidden&&!e.DEBUG)})).append("text").attr("class",o+" ped_label"||"ped_label").attr("x",n).attr("y",r).attr("font-family",e.font_family).attr("font-size",e.font_size).attr("font-weight",e.font_weight).text(i)}function at(e){$("#"+e.targetDiv).empty(),p(e);try{We(e)}catch(e){throw console.error(e),e}try{templates.update(e)}catch(e){}}function nt(e,a,n,r,i){if(i&&-1===$.inArray(i,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+i);"undefined"===t(r)&&(r=1);var o,s,d,l=j(e,a);if(0===l.length){var c=rt(e,a,"F"===a.sex?"M":"F","F"===a.sex);c.noparents=!0,o=c.name,s=Y(e,a.name)+1}else{var u=l[0];o=u.father===a.name?u.mother:u.father,s=Y(e,u.name)}i&&(d=it(e,i));for(var h=[],f=0;f<r;f++){var p={name:E(4),sex:n,mother:"F"===a.sex?a.name:o,father:"F"===a.sex?o:a.name};e.splice(s,0,p),i&&(p[i]=d),h.push(p)}return h}function rt(e,t,a,n,r){if(r&&-1===$.inArray(r,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+r);var i={name:E(4),sex:a};t.top_level?i.top_level=!0:(i.mother=t.mother,i.father=t.father);var o=Y(e,t.name);return r&&function(e,t,a,n){if(!t[n]&&(t[n]=it(e,n),!t[n]))return!1;a[n]=t[n],t.yob&&(a.yob=t.yob);!t.age||0!=t.status&&t.status||(a.age=t.age)}(e,e[o],i,r),n?o>0&&o--:o++,e.splice(o,0,i),i}function it(e,t){for(var a=[1,2,3,4,5,6,7,8,9,"A"],n=0;n<e.length;n++)if(e[n][t]){var r=a.indexOf(e[n][t]);r>-1&&a.splice(r,1)}if(a.length>0)return a[0]}function ot(e,t){if(t.mztwin||t.dztwin)for(var a=t.mztwin?"mztwin":"dztwin",n=0;n<e.length;n++){var r=e[n];r[a]&&t[a]==r[a]&&r.name!==t.name&&("mztwin"===a&&(r.sex=t.sex),t.yob&&(r.yob=t.yob),!t.age||0!=t.status&&t.status||(r.age=t.age))}}function st(e,t,a){var n,r,i,o,s=X(Je[e.targetDiv]),d=Q(s,a),l=d.data,c=d.depth,u=-101,h=j(t,l);if(h.length>0&&(u=Q(s,i=h[0].mother==l.name?h[0].father:h[0].mother).data.id),1==c)for(n={name:E(4),sex:"F",top_level:!0},r={name:E(4),sex:"M",top_level:!0},t.splice(0,0,n),t.splice(0,0,r),o=0;o<t.length;o++)t[o].top_level&&t[o].name!==n.name&&t[o].name!==r.name&&(delete t[o].top_level,t[o].noparents=!0,t[o].mother=n.name,t[o].father=r.name);else{var f=Q(s,d.data.mother),p=Q(s,d.data.father),m=B(t,l),g=1e4,_=d.data.id;for(o=0;o<m.length;o++){var v=Q(s,m[o].name).data.id;v<g&&v>d.data.id&&(g=v),v<_&&(_=v)}var y=_>=d.data.id||u==_&&g<1e4;e.DEBUG&&console.log("lid="+_+" rid="+g+" nid="+d.data.id+" ADD_LHS="+y);var b=t[!y&&p.data.id>f.data.id||y&&p.data.id<f.data.id?Y(t,l.father):Y(t,l.mother)];r=rt(t,b,"M",y),n=rt(t,b,"F",y);var x=Y(t,r.name),$=Y(t,n.name);if(x>$){var w=t[x];t[x]=t[$],t[$]=w}var z=G(t,l),k=d.data.id;for(o=0;o<z.length;o++){var A=Q(s,z[o].name).data.id;if(e.DEBUG&&console.log("ORPHAN="+o+" "+z[o].name+" "+(k<A&&A<g)+" nid="+k+" oid="+A+" rid="+g),(y||k<A)&&A<g){var O=Y(t,z[o].name);t[O].mother=n.name,t[O].father=r.name}}}2==c?(n.top_level=!0,r.top_level=!0):c>2&&(n.noparents=!0,r.noparents=!0);var S=Y(t,l.name);if(t[S].mother=n.name,t[S].father=r.name,delete t[S].noparents,"parent_node"in l){var I=t[Y(t,i)];"noparents"in I&&(I.mother=n.name,I.father=r.name)}}function dt(e,t,a){var n=Q(X(Je[e.targetDiv]),a),r=rt(t,n.data,"F"===n.data.sex?"M":"F","F"===n.data.sex);r.noparents=!0;var i={name:E(4),sex:"M"};i.mother="F"===n.data.sex?n.data.name:r.name,i.father="F"===n.data.sex?r.name:n.data.name;var o=Y(t,n.data.name)+2;t.splice(o,0,i)}function lt(e,t,a){for(var n,r,i=J(X(e),t.depth,a),o=0;o<i.length;o++)i[o].x<t.x&&(n=i[o]),!r&&i[o].x>t.x&&(r=i[o]);return[n,r]}function ct(e,t,a,n){var r,i,o,s=Je[a.targetDiv],d=X(s),l=[];if(void 0===t.id){var c=Q(d,t.name);void 0!==c&&(t=c.data)}if(t.parent_node)for(r=0;r<t.parent_node.length;r++){var u=t.parent_node[r],h=[Q(e,u.mother.name),Q(e,u.father.name)];for(i=0;i<h.length;i++)(h[i].name===t.name||void 0!==h[i].noparents||h[i].top_level)&&(e.splice(Y(e,h[i].name),1),l.push(h[i]));var f=u.children,p=$.map(f,(function(e,t){return e.name}));for(i=0;i<f.length;i++){var m=Q(e,f[i].name);if(m){m.noparents=!0;var g=C(e,m),_=void 0;if(g.length>0&&(_=Q(e,g[0])),_&&_.mother!==m.mother)m.mother=_.mother,m.father=_.father;else if(_){var v=lt(s,Q(d,m.name),p);m.mother=v[0]?v[0].data.mother:v[1]?v[1].data.mother:null,m.father=v[0]?v[0].data.father:v[1]?v[1].data.father:null}else e.splice(Y(e,m.name),1)}}}else e.splice(Y(e,t.name),1);for(console.log(l),r=0;r<l.length;r++){var y=l[r],b=B(e,y);if(console.log("DEL",y.name,b),b.length<1){console.log("del sibs",y.name,b);var x=Q(d,y.name).ancestors();for(i=0;i<x.length;i++)console.log(x[r]),x[i].data.mother&&(console.log("DELETE ",x[i].data.mother,x[i].data.father),e.splice(Y(e,x[i].data.mother.name),1),e.splice(Y(e,x[i].data.father.name),1))}}!function(e){for(var t=["mztwin","dztwin"],a=0;a<e.length;a++)for(var n=0;n<t.length;n++){var r=t[n];if(e[a][r]){for(var i=0,o=0;o<e.length;o++)e[o][r]==e[a][r]&&i++;i<2&&delete e[a][[r]]}}}(e);try{var w=$.extend({},a);w.dataset=A(e),Ve(w),o=T(e)}catch(e){throw O("Warning","Deletion of this pedigree member is disallowed."),e}return o.length>0&&0===T(a.dataset).length?(console.error("individuals unconnected to pedigree ",o),void O("Warning","Deleting this will split the pedigree. Continue?",n,a,e)):(n&&n(a,e),e)}var ut=Object.freeze({__proto__:null,roots:Je,build:We,validate_pedigree:Ve,check_ptr_link_clashes:Ze,get_tree_dimensions:et,rebuild:at,addchild:nt,addsibling:rt,syncTwins:ot,addparents:st,addpartner:dt,delete_node_dataset:ct});return e.canrisk_file=ge,e.io=De,e.pedcache=w,e.pedigree_form=Pe,e.pedigree_utils=ne,e.pedigreejs=ut,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=pedigreejs.v2.0.0-rc1.min.js.map
