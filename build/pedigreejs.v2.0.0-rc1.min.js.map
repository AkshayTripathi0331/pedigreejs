{"version":3,"file":"pedigreejs.v2.0.0-rc1.min.js","sources":["../es/pedcache.js","../es/pedigree_utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/pedigree_form.js","../es/widgets.js","../es/pedigree.js"],"sourcesContent":["//store a history of pedigree\n\nlet max_limit = 25;\nlet dict_cache = {};\n\n// test if browser storage is supported\nfunction has_browser_storage(opts) {\n\ttry {\n\t\tif(opts.store_type === 'array')\n\t\t\treturn false;\n\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\n\t\t\treturn false;\n\n\t\tlet mod = 'test';\n\t\tlocalStorage.setItem(mod, mod);\n\t\tlocalStorage.removeItem(mod);\n\t\treturn true;\n\t} catch(e) {\n\t\treturn false;\n\t}\n}\n\nfunction get_prefix(opts) {\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\n}\n\n// use dict_cache to store cache as an array\nfunction get_arr(opts) {\n\treturn dict_cache[get_prefix(opts)];\n}\n\nfunction get_browser_store(opts, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.getItem(item);\n\telse\n\t\treturn sessionStorage.getItem(item);\n}\n\nfunction set_browser_store(opts, name, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.setItem(name, item);\n\telse\n\t\treturn sessionStorage.setItem(name, item);\n}\n\n// clear all storage items\nfunction clear_browser_store(opts) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.clear();\n\telse\n\t\treturn sessionStorage.clear();\n}\n\n// remove all storage items with keys that have the pedigree history prefix\nexport function clear_pedigree_data(opts) {\n\tlet prefix = get_prefix(opts);\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\tlet items = [];\n\tfor(let i = 0; i < store.length; i++){\n\t\tif(store.key(i).indexOf(prefix) == 0)\n\t\t\titems.push(store.key(i));\n\t}\n\tfor(let i = 0; i < items.length; i++)\n\t\tstore.removeItem(items[i]);\n}\n\nexport function get_count(opts) {\n\tlet count;\n\tif (has_browser_storage(opts))\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\n\telse\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\n\tif(count !== null && count !== undefined)\n\t\treturn count;\n\treturn 0;\n}\n\nfunction set_count(opts, count) {\n\tif (has_browser_storage(opts))\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\n\telse\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\n}\n\nexport function init_cache(opts) {\n\tif(!opts.dataset)\n\t\treturn;\n\tlet count = get_count(opts);\n\tif (has_browser_storage(opts)) {   // local storage\n\t\tset_browser_store(opts, get_prefix(opts)+count, JSON.stringify(opts.dataset));\n\t} else {   // TODO :: array cache\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\n\t\tmax_limit = 500;\n\t\tif(get_arr(opts) === undefined)\n\t\t\tdict_cache[get_prefix(opts)] = [];\n\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\n\t}\n\tif(count < max_limit)\n\t\tcount++;\n\telse\n\t\tcount = 0;\n\tset_count(opts, count);\n}\n\nexport function nstore(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\n\t\t\t\treturn i;\n\t\t}\n\t} else {\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\n\t}\n\treturn -1;\n}\n\nexport function current(opts) {\n\tlet current = get_count(opts)-1;\n\tif(current == -1)\n\t\tcurrent = max_limit;\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\n\telse if(get_arr(opts))\n\t\treturn JSON.parse(get_arr(opts)[current]);\n}\n\nexport function last(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\n\t\t\tif(it !== null) {\n\t\t\t\tset_count(opts, i);\n\t\t\t\treturn JSON.parse(it);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet arr = get_arr(opts);\n\t\tif(arr)\n\t\t\treturn JSON.parse(arr(arr.length-1));\n\t}\n\treturn undefined;\n}\n\nexport function previous(opts, previous) {\n\tif(previous === undefined)\n\t\tprevious = get_count(opts) - 2;\n\n\tif(previous < 0) {\n\t\tlet nstore = nstore(opts);\n\t\tif(nstore < max_limit)\n\t\t\tprevious = nstore - 1;\n\t\telse\n\t\t\tprevious = max_limit - 1;\n\t}\n\tset_count(opts, previous + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[previous]);\n}\n\nexport function next(opts, next) {\n\tif(next === undefined)\n\t\tnext = get_count(opts);\n\tif(next >= max_limit)\n\t\tnext = 0;\n\n\tset_count(opts, parseInt(next) + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[next]);\n}\n\nexport function clear(opts) {\n\tif(has_browser_storage(opts))\n\t\tclear_browser_store(opts);\n\tdict_cache = {};\n}\n\n// zoom - store translation coords\nexport function setposition(opts, x, y, zoom) {\n\tif(has_browser_storage(opts)) {\n\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\n\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\n\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\n\t\tif(zoom)\n\t\t\tset_browser_store(opts, zoomName, zoom);\n\t\telse\n\t\t\t((opts.store_type === 'local' ? localStorage.removeItem(zoomName) : sessionStorage.removeItem(zoomName)));\n\t} else {\n\t\t//TODO\n\t}\n}\n\nexport function getposition(opts) {\n\tif(!has_browser_storage(opts) ||\n\t\t(localStorage.getItem(get_prefix(opts)+'_X') === null &&\n\t\t sessionStorage.getItem(get_prefix(opts)+'_X') === null))\n\t\treturn [null, null];\n\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\n\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\n\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\n\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\n\treturn pos;\n}\n","// Pedigree Tree Utils\n\nimport {syncTwins, rebuild, addchild, delete_node_dataset} from './pedigree.js';\nimport * as pedcache from './pedcache.js';\n\nexport function isIE() {\n\t let ua = navigator.userAgent;\n\t /* MSIE used to detect old browsers and Trident used to newer ones*/\n\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\n}\n\nexport function isEdge() {\n\t return navigator.userAgent.match(/Edge/g);\n}\n\nexport function copy_dataset(dataset) {\n\tif(dataset[0].id) { // sort by id\n\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\n\t}\n\n\tlet disallowed = [\"id\", \"parent_node\"];\n\tlet newdataset = [];\n\tfor(let i=0; i<dataset.length; i++){\n\t\tlet obj = {};\n\t\tfor(let key in dataset[i]) {\n\t\t\tif(disallowed.indexOf(key) == -1)\n\t\t\t\tobj[key] = dataset[i][key];\n\t\t}\n\t\tnewdataset.push(obj);\n\t}\n\treturn newdataset;\n}\n\n/**\n *  Get formatted time or data & time\n */\nexport function getFormattedDate(time){\n\tlet d = new Date();\n\tif(time)\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n\telse\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n }\n\n/**\n * Show message or confirmation dialog.\n * @param title\t - dialog window title\n * @param msg\t   - message to diasplay\n * @param onConfirm - function to call in a confirmation dialog\n * @param opts\t  - pedigreejs options\n * @param dataset\t- pedigree dataset\n */\nexport function messages(title, msg, onConfirm, opts, dataset) {\n\tif(onConfirm) {\n\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\tmodal: true,\n\t\t\t\ttitle: title,\n\t\t\t\twidth: 350,\n\t\t\t\tbuttons: {\n\t\t\t\t\t\"Yes\": function () {\n\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\tonConfirm(opts, dataset);\n\t\t\t\t\t},\n\t\t\t\t\t\"No\": function () {\n\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t} else {\n\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\ttitle: title,\n\t\t\twidth: 350,\n\t\t\tbuttons: [{\n\t\t\t\ttext: \"OK\",\n\t\t\t\tclick: function() { $( this ).dialog( \"close\" );}\n\t\t\t}]\n\t\t});\n\t}\n}\n\n/**\n * Validate age and yob is consistent with current year. The sum of age and\n * yob should not be greater than or equal to current year. If alive the\n * absolute difference between the sum of age and year of birth and the\n * current year should be <= 1.\n * @param age\t- age in years.\n * @param yob\t- year of birth.\n * @param status - 0 = alive, 1 = dead.\n * @return true if age and yob are consistent with current year otherwise false.\n */\nexport function validate_age_yob(age, yob, status) {\n\tlet year = new Date().getFullYear();\n\tlet sum = parseInt(age) + parseInt(yob);\n\tif(status == 1) {   // deceased\n\t\treturn year >= sum;\n\t}\n\treturn Math.abs(year - sum) <= 1 && year >= sum;\n}\n\nexport function capitaliseFirstLetter(string) {\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n\nexport function makeid(len) {\n\tlet text = \"\";\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n\tfor( let i=0; i < len; i++ )\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\n\treturn text;\n}\n\nexport function buildTree(opts, person, root, partnerLinks, id) {\n\tif (typeof person.children === typeof undefined)\n\t\tperson.children = getChildren(opts.dataset, person);\n\n\tif (typeof partnerLinks === typeof undefined) {\n\t\tpartnerLinks = [];\n\t\tid = 1;\n\t}\n\n\tlet nodes = flatten(root);\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\n\tlet partners = [];\n\t$.each(person.children, function(_i, child) {\n\t\t$.each(opts.dataset, function(_j, p) {\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\n\t\t\t\tm = (m !== undefined? m : getNodeByName(opts.dataset, p.mother));\n\t\t\t\tf = (f !== undefined? f : getNodeByName(opts.dataset, p.father));\n\t\t\t\tif(!contains_parent(partners, m, f))\n\t\t\t\t\tpartners.push({'mother': m, 'father': f});\n\t\t\t}\n\t\t});\n\t});\n\t$.merge(partnerLinks, partners);\n\n\t$.each(partners, function(_i, ptr) {\n\t\tlet mother = ptr.mother;\n\t\tlet father = ptr.father;\n\t\tmother.children = [];\n\t\tlet parent = {\n\t\t\t\tname : makeid(4),\n\t\t\t\thidden : true,\n\t\t\t\tparent : null,\n\t\t\t\tfather : father,\n\t\t\t\tmother : mother,\n\t\t\t\tchildren : getChildren(opts.dataset, mother, father)\n\t\t};\n\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\n\t\tif(!('id' in father) && !('id' in mother))\n\t\t\tid = setChildrenId(person.children, id);\n\n\t\t// look at grandparents index\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\n\t\tif(gp.fidx < gp.midx) {\n\t\t\tfather.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tmother.id = id++;\n\t\t} else {\n\t\t\tmother.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tfather.id = id++;\n\t\t}\n\t\tid = updateParent(mother, parent, id, nodes, opts);\n\t\tid = updateParent(father, parent, id, nodes, opts);\n\t\tperson.children.push(parent);\n\t});\n\tid = setChildrenId(person.children, id);\n\n\t$.each(person.children, function(_i, p) {\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\n\t});\n\treturn [partnerLinks, id];\n}\n\n// update parent node and sort twins\nfunction updateParent(p, parent, id, nodes, opts) {\n\t// add to parent node\n\tif('parent_node' in p)\n\t\tp.parent_node.push(parent);\n\telse\n\t\tp.parent_node = [parent];\n\n\t// check twins lie next to each other\n\tif(p.mztwin || p.dztwins) {\n\t\tlet twins = getTwins(opts.dataset, p);\n\t\tfor(let i=0; i<twins.length; i++) {\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\n\t\t\tif(twin)\n\t\t\t\ttwin.id = id++;\n\t\t}\n\t}\n\treturn id;\n}\n\nfunction setChildrenId(children, id) {\n\t// sort twins to lie next to each other\n\tchildren.sort(function(a, b) {\n\t\tif(a.mztwin && b.mztwin && a.mztwin == b.mztwin)\n\t\t\treturn 0;\n\t\telse if(a.dztwin && b.dztwin && a.dztwin == b.dztwin)\n\t\t\treturn 0;\n\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\n\t\t\treturn 1;\n\t\treturn 0;\n\t});\n\n\t$.each(children, function(_i, p) {\n\t\tif(p.id === undefined) p.id = id++;\n\t});\n\treturn id;\n}\n\nexport function isProband(obj) {\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n}\n\nexport function setProband(dataset, name, is_proband) {\n\t$.each(dataset, function(_i, p) {\n\t\tif (name === p.name)\n\t\t\tp.proband = is_proband;\n\t\telse\n\t\t\tdelete p.proband;\n\t});\n}\n\n//combine arrays ignoring duplicates\nfunction combineArrays(arr1, arr2) {\n\tfor(let i=0; i<arr2.length; i++)\n\t\tif($.inArray( arr2[i], arr1 ) == -1) arr1.push(arr2[i]);\n}\n\nfunction include_children(connected, p, dataset) {\n\tif($.inArray( p.name, connected ) == -1)\n\t\treturn;\n\tcombineArrays(connected, get_partners(dataset, p));\n\tlet children = getAllChildren(dataset, p);\n\t$.each(children, function( _child_idx, child ) {\n\t\tif($.inArray( child.name, connected ) == -1) {\n\t\t\tconnected.push(child.name);\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\n\t\t}\n\t});\n}\n\n//get the partners for a given node\nexport function get_partners(dataset, anode) {\n\tlet ptrs = [];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) == -1)\n\t\t\tptrs.push(bnode.father);\n\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) == -1)\n\t\t\tptrs.push(bnode.mother);\n\t}\n\treturn ptrs;\n}\n\n//return a list of individuals that aren't connected to the target\nexport function unconnected(dataset){\n\tlet target = dataset[ getProbandIndex(dataset) ];\n\tif(!target){\n\t\tconsole.warn(\"No target defined\");\n\t\tif(dataset.length == 0) {\n\t\t\tthrow \"empty pedigree data set\";\n\t\t}\n\t\ttarget = dataset[0];\n\t}\n\tlet connected = [target.name];\n\tlet change = true;\n\tlet ii = 0;\n\twhile(change && ii < 200) {\n\t\tii++;\n\t\tlet nconnect = connected.length;\n\t\t$.each(dataset, function( _idx, p ) {\n\t\t\tif($.inArray( p.name, connected ) != -1) {\n\t\t\t\t// check if this person or a partner has a parent\n\t\t\t\tlet ptrs = get_partners(dataset, p);\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\n\t\t\t\tfor(let i=0; i<ptrs.length; i++){\n\t\t\t\t\tif(!getNodeByName(dataset, ptrs[i]).noparents)\n\t\t\t\t\t\thas_parent = true;\n\t\t\t\t}\n\n\t\t\t\tif(has_parent){\n\t\t\t\t\tif(p.mother && $.inArray( p.mother, connected ) == -1)\n\t\t\t\t\t\tconnected.push(p.mother);\n\t\t\t\t\tif(p.father && $.inArray( p.father, connected ) == -1)\n\t\t\t\t\t\tconnected.push(p.father);\n\t\t\t\t}\n\t\t\t} else if( !p.noparents &&\n\t\t\t\t\t  ((p.mother && $.inArray( p.mother, connected ) != -1) ||\n\t\t\t\t\t   (p.father && $.inArray( p.father, connected ) != -1))){\n\t\t\t\tconnected.push(p.name);\n\t\t\t}\n\t\t\t// include any children\n\t\t\tinclude_children(connected, p, dataset);\n\t\t});\n\t\tchange = (nconnect != connected.length);\n\t}\n\tlet names = $.map(dataset, function(val, _i){return val.name;});\n\treturn $.map(names, function(name, _i){return $.inArray(name, connected) == -1 ? name : null;});\n}\n\nexport function getProbandIndex(dataset) {\n\tlet proband;\n\t$.each(dataset, function(i, val) {\n\t\tif (isProband(val)) {\n\t\t\tproband = i;\n\t\t\treturn proband;\n\t\t}\n\t});\n\treturn proband;\n}\n\nexport function getChildren(dataset, mother, father) {\n\tlet children = [];\n\tlet names = [];\n\tif(mother.sex === 'F')\n\t\t$.each(dataset, function(_i, p) {\n\t\t\tif(mother.name === p.mother)\n\t\t\t\tif(!father || father.name == p.father) {\n\t\t\t\t\tif($.inArray(p.name, names) === -1){\n\t\t\t\t\t\tchildren.push(p);\n\t\t\t\t\t\tnames.push(p.name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t});\n\treturn children;\n}\n\nfunction contains_parent(arr, m, f) {\n\tfor(let i=0; i<arr.length; i++)\n\t\tif(arr[i].mother === m && arr[i].father === f)\n\t\t\treturn true;\n\treturn false;\n}\n\n// get the siblings of a given individual - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getSiblings(dataset, person, sex) {\n\tif(person === undefined || !person.mother || person.noparents)\n\t\treturn [];\n\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex == sex) ? p : null;\n\t});\n}\n\n// get the siblings + adopted siblings\nexport function getAllSiblings(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex == sex) ? p : null;\n\t});\n}\n\n// get the mono/di-zygotic twin(s)\nexport function getTwins(dataset, person) {\n\tlet sibs = getSiblings(dataset, person);\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\n\treturn $.map(sibs, function(p, _i){\n\t\treturn p.name !== person.name && p[twin_type] == person[twin_type] ? p : null;\n\t});\n}\n\n// get the adopted siblings of a given individual\nexport function getAdoptedSiblings(dataset, person) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && 'noparents' in p &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) ? p : null;\n\t});\n}\n\nexport function getAllChildren(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn !('noparents' in p) &&\n\t\t\t   (p.mother === person.name || p.father === person.name) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the depth of the given person from the root\nexport function getDepth(dataset, name) {\n\tlet idx = getIdxByName(dataset, name);\n\tlet depth = 1;\n\n\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\n\t\tdepth++;\n\t}\n\treturn depth;\n}\n\n// given an array of people get an index for a given person\nexport function getIdxByName(arr, name) {\n\tlet idx = -1;\n\t$.each(arr, function(i, p) {\n\t\tif (name === p.name) {\n\t\t\tidx = i;\n\t\t\treturn idx;\n\t\t}\n\t});\n\treturn idx;\n}\n\n// get the nodes at a given depth sorted by their x position\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\n\treturn $.map(fnodes, function(p, _i){\n\t\treturn p.depth == depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) == -1 ? p : null;\n\t}).sort(function (a,b) {return a.x - b.x;});\n}\n\n// convert the partner names into corresponding tree nodes\nexport function linkNodes(flattenNodes, partners) {\n\tlet links = [];\n\tfor(let i=0; i< partners.length; i++)\n\t\tlinks.push({'mother': getNodeByName(flattenNodes, partners[i].mother.name),\n\t\t\t\t\t'father': getNodeByName(flattenNodes, partners[i].father.name)});\n\treturn links;\n}\n\n// get ancestors of a node\nexport function ancestors(dataset, node) {\n\tlet ancestors = [];\n\tfunction recurse(node) {\n\t\tif(node.data) node = node.data;\n\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\n\t\t\trecurse(getNodeByName(dataset, node.mother));\n\t\t\trecurse(getNodeByName(dataset, node.father));\n\t\t}\n\t\tancestors.push(node);\n\t}\n\trecurse(node);\n\treturn ancestors;\n}\n\n// test if two nodes are consanguinous partners\nexport function consanguity(node1, node2, opts) {\n\tif(node1.depth !== node2.depth) // parents at different depths\n\t\treturn true;\n\tlet ancestors1 = ancestors(opts.dataset, node1);\n\tlet ancestors2 = ancestors(opts.dataset, node2);\n\tlet names1 = $.map(ancestors1, function(ancestor, _i){return ancestor.name;});\n\tlet names2 = $.map(ancestors2, function(ancestor, _i){return ancestor.name;});\n\tlet consanguity = false;\n\t$.each(names1, function( _index, name ) {\n\t\tif($.inArray(name, names2) !== -1){\n\t\t\tconsanguity = true;\n\t\t\treturn false;\n\t\t}\n\t});\n\treturn consanguity;\n}\n\n// return a flattened representation of the tree\nexport function flatten(root) {\n\tlet flat = [];\n\tfunction recurse(node) {\n\t\tif(node.children)\n\t\t\tnode.children.forEach(recurse);\n\t\tflat.push(node);\n\t}\n\trecurse(root);\n\treturn flat;\n}\n\n// Adjust D3 layout positioning.\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\n// from links - e.g. where there is a single child plus a hidden child\nexport function adjust_coords(opts, root, flattenNodes) {\n\tfunction recurse(node) {\n\t\tif (node.children) {\n\t\t\tnode.children.forEach(recurse);\n\n\t\t\tif(node.data.father !== undefined) { \t// hidden nodes\n\t\t\t\tlet father = getNodeByName(flattenNodes, node.data.father.name);\n\t\t\t\tlet mother = getNodeByName(flattenNodes, node.data.mother.name);\n\t\t\t\tlet xmid = (father.x + mother.x) /2;\n\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\n\t\t\t\t\tlet diff = node.x - xmid;\n\t\t\t\t\tif(node.children.length == 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\n\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\n\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\n\t\t\t\t\t\t\t\tchild1.x = xmid;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if(node.children.length == 1 && !node.children[0].data.hidden) {\n\t\t\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\n\t\t\t\t\t\t\tif(node.children.length == 1) {\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\n\t\t\t\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\n\t\t\t\t\t\t\t\tfor(let i=0; i<descendants.length; i++) {\n\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\trecurse(root);\n\trecurse(root);\n}\n\n// test if moving siblings by diff overlaps with other nodes\nfunction nodesOverlap(opts, node, diff, root) {\n\tlet descendants = node.descendants();\n\tlet descendantsNames = $.map(descendants, function(descendant, _i){return descendant.data.name;});\n\tlet nodes = root.descendants();\n\tfor(let i=0; i<descendants.length; i++){\n\t\tlet descendant = descendants[i];\n\t\tif(node.data.name !== descendant.data.name){\n\t\t\tlet xnew = descendant.x - diff;\n\t\t\tif(overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// test if x position overlaps a node at the same depth\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\n\tfor(let n=0; n<nodes.length; n++) {\n\t\tif(depth == nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) == -1){\n\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// given a persons name return the corresponding d3 tree node\nexport function getNodeByName(nodes, name) {\n\tfor (let i = 0; i < nodes.length; i++) {\n\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\treturn nodes[i];\n\t\telse if (name === nodes[i].name)\n\t\t\treturn nodes[i];\n\t}\n}\n\n// given the name of a url param get the value\nexport function urlParam(name){\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\n\tif (results===null)\n\t   return null;\n\telse\n\t   return results[1] || 0;\n}\n\n// get grandparents index\nexport function get_grandparents_idx(dataset, midx, fidx) {\n\tlet gmidx = midx;\n\tlet gfidx = fidx;\n\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\n\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\n\t}\n\treturn {'midx': gmidx, 'fidx': gfidx};\n}\n\n// Set or remove proband attributes.\n// If a value is not provided the attribute is removed from the proband.\n// 'key' can be a list of keys or a single key.\nexport function proband_attr(opts, keys, value){\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\n\tnode_attr(opts, proband.name, keys, value);\n}\n\n// Set or remove node attributes.\n// If a value is not provided the attribute is removed.\n// 'key' can be a list of keys or a single key.\nexport function node_attr(opts, name, keys, value){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(newdataset, name);\n\tif(!node){\n\t\tconsole.warn(\"No person defined\");\n\t\treturn;\n\t}\n\n\tif(!$.isArray(keys)) {\n\t\tkeys = [keys];\n\t}\n\n\tif(value) {\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\n\t\t\tif(k in node && keys.length === 1) {\n\t\t\t\tif(node[k] === value)\n\t\t\t\t\treturn;\n\t\t\t\ttry {\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\n\t\t\t\t\t   return;\n\t\t\t\t} catch(e){\n\t\t\t\t\t// continue regardless of error\n\t\t\t\t}\n\t\t\t}\n\t\t\tnode[k] = value;\n\t\t}\n\t} else {\n\t\tlet found = false;\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\n\t\t\tif(k in node) {\n\t\t\t\tdelete node[k];\n\t\t\t\tfound = true;\n\t\t\t}\n\t\t}\n\t\tif(!found)\n\t\t\treturn;\n\t}\n\tsyncTwins(newdataset, node);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\n\tif(!proband){\n\t\tconsole.warn(\"No proband defined\");\n\t\treturn;\n\t}\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\n\tnewchild.age = age;\n\tnewchild.yob = yob;\n\tif(breastfeeding !== undefined)\n\t\tnewchild.breastfeeding = breastfeeding;\n\topts.dataset = newdataset;\n\trebuild(opts);\n\treturn newchild.name;\n}\n\n// delete node using the name\nexport function delete_node_by_name(opts, name){\n\tfunction onDone(opts, dataset) {\n\t\t// assign new dataset and rebuild pedigree\n\t\topts.dataset = dataset;\n\t\trebuild(opts);\n\t}\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(pedcache.current(opts), name);\n\tif(!node){\n\t\tconsole.warn(\"No node defined\");\n\t\treturn;\n\t}\n\tdelete_node_dataset(newdataset, node, opts, onDone);\n}\n\n// check by name if the individual exists\nexport function exists(opts, name){\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\n}\n\n// print options and dataset\nexport function print_opts(opts){\n\t$(\"#pedigree_data\").remove();\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\n\tlet key;\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\n\t\tfor(key in opts.dataset[i]) {\n\t\t\tif(key === 'name') continue;\n\t\t\tif(key === 'parent')\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\n\t\t\telse if (key === 'children') {\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\n\t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\n\t\t\t} else\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\n\t\t}\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\n\n\t}\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\n\tfor(key in opts) {\n\t\tif(key === 'dataset') continue;\n\t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\n\t}\n}\n","import * as pedcache from './pedcache.js';\n\nlet zoom, xi, yi;\n\n// zoom and drag\nexport function get_zoom(opts) {\n\tzoom = d3.zoom()\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\n\t  .filter(function() {\n\t\t\tif(d3.event.type === 'dblclick') return false;\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\n\t\t\t\tif(d3.event.type && d3.event.type === 'wheel') return false\n\t\t\t}\n\t\t\tconsole.log(\"zoom\", d3.event.type, d3.event);\n\t\t\treturn  true})\n\t  .on('zoom', function() { zoomFn(opts) });\n\treturn zoom;\t  \n}\n\nexport function set_initial_xy(opts) {\n\txi = opts.symbol_size/2;\n\tyi = -opts.symbol_size*2.5;\n}\n\nfunction get_bounds(ped, opts) {\n\tlet xmin = Number.MAX_VALUE;\n\tlet xmax = -1000000;\n\tlet ymin = Number.MAX_VALUE;\n\tlet ymax = -1000000;\n\tlet sym2 = opts.symbol_size/2;\n\tped.selectAll('g').each(function(d, _i) {\n\t\tif(d.x && d.data.name !== 'hidden_root') {\n\t\t\tif(d.x-sym2 < xmin) xmin = d.x-sym2;\n\t\t\tif(d.x+sym2 > xmax) xmax = d.x+sym2;\n\t\t\tif(d.y-sym2 < ymin) ymin = d.y-sym2;\n\t\t\tif(d.y+sym2 > ymax) ymax = d.y+sym2;\n\t\t}\n\t});\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\n}\n\nfunction zoomFn(opts) {\n\tlet t = d3.event.transform;\n\tif(d3.event.sourceEvent && d3.event.sourceEvent.type === 'mousemove') {\n\t\tlet xyk = pedcache.getposition(opts);\n\t\tif(xyk.length == 3) t.k = xyk[2];\n\t}\n\ttransform_pedigree(opts, t.x+(xi*t.k), t.y+(yi*t.k), t.k);\n    return;\n}\n\n// scale size the pedigree\nexport function btn_zoom(opts, scale) {\n\tlet xyk = pedcache.getposition(opts);  // cached position\n\tlet k = (xyk.length == 3 ? xyk[2]*scale : 1*scale);\n\tlet x = (xyk[0] !== null ? xyk[0] : xi)-(xi*k);\n\tlet y = (xyk[1] !== null ? xyk[1] : yi)-(yi*k);\n\n\tif(k < opts.zoomIn || k > opts.zoomOut) {\n\t\tif(xyk.length == 3) {\n\t\t\tlet ck = xyk[2];\n\t\t\tlet zoomOut = (k < ck);\n\t\t\tif(zoomOut  && k < opts.zoomIn) return;\n\t\t\tif(!zoomOut && k > opts.zoomOut) return;\n\t\t} else {\n\t\t\treturn;\n\t\t}\n\t}\n\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tvar transform = d3.zoomIdentity \t\t// new zoom transform (using d3.zoomIdentity as a base)\n      .scale(k) \n      .translate(x, y);\n    svg.transition().duration(700).call(zoom.transform, transform); \t// apply new zoom transform:\n}\n\nexport function zoom_to_fit(opts) {\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tlet bounds = get_bounds(ped, opts);\n\tlet w = bounds.xmax-bounds.xmin,\n\t    h = bounds.ymax-bounds.ymin;\n\t\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tlet wfull = svg.node().clientWidth,\n\t    hfull = svg.node().clientHeight;\n\tlet k = 0.90 / Math.max(w/wfull, h/hfull);\n\t//let midX = w / 2,\n\t//    midY = h / 2;\n\t//let x = (wfull/2) - (k * midX);\n\t//let y = (hfull/2) - (k * midY);\n\n\tvar transform = d3.zoomIdentity \t\t// new zoom transform (using d3.zoomIdentity as a base)\n      .scale(k) \n      .translate(-opts.symbol_size*1.5*k, 0);\n    svg.transition().duration(700).call(zoom.transform, transform); \t// apply new zoom transform:\n}\n\n//export function center(opts) {\n//\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n//\tvar transform = d3.zoomIdentity \t\t// new zoom transform (using d3.zoomIdentity as a base)\n//      .translate(0, 0);\n//    svg.transition().duration(700).call(zoom.transform, transform); \t// apply new zoom transform:\n//}\n\nfunction transform_pedigree(opts, x, y, k) {\n\tpedcache.setposition(opts, x, y, (k !== 1 ? k : undefined));\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tped.attr('transform', 'translate(' + x + ',' + y + ') scale(' + k + ')');\n}\n","// undo, redo, reset buttons\nimport * as pedcache from './pedcache.js';\nimport {rebuild, build} from './pedigree.js';\nimport {btn_zoom, zoom_to_fit} from './zoom.js';\nimport {copy_dataset, getProbandIndex} from './pedigree_utils.js';\n\nexport function add(options) {\n\tlet opts = $.extend({\n        // defaults\n\t\tbtn_target: 'pedigree_history'\n    }, options );\n\n\tlet btns = [{\"fa\": \"fa-undo pull-left\", \"title\": \"undo\"},\n\t\t\t\t{\"fa\": \"fa-repeat pull-left\", \"title\": \"redo\"},\n\t\t\t\t{\"fa\": \"fa-refresh pull-left\", \"title\": \"reset\"},\n\t\t\t\t{\"fa\": \"fa-arrows-alt pull-left\", \"title\": \"fullscreen\"}];\n\n\tbtns.push({\"fa\": \"fa-crosshairs pull-right\", \"title\": \"zoom-to-fit\"});\n\tif(opts.zoomSrc && (opts.zoomSrc.indexOf('button') > -1)) {\n\t\tif(opts.zoomOut != 1)\n\t\t\tbtns.push({\"fa\": \"fa-minus-circle pull-right\", \"title\": \"zoom-out\"});\n\t\tif(opts.zoomIn != 1)\n\t\t\tbtns.push({\"fa\": \"fa-plus-circle pull-right\", \"title\": \"zoom-in\"});\n\t}\n\t\n\n\tlet lis = \"\";\n\tfor(let i=0; i<btns.length; i++) {\n\t\tlis += '<span>';\n\t\tlis += '&nbsp;<i class=\"fa fa-lg ' + btns[i].fa + '\" ' +\n\t\t               (btns[i].fa == \"fa-arrows-alt pull-left\" ? 'id=\"fullscreen\" ' : '') +\n\t\t               ' aria-hidden=\"true\" title=\"'+ btns[i].title +'\"></i>';\n\t\tlis += '</span>';\n\t}\n\t$( \"#\"+opts.btn_target ).append(lis);\n\tclick(opts);\n}\n\nexport function is_fullscreen(){\n\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement);\n}\n\nfunction click(opts) {\n\t// fullscreen\n    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(_e)  {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\t\topts.dataset = local_dataset;\n\t\t}\n\t\trebuild(opts);\n    });\n\n\t$('#fullscreen').on('click', function(_e) {\n\t\tif (!document.mozFullScreen && !document.webkitFullScreen) {\n\t\t\tlet target = $(\"#\"+opts.targetDiv)[0];\n\t\t\tif(target.mozRequestFullScreen)\n\t\t\t\ttarget.mozRequestFullScreen();\n\t\t\telse\n\t\t\t\ttarget.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);\n\t\t} else {\n\t\t\tif(document.mozCancelFullScreen)\n\t\t\t\tdocument.mozCancelFullScreen();\n\t\t\telse\n\t\t\t\tdocument.webkitCancelFullScreen();\n\t\t}\n\t});\n\n\t// undo/redo/reset\n\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\n\t\te.stopPropagation();\n\t\tif($(e.target).hasClass(\"disabled\"))\n\t\t\treturn false;\n\n\t\tif($(e.target).hasClass('fa-undo')) {\n\t\t\topts.dataset = pedcache.previous(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\tbuild(opts);\n\t\t} else if ($(e.target).hasClass('fa-repeat')) {\n\t\t\topts.dataset = pedcache.next(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\tbuild(opts);\n\t\t} else if ($(e.target).hasClass('fa-refresh')) {\n\t\t\t$('<div id=\"msgDialog\">Resetting the pedigree may result in loss of some data.</div>').dialog({\n\t\t\t\ttitle: 'Confirm Reset',\n\t\t\t\tresizable: false,\n\t\t\t\theight: \"auto\",\n\t\t\t\twidth: 400,\n\t\t\t\tmodal: true,\n\t\t\t\tbuttons: {\n\t\t\t\t\tContinue: function() {\n\t\t\t\t\t\treset(opts, opts.keep_proband_on_reset);\n\t\t\t\t\t\t$(this).dialog( \"close\" );\n\t\t\t\t\t},\n\t\t\t\t\tCancel: function() {\n\t\t\t\t\t\t$(this).dialog( \"close\" );\n\t\t\t\t\t\treturn;\n\t\t\t\t    }\n\t\t\t\t}\n\t\t\t});\n\t\t} else if ($(e.target).hasClass('fa-plus-circle')) {\n\t\t\tbtn_zoom(opts, 1.1);\n\t\t} else if ($(e.target).hasClass('fa-minus-circle')) {\n\t\t\tbtn_zoom(opts, 0.9);\n\t\t} else if ($(e.target).hasClass('fa-crosshairs')) {\n\t\t\tzoom_to_fit(opts);\n\t\t} \n\t\t// trigger fhChange event\n\t\t$(document).trigger('fhChange', [opts]);\n\t});\n}\n\n// reset pedigree and clear the history\nexport function reset(opts, keep_proband) {\n\tlet proband;\n\tif(keep_proband) {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tlet newdataset =  copy_dataset(local_dataset);\n\t\tproband = newdataset[getProbandIndex(newdataset)];\n\t\t//let children = pedigree_util.getChildren(newdataset, proband);\n\t\tproband.name = \"ch1\";\n\t\tproband.mother = \"f21\";\n\t\tproband.father = \"m21\";\n\t\t// clear pedigree data but keep proband data and risk factors\n\t\tpedcache.clear_pedigree_data(opts)\n\t} else {\n\t\tproband = {\n\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"\n\t\t};\n\t\tpedcache.clear(opts); // clear all storage data\n\t}\n\n\tdelete opts.dataset;\n\n\tlet selected = $(\"input[name='default_fam']:checked\");\n\tif(selected.length > 0 && selected.val() == 'extended2') {    // secondary relatives\n\t\topts.dataset = [\n\t\t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\n\t\t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\n\t\t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\n\t\t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\n\t\t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\n\t\t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\tproband,\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\n\t\t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\n\t\t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"}];\n\t} else if(selected.length > 0 && selected.val() == 'extended1') {    // primary relatives\n\t\topts.dataset = [\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\tproband,\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"}];\n\t} else {\n\t\topts.dataset = [\n\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t{\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\tproband];\n\t}\n\trebuild(opts);\n}\n\nexport function updateButtons(opts) {\n\tlet current = pedcache.get_count(opts);\n\tlet nstore = pedcache.nstore(opts);\n\tlet id = \"#\"+opts.btn_target;\n\tif(nstore <= current)\n\t\t$(id+\" .fa-repeat\").addClass('disabled');\n\telse\n\t\t$(id+\" .fa-repeat\").removeClass('disabled');\n\n\tif(current > 1)\n\t\t$(id+\" .fa-undo\").removeClass('disabled');\n\telse\n\t\t$(id+\" .fa-undo\").addClass('disabled');\n}\n","import * as pedigree_util from './pedigree_utils.js';\n\n// cancers, genetic & pathology tests\nexport let cancers = {\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\n\t};\nexport let genetic_test = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d',\t'rad51c', 'brip1'];\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\n\n// risk factor to storage\nlet RISK_FACTOR_STORE = new Object();\n\n// get surgical ops and PRS for canrisk header\nexport function get_meta() {\n\tlet meta = get_surgical_ops();\n\tlet prs;\n\ttry {\n\t\tprs = get_prs_values();\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\n\t\t}\n\t} catch(err) { console.warn(\"PRS\", prs); }\n\treturn meta;\n}\n\n// return a non-anonimised pedigree format\nexport function get_non_anon_pedigree(dataset, meta) {\n\treturn get_pedigree(dataset, undefined, meta, false);\n}\n\n//check if input has a value\nexport function hasInput(id) {\n\treturn $.trim($('#'+id).val()).length !== 0;\n}\n\n//return true if the object is empty\nlet isEmpty = function(myObj) {\n\tfor(let key in myObj) {\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\n//get breast and ovarian PRS values\nexport function get_prs_values() {\n\tlet prs = {};\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\n\t\tprs['breast_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\n\t\tprs['ovarian_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\n\t\t};\n\t}\n\tconsole.log(prs);\n\treturn (isEmpty(prs) ? 0 : prs);\n}\n\nfunction get_surgical_ops() {\n\tlet meta = \"\";\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";OVARY2=y\";\n\t}\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";MAST2=y\";\n\t}\n\treturn meta;\n}\n\nexport function readCanRiskV1(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet hdr = [];  // collect risk factor header lines\n\t// assumes two line header\n\tfor(let i = 0;i < lines.length;i++){\n\t\tlet ln = lines[i].trim();\n\t\tif(ln.indexOf(\"##\") === 0) {\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0 && ln.indexOf(\";\") > -1) {   // contains surgical op data\n\t\t\t\tlet ops = ln.split(\";\");\n\t\t\t\tfor(let j=1; j<ops.length; j++) {\n\t\t\t\t\tlet opdata = ops[j].split(\"=\");\n\t\t\t\t\tif(opdata.length === 2) {\n\t\t\t\t\t\thdr.push(ops[j]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet delim = /\\t/;\n\t\tif(ln.indexOf('\\t') < 0) {\n\t\t\tdelim = /\\s+/;\n\t\t\tconsole.log(\"NOT TAB DELIM\");\n\t\t}\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\n\n\t\tif(attr.length > 1) {\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] == 1) indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\tfor(let j=0; j<genetic_test.length; j++) {\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\n\t\t\t\tif(gene_test[0] !== '0') {\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N'))\n\t\t\t\t\t\tindi[genetic_test[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tlet path_test = attr[idx].split(\":\");\n\t\t\tfor(let j=0; j<path_test.length; j++) {\n\t\t\t\tif(path_test[j] !== '0') {\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\treturn [hdr, ped];\n}\n\n/**\n * Get CanRisk formated pedigree.\n */\nexport function get_pedigree(dataset, famid, meta, isanon) {\n\tlet msg = \"##CanRisk 1.0\";\n\tif(!famid) {\n\t\tfamid = \"XXXX\";\n\t}\n\tif(meta) {\n\t\tmsg += meta;\n\t}\n\tif(typeof isanon === 'undefined') {\n\t\tisanon = true;\n\t}\n\t// array of individuals excluded from the calculation\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\n\n\t// female risk factors\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\n\tlet sex = 'F';\n\tif(probandIdx) {\n\t\tsex = dataset[probandIdx].sex;\n\t}\n\n\tif(sex !== 'M') {\n\t\tlet menarche    = get_risk_factor('menarche_age');\n\t\tlet parity      = get_risk_factor('parity');\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\n\t\tlet mht_use     = get_risk_factor('mht');\n\t\tlet bmi         = get_risk_factor('bmi');\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\n\t\tlet hgt         = get_risk_factor('height');\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\n\t\tlet endo        = get_risk_factor('endometriosis');\n\n\t\tif(menarche !== undefined)\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\n\t\tif(parity !== undefined)\n\t\t\tmsg += \"\\n##parity=\"+parity;\n\t\tif(first_birth !== undefined)\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\n\t\tif(oc_use !== undefined)\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\n\t\tif(mht_use !== undefined)\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\n\t\tif(bmi !== undefined)\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\n\t\tif(alcohol !== undefined)\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\n\t\tif(menopause !== undefined)\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\n\t\tif(mdensity !== undefined)\n\t\t\tmsg += \"\\n##birads=\"+mdensity;\n\t\tif(hgt !== undefined)\n\t\t\tmsg += \"\\n##height=\"+hgt;\n\t\tif(tl !== undefined)\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\n\t\t\t\tmsg += \"\\n##TL=Y\";\n\t\t\telse\n\t\t\t\tmsg += \"\\n##TL=N\";\n\n\t\tif(endo !== undefined)\n\t\t\tmsg += \"\\n##endo=\"+endo;\n\t}\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\\tBRCA1\\tBRCA2\\tPALB2\\tATM\\tCHEK2\\tRAD51D\\tRAD51C\\tBRIP1\\tER:PR:HER2:CK14:CK56\";\n\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet p = dataset[i];\n\t\tif($.inArray(p.name, excl) != -1) {\n\t\t\tconsole.log('EXCLUDE: '+p.name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\n\t\tif(isanon)\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\n\t\telse\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) == -1)? p.father : 0)+'\\t';\t// max 7 chars\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) == -1)? p.mother : 0)+'\\t';\t// max 7 chars\n\t\tmsg += p.sex+'\\t';\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\n\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\tif(diagnosis_age in p)\n\t\t\t\tmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\n\t\t\telse\n\t\t\t\tmsg += '0\\t';\n\t\t});\n\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\n\n\t\tfor(let j=0; j<genetic_test.length; j++) {\n\t\t\tif(genetic_test[j]+'_gene_test' in p &&\n\t\t\t   p[genetic_test[j]+'_gene_test']['type'] !== '-' &&\n\t\t\t   p[genetic_test[j]+'_gene_test']['result'] !== '-') {\n\t\t\t\tmsg += p[genetic_test[j]+'_gene_test']['type'] + ':';\n\t\t\t\tmsg += p[genetic_test[j]+'_gene_test']['result'] + '\\t';\n\t\t\t} else {\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\n\t\t\t}\n\t\t}\n\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\n\t\t\t} else {\n\t\t\t\tmsg += '0';\n\t\t\t}\n\t\t\tif(j<(pathology_tests.length-1))\n\t\t\t\tmsg += \":\";\n\t\t}\n\t}\n\tconsole.log(msg, RISK_FACTOR_STORE);\n\treturn msg;\n}\n\nexport function show_risk_factor_store() {\n\tconsole.log(\"RISK_FACTOR_STORE::\");\n\t$.each(RISK_FACTOR_STORE, function(name, val){\n\t\tconsole.log(name + \" : \" + val);\n\t});\n}\n\nexport function save_risk_factor(risk_factor_name, val) {\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\n}\n\nexport function get_risk_factor(risk_factor_name) {\n\tlet key = store_name(risk_factor_name);\n\tif(key in RISK_FACTOR_STORE) {\n\t\treturn RISK_FACTOR_STORE[key];\n\t}\n\treturn undefined;\n}\n\n// remove risk factor from storage\nexport function remove_risk_factor(risk_factor_name) {\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\n}\n\n// prefix risk factor name with the app/page name\nexport function store_name(risk_factor_name) {\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\n\t       '::' + risk_factor_name;\n}\n","// pedigree I/O\nimport * as pedigree_util from './pedigree_utils.js';\nimport * as pedcache from './pedcache.js';\nimport {get_tree_dimensions, validate_pedigree, rebuild} from './pedigree.js';\nimport {readCanRiskV1, cancers, genetic_test, pathology_tests} from './canrisk_file.js';\n\n\nexport function add(opts) {\n\t$('#load').change(function(e) {\n\t\tload(e, opts);\n\t});\n\n\t$('#save').click(function(_e) {\n\t\tsave(opts);\n\t});\n\n\t$('#print').click(function(_e) {\n\t\tprint(get_printable_svg(opts));\n\t});\n\n\t$('#svg_download').click(function(_e) {\n\t\tsvg_download(get_printable_svg(opts));\n\t});\n\n\t$('#png_download').click(function(_e) {\n\t\tlet deferred = svg2img($('svg'), \"pedigree\");\n\t\t$.when.apply($,[deferred]).done(function() {\n\t\t\tlet obj = getByName(arguments, \"pedigree\");\n\t\t\tif(pedigree_util.isEdge() || pedigree_util.isIE()) {\n\t\t\t\tlet html=\"<img src='\"+obj.img+\"' alt='canvas image'/>\";\n\t\t\t\tlet newTab = window.open();\t\t// pop-ups need to be enabled\n\t\t\t\tnewTab.document.write(html);\n\t\t\t} else {\n\t\t\t\tlet a\t  = document.createElement('a');\n\t\t\t\ta.href\t = obj.img;\n\t\t\t\ta.download = 'plot.png';\n\t\t\t\ta.target   = '_blank';\n\t\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t\t\t}\n\t\t});\n\t});\n}\n\n/**\n * Get object from array by the name attribute.\n */\nfunction getByName(arr, name) {\n\treturn $.grep(arr, function(o){ return o && o.name == name; })[0];\n}\n\n/**\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\n */\nexport function svg2img(svg, deferred_name, options) {\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\n\tif(!options) options = defaults;\n\t$.each(defaults, function(key, value) {\n\t\tif(!(key in options)) {options[key] = value;}\n\t});\n\n\t// set SVG background to white - fix for jpeg creation\n\tif (svg.find(\".pdf-white-bg\").length === 0){\n\t\tlet d3obj = d3.select(svg.get(0));\n\t\td3obj.append(\"rect\")\n\t\t\t.attr(\"width\", \"100%\")\n\t\t\t.attr(\"height\", \"100%\")\n\t\t\t.attr(\"class\", \"pdf-white-bg\")\n\t\t\t.attr(\"fill\", \"white\");\n\t\td3obj.select(\".pdf-white-bg\").lower();\n\t}\n\n\tlet deferred = $.Deferred();\n\tlet svgStr;\n\tif (typeof window.XMLSerializer != \"undefined\") {\n\t\tsvgStr = (new XMLSerializer()).serializeToString(svg.get(0));\n\t} else if (typeof svg.xml != \"undefined\") {\n\t\tsvgStr = svg.get(0).xml;\n\t}\n\n\tlet imgsrc = 'data:image/svg+xml;base64,'+ btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\n\tlet canvas = document.createElement(\"canvas\");\n\tcanvas.width = svg.width()*options.resolution;\n\tcanvas.height = svg.height()*options.resolution;\n\tlet context = canvas.getContext(\"2d\");\n\tlet img = document.createElement(\"img\");\n\timg.onload = function() {\n\t\tif(pedigree_util.isIE()) {\n\t\t\t// change font so it isn't tiny\n\t\t\tsvgStr = svgStr.replace(/ font-size=\"\\d?.\\d*em\"/g, '');\n\t\t\tsvgStr = svgStr.replace(/<text /g, '<text font-size=\"12px\" ');\n\t\t\tlet v = canvg.Canvg.fromString(context, svgStr, {\n\t\t\t\tscaleWidth: canvas.width,\n\t\t\t\tscaleHeight: canvas.height,\n\t\t\t\tignoreDimensions: true\n\t\t\t});\n\t\t\tv.start();\n\t\t\tconsole.log(deferred_name, options.img_type, \"use canvg to create image\");\n\t\t} else {\n\t\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\n\t\t\tconsole.log(deferred_name, options.img_type);\n\t\t}\n\t\tdeferred.resolve({'name': deferred_name, 'resolution': options.resolution, 'img':canvas.toDataURL(options.img_type, 1), 'w':canvas.width, 'h':canvas.height});\n\t};\n\timg.src = imgsrc;\n\treturn deferred.promise();\n}\n\nfunction getMatches(str, myRegexp) {\n\tlet matches = [];\n\tlet match;\n\tlet c = 0;\n\tmyRegexp.lastIndex = 0;\n\twhile ((match = myRegexp.exec(str))) {\n\t\tc++;\n\t\tif(c > 400) {\n\t\t\tconsole.error(\"getMatches: counter exceeded 800\");\n\t\t\treturn -1;\n\t\t}\n\t\tmatches.push(match);\n\t\tif (myRegexp.lastIndex === match.index) {\n\t\t\tmyRegexp.lastIndex++;\n\t\t}\n\t}\n\treturn matches;\n}\n\n// find all url's to make unique\nfunction unique_urls(svg_html) {\n\tlet matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g);\n\tif(matches === -1)\n\t\treturn \"ERROR DISPLAYING PEDIGREE\"\n\n\t$.each(matches, function(_index, match) {\n\t\tlet quote = (match[1] ? match[1] : \"\");\n\t\tlet val = match[2];\n\t\tlet m1 = \"id=\\\"\" + val + \"\\\"\";\n\t\tlet m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\n\n\t\tlet newval = val+pedigree_util.makeid(2);\n\t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\"+newval+\"\\\"\" );\n\t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\"+newval+\")\" );\n   });\n\treturn svg_html;\n}\n\n// return a copy pedigree svg\nexport function copy_svg(opts) {\n\tlet svg_node = get_printable_svg(opts);\n\tlet d3obj = d3.select(svg_node.get(0));\n\n\t// remove unused elements\n\td3obj.selectAll(\".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection\").remove();\n\td3obj.selectAll(\"text\")\n\t  .filter(function(){\n\t\t return d3.select(this).text().length === 0\n\t  }).remove();\n\treturn $(unique_urls(svg_node.html()));\n}\n\n// get printable svg div, adjust size to tree dimensions and scale to fit\nfunction get_printable_svg(opts) {\n\tlet local_dataset = pedcache.current(opts); // get current dataset\n\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\topts.dataset = local_dataset;\n\t}\n\n\tlet tree_dimensions = get_tree_dimensions(opts);\n\tlet svg_div = $('<div></div>');  \t\t\t\t// create a new div\n\tlet svg = $('#'+opts.targetDiv).find('svg').clone().appendTo(svg_div);\n\tif(opts.width < tree_dimensions.width || opts.height < tree_dimensions.height ||\n\t   tree_dimensions.width > 595 || tree_dimensions.height > 842) {\n\t\tlet wid = tree_dimensions.width;\n\t\tlet hgt = tree_dimensions.height + 100;\n\t\tlet scale = 1.0;\n\n\t\tif(tree_dimensions.width > 595 || tree_dimensions.height > 842) {   // scale to fit A4\n\t\t\tif(tree_dimensions.width > 595)  wid = 595;\n\t\t\tif(tree_dimensions.height > 842) hgt = 842;\n\t\t\tlet xscale = wid/tree_dimensions.width;\n\t\t\tlet yscale = hgt/tree_dimensions.height;\n\t\t\tscale = (xscale < yscale ? xscale : yscale);\n\t\t}\n\n\t\tsvg.attr('width', wid);\t\t// adjust dimensions\n\t\tsvg.attr('height', hgt);\n\n\t\tlet ytransform = (-opts.symbol_size*1.5*scale);\n\t\tsvg.find(\".diagram\").attr(\"transform\", \"translate(0, \"+ytransform+\") scale(\"+scale+\")\");\n\t}\n\treturn svg_div;\n}\n\n// download the SVG to a file\nexport function svg_download(svg){\n\tlet a\t  = document.createElement('a');\n\ta.href\t = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svg.html() ) ) );\n\ta.download = 'plot.svg';\n\ta.target   = '_blank';\n\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n}\n\n// open print window for a given element\nexport function print(el, id){\n\tif(el.constructor !== Array)\n\t\tel = [el];\n\n\tlet width = $(window).width()*0.9;\n\tlet height = $(window).height()-10;\n\tlet cssFiles = [\n\t\t'/static/css/canrisk.css',\n\t\t'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css'\n\t];\n\tlet printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\n\tlet headContent = '';\n\tfor(let i=0; i<cssFiles.length; i++)\n\t\theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\n\theadContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\n\n\tlet html = \"\";\n\tfor(let i=0; i<el.length; i++) {\n\t\tif(i === 0 && id)\n\t\t\thtml += id;\n\t\thtml += $(el[i]).html();\n\t\tif(i < el.length-1)\n\t\t\thtml += '<div class=\"page-break\"> </div>';\n\t}\n\n\tprintWindow.document.write(headContent);\n\tprintWindow.document.write(html);\n\tprintWindow.document.close();\n\n\tprintWindow.focus();\n\tsetTimeout(function() {\n\t\tprintWindow.print();\n\t\tprintWindow.close();\n\t}, 300);\n}\n\n// save content to a file\nexport function save_file(opts, content, filename, type){\n\tif(opts.DEBUG)\n\t\tconsole.log(content);\n\tif(!filename) filename = \"ped.txt\";\n\tif(!type) type = \"text/plain\";\n\n   let file = new Blob([content], {type: type});\n   if (window.navigator.msSaveOrOpenBlob) \t// IE10+\n\t   window.navigator.msSaveOrOpenBlob(file, filename);\n   else { \t\t\t\t\t\t\t\t\t// other browsers\n\t   let a = document.createElement(\"a\");\n\t   let url = URL.createObjectURL(file);\n\t   a.href = url;\n\t   a.download = filename;\n\t   document.body.appendChild(a);\n\t   a.click();\n\t   setTimeout(function() {\n\t\t   document.body.removeChild(a);\n\t\t   window.URL.revokeObjectURL(url);\n\t\t}, 0);\n\t}\n}\n\nfunction save(opts){\n\tlet content = JSON.stringify(pedcache.current(opts));\n\tsave_file(opts, content);\n}\n\nfunction canrisk_validation(opts) {\n\t$.each(opts.dataset, function(_idx, p) {\n\t\tif(!p.hidden && p.sex === 'M' && !pedigree_util.isProband(p)) {\n\t\t\tif(p[cancers['breast_cancer2']]) {\n\t\t\t\tlet msg = 'Male family member ('+p.display_name+') with contralateral breast cancer found. '+\n\t\t\t\t\t\t  'Please note that as the risk models do not take this into account the second '+\n\t\t\t\t\t\t  'breast cancer is ignored.'\n\t\t\t\tconsole.error(msg);\n\t\t\t\tdelete p[cancers['breast_cancer2']];\n\t\t\t\tpedigree_util.messages(\"Warning\", msg);\n\t\t\t}\n\t\t}\n\t});\n}\n\nexport function load(e, opts) {\n\tlet f = e.target.files[0];\n\tif(f) {\n\t\tlet risk_factors;\n\t\tlet reader = new FileReader();\n\t\treader.onload = function(e) {\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log(e.target.result);\n\t\t\ttry {\n\t\t\t\tif(e.target.result.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\n\t\t\t\t\topts.dataset = readBoadiceaV4(e.target.result, 4);\n\t\t\t\t\tcanrisk_validation(opts);\n\t\t\t\t} else if(e.target.result.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\n\t\t\t\t\topts.dataset = readBoadiceaV4(e.target.result, 2);\n\t\t\t\t\tcanrisk_validation(opts);\n\t\t\t\t} else if(e.target.result.indexOf(\"##\") === 0 && e.target.result.indexOf(\"CanRisk\") !== -1) {\n\t\t\t\t\tlet canrisk_data = readCanRisk(e.target.result);\n\t\t\t\t\trisk_factors = canrisk_data[0];\n\t\t\t\t\topts.dataset = canrisk_data[1];\n\t\t\t\t\tcanrisk_validation(opts);\n\t\t\t\t} else {\n\t\t\t\t\ttry {\n\t\t\t\t\t\topts.dataset = JSON.parse(e.target.result);\n\t\t\t\t\t} catch(err) {\n\t\t\t\t\t\topts.dataset = readLinkage(e.target.result);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tvalidate_pedigree(opts);\n\t\t\t} catch(err1) {\n\t\t\t\tconsole.error(err1, e.target.result);\n\t\t\t\tpedigree_util.messages(\"File Error\", ( err1.message ? err1.message : err1));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconsole.log(opts.dataset);\n\t\t\ttry{\n\t\t\t\trebuild(opts);\n\t\t\t\tif(risk_factors !== undefined) {\n\t\t\t\t\tconsole.log(risk_factors);\n\t\t\t\t\t// load risk factors - fire riskfactorChange event\n\t\t\t\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\n\t\t\t\t}\n\t\t\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\n\n\t\t\t\ttry {\n\t\t\t\t\t// update FH section\n\t\t\t\t\tacc_FamHist_ticked();\n\t\t\t\t\tacc_FamHist_Leave();\n\t\t\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\n\t\t\t\t} catch(err3) {\n\t\t\t\t\t// ignore error\n\t\t\t\t}\n\t\t\t} catch(err2) {\n\t\t\t\tpedigree_util.messages(\"File Error\", ( err2.message ? err2.message : err2));\n\t\t\t}\n\t\t};\n\t\treader.onerror = function(event) {\n\t\t\tpedigree_util.messages(\"File Error\", \"File could not be read! Code \" + event.target.error.code);\n\t\t};\n\t\treader.readAsText(f);\n\t} else {\n\t\tconsole.error(\"File could not be read!\");\n\t}\n\t$(\"#load\")[0].value = ''; // reset value\n}\n\n//\n// https://www.cog-genomics.org/plink/1.9/formats#ped\n// https://www.cog-genomics.org/plink/1.9/formats#fam\n//\t1. Family ID ('FID')\n//\t2. Within-family ID ('IID'; cannot be '0')\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\n//  7. Genotypes (column 7 onwards);\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\nexport function readLinkage(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet famid;\n\tfor(let i = 0;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t   if(attr.length < 5)\n\t\t   throw('unknown format');\n\t   let sex = (attr[4] == '1' ? 'M' : (attr[4] == '2' ? 'F' : 'U'));\n\t   let indi = {\n\t\t\t'famid': attr[0],\n\t\t\t'display_name': attr[1],\n\t\t\t'name':\tattr[1],\n\t\t\t'sex': sex\n\t\t};\n\t\tif(attr[2] !== \"0\") indi.father = attr[2];\n\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\n\n\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\n\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\n\t\t\tbreak;\n\t\t}\n\t\tif(attr[5] == \"2\") indi.affected = 2;\n\t\t// add genotype columns\n\t\tif(attr.length > 6) {\n\t\t\tindi.alleles = \"\";\n\t\t\tfor(let j=6; j<attr.length; j+=2) {\n\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\n\t\t\t}\n\t\t}\n\n\t\tped.unshift(indi);\n\t\tfamid = attr[0];\n\t}\n\treturn process_ped(ped);\n}\n\nfunction readCanRisk(boadicea_lines) {\n\tlet [hdr, ped] = readCanRiskV1(boadicea_lines);\n\ttry {\n\t\treturn [hdr, process_ped(ped)];\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn [hdr, ped];\n\t}\n}\n\n// read boadicea format v4 & v2\nexport function readBoadiceaV4(boadicea_lines, version) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\t// assumes two line header\n\tfor(let i = 2;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t\tif(attr.length > 1) {\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] == 1) indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(_cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(version === 4) {\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, P = positive, N = negative\n\t\t\t\tfor(let j=0; j<5; j++) {\n\t\t\t\t\tidx+=2;\n\t\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\n\t\t\t\t\t\t\tindi[genetic_test[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (version === 2) {\n\t\t\t\t// genetic test BRCA1, BRCA2\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\n\t\t\t\tidx+=2; \t// gtest\n\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T')) {\n\t\t\t\t\t\tif(attr[idx-1] === 'N') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '1') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '2') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '3') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t}\n\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t\tif(attr[idx] !== '0') {\n\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = attr[idx];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +attr[idx]);\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\n\ttry {\n\t\treturn process_ped(ped);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn ped;\n\t}\n}\n\nfunction process_ped(ped) {\n\t// find the level of individuals in the pedigree\n\tfor(let j=0;j<2;j++) {\n\t\tfor(let i=0;i<ped.length;i++) {\n\t\t\tgetLevel(ped, ped[i].name);\n\t\t}\n\t}\n\n\t// find the max level (i.e. top_level)\n\tlet max_level = 0;\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(ped[i].level && ped[i].level > max_level)\n\t\t\tmax_level = ped[i].level;\n\t}\n\n\t// identify top_level and other nodes without parents\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(pedigree_util.getDepth(ped, ped[i].name) == 1) {\n\t\t\tif(ped[i].level && ped[i].level == max_level) {\n\t\t\t\tped[i].top_level = true;\n\t\t\t} else {\n\t\t\t\tped[i].noparents = true;\n\n\t\t\t\t// 1. look for partners parents\n\t\t\t\tlet pidx = getPartnerIdx(ped, ped[i]);\n\t\t\t\tif(pidx > -1) {\n\t\t\t\t\tif(ped[pidx].mother) {\n\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\n\t\t\t\t\t\tped[i].father = ped[pidx].father;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// 2. or adopt parents from level above\n\t\t\t\tif(!ped[i].mother){\n\t\t\t\t\tfor(let j=0; j<ped.length; j++) {\n\t\t\t\t\t\tif(ped[i].level == (ped[j].level-1)) {\n\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\n\t\t\t\t\t\t\tif(pidx > -1) {\n\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tdelete ped[i].top_level;\n\t\t}\n\t}\n\treturn ped;\n}\n\n// get the partners for a given node\nfunction getPartnerIdx(dataset, anode) {\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother)\n\t\t\treturn pedigree_util.getIdxByName(dataset, bnode.father);\n\t\telse if(anode.name === bnode.father)\n\t\t\treturn pedigree_util.getIdxByName(dataset, bnode.mother);\n\t}\n\treturn -1;\n}\n\n// for a given individual assign levels to a parents ancestors\nfunction getLevel(dataset, name) {\n\tlet idx = pedigree_util.getIdxByName(dataset, name);\n\tlet level = (dataset[idx].level ? dataset[idx].level : 0);\n\tupdate_parents_level(idx, level, dataset);\n}\n\n// recursively update parents levels\nfunction update_parents_level(idx, level, dataset) {\n\tlet parents = ['mother', 'father'];\n\tlevel++;\n\tfor(let i=0; i<parents.length; i++) {\n\t\tlet pidx = pedigree_util.getIdxByName(dataset, dataset[idx][parents[i]]);\n\t\tif(pidx >= 0) {\n\t\t\tlet ma = dataset[pedigree_util.getIdxByName(dataset, dataset[idx].mother)];\n\t\t\tlet pa = dataset[pedigree_util.getIdxByName(dataset, dataset[idx].father)];\n\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\n\t\t\t\tma.level = level;\n\t\t\t\tpa.level = level;\n\t\t\t}\n\n\t\t\tif(ma.level < pa.level) {\n\t\t\t\tma.level = pa.level;\n\t\t\t} else if(pa.level < ma.level) {\n\t\t\t\tpa.level = ma.level;\n\t\t\t}\n\t\t\tupdate_parents_level(pidx, level, dataset);\n\t\t}\n\t}\n}\n","// pedigree form\nimport {rebuild, syncTwins} from './pedigree.js';\nimport {copy_dataset, getNodeByName} from './pedigree_utils.js';\nimport {current as pedcache_current} from './pedcache.js';\n\n\n// handle family history change events (undo/redo/delete)\n$(document).on('fhChange', function(e, opts){\n\ttry {\n\t\tlet id = $('#id_name').val();  // get name from hidden field\n\t\tlet node = getNodeByName(pedcache_current(opts), id)\n\t\tif(node === undefined)\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\n\t\telse\n\t\t\t$('form > fieldset').prop('disabled', false);\n\t} catch(err) {\n\t\tconsole.warn(err);\n\t}\n})\n\n// update status field and age label - 0 = alive, 1 = dead\nexport function updateStatus(status) {\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\n\t(status == 1 ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\n\t$('#id_age_'+status).removeClass(\"hidden\");\n\t$('#id_age_'+(status == 1 ? '0' : '1')).addClass(\"hidden\");\n}\n\nexport function nodeclick(node) {\n\t$('form > fieldset').prop('disabled', false);\n\t// clear values\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\n\t$('#person_details select').val('').prop('selected', true);\n\n\t// assign values to input fields in form\n\tif(node.sex === 'M' || node.sex === 'F')\n\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\n\telse\n\t\t$('input[name=sex]').prop('checked', false);\n\tupdate_cancer_by_sex(node);\n\n\tif(!('status' in node))\n\t\tnode.status = 0;\n\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\n\t// show lock symbol for age and yob synchronisation\n\tupdateStatus(node.status);\n\n\tif('proband' in node) {\n\t\t$('#id_proband').prop('checked', node.proband);\n\t\t$('#id_proband').prop(\"disabled\", true);\n\t} else {\n\t\t$('#id_proband').prop('checked', false);\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\n\t}\n\n\tif('exclude' in node) {\n\t\t$('#id_exclude').prop('checked', node.exclude);\n\t} else {\n\t\t$('#id_exclude').prop('checked', false);\n\t}\n\n/*\t\tif('ashkenazi' in node) {\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\n\t\t} else {\n\t\t\t$('#id_ashkenazi').prop('checked', false);\n\t\t}*/\n\n\t// year of birth\n\tif('yob' in node) {\n\t\t$('#id_yob_0').val(node.yob);\n\t} else {\n\t\t$('#id_yob_0').val('-');\n\t}\n\n\t// clear pathology\n\t$('select[name$=\"_bc_pathology\"]').val('-');\n\t// clear gene tests\n\t$('select[name*=\"_gene_test\"]').val('-');\n\n\t// disable sex radio buttons if the person has a partner\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\n\n\t// disable pathology for male relatives (as not used by model)\n\t// and if no breast cancer age of diagnosis\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\n\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\n\n\t// approximate diagnosis age\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\n\tupdate_diagnosis_age_widget();\n\n\tfor(let key in node) {\n\t\tif(key !== 'proband' && key !== 'sex') {\n\t\t\tif($('#id_'+key).length) {\t// input value\n\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\n\t\t\t\t\t$('#id_'+key).val(node[key].type);\n\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key).val(node[key]);\n\t\t\t\t}\n\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\n\t\t\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n}\n\nfunction update_ashkn(newdataset) {\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tif($('#orig_ashk').is(':checked')) {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tif(p.proband)\n\t\t\t\tp.ashkenazi = 1;\n\t\t});\n\t} else {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tdelete p.ashkenazi;\n\t\t});\n\t}\n}\n\n// Save Ashkenazi status\nexport function save_ashkn(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet newdataset = copy_dataset(dataset);\n\tupdate_ashkn(newdataset);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\nexport function save(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet name = $('#id_name').val();\n\tlet newdataset = copy_dataset(dataset);\n\tlet person = getNodeByName(newdataset, name);\n\tif(!person) {\n\t\tconsole.warn('person not found when saving details');\n\t\treturn;\n\t}\n\t$(\"#\"+opts.targetDiv).empty();\n\n\t// individual's personal and clinical details\n\tlet yob = $('#id_yob_0').val();\n\tif(yob && yob !== '') {\n\t\tperson.yob = yob;\n\t} else {\n\t\tdelete person.yob;\n\t}\n\n\t// current status: 0 = alive, 1 = dead\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\n\tif(status.length > 0){\n\t\tperson.status = status.val();\n\t}\n\n\t// booleans switches\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tlet s = $('#id_'+attr);\n\t\tif(s.length > 0){\n\t\t\tconsole.log(s.is(\":checked\"));\n\t\t\tif(s.is(\":checked\"))\n\t\t\t\tperson[attr] = true;\n\t\t\telse\n\t\t\t\tdelete person[attr];\n\t\t}\n\t}\n\n\t// current sex\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\n\tif(sex.length > 0){\n\t\tperson.sex = sex.val();\n\t\tupdate_cancer_by_sex(person);\n\t}\n\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tupdate_ashkn(newdataset);\n\n\tif($('#id_approx').is(':checked')) // approximate diagnosis age\n\t\tperson.approx_diagnosis_age = true;\n\telse\n\t\tdelete person.approx_diagnosis_age;\n\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\n\n\t\tif($(this).val()) {\n\t\t\tlet val = $(this).val();\n\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\n\t\t\t\tval = round5(val);\n\t\t\tperson[name] = val;\n\t\t} else {\n\t\t\tdelete person[name];\n\t\t}\n\t});\n\n\t// cancer checkboxes\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\n\t\tif(this.checked)\n\t\t\tperson[$(this).attr('name')] = true;\n\t\telse\n\t\t\tdelete person[$(this).attr('name')];\n\t});\n\n\t// pathology tests\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tperson[$(this).attr('name')] = $(this).val();\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// genetic tests\n\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tlet tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\n\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n\n\tsyncTwins(newdataset, person);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\nexport function update_diagnosis_age_widget() {\n\tif($(\"#id_approx\").is(':checked')) {\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\n\t} else {\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\n\t}\n}\n\n// males should not have ovarian cancer and females should not have prostate cancer\nfunction update_cancer_by_sex(node) {\n\t$('#cancer .row').show();\n\tif(node.sex === 'M') {\n\t\tdelete node.ovarian_cancer_diagnosis_age;\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\n\t} else if(node.sex === 'F') {\n\t\tdelete node.prostate_cancer_diagnosis_age;\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\n\t}\n}\n\n// round to 5, 15, 25, 35 ....\nfunction round5(x1) {\n\tlet x2 = (Math.round((x1-1) / 10) * 10);\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\n}\n\n","// pedigree widgets\nimport {addsibling, addchild, addparents, addpartner, rebuild, delete_node_dataset} from './pedigree.js';\nimport {copy_dataset, makeid, getIdxByName} from './pedigree_utils.js';\nimport {save} from './pedigree_form.js';\nimport {current as pedcache_current} from './pedcache.js';\n\nlet dragging;\nlet last_mouseover;\n//\n// Add widgets to nodes and bind events\nexport function addWidgets(opts, node) {\n\n\t// popup gender selection box\n\tlet font_size = parseInt($(\"body\").css('font-size'));\n\tlet popup_selection = d3.select('.diagram');\n\tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\n\t\t\t\t\t\t\t.attr(\"rx\", 6)\n\t\t\t\t\t\t\t.attr(\"ry\", 6)\n\t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t\t\t\t\t.style(\"opacity\", 0)\n\t\t\t\t\t\t\t.attr(\"width\",  font_size*7.9)\n\t\t\t\t\t\t\t.attr(\"height\", font_size*2)\n\t\t\t\t\t\t\t.style(\"stroke\", \"darkgrey\")\n\t\t\t\t\t\t\t.attr(\"fill\", \"white\");\n\n\tlet square = popup_selection.append(\"text\")  // male\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.attr('font-size', '1.em' )\n\t\t.attr(\"class\", \"popup_selection fa-lg fa-square persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size/3)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf096 \");\n\tlet square_title = square.append(\"svg:title\").text(\"add male\");\n\n\tlet circle = popup_selection.append(\"text\")  // female\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.attr('font-size', '1.em' )\n\t\t.attr(\"class\", \"popup_selection fa-lg fa-circle persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size*1.7)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf10c \");\n\tlet circle_title = circle.append(\"svg:title\").text(\"add female\");\n\n\tlet unspecified = popup_selection.append(\"text\")  // unspecified\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.attr('font-size', '1.em' )\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"class\", \"popup_selection fa-lg fa-unspecified popup_selection_rotate45 persontype\")\n\t\t.text(\"\\uf096 \");\n\tunspecified.append(\"svg:title\").text(\"add unspecified\");\n\n\tlet dztwin = popup_selection.append(\"text\")  // dizygotic twins\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"class\", \"popup_selection fa-2x fa-angle-up persontype dztwin\")\n\t\t.attr(\"x\", font_size*4.6)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf106 \");\n\tdztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\n\n\tlet mztwin = popup_selection.append(\"text\")  // monozygotic twins\n\t.attr('font-family', 'FontAwesome')\n\t.style(\"opacity\", 0)\n\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t.attr(\"class\", \"popup_selection fa-2x fa-caret-up persontype mztwin\")\n\t.attr(\"x\", font_size*6.2)\n\t.attr(\"y\", font_size*1.5)\n\t.text(\"\\uf0d8\");\n\tmztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\n\n\tlet add_person = {};\n\t// click the person type selection\n\td3.selectAll(\".persontype\")\n\t  .on(\"click\", function () {\n\t\tlet newdataset = copy_dataset(pedcache_current(opts));\n\t\tlet mztwin = d3.select(this).classed(\"mztwin\");\n\t\tlet dztwin = d3.select(this).classed(\"dztwin\");\n\t\tlet twin_type;\n\t\tlet sex;\n\t\tif(mztwin || dztwin) {\n\t\t\tsex = add_person.node.datum().data.sex;\n\t\t\ttwin_type = (mztwin ? \"mztwin\" : \"dztwin\");\n\t\t} else {\n\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\n\t\t}\n\n\t\tif(add_person.type === 'addsibling')\n\t\t\taddsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\n\t\telse if(add_person.type === 'addchild')\n\t\t\taddchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\n\t\telse\n\t\t\treturn;\n\t\topts.dataset = newdataset;\n\t\trebuild(opts);\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\tadd_person = {};\n\t  })\n\t  .on(\"mouseover\", function() {\n\t\t  if(add_person.node)\n\t\t\t  add_person.node.select('rect').style(\"opacity\", 0.2);\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t  // add tooltips to font awesome widgets\n\t\t  if(add_person.type === 'addsibling'){\n\t\t\t if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add brother\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add sister\");\n\t\t  } else if(add_person.type === 'addchild'){\n\t\t\t  if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add son\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add daughter\");\n\t\t  }\n\t  });\n\n\t// handle mouse out of popup selection\n\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\n\t\t// hide rect and popup selection\n\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) == -1)\n\t\t\tadd_person.node.select('rect').style(\"opacity\", 0);\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t});\n\n\n\t// drag line between nodes to create partners\n\tdrag_handle(opts);\n\n\t// rectangle used to highlight on mouse over\n\tnode.append(\"rect\")\n\t\t.filter(function (d) {\n\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\n\t\t})\n\t\t.attr(\"class\", 'indi_rect')\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.attr(\"x\", function(_d) { return - 0.75*opts.symbol_size; })\n\t\t.attr(\"y\", function(_d) { return - opts.symbol_size; })\n\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\n\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\n\t\t.style(\"stroke\", \"black\")\n\t\t.style(\"stroke-width\", 0.7)\n\t\t.style(\"opacity\", 0)\n\t\t.attr(\"fill\", \"lightgrey\");\n\n\t// widgets\n\tlet fx = function(_d) {return off - 0.75*opts.symbol_size;};\n\tlet fy = opts.symbol_size -2;\n\tlet off = 0;\n\tlet widgets = {\n\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\n\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\n\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\n\t\t'addparents': {\n\t\t\t'text': '\\uf062', 'title': 'add parents',\n\t\t\t'fx': - 0.75*opts.symbol_size,\n\t\t\t'fy': - opts.symbol_size + 11\n\t\t},\n\t\t'delete': {\n\t\t\t'text': 'X', 'title': 'delete',\n\t\t\t'fx': opts.symbol_size/2 - 1,\n\t\t\t'fy': - opts.symbol_size + 12,\n\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\n\t\t}\n\t};\n\n\tif(opts.edit) {\n\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': -font_size/2+2, 'fy': -opts.symbol_size + 11};\n\t}\n\n\tfor(let key in widgets) {\n\t\tlet widget = node.append(\"text\")\n\t\t\t.filter(function (d) {\n\t\t\t\treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\n\t\t\t\t\t\t!((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\n\t\t\t\t\t\t!(d.data.parent_node !== undefined && d.data.parent_node.length > 1 && key === 'addpartner') &&\n\t\t\t\t\t\t!(d.data.parent_node === undefined && key === 'addchild') &&\n\t\t\t\t\t\t!((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\n\t\t\t})\n\t\t\t.attr(\"class\", key)\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.attr(\"xx\", function(d){return d.x;})\n\t\t\t.attr(\"yy\", function(d){return d.y;})\n\t\t\t.attr(\"x\", widgets[key].fx)\n\t\t\t.attr(\"y\", widgets[key].fy)\n\t\t\t.attr('font-size', '0.9em' )\n\t\t\t.text(widgets[key].text);\n\n\t\tif('styles' in widgets[key])\n\t\t\tfor(let style in widgets[key].styles){\n\t\t\t\twidget.attr(style, widgets[key].styles[style]);\n\t\t\t}\n\n\t\twidget.append(\"svg:title\").text(widgets[key].title);\n\t\toff += 17;\n\t}\n\n\t// add sibling or child\n\td3.selectAll(\".addsibling, .addchild\")\n\t  .on(\"mouseover\", function () {\n\t\t  let type = d3.select(this).attr('class');\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\n\n\t\t  //let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\n\t\t  let x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\n\t\t  let y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\n\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\n\t\t  d3.selectAll('.popup_selection_rotate45')\n\t\t\t.attr(\"transform\", \"translate(\"+(x+3*font_size)+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\n\t  });\n\n\t// handle widget clicks\n\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\n\t  .on(\"click\", function () {\n\t\t  d3.event.stopPropagation();\n\t\tlet opt = d3.select(this).attr('class');\n\t\tlet d = d3.select(this.parentNode).datum();\n\t\tif(opts.DEBUG) {\n\t\t\tconsole.log(opt);\n\t\t}\n\n\t\tlet newdataset;\n\t\tif(opt === 'settings') {\n\t\t\tif(typeof opts.edit === 'function') {\n\t\t\t\topts.edit(opts, d);\n\t\t\t} else {\n\t\t\t\topenEditDialog(opts, d);\n\t\t\t}\n\t\t} else if(opt === 'delete') {\n\t\t\tnewdataset = copy_dataset(pedcache_current(opts));\n\t\t\tdelete_node_dataset(newdataset, d.data, opts, onDone);\n\t\t} else if(opt === 'addparents') {\n\t\t\tnewdataset = copy_dataset(pedcache_current(opts));\n\t\t\topts.dataset = newdataset;\n\t\t\taddparents(opts, newdataset, d.data.name);\n\t\t\trebuild(opts);\n\t\t} else if(opt === 'addpartner') {\n\t\t\tnewdataset = copy_dataset(pedcache_current(opts));\n\t\t\taddpartner(opts, newdataset, d.data.name);\n\t\t\topts.dataset = newdataset;\n\t\t\trebuild(opts);\n\t\t}\n\t\t// trigger fhChange event\n\t\t$(document).trigger('fhChange', [opts]);\n\t});\n\n\t// other mouse events\n\tlet highlight = [];\n\n\tnode.filter(function (d) { return !d.data.hidden; })\n\t.on(\"click\", function (d) {\n\t\tif (d3.event.ctrlKey) {\n\t\t\tif(highlight.indexOf(d) == -1)\n\t\t\t\thighlight.push(d);\n\t\t\telse\n\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\n\t\t} else\n\t\t\thighlight = [d];\n\n\t\tif('nodeclick' in opts) {\n\t\t\topts.nodeclick(d.data);\n\t\t\td3.selectAll(\".indi_rect\").style(\"opacity\", 0);\n\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) != -1;}).style(\"opacity\", 0.5);\n\t\t}\n\t})\n\t.on(\"mouseover\", function(d){\n\t\td3.event.stopPropagation();\n\t\tlast_mouseover = d;\n\t\tif(dragging) {\n\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\n\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\n\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 1);\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 0);\n\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\n\t})\n\t.on(\"mouseout\", function(d){\n\t\tif(dragging)\n\t\t\treturn;\n\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 0);\n\t\tif(highlight.indexOf(d) == -1)\n\t\t\td3.select(this).select('rect').style(\"opacity\", 0);\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 1);\n\t\t// hide popup if it looks like the mouse is moving north\n\t\tlet xcoord = d3.mouse(this)[0];\n\t\tlet ycoord = d3.mouse(this)[1];\n\t\tif(ycoord < 0.8*opts.symbol_size)\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\tif(!dragging) {\n\t\t\t// hide popup if it looks like the mouse is moving north, south or west\n\t\t\tif( Math.abs(ycoord) > 0.25*opts.symbol_size ||\n\t\t\t\tMath.abs(ycoord) < -0.25*opts.symbol_size ||\n\t\t\t\txcoord < 0.2*opts.symbol_size){\n\t\t\t\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\t\t}\n        }\n\t});\n}\n\nfunction onDone(opts, dataset) {\n\t// assign new dataset and rebuild pedigree\n\topts.dataset = dataset;\n\trebuild(opts);\n}\n\n// drag line between nodes to create partners\nfunction drag_handle(opts) {\n\tlet line_drag_selection = d3.select('.diagram');\n\tlet dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\n        .attr(\"stroke-width\", 6)\n        .style(\"stroke-dasharray\", (\"2, 1\"))\n        .attr(\"stroke\",\"black\")\n        .call(d3.drag()\n                .on(\"start\", dragstart)\n                .on(\"drag\", drag)\n                .on(\"end\", dragstop));\n\tdline.append(\"svg:title\").text(\"drag to create consanguineous partners\");\n\n\tsetLineDragPosition(0, 0, 0, 0);\n\n\tfunction dragstart() {\n\t\tdragging = last_mouseover;\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"darkred\");\n\t}\n\n\tfunction dragstop(_d) {\n\t\tif(last_mouseover &&\n\t\t   dragging.data.name !== last_mouseover.data.name &&\n\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\n\t\t\t// make partners\n\t\t\tlet child = {\"name\": makeid(4), \"sex\": 'U',\n\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\n\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\n\t\t\tlet newdataset = copy_dataset(opts.dataset);\n\t\t\topts.dataset = newdataset;\n\n\t\t\tlet idx = getIdxByName(opts.dataset, dragging.data.name)+1;\n\t\t\topts.dataset.splice(idx, 0, child);\n\t\t\trebuild(opts);\n\t\t}\n\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"black\");\n\t\tdragging = undefined;\n\t\treturn;\n\t}\n\n\tfunction drag(_d) {\n\t\td3.event.sourceEvent.stopPropagation();\n\t\tlet dx = d3.event.dx;\n\t\tlet dy = d3.event.dy;\n        let xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\n        let ynew = parseFloat(d3.select(this).attr('y2'))+ dy;\n        setLineDragPosition(opts.symbol_size-10, 0, xnew, ynew);\n\t}\n}\n\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\n\tif(translate)\n\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\n\td3.selectAll('.line_drag_selection')\n\t\t.attr(\"x1\", x1)\n\t\t.attr(\"y1\", y1)\n\t\t.attr(\"x2\", x2)\n\t\t.attr(\"y2\", y2);\n}\n\nfunction capitaliseFirstLetter(string) {\n    return string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\nfunction openEditDialog(opts, d) {\n\t$('#node_properties').dialog({\n\t    autoOpen: false,\n\t    title: d.data.display_name,\n\t    width: ($(window).width() > 400 ? 450 : $(window).width()- 30)\n\t});\n\n\tlet table = \"<table id='person_details' class='table'>\";\n\n\ttable += \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\"+\n\t(d.data.name ? d.data.name : \"\")+\"></td></tr>\";\n\ttable += \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\"+\n\t\t\t(d.data.display_name ? d.data.display_name : \"\")+\"></td></tr>\";\n\n\ttable += \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value=\"+\n\t\t\t(d.data.age ? d.data.age : \"\")+\"></td></tr>\";\n\n\ttable += \"<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value=\"+\n\t\t(d.data.yob ? d.data.yob : \"\")+\"></td></tr>\";\n\n\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" '+(d.data.sex === 'M' ? \"checked\" : \"\")+'>Male</label>' +\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" '+(d.data.sex === 'F' ? \"checked\" : \"\")+'>Female</label>' +\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"U\">Unknown</label>' +\n\t\t\t '</td></tr>';\n\n\t// alive status = 0; dead status = 1\n\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" '+(parseInt(d.data.status) === 0 ? \"checked\" : \"\")+'>&thinsp;Alive</label>' +\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" '+(parseInt(d.data.status) === 1 ? \"checked\" : \"\")+'>&thinsp;Deceased</label>' +\n\t\t\t '</td></tr>';\n\t$(\"#id_status input[value='\"+d.data.status+\"']\").prop('checked', true);\n\n\t// switches\n\tlet switches = [\"adopted_in\", \"adopted_out\", \"miscarriage\", \"stillbirth\", \"termination\"];\n\ttable += '<tr><td colspan=\"2\"><strong>Reproduction:</strong></td></tr>';\n\ttable += '<tr><td colspan=\"2\">';\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tif(iswitch === 2)\n\t\t\ttable += '</td></tr><tr><td colspan=\"2\">';\n\t\ttable +=\n\t\t '<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"id_'+attr +\n\t\t    '\" name=\"'+attr+'\" value=\"0\" '+(d.data[attr] ? \"checked\" : \"\")+'>&thinsp;' +\n\t\t    capitaliseFirstLetter(attr.replace('_', ' '))+'</label>'\n\t}\n\ttable += '</td></tr>';\n\n\t//\n\tlet exclude = [\"children\", \"name\", \"parent_node\", \"top_level\", \"id\", \"noparents\",\n\t\t           \"level\", \"age\", \"sex\", \"status\", \"display_name\", \"mother\", \"father\",\n\t\t           \"yob\", \"mztwin\", \"dztwin\"];\n\t$.merge(exclude, switches);\n\ttable += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\n\t$.each(opts.diseases, function(k, v) {\n\t\texclude.push(v.type+\"_diagnosis_age\");\n\n\t\tlet disease_colour = '&thinsp;<span style=\"padding-left:5px;background:'+opts.diseases[k].colour+'\"></span>';\n\t\tlet diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\n\n\t\ttable += \"<tr><td style='text-align:right'>\"+capitaliseFirstLetter(v.type.replace(\"_\", \" \"))+\n\t\t\t\t\tdisease_colour+\"&nbsp;</td><td>\" +\n\t\t\t\t\t\"<input class='form-control' id='id_\" +\n\t\t\t\t\tv.type + \"_diagnosis_age_0' max='110' min='0' name='\" +\n\t\t\t\t\tv.type + \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\n\t\t\t\t\t(diagnosis_age !== undefined ? diagnosis_age : \"\") +\"'></td></tr>\";\n\t});\n\n\ttable += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\n\t$.each(d.data, function(k, v) {\n\t\tif($.inArray(k, exclude) == -1) {\n\t\t\tlet kk = capitaliseFirstLetter(k);\n\t\t\tif(v === true || v === false) {\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='checkbox' id='id_\" + k + \"' name='\" +\n\t\t\t\t\t\tk+\"' value=\"+v+\" \"+(v ? \"checked\" : \"\")+\"></td></tr>\";\n\t\t\t} else if(k.length > 0){\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='text' id='id_\" +\n\t\t\t\t\t\tk+\"' name='\"+k+\"' value=\"+v+\"></td></tr>\";\n\t\t\t}\n\t\t}\n    });\n\ttable += \"</table>\";\n\n\t$('#node_properties').html(table);\n\t$('#node_properties').dialog('open');\n\n\t$('#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]').change(function() {\n\t\tsave(opts);\n    });\n\treturn;\n}\n","// Pedigree Tree Builder\nimport  * as pedigree_utils from './pedigree_utils.js';\nimport * as pbuttons from './pbuttons.js';\nimport * as pedcache from './pedcache.js';\nimport * as io from './io.js';\nimport {addWidgets} from './widgets.js';\nimport {get_zoom, set_initial_xy} from './zoom.js';\n\nexport let roots = {};\n\nexport function build(options) {\n\tlet opts = $.extend({ // defaults\n\t\ttargetDiv: 'pedigree_edit',\n\t\tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\n\t\twidth: 600,\n\t\theight: 400,\n\t\tsymbol_size: 35,\n\t\tzoomSrc: ['wheel', 'button'],\n\t\tzoomIn: 1.0,\n\t\tzoomOut: 1.0,\n\t\tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\n\t\t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\n\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#4DAA4D'},\n\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\n\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\n\t\tlabels: ['stillbirth', 'age', 'yob', 'alleles'],\n\t\tkeep_proband_on_reset: false,\n\t\tfont_size: '.75em',\n\t\tfont_family: 'Helvetica',\n\t\tfont_weight: 700,\n\t\tbackground: \"#EEE\",\n\t\tnode_background: '#fdfdfd',\n\t\tvalidate: true,\n\t\tDEBUG: false}, options );\n\n\tif ( $( \"#fullscreen\" ).length === 0 ) {\n\t\t// add undo, redo, fullscreen buttons and event listeners once\n\t\tpbuttons.add(opts);\n\t\tio.add(opts);\n\t}\n\n\tif(pedcache.nstore(opts) == -1)\n\t\tpedcache.init_cache(opts);\n\n\tpbuttons.updateButtons(opts);\n\n\t// validate pedigree data\n\tvalidate_pedigree(opts);\n\t// group top level nodes by partners\n\topts.dataset = group_top_level(opts.dataset);\n\n\tif(opts.DEBUG)\n\t\tpedigree_utils.print_opts(opts);\n\tlet svg_dimensions = get_svg_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv)\n\t\t\t\t .append(\"svg:svg\")\n\t\t\t\t .attr(\"width\", svg_dimensions.width)\n\t\t\t\t .attr(\"height\", svg_dimensions.height);\n\n\tsvg.append(\"rect\")\n\t\t.attr(\"width\", \"100%\")\n\t\t.attr(\"height\", \"100%\")\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.style(\"stroke\", \"darkgrey\")\n\t\t.style(\"fill\", opts.background) // or none\n\t\t.style(\"stroke-width\", 1);\n\n\tlet xytransform = pedcache.getposition(opts);  // cached position\n\tlet xtransform = xytransform[0];\n\tlet ytransform = xytransform[1];\n\tlet k = 1;\n\tif(xytransform.length == 3){\n\t\tk = xytransform[2];\n\t}\n\n\tif(xtransform === null || ytransform === null) {\n\t\txtransform = opts.symbol_size/2;\n\t\tytransform = (-opts.symbol_size*2.5);\n\t\tpedcache.setposition(opts, xtransform, ytransform);\n\t}\n\tset_initial_xy(opts);\n\t\n\tlet ped = svg.append(\"g\")\n\t\t\t .attr(\"class\", \"diagram\")\n\t\t\t .attr(\"transform\", \"translate(\"+xtransform+\",\" + ytransform + \") scale(\"+k+\")\");\n\n\tlet top_level = $.map(opts.dataset, function(val, _i){return 'top_level' in val && val.top_level ? val : null;});\n\tlet hidden_root = {\n\t\tname : 'hidden_root',\n\t\tid : 0,\n\t\thidden : true,\n\t\tchildren : top_level\n\t};\n\n\tlet partners = pedigree_utils.buildTree(opts, hidden_root, hidden_root)[0];\n\tlet root = d3.hierarchy(hidden_root);\n\troots[opts.targetDiv] = root;\n\n\t// / get score at each depth used to adjust node separation\n\tlet tree_dimensions = get_tree_dimensions(opts);\n\tif(opts.DEBUG)\n\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\n\t\t\t\t\t' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\n\n\tlet treemap = d3.tree().separation(function(a, b) {\n\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? 1.2 : 2.2;\n\t}).size([tree_dimensions.width, tree_dimensions.height]);\n\n\tlet nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\n\tlet flattenNodes = nodes.descendants();\n\n\t// check the number of visible nodes equals the size of the pedigree dataset\n\tlet vis_nodes = $.map(opts.dataset, function(p, _i){return p.hidden ? null : p;});\n\tif(vis_nodes.length != opts.dataset.length) {\n\t\tthrow create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\n\t}\n\n\tpedigree_utils.adjust_coords(opts, nodes, flattenNodes);\n\n\tlet ptrLinkNodes = pedigree_utils.linkNodes(flattenNodes, partners);\n\tcheck_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines\n\n\tlet node = ped.selectAll(\".node\")\n\t\t\t\t  .data(nodes.descendants())\n\t\t\t\t  .enter()\n\t\t\t\t  .append(\"g\")\n\t\t\t\t\t.attr(\"transform\", function(d, _i) {\n\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\n\t\t\t\t\t});\n\n\t// provide a border to the node\n\tnode.append(\"path\")\n\t\t.filter(function (d) {return !d.data.hidden;})\n\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\n\t\t.attr(\"transform\", function(d) {return d.data.sex == \"U\" && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(_d) { return (opts.symbol_size * opts.symbol_size) + 2;})\n\t\t\t\t.type(function(d) {\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\t\treturn d.data.sex == \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t})\n\t\t.style(\"stroke-width\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".3em\" : \".1em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\t// set a clippath\n\tnode.append(\"clipPath\")\n\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\n\t\t.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\n\t\t.attr(\"class\", \"node\")\n\t\t.attr(\"transform\", function(d) {return d.data.sex == \"U\" && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(d) {\n\t\t\t\tif (d.data.hidden)\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\n\t\t\t})\n\t\t\t.type(function(d) {\n\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\treturn d.data.sex == \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\n\n\t// pie plots for disease colours\n\tlet pienode = node.selectAll(\"pienode\")\n\t   .data(function(d) {\t \t\t// set the disease data for the pie plot\n\t\t   let ncancers = 0;\n\t\t   let cancers = $.map(opts.diseases, function(_val, i){\n\t\t\t   if(prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\n\t\t   });\n\t\t   if(ncancers === 0) cancers = [1];\n\t\t   return [$.map(cancers, function(val, _i){\n\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\n\t\t\t\t\t\t'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\n\t\t\t\t\t\t'affected': d.data.affected,\n\t\t\t\t\t\t'exclude': d.data.exclude};})];\n\t   })\n\t   .enter()\n\t\t.append(\"g\");\n\n\tpienode.selectAll(\"path\")\n\t\t.data(d3.pie().value(function(d) {return d.cancer;}))\n\t\t.enter().append(\"path\")\n\t\t\t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\n\t\t\t.attr(\"class\", \"pienode\")\n\t\t\t.attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\n\t\t\t.style(\"fill\", function(d, i) {\n\t\t\t\tif(d.data.exclude)\n\t\t\t\t\treturn 'lightgrey';\n\t\t\t\tif(d.data.ncancers === 0) {\n\t\t\t\t\tif(d.data.affected)\n\t\t\t\t\t\treturn 'darkgrey';\n\t\t\t\t\treturn opts.node_background;\n\t\t\t\t}\n\t\t\t\treturn opts.diseases[i].colour;\n\t\t\t});\n\n\t// adopted in/out brackets\n\tnode.append(\"path\")\n\t\t.filter(function (d) {return !d.data.hidden && (d.data.adopted_in || d.data.adopted_out);})\n\t\t.attr(\"d\", function(_d) { {\n\t\t\tlet dx = -(opts.symbol_size * 0.66);\n\t\t\tlet dy = -(opts.symbol_size * 0.64);\n\t\t\tlet indent = opts.symbol_size/4;\n\t\t\treturn get_bracket(dx, dy, indent, opts)+get_bracket(-dx, dy, -indent, opts);\n\t\t\t}})\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t})\n\t\t.style(\"stroke-width\", function (_d) {\n\t\t\treturn \".1em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\n\t// alive status = 0; dead status = 1\n\tnode.append('line')\n\t\t.filter(function (d) {return d.data.status == 1;})\n\t\t\t.style(\"stroke\", \"black\")\n\t\t\t.attr(\"x1\", function(_d, _i) {return -0.6*opts.symbol_size;})\n\t\t\t.attr(\"y1\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"x2\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"y2\", function(_d, _i) {return -0.6*opts.symbol_size;});\n\n\t// names of individuals\n\taddLabel(opts, node, -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\n\t\t\tfunction(d) {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\n\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';});\n\n/*\n * let warn = node.filter(function (d) { return (!d.data.age || !d.data.yob) && !d.data.hidden; }).append(\"text\") .attr('font-family', 'FontAwesome')\n * .attr(\"x\", \".25em\") .attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size)) .html(\"\\uf071\"); warn.append(\"svg:title\").text(\"incomplete\");\n */\n\n\tlet font_size = parseInt(getPx(opts)) + 4;\n\t// display label defined in opts.labels e.g. alleles/genotype data\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\taddLabel(opts, node, -(0.7 * opts.symbol_size),\n\t\t\tfunction(d) {\n\t\t\t\tif(!d.data[label])\n\t\t\t\t\treturn;\n\t\t\t\td.y_offset = (ilab === 0 || !d.y_offset ? font_size*2.25 : d.y_offset+font_size);\n\t\t\t\treturn d.y_offset;\n\t\t\t},\n\t\t\tfunction(d) {\n\t\t\t\tif(d.data[label]) {\n\t\t\t\t\tif(label === 'alleles') {\n\t\t\t\t\t\tlet alleles = \"\";\n\t\t\t\t\t\tlet vars = d.data.alleles.split(';');\n\t\t\t\t\t\tfor(let ivar = 0;ivar < vars.length;ivar++) {\n\t\t\t\t\t\t\tif(vars[ivar] !== \"\") alleles += vars[ivar] + ';';\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn alleles;\n\t\t\t\t\t} else if(label === 'age') {\n\t\t\t\t\t\treturn d.data[label] +'y';\n\t\t\t\t\t} else if(label === 'stillbirth') {\n\t\t\t\t\t\treturn \"SB\";\n\t\t\t\t\t}\n\t\t\t\t\treturn d.data[label];\n\t\t\t\t}\n\t\t\t}, 'indi_details');\n\t}\n\n\t// individuals disease details\n\tfor(let i=0;i<opts.diseases.length; i++) {\n\t\tlet disease = opts.diseases[i].type;\n\t\taddLabel(opts, node, -(opts.symbol_size),\n\t\t\t\tfunction(d) {\n\t\t\t\t\tlet y_offset = (d.y_offset ? d.y_offset+font_size: font_size*2.2);\n\t\t\t\t\tfor(let j=0;j<opts.diseases.length; j++) {\n\t\t\t\t\t\tif(disease === opts.diseases[j].type)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tif(prefixInObj(opts.diseases[j].type, d.data))\n\t\t\t\t\t\t\ty_offset += font_size-1;\n\t\t\t\t\t}\n\t\t\t\t\treturn y_offset;\n\t\t\t\t},\n\t\t\t\tfunction(d) {\n\t\t\t\t\tlet dis = disease.replace('_', ' ').replace('cancer', 'ca.');\n\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\n\t\t\t\t}, 'indi_details');\n\t}\n\n\t//\n\taddWidgets(opts, node);\n\n\t// links between partners\n\tlet clash_depth = {};\n\n\t// get path looping over node(s)\n\tlet draw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\n\t\tlet extend = function(i, l) {\n\t\t\tif(i+1 < l)   // && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\n\t\t\t\treturn extend(++i);\n\t\t\treturn i;\n\t\t};\n\t\tlet path = \"\";\n\t\tfor(let j=0; j<clash.length; j++) {\n\t\t\tlet k = extend(j, clash.length);\n\t\t\tlet dx1 = clash[j] - dx - cshift;\n\t\t\tlet dx2 = clash[k] + dx + cshift;\n\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\n\t\t\t\tparent_node.y = dy2;\n\n\t\t\tpath += \"L\" + dx1 + \",\" +  (dy1 - cshift) +\n\t\t\t\t\t\"L\" + dx1 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy1 - cshift);\n\t\t\tj = k;\n\t\t}\n\t\treturn path;\n\t}\n\n\n\tpartners = ped.selectAll(\".partner\")\n\t\t.data(ptrLinkNodes)\n\t\t.enter()\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke\", \"#000\")\n\t\t\t.attr(\"shape-rendering\", \"auto\")\n\t\t\t.attr('d', function(d, _i) {\n\t\t\t\tlet node1 = pedigree_utils.getNodeByName(flattenNodes, d.mother.data.name);\n\t\t\t\tlet node2 = pedigree_utils.getNodeByName(flattenNodes, d.father.data.name);\n\t\t\t\tlet consanguity = pedigree_utils.consanguity(node1, node2, opts);\n\t\t\t\tlet divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\n\n\t\t\t\tlet x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\n\t\t\t\tlet x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\n\t\t\t\tlet dy1 = d.mother.y;\n\t\t\t\tlet dy2, dx, parent_node;\n\n\t\t\t\t// identify clashes with other nodes at the same depth\n\t\t\t\tlet clash = check_ptr_link_clashes(opts, d);\n\t\t\t\tlet path = \"\";\n\t\t\t\tif(clash) {\n\t\t\t\t\tif(d.mother.depth in clash_depth)\n\t\t\t\t\t\tclash_depth[d.mother.depth] += 4;\n\t\t\t\t\telse\n\t\t\t\t\t\tclash_depth[d.mother.depth] = 4;\n\n\t\t\t\t\tdy1 -= clash_depth[d.mother.depth];\n\t\t\t\t\tdx = clash_depth[d.mother.depth] + opts.symbol_size/2 + 2;\n\n\t\t\t\t\tlet parent_nodes = d.mother.data.parent_node;\n\t\t\t\t\tlet parent_node_name = parent_nodes[0];\n\t\t\t\t\tfor(let ii=0; ii<parent_nodes.length; ii++) {\n\t\t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\n\t\t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\n\t\t\t\t\t\t\tparent_node_name = parent_nodes[ii].name;\n\t\t\t\t\t}\n\t\t\t\t\tparent_node = pedigree_utils.getNodeByName(flattenNodes, parent_node_name);\n\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\n\t\t\t\t\tclash.sort(function (a,b) {return a - b;});\n\n\t\t\t\t\tdy2 = (dy1-opts.symbol_size/2-3);\n\t\t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\n\t\t\t\t}\n\n\t\t\t\tlet divorce_path = \"\";\n\t\t\t\tif(divorced && !clash)\n\t\t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-6) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+6) +\n\t\t\t\t\t\t\t\t   \"M\" + (x1+((x2-x1)*.66)+10) + \",\" + (dy1-6) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-2)  + \",\" + (dy1+6);\n\t\t\t\tif(consanguity) {  // consanguinous, draw double line between partners\n\t\t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\n\t\t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\n\n\t\t\t\t\tlet cshift = 3;\n\t\t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {\t  // DIFFERENT LEVEL\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\n\t\t\t\t\t} else {\t\t\t\t\t\t   // SAME LEVEL\n\t\t\t\t\t\tlet path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\n\t\t\t});\n\n\t// links to children\n\tped.selectAll(\".link\")\n\t\t.data(root.links(nodes.descendants()))\n\t\t.enter()\n\t\t\t.filter(function (d) {\n\t\t\t\t// filter unless debug is set\n\t\t\t\treturn (opts.DEBUG ||\n\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\n\t\t\t})\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke-width\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 1;\n\t\t\t\treturn (opts.DEBUG ? 2 : 1);\n\t\t\t})\n\t\t\t.attr(\"stroke\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 'pink';\n\t\t\t\treturn \"#000\";\n\t\t\t})\n\t\t\t.attr(\"stroke-dasharray\", function(d, _i) {\n\t\t\t\tif(!d.target.data.adopted_in) return null;\n\t\t\t\tlet dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\n\t\t\t\tlet dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\n\t\t\t\tlet twins = pedigree_utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\n\t\t\t\tfor(let usedlen = 0; usedlen < dash_len; usedlen += 10)\n\t\t\t\t\t$.merge(dash_array, [5, 5]);\n\t\t\t\treturn dash_array;\n\t\t\t})\n\t\t\t.attr(\"shape-rendering\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\n\t\t\t\t\treturn \"geometricPrecision\";\n\t\t\t\treturn \"auto\";\n\t\t\t})\n\t\t\t.attr(\"d\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\n\t\t\t\t\t// get twin position\n\t\t\t\t\tlet twins = pedigree_utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\t\tif(twins.length >= 1) {\n\t\t\t\t\t\tlet twinx = 0;\n\t\t\t\t\t\tlet xmin = d.target.x;\n\t\t\t\t\t\tlet xmax = d.target.x;\n\t\t\t\t\t\tfor(let t=0; t<twins.length; t++) {\n\t\t\t\t\t\t\tlet thisx = pedigree_utils.getNodeByName(flattenNodes, twins[t].name).x;\n\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\n\t\t\t\t\t\t\tif(xmax < thisx) xmax = thisx;\n\t\t\t\t\t\t\ttwinx += thisx;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet xmid = ((d.target.x + twinx) / (twins.length+1));\n\t\t\t\t\t\tlet ymid = ((d.source.y + d.target.y) / 2);\n\n\t\t\t\t\t\tlet xhbar = \"\";\n\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\n\t\t\t\t\t\t\t// horizontal bar for mztwins\n\t\t\t\t\t\t\tlet xx = (xmid + d.target.x)/2;\n\t\t\t\t\t\t\tlet yy = (ymid + (d.target.y-opts.symbol_size/2))/2;\n\t\t\t\t\t\t\txhbar = \"M\" + xx + \",\" + yy +\n\t\t\t\t\t\t\t\t\t\"L\" + (xmid + (xmid-xx)) + \" \" + yy;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t\t\t   \"V\" + ymid +\n\t\t\t\t\t\t\t   \"H\" + xmid +\n\t\t\t\t\t\t\t   \"L\" + (d.target.x) + \" \" + (d.target.y-opts.symbol_size/2) +\n\t\t\t\t\t\t\t   xhbar;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(d.source.data.mother) {   // check parents depth to see if they are at the same level in the tree\n\t\t\t\t\tlet ma = pedigree_utils.getNodeByName(flattenNodes, d.source.data.mother.name);\n\t\t\t\t\tlet pa = pedigree_utils.getNodeByName(flattenNodes, d.source.data.father.name);\n\n\t\t\t\t\tif(ma.depth !== pa.depth) {\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + ((ma.y + pa.y) / 2) +\n\t\t\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t   \"V\" + ((d.source.y + d.target.y) / 2) +\n\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t});\n\n\t// draw proband arrow\n\tlet probandIdx  = pedigree_utils.getProbandIndex(opts.dataset);\n\tif(typeof probandIdx !== 'undefined') {\n\t\tlet probandNode = pedigree_utils.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\n\t\tlet triid = \"triangle\"+pedigree_utils.makeid(3);\n\t\tped.append(\"svg:defs\").append(\"svg:marker\")\t// arrow head\n\t\t\t.attr(\"id\", triid)\n\t\t\t.attr(\"refX\", 6)\n\t\t\t.attr(\"refY\", 6)\n\t\t\t.attr(\"markerWidth\", 20)\n\t\t\t.attr(\"markerHeight\", 20)\n\t\t\t.attr(\"orient\", \"auto\")\n\t\t\t.append(\"path\")\n\t\t\t.attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\n\t\t\t.style(\"fill\", \"black\");\n\n\t\tped.append(\"line\")\n\t\t\t.attr(\"x1\", probandNode.x-opts.symbol_size)\n\t\t\t.attr(\"y1\", probandNode.y+opts.symbol_size)\n\t\t\t.attr(\"x2\", probandNode.x-opts.symbol_size/2)\n\t\t\t.attr(\"y2\", probandNode.y+opts.symbol_size/2)\n\t\t\t.attr(\"stroke-width\", 1)\n\t\t\t.attr(\"stroke\", \"black\")\n\t\t\t.attr(\"marker-end\", \"url(#\"+triid+\")\");\n\t}\n\t// drag and zoom\n\tsvg.call(get_zoom(opts));\n\treturn opts;\n}\n\nfunction create_err(err) {\n\tconsole.error(err);\n\treturn new Error(err);\n}\n\n// validate pedigree data\nexport function validate_pedigree(opts){\n\tif(opts.validate) {\n\t\tif (typeof opts.validate == 'function') {\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\n\t\t\treturn opts.validate.call(this, opts);\n\t\t}\n\n\t\t// check consistency of parents sex\n\t\tlet uniquenames = [];\n\t\tlet famids = [];\n\t\tlet display_name;\n\t\tfor(let p=0; p<opts.dataset.length; p++) {\n\t\t\tif(!p.hidden) {\n\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\n\t\t\t\t\tif(!display_name)\n\t\t\t\t\t\tdisplay_name = 'unnamed';\n\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\n\t\t\t\t\tlet father = opts.dataset[p].father;\n\t\t\t\t\tif(!mother || !father) {\n\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet midx = pedigree_utils.getIdxByName(opts.dataset, mother);\n\t\t\t\t\tlet fidx = pedigree_utils.getIdxByName(opts.dataset, father);\n\t\t\t\t\tif(midx === -1)\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(fidx === -1)\n\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\n\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\n\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tif(!opts.dataset[p].name)\n\t\t\t\tthrow create_err(display_name+' has no IndivID.');\n\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\n\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\n\t\t\tuniquenames.push(opts.dataset[p].name);\n\n\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\n\t\t\t\tfamids.push(opts.dataset[p].famid);\n\t\t\t}\n\t\t}\n\n\t\tif(famids.length > 1) {\n\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\n\t\t}\n\t\t// warn if there is a break in the pedigree\n\t\tlet uc = pedigree_utils.unconnected(opts.dataset);\n\t\tif(uc.length > 0)\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\n\t}\n}\n\n//adopted in/out brackets\nfunction get_bracket(dx, dy, indent, opts) {\n\treturn \t\"M\" + (dx+indent) + \",\" + dy +\n\t\t\t\"L\" + dx + \" \" + dy +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + (dx+indent) + \",\" + (dy+(opts.symbol_size *  1.28))\n}\n\n// check if the object contains a key with a given prefix\nfunction prefixInObj(prefix, obj) {\n\tlet found = false;\n\tif(obj)\n\t\t$.each(obj, function(k, _n){\n\t\t\tif(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\n\t\t\t\tfound = true;\n\t\t\t\treturn found;\n\t\t\t}\n\t\t});\n\treturn found;\n}\n\n// check for crossing of partner lines\nfunction check_ptr_links(opts, ptrLinkNodes){\n\tfor(let a=0; a<ptrLinkNodes.length; a++) {\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\n\t\tif(clash)\n\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\n\t}\n}\n\nexport function check_ptr_link_clashes(opts, anode) {\n\tlet root = roots[opts.targetDiv];\n\tlet flattenNodes = pedigree_utils.flatten(root);\n\tlet mother, father;\n\tif('name' in anode) {\n\t\tanode = pedigree_utils.getNodeByName(flattenNodes, anode.name);\n\t\tif(!('mother' in anode.data))\n\t\t\treturn null;\n\t\tmother = pedigree_utils.getNodeByName(flattenNodes, anode.data.mother);\n\t\tfather = pedigree_utils.getNodeByName(flattenNodes, anode.data.father);\n\t} else {\n\t\tmother = anode.mother;\n\t\tfather = anode.father;\n\t}\n\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\n\tlet dy = mother.y;\n\n\t// identify clashes with other nodes at the same depth\n\tlet clash = $.map(flattenNodes, function(bnode, _i){\n\t\treturn !bnode.data.hidden &&\n\t\t\t\tbnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\n\t\t\t\tbnode.y == dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\n\t});\n\treturn clash.length > 0 ? clash : null;\n}\n\nfunction get_svg_dimensions(opts) {\n\treturn {'width' : (pbuttons.is_fullscreen()? window.innerWidth  : opts.width),\n\t\t\t'height': (pbuttons.is_fullscreen()? window.innerHeight : opts.height)};\n}\n\nexport function get_tree_dimensions(opts) {\n\t// / get score at each depth used to adjust node separation\n\tlet svg_dimensions = get_svg_dimensions(opts);\n\tlet maxscore = 0;\n\tlet generation = {};\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet depth = pedigree_utils.getDepth(opts.dataset, opts.dataset[i].name);\n\t\tlet children = pedigree_utils.getAllChildren(opts.dataset, opts.dataset[i]);\n\n\t\t// score based on no. of children and if parent defined\n\t\tlet score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\n\t\tif(depth in generation)\n\t\t\tgeneration[depth] += score;\n\t\telse\n\t\t\tgeneration[depth] = score;\n\n\t\tif(generation[depth] > maxscore)\n\t\t\tmaxscore = generation[depth];\n\t}\n\n\tlet max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\n\tlet tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\n\t\t\t\t\t   svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\n\t\t\t\t\t   svg_dimensions.height - opts.symbol_size : max_depth);\n\treturn {'width': tree_width, 'height': tree_height};\n}\n\n// group top_level nodes by their partners\nfunction group_top_level(dataset) {\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t// calculate top_level nodes\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tif(pedigree_utils.getDepth(dataset, dataset[i].name) == 2)\n\t\t\tdataset[i].top_level = true;\n\t}\n\n\tlet top_level = [];\n\tlet top_level_seen = [];\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tlet node = dataset[i];\n\t\tif('top_level' in node && $.inArray(node.name, top_level_seen) == -1){\n\t\t\ttop_level_seen.push(node.name);\n\t\t\ttop_level.push(node);\n\t\t\tlet ptrs = pedigree_utils.get_partners(dataset, node);\n\t\t\tfor(let j=0; j<ptrs.length; j++){\n\t\t\t\tif($.inArray(ptrs[j], top_level_seen) == -1) {\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\n\t\t\t\t\ttop_level.push(pedigree_utils.getNodeByName(dataset, ptrs[j]));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tlet newdataset = $.map(dataset, function(val, _i){return 'top_level' in val && val.top_level ? null : val;});\n\tfor (let i = top_level.length; i > 0; --i)\n\t\tnewdataset.unshift(top_level[i-1]);\n\treturn newdataset;\n}\n\n// get height in pixels\nfunction getPx(opts){\n\tlet emVal = opts.font_size;\n\tif (emVal === parseInt(emVal, 10)) // test if integer\n\t\treturn emVal;\n\n\tif(emVal.indexOf(\"px\") > -1)\n\t\treturn emVal.replace('px', '');\n\telse if(emVal.indexOf(\"em\") === -1)\n\t\treturn emVal;\n\temVal = parseFloat(emVal.replace('em', ''));\n\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\n}\n\n// Add label\nfunction addLabel(opts, node, fx, fy, ftext, class_label) {\n\tnode.filter(function (d) {\n\t\treturn d.data.hidden && !opts.DEBUG ? false : true;\n\t}).append(\"text\")\n\t.attr(\"class\", class_label + ' ped_label' || \"ped_label\")\n\t.attr(\"x\", fx)\n\t.attr(\"y\", fy)\n\t// .attr(\"dy\", size)\n\t.attr(\"font-family\", opts.font_family)\n\t.attr(\"font-size\", opts.font_size)\n\t.attr(\"font-weight\", opts.font_weight)\n\t.text(ftext);\n}\n\nexport function rebuild(opts) {\n\t$(\"#\"+opts.targetDiv).empty();\n\tpedcache.init_cache(opts);\n\ttry {\n\t\tbuild(opts);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\tthrow e;\n\t}\n\n\ttry {\n\t\ttemplates.update(opts);\n\t} catch(e) {\n\t\t// templates not declared\n\t}\n}\n\n// add children to a given node\nexport function addchild(dataset, node, sex, nchild, twin_type) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tif (typeof nchild === typeof undefined)\n\t\tnchild = 1;\n\tlet children = pedigree_utils.getAllChildren(dataset, node);\n\tlet ptr_name, idx;\n\tif (children.length === 0) {\n\t\tlet partner = addsibling(dataset, node, node.sex === 'F' ? 'M': 'F', node.sex === 'F');\n\t\tpartner.noparents = true;\n\t\tptr_name = partner.name;\n\t\tidx = pedigree_utils.getIdxByName(dataset, node.name)+1;\n\t} else {\n\t\tlet c = children[0];\n\t\tptr_name = (c.father === node.name ? c.mother : c.father);\n\t\tidx = pedigree_utils.getIdxByName(dataset, c.name);\n\t}\n\n\tlet twin_id;\n\tif(twin_type)\n\t\ttwin_id = getUniqueTwinID(dataset, twin_type);\n\tlet newchildren = [];\n\tfor (let i = 0; i < nchild; i++) {\n\t\tlet child = {\"name\": pedigree_utils.makeid(4), \"sex\": sex,\n\t\t\t\t\t \"mother\": (node.sex === 'F' ? node.name : ptr_name),\n\t\t\t\t\t \"father\": (node.sex === 'F' ? ptr_name : node.name)};\n\t\tdataset.splice(idx, 0, child);\n\n\t\tif(twin_type)\n\t\t\tchild[twin_type] = twin_id;\n\t\tnewchildren.push(child);\n\t}\n\treturn newchildren;\n}\n\n//\nexport function addsibling(dataset, node, sex, add_lhs, twin_type) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tlet newbie = {\"name\": pedigree_utils.makeid(4), \"sex\": sex};\n\tif(node.top_level) {\n\t\tnewbie.top_level = true;\n\t} else {\n\t\tnewbie.mother = node.mother;\n\t\tnewbie.father = node.father;\n\t}\n\tlet idx = pedigree_utils.getIdxByName(dataset, node.name);\n\n\tif(twin_type) {\n\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\n\t}\n\n\tif(add_lhs) { // add to LHS\n\t\tif(idx > 0) idx--;\n\t} else\n\t\tidx++;\n\tdataset.splice(idx, 0, newbie);\n\treturn newbie;\n}\n\n// set two siblings as twins\nfunction setMzTwin(dataset, d1, d2, twin_type) {\n\tif(!d1[twin_type]) {\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\n\t\tif(!d1[twin_type])\n\t\t\treturn false;\n\t}\n\td2[twin_type] = d1[twin_type];\n\tif(d1.yob)\n\t\td2.yob = d1.yob;\n\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\td2.age = d1.age;\n\treturn true;\n}\n\n// get a new unique twins ID, max of 10 twins in a pedigree\nfunction getUniqueTwinID(dataset, twin_type) {\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tif(dataset[i][twin_type]) {\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\n\t\t\tif (idx > -1)\n\t\t\t\tmz.splice(idx, 1);\n\t\t}\n\t}\n\tif(mz.length > 0)\n\t\treturn mz[0];\n\treturn undefined;\n}\n\n// sync attributes of twins\nexport function syncTwins(dataset, d1) {\n\tif(!d1.mztwin && !d1.dztwin)\n\t\treturn;\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet d2 = dataset[i];\n\t\tif(d2[twin_type] && d1[twin_type] == d2[twin_type] && d2.name !== d1.name) {\n\t\t\tif(twin_type === \"mztwin\")\n\t\t\t  d2.sex = d1.sex;\n\t\t\tif(d1.yob)\n\t\t\t\td2.yob = d1.yob;\n\t\t\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\t\t\td2.age = d1.age;\n\t\t}\n\t}\n}\n\n// check integrity twin settings\nfunction checkTwins(dataset) {\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tfor(let j=0; j<twin_types.length; j++) {\n\t\t\tlet twin_type = twin_types[j];\n\t\t\tif(dataset[i][twin_type]) {\n\t\t\t\tlet count = 0;\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\n\t\t\t\t\tif(dataset[j][twin_type] == dataset[i][twin_type])\n\t\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t\tif(count < 2)\n\t\t\t\t\tdelete dataset[i][[twin_type]];\n\t\t\t}\n\t\t}\n\t}\n}\n\n// add parents to the 'node'\nexport function addparents(opts, dataset, name) {\n\tlet mother, father;\n\tlet root = roots[opts.targetDiv];\n\tlet flat_tree = pedigree_utils.flatten(root);\n\tlet tree_node = pedigree_utils.getNodeByName(flat_tree, name);\n\tlet node  = tree_node.data;\n\tlet depth = tree_node.depth;   // depth of the node in relation to the root (depth = 1 is a top_level node)\n\n\tlet pid = -101;\n\tlet ptr_name;\n\tlet children = pedigree_utils.getAllChildren(dataset, node);\n\tif(children.length > 0){\n\t\tptr_name = children[0].mother == node.name ? children[0].father : children[0].mother;\n\t\tpid = pedigree_utils.getNodeByName(flat_tree, ptr_name).data.id;\n\t}\n\n\tlet i;\n\tif(depth == 1) {\n\t\tmother = {\"name\": pedigree_utils.makeid(4), \"sex\": \"F\", \"top_level\": true};\n\t\tfather = {\"name\": pedigree_utils.makeid(4), \"sex\": \"M\", \"top_level\": true};\n\t\tdataset.splice(0, 0, mother);\n\t\tdataset.splice(0, 0, father);\n\n\t\tfor(i=0; i<dataset.length; i++){\n\t\t\tif(dataset[i].top_level && dataset[i].name !== mother.name && dataset[i].name !== father.name){\n\t\t\t\tdelete dataset[i].top_level;\n\t\t\t\tdataset[i].noparents = true;\n\t\t\t\tdataset[i].mother = mother.name;\n\t\t\t\tdataset[i].father = father.name;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet node_mother = pedigree_utils.getNodeByName(flat_tree, tree_node.data.mother);\n\t\tlet node_father = pedigree_utils.getNodeByName(flat_tree, tree_node.data.father);\n\t\tlet node_sibs = pedigree_utils.getAllSiblings(dataset, node);\n\n\t\t// lhs & rhs id's for siblings of this node\n\t\tlet rid = 10000;\n\t\tlet lid = tree_node.data.id;\n\t\tfor(i=0; i<node_sibs.length; i++){\n\t\t\tlet sid = pedigree_utils.getNodeByName(flat_tree, node_sibs[i].name).data.id;\n\t\t\tif(sid < rid && sid > tree_node.data.id)\n\t\t\t\trid = sid;\n\t\t\tif(sid < lid)\n\t\t\t\tlid = sid;\n\t\t}\n\t\tlet add_lhs = (lid >= tree_node.data.id || (pid == lid && rid < 10000));\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\n\t\tlet midx;\n\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\n\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\n\t\t\tmidx = pedigree_utils.getIdxByName(dataset, node.father);\n\t\telse\n\t\t\tmidx = pedigree_utils.getIdxByName(dataset, node.mother);\n\n\t\tlet parent = dataset[midx];\n\t\tfather = addsibling(dataset, parent, 'M', add_lhs);\n\t\tmother = addsibling(dataset, parent, 'F', add_lhs);\n\n\t\tlet faidx = pedigree_utils.getIdxByName(dataset, father.name);\n\t\tlet moidx = pedigree_utils.getIdxByName(dataset, mother.name);\n\t\tif(faidx > moidx) {\t\t\t\t   // switch to ensure father on lhs of mother\n\t\t\tlet tmpfa = dataset[faidx];\n\t\t\tdataset[faidx] = dataset[moidx];\n\t\t\tdataset[moidx] = tmpfa;\n\t\t}\n\n\t\tlet orphans = pedigree_utils.getAdoptedSiblings(dataset, node);\n\t\tlet nid = tree_node.data.id;\n\t\tfor(i=0; i<orphans.length; i++){\n\t\t\tlet oid = pedigree_utils.getNodeByName(flat_tree, orphans[i].name).data.id;\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\n\t\t\tif((add_lhs || nid < oid) && oid < rid){\n\t\t\t\tlet oidx = pedigree_utils.getIdxByName(dataset, orphans[i].name);\n\t\t\t\tdataset[oidx].mother = mother.name;\n\t\t\t\tdataset[oidx].father = father.name;\n\t\t\t}\n\t\t}\n\t}\n\n\tif(depth == 2) {\n\t\tmother.top_level = true;\n\t\tfather.top_level = true;\n\t} else if(depth > 2) {\n\t\tmother.noparents = true;\n\t\tfather.noparents = true;\n\t}\n\tlet idx = pedigree_utils.getIdxByName(dataset, node.name);\n\tdataset[idx].mother = mother.name;\n\tdataset[idx].father = father.name;\n\tdelete dataset[idx].noparents;\n\n\tif('parent_node' in node) {\n\t\tlet ptr_node = dataset[pedigree_utils.getIdxByName(dataset, ptr_name)];\n\t\tif('noparents' in ptr_node) {\n\t\t\tptr_node.mother = mother.name;\n\t\t\tptr_node.father = father.name;\n\t\t}\n\t}\n}\n\n// add partner\nexport function addpartner(opts, dataset, name) {\n\tlet root = roots[opts.targetDiv];\n\tlet flat_tree = pedigree_utils.flatten(root);\n\tlet tree_node = pedigree_utils.getNodeByName(flat_tree, name);\n\n\tlet partner = addsibling(dataset, tree_node.data, tree_node.data.sex === 'F' ? 'M' : 'F', tree_node.data.sex === 'F');\n\tpartner.noparents = true;\n\n\tlet child = {\"name\": pedigree_utils.makeid(4), \"sex\": \"M\"};\n\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\n\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\n\n\tlet idx = pedigree_utils.getIdxByName(dataset, tree_node.data.name)+2;\n\tdataset.splice(idx, 0, child);\n}\n\n// get adjacent nodes at the same depth\nfunction adjacent_nodes(root, node, excludes) {\n\tlet dnodes = pedigree_utils.getNodesAtDepth(pedigree_utils.flatten(root), node.depth, excludes);\n\tlet lhs_node, rhs_node;\n\tfor(let i=0; i<dnodes.length; i++) {\n\t\tif(dnodes[i].x < node.x)\n\t\t\tlhs_node = dnodes[i];\n\t\tif(!rhs_node && dnodes[i].x > node.x)\n\t\t\trhs_node = dnodes[i];\n\t}\n\treturn [lhs_node, rhs_node];\n}\n\n// delete a node and descendants\nexport function delete_node_dataset(dataset, node, opts, onDone) {\n\tlet root = roots[opts.targetDiv];\n\tlet fnodes = pedigree_utils.flatten(root);\n\tlet deletes = [];\n\tlet i, j;\n\n\t// get d3 data node\n\tif(node.id === undefined) {\n\t\tlet d3node = pedigree_utils.getNodeByName(fnodes, node.name);\n\t\tif(d3node !== undefined)\n\t\t\tnode = d3node.data;\n\t}\n\n\tif(node.parent_node) {\n\t\tfor(i=0; i<node.parent_node.length; i++){\n\t\t\tlet parent = node.parent_node[i];\n\t\t\tlet ps = [pedigree_utils.getNodeByName(dataset, parent.mother.name),\n\t\t\t\t\t  pedigree_utils.getNodeByName(dataset, parent.father.name)];\n\t\t\t// delete parents\n\t\t\tfor(j=0; j<ps.length; j++) {\n\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\n\t\t\t\t\tdataset.splice(pedigree_utils.getIdxByName(dataset, ps[j].name), 1);\n\t\t\t\t\tdeletes.push(ps[j]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet children = parent.children;\n\t\t\tlet children_names = $.map(children, function(p, _i){return p.name;});\n\t\t\tfor(j=0; j<children.length; j++) {\n\t\t\t\tlet child = pedigree_utils.getNodeByName(dataset, children[j].name);\n\t\t\t\tif(child){\n\t\t\t\t\tchild.noparents = true;\n\t\t\t\t\tlet ptrs = pedigree_utils.get_partners(dataset, child);\n\t\t\t\t\tlet ptr;\n\t\t\t\t\tif(ptrs.length > 0)\n\t\t\t\t\t\tptr = pedigree_utils.getNodeByName(dataset, ptrs[0]);\n\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\n\t\t\t\t\t\tchild.mother = ptr.mother;\n\t\t\t\t\t\tchild.father = ptr.father;\n\t\t\t\t\t} else if(ptr) {\n\t\t\t\t\t\tlet child_node  = pedigree_utils.getNodeByName(fnodes, child.name);\n\t\t\t\t\t\tlet adj = adjacent_nodes(root, child_node, children_names);\n\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\n\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdataset.splice(pedigree_utils.getIdxByName(dataset, child.name), 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tdataset.splice(pedigree_utils.getIdxByName(dataset, node.name), 1);\n\t}\n\n\t// delete ancestors\n\tconsole.log(deletes);\n\tfor(i=0; i<deletes.length; i++) {\n\t\tlet del = deletes[i];\n\t\tlet sibs = pedigree_utils.getAllSiblings(dataset, del);\n\t\tconsole.log('DEL', del.name, sibs);\n\t\tif(sibs.length < 1) {\n\t\t\tconsole.log('del sibs', del.name, sibs);\n\t\t\tlet data_node  = pedigree_utils.getNodeByName(fnodes, del.name);\n\t\t\tlet ancestors = data_node.ancestors();\n\t\t\tfor(j=0; j<ancestors.length; j++) {\n\t\t\t\tconsole.log(ancestors[i]);\n\t\t\t\tif(ancestors[j].data.mother){\n\t\t\t\t\tconsole.log('DELETE ', ancestors[j].data.mother, ancestors[j].data.father);\n\t\t\t\t\tdataset.splice(pedigree_utils.getIdxByName(dataset, ancestors[j].data.mother.name), 1);\n\t\t\t\t\tdataset.splice(pedigree_utils.getIdxByName(dataset, ancestors[j].data.father.name), 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// check integrity of mztwins settings\n\tcheckTwins(dataset);\n\n\tlet uc;\n\ttry\t{\n\t\t// validate new pedigree dataset\n\t\tlet newopts = $.extend({}, opts);\n\t\tnewopts.dataset = pedigree_utils.copy_dataset(dataset);\n\t\tvalidate_pedigree(newopts);\n\t\t// check if pedigree is split\n\t\tuc = pedigree_utils.unconnected(dataset);\n\t} catch(err) {\n\t\tpedigree_utils.messages('Warning', 'Deletion of this pedigree member is disallowed.')\n\t\tthrow err;\n\t}\n\tif(uc.length > 0) {\n\t\t// check & warn only if this is a new split\n\t\tif(pedigree_utils.unconnected(opts.dataset).length === 0) {\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", uc);\n\t\t\tpedigree_utils.messages(\"Warning\", \"Deleting this will split the pedigree. Continue?\", onDone, opts, dataset);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif(onDone) {\n\t\tonDone(opts, dataset);\n\t}\n\treturn dataset;\n}\n"],"names":["max_limit","dict_cache","has_browser_storage","opts","store_type","undefined","mod","localStorage","setItem","removeItem","e","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","name","clear_pedigree_data","prefix","store","items","i","length","key","indexOf","push","get_count","count","set_count","init_cache","dataset","JSON","stringify","console","warn","nstore","current","parse","previous","next","parseInt","clear","clear_browser_store","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","arr","isIE","ua","navigator","userAgent","isEdge","match","copy_dataset","id","sort","a","b","disallowed","newdataset","obj","messages","title","msg","onConfirm","$","dialog","modal","width","buttons","this","text","click","makeid","len","possible","charAt","Math","floor","random","buildTree","person","root","partnerLinks","_typeof","children","getChildren","nodes","flatten","partners","each","_i","child","_j","p","mother","father","m","getNodeByName","f","contains_parent","merge","ptr","parent","hidden","midx","getIdxByName","fidx","setChildrenId","gp","get_grandparents_idx","updateParent","parent_node","mztwin","dztwins","twins","getTwins","twin","dztwin","isProband","attr","combineArrays","arr1","arr2","inArray","include_children","connected","get_partners","getAllChildren","_child_idx","anode","ptrs","bnode","unconnected","target","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","map","val","proband","sex","getSiblings","getAllSiblings","sibs","twin_type","getAdoptedSiblings","getDepth","idx","depth","top_level","getNodesAtDepth","fnodes","exclude_names","data","linkNodes","flattenNodes","links","ancestors","node","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","_index","flat","forEach","adjust_coords","xmid","overlap","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","DEBUG","log","xnew","n","abs","symbol_size","gmidx","gfidx","node_attr","keys","value","pedcache","isArray","k","found","syncTwins","rebuild","print_opts","remove","append","xi","yi","time","d","Date","getHours","slice","getMinutes","getSeconds","getFullYear","getMonth","getDate","age","yob","status","year","sum","string","toUpperCase","is_proband","results","RegExp","exec","window","location","href","breastfeeding","newchild","addchild","delete_node_dataset","get_zoom","d3","scaleExtent","zoomIn","zoomOut","filter","event","type","zoomSrc","on","t","transform","sourceEvent","xyk","select","targetDiv","transform_pedigree","zoomFn","btn_zoom","scale","svg","zoomIdentity","translate","transition","duration","call","zoom_to_fit","bounds","ped","xmin","Number","MAX_VALUE","xmax","ymin","ymax","sym2","selectAll","get_bounds","w","h","wfull","clientWidth","hfull","clientHeight","max","add","options","extend","btns","lis","fa","document","_e","local_dataset","mozFullScreen","webkitFullScreen","mozCancelFullScreen","webkitCancelFullScreen","mozRequestFullScreen","webkitRequestFullScreen","Element","ALLOW_KEYBOARD_INPUT","stopPropagation","hasClass","empty","build","resizable","height","Continue","keep_proband","selected","reset","keep_proband_on_reset","Cancel","trigger","is_fullscreen","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","cancers","genetic_test","pathology_tests","RISK_FACTOR_STORE","Object","hasInput","trim","get_prs_values","prs","myObj","prototype","hasOwnProperty","isEmpty","readCanRiskV1","boadicea_lines","lines","split","hdr","ln","ops","j","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","path_test","unshift","get_pedigree","famid","meta","isanon","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","mdensity","hgt","tl","endo","display_name","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","alpha","zscore","ovarian_cancer_prs","err","load","content","save_file","save","print","get_printable_svg","svg_download","deferred","svg2img","when","apply","done","getByName","arguments","html","img","newTab","open","write","createElement","download","body","appendChild","removeChild","grep","o","deferred_name","defaults","iscanvg","resolution","img_type","find","d3obj","get","lower","svgStr","Deferred","XMLSerializer","serializeToString","xml","imgsrc","btoa","unescape","encodeURIComponent","canvas","context","getContext","onload","canvg","Canvg","fromString","scaleWidth","scaleHeight","ignoreDimensions","start","drawImage","resolve","toDataURL","src","promise","unique_urls","svg_html","matches","str","myRegexp","c","lastIndex","error","index","getMatches","quote","m1","m2","newval","tree_dimensions","get_tree_dimensions","svg_div","clone","appendTo","wid","xscale","yscale","ytransform","constructor","Array","cssFiles","printWindow","headContent","css","close","focus","setTimeout","filename","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","files","risk_factors","reader","FileReader","result","readBoadiceaV4","canrisk_data","process_ped","readCanRisk","readLinkage","validate_pedigree","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","onerror","code","readAsText","affected","alleles","version","_cancer","level","update_parents_level","max_level","pidx","getPartnerIdx","parents","ma","pa","svg_node","updateStatus","removeClass","addClass","update_ashkn","is","pedcache_current","switches","iswitch","s","update_cancer_by_sex","approx_diagnosis_age","substring","round5","checked","tres","valid","update_diagnosis_age_widget","prop","hide","show","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","x1","x2","round","dragging","last_mouseover","addWidgets","font_size","popup_selection","style","square_title","circle_title","add_person","classed","datum","addsibling","highlight","dragstart","dragstop","_d","splice","setLineDragPosition","drag","dx","dy","ynew","drag_handle","fx","off","fy","widgets","edit","settings","widget","styles","parentNode","opt","autoOpen","table","capitaliseFirstLetter","diseases","v","disease_colour","colour","kk","openEditDialog","onDone","addparents","addpartner","ctrlKey","nodeclick","xcoord","mouse","ycoord","y1","y2","roots","labels","font_family","font_weight","background","node_background","validate","pbuttons","io","pedigree_utils","top_level_seen","group_top_level","svg_dimensions","get_svg_dimensions","xytransform","xtransform","set_initial_xy","hidden_root","hierarchy","tree","separation","size","treemap","create_err","ptrLinkNodes","clash","check_ptr_link_clashes","check_ptr_links","enter","miscarriage","termination","symbol","symbolTriangle","symbolCircle","symbolSquare","ncancers","_val","prefixInObj","pie","arc","innerRadius","outerRadius","adopted_in","adopted_out","indent","get_bracket","addLabel","emVal","getComputedStyle","fontSize","getPx","ilab","label","y_offset","vars","ivar","disease","dis","clash_depth","draw_path","dy1","dy2","cshift","l","path","dx1","dx2","insert","divorced","parent_nodes","parent_node_name","divorce_path","source","dash_len","dash_array","usedlen","twinx","thisx","ymid","xhbar","xx","yy","probandNode","triid","Error","uniquenames","famids","join","uc","_n","innerWidth","innerHeight","maxscore","generation","score","max_depth","ftext","class_label","templates","update","nchild","ptr_name","twin_id","partner","getUniqueTwinID","newchildren","add_lhs","newbie","d1","d2","setMzTwin","mz","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","faidx","moidx","tmpfa","orphans","nid","oid","oidx","ptr_node","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","deletes","d3node","ps","children_names","adj","del","twin_types","checkTwins","newopts"],"mappings":"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"}