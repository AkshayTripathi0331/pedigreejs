{"version":3,"file":"pedigreejs.v3.0.0-rc3.min.js","sources":["../es/pedcache.js","../es/utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/twins.js","../es/popup_form.js","../es/widgets.js","../es/labels.js","../es/pedigree.js","../es/extras.js"],"sourcesContent":["/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n//store a history of pedigree\n\nlet max_limit = 25;\nlet dict_cache = {};\n\n// test if browser storage is supported\nfunction has_browser_storage(opts) {\n\ttry {\n\t\tif(opts.store_type === 'array')\n\t\t\treturn false;\n\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\n\t\t\treturn false;\n\n\t\tlet mod = 'test';\n\t\tlocalStorage.setItem(mod, mod);\n\t\tlocalStorage.removeItem(mod);\n\t\treturn true;\n\t} catch(e) {\n\t\treturn false;\n\t}\n}\n\nfunction get_prefix(opts) {\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\n}\n\n// use dict_cache to store cache as an array\nfunction get_arr(opts) {\n\treturn dict_cache[get_prefix(opts)];\n}\n\nfunction get_browser_store(opts, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.getItem(item);\n\telse\n\t\treturn sessionStorage.getItem(item);\n}\n\nfunction set_browser_store(opts, name, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.setItem(name, item);\n\telse\n\t\treturn sessionStorage.setItem(name, item);\n}\n\n// clear all storage items\nfunction clear_browser_store(opts) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.clear();\n\telse\n\t\treturn sessionStorage.clear();\n}\n\n// remove all storage items with keys that have the pedigree history prefix\nexport function clear_pedigree_data(opts) {\n\tlet prefix = get_prefix(opts);\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\tlet items = [];\n\tfor(let i = 0; i < store.length; i++){\n\t\tif(store.key(i).indexOf(prefix) == 0)\n\t\t\titems.push(store.key(i));\n\t}\n\tfor(let i = 0; i < items.length; i++)\n\t\tstore.removeItem(items[i]);\n}\n\nexport function get_count(opts) {\n\tlet count;\n\tif (has_browser_storage(opts))\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\n\telse\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\n\tif(count !== null && count !== undefined)\n\t\treturn count;\n\treturn 0;\n}\n\nfunction set_count(opts, count) {\n\tif (has_browser_storage(opts))\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\n\telse\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\n}\n\nexport function init_cache(opts) {\n\tif(!opts.dataset)\n\t\treturn;\n\tlet count = get_count(opts);\n\tif (has_browser_storage(opts)) {   // local storage\n\t\tset_browser_store(opts, get_prefix(opts)+count, JSON.stringify(opts.dataset));\n\t} else {   // TODO :: array cache\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\n\t\tmax_limit = 500;\n\t\tif(get_arr(opts) === undefined)\n\t\t\tdict_cache[get_prefix(opts)] = [];\n\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\n\t}\n\tif(count < max_limit)\n\t\tcount++;\n\telse\n\t\tcount = 0;\n\tset_count(opts, count);\n}\n\nexport function nstore(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\n\t\t\t\treturn i;\n\t\t}\n\t} else {\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\n\t}\n\treturn -1;\n}\n\nexport function current(opts) {\n\tlet current = get_count(opts)-1;\n\tif(current == -1)\n\t\tcurrent = max_limit;\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\n\telse if(get_arr(opts))\n\t\treturn JSON.parse(get_arr(opts)[current]);\n}\n\nexport function last(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\n\t\t\tif(it !== null) {\n\t\t\t\tset_count(opts, i);\n\t\t\t\treturn JSON.parse(it);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet arr = get_arr(opts);\n\t\tif(arr)\n\t\t\treturn JSON.parse(arr(arr.length-1));\n\t}\n\treturn undefined;\n}\n\nexport function previous(opts, previous) {\n\tif(previous === undefined)\n\t\tprevious = get_count(opts) - 2;\n\n\tif(previous < 0) {\n\t\tlet nstore = nstore(opts);\n\t\tif(nstore < max_limit)\n\t\t\tprevious = nstore - 1;\n\t\telse\n\t\t\tprevious = max_limit - 1;\n\t}\n\tset_count(opts, previous + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[previous]);\n}\n\nexport function next(opts, next) {\n\tif(next === undefined)\n\t\tnext = get_count(opts);\n\tif(next >= max_limit)\n\t\tnext = 0;\n\n\tset_count(opts, parseInt(next) + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[next]);\n}\n\nexport function clear(opts) {\n\tif(has_browser_storage(opts))\n\t\tclear_browser_store(opts);\n\tdict_cache = {};\n}\n\n// zoom - store translation coords\nexport function setposition(opts, x, y, zoom) {\n\tif(has_browser_storage(opts)) {\n\t\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\t\tif(x) {\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\n\t\t} else {\n\t\t\tstore.removeItem(get_prefix(opts)+'_X');\n\t\t\tstore.removeItem(get_prefix(opts)+'_Y');\n\t\t}\n\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\n\t\tif(zoom)\n\t\t\tset_browser_store(opts, zoomName, zoom);\n\t\telse\n\t\t\tstore.removeItem(zoomName);\n\t} else {\n\t\t//TODO\n\t}\n}\n\nexport function getposition(opts) {\n\tif(!has_browser_storage(opts) ||\n\t\t(localStorage.getItem(get_prefix(opts)+'_X') === null &&\n\t\t sessionStorage.getItem(get_prefix(opts)+'_X') === null))\n\t\treturn [null, null];\n\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\n\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\n\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\n\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\n\treturn pos;\n}\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree Tree Utils\nimport * as pedcache from './pedcache.js';\n\n\nexport let roots = {};\n\nexport function isIE() {\n\t let ua = navigator.userAgent;\n\t /* MSIE used to detect old browsers and Trident used to newer ones*/\n\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\n}\n\nexport function isEdge() {\n\t return navigator.userAgent.match(/Edge/g);\n}\n\nexport function create_err(err) {\n\tconsole.error(err);\n\treturn new Error(err);\n}\n\n// validate pedigree data\nexport function validate_pedigree(opts){\n\tif(opts.validate) {\n\t\tif (typeof opts.validate == 'function') {\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\n\t\t\treturn opts.validate.call(this, opts);\n\t\t}\n\n\t\t// check consistency of parents sex\n\t\tlet uniquenames = [];\n\t\tlet famids = [];\n\t\tlet display_name;\n\t\tfor(let p=0; p<opts.dataset.length; p++) {\n\t\t\tif(!p.hidden) {\n\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\n\t\t\t\t\tif(!display_name)\n\t\t\t\t\t\tdisplay_name = 'unnamed';\n\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\n\t\t\t\t\tlet father = opts.dataset[p].father;\n\t\t\t\t\tif(!mother || !father) {\n\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet midx = getIdxByName(opts.dataset, mother);\n\t\t\t\t\tlet fidx = getIdxByName(opts.dataset, father);\n\t\t\t\t\tif(midx === -1)\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(fidx === -1)\n\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\n\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\n\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tif(!opts.dataset[p].name)\n\t\t\t\tthrow create_err(display_name+' has no IndivID.');\n\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\n\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\n\t\t\tuniquenames.push(opts.dataset[p].name);\n\n\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\n\t\t\t\tfamids.push(opts.dataset[p].famid);\n\t\t\t}\n\t\t}\n\n\t\tif(famids.length > 1) {\n\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\n\t\t}\n\t\t// warn if there is a break in the pedigree\n\t\tlet uc = unconnected(opts.dataset);\n\t\tif(uc.length > 0)\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\n\t}\n}\n\nexport function copy_dataset(dataset) {\n\tif(dataset[0].id) { // sort by id\n\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\n\t}\n\n\tlet disallowed = [\"id\", \"parent_node\"];\n\tlet newdataset = [];\n\tfor(let i=0; i<dataset.length; i++){\n\t\tlet obj = {};\n\t\tfor(let key in dataset[i]) {\n\t\t\tif(disallowed.indexOf(key) == -1)\n\t\t\t\tobj[key] = dataset[i][key];\n\t\t}\n\t\tnewdataset.push(obj);\n\t}\n\treturn newdataset;\n}\n\n// check if the object contains a key with a given prefix\nexport function prefixInObj(prefix, obj) {\n\tlet found = false;\n\tif(obj)\n\t\t$.each(obj, function(k, _n){\n\t\t\tif(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\n\t\t\t\tfound = true;\n\t\t\t\treturn found;\n\t\t\t}\n\t\t});\n\treturn found;\n}\n\n/**\n *  Get formatted time or data & time\n */\nexport function getFormattedDate(time){\n\tlet d = new Date();\n\tif(time)\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n\telse\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n }\n\n/**\n * Show message or confirmation dialog.\n * @param title\t - dialog window title\n * @param msg\t   - message to diasplay\n * @param onConfirm - function to call in a confirmation dialog\n * @param opts\t  - pedigreejs options\n * @param dataset\t- pedigree dataset\n */\nexport function messages(title, msg, onConfirm, opts, dataset) {\n\tif(onConfirm) {\n\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\tmodal: true,\n\t\t\t\ttitle: title,\n\t\t\t\twidth: 350,\n\t\t\t\tbuttons: {\n\t\t\t\t\t\"Yes\": function () {\n\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\tonConfirm(opts, dataset);\n\t\t\t\t\t},\n\t\t\t\t\t\"No\": function () {\n\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t} else {\n\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\ttitle: title,\n\t\t\twidth: 350,\n\t\t\tbuttons: [{\n\t\t\t\ttext: \"OK\",\n\t\t\t\tclick: function() { $( this ).dialog( \"close\" );}\n\t\t\t}]\n\t\t});\n\t}\n}\n\n/**\n * Validate age and yob is consistent with current year. The sum of age and\n * yob should not be greater than or equal to current year. If alive the\n * absolute difference between the sum of age and year of birth and the\n * current year should be <= 1.\n * @param age\t- age in years.\n * @param yob\t- year of birth.\n * @param status - 0 = alive, 1 = dead.\n * @return true if age and yob are consistent with current year otherwise false.\n */\nexport function validate_age_yob(age, yob, status) {\n\tlet year = new Date().getFullYear();\n\tlet sum = parseInt(age) + parseInt(yob);\n\tif(status == 1) {   // deceased\n\t\treturn year >= sum;\n\t}\n\treturn Math.abs(year - sum) <= 1 && year >= sum;\n}\n\nexport function capitaliseFirstLetter(string) {\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n\nexport function makeid(len) {\n\tlet text = \"\";\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n\tfor( let i=0; i < len; i++ )\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\n\treturn text;\n}\n\nexport function buildTree(opts, person, root, partnerLinks, id) {\n\tif (typeof person.children === typeof undefined)\n\t\tperson.children = getChildren(opts.dataset, person);\n\n\tif (typeof partnerLinks === typeof undefined) {\n\t\tpartnerLinks = [];\n\t\tid = 1;\n\t}\n\n\tlet nodes = flatten(root);\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\n\tlet partners = [];\n\t$.each(person.children, function(_i, child) {\n\t\t$.each(opts.dataset, function(_j, p) {\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\n\t\t\t\tm = (m !== undefined? m : getNodeByName(opts.dataset, p.mother));\n\t\t\t\tf = (f !== undefined? f : getNodeByName(opts.dataset, p.father));\n\t\t\t\tif(!contains_parent(partners, m, f))\n\t\t\t\t\tpartners.push({'mother': m, 'father': f});\n\t\t\t}\n\t\t});\n\t});\n\t$.merge(partnerLinks, partners);\n\n\t$.each(partners, function(_i, ptr) {\n\t\tlet mother = ptr.mother;\n\t\tlet father = ptr.father;\n\t\tmother.children = [];\n\t\tlet parent = {\n\t\t\t\tname : makeid(4),\n\t\t\t\thidden : true,\n\t\t\t\tparent : null,\n\t\t\t\tfather : father,\n\t\t\t\tmother : mother,\n\t\t\t\tchildren : getChildren(opts.dataset, mother, father)\n\t\t};\n\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\n\t\tif(!('id' in father) && !('id' in mother))\n\t\t\tid = setChildrenId(person.children, id);\n\n\t\t// look at grandparents index\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\n\t\tif(gp.fidx < gp.midx) {\n\t\t\tfather.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tmother.id = id++;\n\t\t} else {\n\t\t\tmother.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tfather.id = id++;\n\t\t}\n\t\tid = updateParent(mother, parent, id, nodes, opts);\n\t\tid = updateParent(father, parent, id, nodes, opts);\n\t\tperson.children.push(parent);\n\t});\n\tid = setChildrenId(person.children, id);\n\n\t$.each(person.children, function(_i, p) {\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\n\t});\n\treturn [partnerLinks, id];\n}\n\n\n// update parent node and sort twins\nfunction updateParent(p, parent, id, nodes, opts) {\n\t// add to parent node\n\tif('parent_node' in p)\n\t\tp.parent_node.push(parent);\n\telse\n\t\tp.parent_node = [parent];\n\n\t// check twins lie next to each other\n\tif(p.mztwin || p.dztwins) {\n\t\tlet twins = getTwins(opts.dataset, p);\n\t\tfor(let i=0; i<twins.length; i++) {\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\n\t\t\tif(twin)\n\t\t\t\ttwin.id = id++;\n\t\t}\n\t}\n\treturn id;\n}\n\nfunction setChildrenId(children, id) {\n\t// sort twins to lie next to each other\n\tchildren.sort(function(a, b) {\n\t\tif(a.mztwin && b.mztwin && a.mztwin == b.mztwin)\n\t\t\treturn 0;\n\t\telse if(a.dztwin && b.dztwin && a.dztwin == b.dztwin)\n\t\t\treturn 0;\n\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\n\t\t\treturn 1;\n\t\treturn 0;\n\t});\n\n\t$.each(children, function(_i, p) {\n\t\tif(p.id === undefined) p.id = id++;\n\t});\n\treturn id;\n}\n\nexport function isProband(obj) {\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n}\n\nexport function setProband(dataset, name, is_proband) {\n\t$.each(dataset, function(_i, p) {\n\t\tif (name === p.name)\n\t\t\tp.proband = is_proband;\n\t\telse\n\t\t\tdelete p.proband;\n\t});\n}\n\n//combine arrays ignoring duplicates\nfunction combineArrays(arr1, arr2) {\n\tfor(let i=0; i<arr2.length; i++)\n\t\tif($.inArray( arr2[i], arr1 ) == -1) arr1.push(arr2[i]);\n}\n\nfunction include_children(connected, p, dataset) {\n\tif($.inArray( p.name, connected ) == -1)\n\t\treturn;\n\tcombineArrays(connected, get_partners(dataset, p));\n\tlet children = getAllChildren(dataset, p);\n\t$.each(children, function( _child_idx, child ) {\n\t\tif($.inArray( child.name, connected ) == -1) {\n\t\t\tconnected.push(child.name);\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\n\t\t}\n\t});\n}\n\n//get the partners for a given node\nexport function get_partners(dataset, anode) {\n\tlet ptrs = [];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) == -1)\n\t\t\tptrs.push(bnode.father);\n\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) == -1)\n\t\t\tptrs.push(bnode.mother);\n\t}\n\treturn ptrs;\n}\n\n//return a list of individuals that aren't connected to the target\nexport function unconnected(dataset){\n\tlet target = dataset[ getProbandIndex(dataset) ];\n\tif(!target){\n\t\tconsole.warn(\"No target defined\");\n\t\tif(dataset.length == 0) {\n\t\t\tthrow \"empty pedigree data set\";\n\t\t}\n\t\ttarget = dataset[0];\n\t}\n\tlet connected = [target.name];\n\tlet change = true;\n\tlet ii = 0;\n\twhile(change && ii < 200) {\n\t\tii++;\n\t\tlet nconnect = connected.length;\n\t\t$.each(dataset, function( _idx, p ) {\n\t\t\tif($.inArray( p.name, connected ) != -1) {\n\t\t\t\t// check if this person or a partner has a parent\n\t\t\t\tlet ptrs = get_partners(dataset, p);\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\n\t\t\t\tfor(let i=0; i<ptrs.length; i++){\n\t\t\t\t\tif(!getNodeByName(dataset, ptrs[i]).noparents)\n\t\t\t\t\t\thas_parent = true;\n\t\t\t\t}\n\n\t\t\t\tif(has_parent){\n\t\t\t\t\tif(p.mother && $.inArray( p.mother, connected ) == -1)\n\t\t\t\t\t\tconnected.push(p.mother);\n\t\t\t\t\tif(p.father && $.inArray( p.father, connected ) == -1)\n\t\t\t\t\t\tconnected.push(p.father);\n\t\t\t\t}\n\t\t\t} else if( !p.noparents &&\n\t\t\t\t\t  ((p.mother && $.inArray( p.mother, connected ) != -1) ||\n\t\t\t\t\t   (p.father && $.inArray( p.father, connected ) != -1))){\n\t\t\t\tconnected.push(p.name);\n\t\t\t}\n\t\t\t// include any children\n\t\t\tinclude_children(connected, p, dataset);\n\t\t});\n\t\tchange = (nconnect != connected.length);\n\t}\n\tlet names = $.map(dataset, function(val, _i){return val.name;});\n\treturn $.map(names, function(name, _i){return $.inArray(name, connected) == -1 ? name : null;});\n}\n\nexport function getProbandIndex(dataset) {\n\tlet proband;\n\t$.each(dataset, function(i, val) {\n\t\tif (isProband(val)) {\n\t\t\tproband = i;\n\t\t\treturn proband;\n\t\t}\n\t});\n\treturn proband;\n}\n\nexport function getChildren(dataset, mother, father) {\n\tlet children = [];\n\tlet names = [];\n\tif(mother.sex === 'F')\n\t\t$.each(dataset, function(_i, p) {\n\t\t\tif(mother.name === p.mother)\n\t\t\t\tif(!father || father.name == p.father) {\n\t\t\t\t\tif($.inArray(p.name, names) === -1){\n\t\t\t\t\t\tchildren.push(p);\n\t\t\t\t\t\tnames.push(p.name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t});\n\treturn children;\n}\n\nfunction contains_parent(arr, m, f) {\n\tfor(let i=0; i<arr.length; i++)\n\t\tif(arr[i].mother === m && arr[i].father === f)\n\t\t\treturn true;\n\treturn false;\n}\n\n// get the mono/di-zygotic twin(s)\nexport function getTwins(dataset, person) {\n\tlet sibs = getSiblings(dataset, person);\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\n\treturn $.map(sibs, function(p, _i){\n\t\treturn p.name !== person.name && p[twin_type] == person[twin_type] ? p : null;\n\t});\n}\n\n// get the siblings - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getSiblings(dataset, person, sex) {\n\tif(person === undefined || !person.mother || person.noparents)\n\t\treturn [];\n\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex == sex) ? p : null;\n\t});\n}\n\n// get the siblings + adopted siblings - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getAllSiblings(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex == sex) ? p : null;\n\t});\n}\n\n// get the adopted siblings of a given individual\nexport function getAdoptedSiblings(dataset, person) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && 'noparents' in p &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) ? p : null;\n\t});\n}\n\nexport function getAllChildren(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn !('noparents' in p) &&\n\t\t\t   (p.mother === person.name || p.father === person.name) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the depth of the given person from the root\nexport function getDepth(dataset, name) {\n\tlet idx = getIdxByName(dataset, name);\n\tlet depth = 1;\n\n\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\n\t\tdepth++;\n\t}\n\treturn depth;\n}\n\n// given an array of people get an index for a given person\nexport function getIdxByName(arr, name) {\n\tlet idx = -1;\n\t$.each(arr, function(i, p) {\n\t\tif (name === p.name) {\n\t\t\tidx = i;\n\t\t\treturn idx;\n\t\t}\n\t});\n\treturn idx;\n}\n\n// get the nodes at a given depth sorted by their x position\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\n\treturn $.map(fnodes, function(p, _i){\n\t\treturn p.depth == depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) == -1 ? p : null;\n\t}).sort(function (a,b) {return a.x - b.x;});\n}\n\n// convert the partner names into corresponding tree nodes\nexport function linkNodes(flattenNodes, partners) {\n\tlet links = [];\n\tfor(let i=0; i< partners.length; i++)\n\t\tlinks.push({'mother': getNodeByName(flattenNodes, partners[i].mother.name),\n\t\t\t\t\t'father': getNodeByName(flattenNodes, partners[i].father.name)});\n\treturn links;\n}\n\n// get ancestors of a node\nexport function ancestors(dataset, node) {\n\tlet ancestors = [];\n\tfunction recurse(node) {\n\t\tif(node.data) node = node.data;\n\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\n\t\t\trecurse(getNodeByName(dataset, node.mother));\n\t\t\trecurse(getNodeByName(dataset, node.father));\n\t\t}\n\t\tancestors.push(node);\n\t}\n\trecurse(node);\n\treturn ancestors;\n}\n\n// test if two nodes are consanguinous partners\nexport function consanguity(node1, node2, opts) {\n\tif(node1.depth !== node2.depth) // parents at different depths\n\t\treturn true;\n\tlet ancestors1 = ancestors(opts.dataset, node1);\n\tlet ancestors2 = ancestors(opts.dataset, node2);\n\tlet names1 = $.map(ancestors1, function(ancestor, _i){return ancestor.name;});\n\tlet names2 = $.map(ancestors2, function(ancestor, _i){return ancestor.name;});\n\tlet consanguity = false;\n\t$.each(names1, function( _index, name ) {\n\t\tif($.inArray(name, names2) !== -1){\n\t\t\tconsanguity = true;\n\t\t\treturn false;\n\t\t}\n\t});\n\treturn consanguity;\n}\n\n// return a flattened representation of the tree\nexport function flatten(root) {\n\tlet flat = [];\n\tfunction recurse(node) {\n\t\tif(node.children)\n\t\t\tnode.children.forEach(recurse);\n\t\tflat.push(node);\n\t}\n\trecurse(root);\n\treturn flat;\n}\n\n// Adjust D3 layout positioning.\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\n// from links - e.g. where there is a single child plus a hidden child\nexport function adjust_coords(opts, root, flattenNodes) {\n\tfunction recurse(node) {\n\t\tif (node.children) {\n\t\t\tnode.children.forEach(recurse);\n\n\t\t\tif(node.data.father !== undefined) { \t// hidden nodes\n\t\t\t\tlet father = getNodeByName(flattenNodes, node.data.father.name);\n\t\t\t\tlet mother = getNodeByName(flattenNodes, node.data.mother.name);\n\t\t\t\tlet xmid = (father.x + mother.x) /2;\n\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\n\t\t\t\t\tlet diff = node.x - xmid;\n\t\t\t\t\tif(node.children.length == 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\n\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\n\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\n\t\t\t\t\t\t\t\tchild1.x = xmid;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if(node.children.length == 1 && !node.children[0].data.hidden) {\n\t\t\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\n\t\t\t\t\t\t\tif(node.children.length == 1) {\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\n\t\t\t\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\n\t\t\t\t\t\t\t\tfor(let i=0; i<descendants.length; i++) {\n\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\trecurse(root);\n\trecurse(root);\n}\n\n// test if moving siblings by diff overlaps with other nodes\nfunction nodesOverlap(opts, node, diff, root) {\n\tlet descendants = node.descendants();\n\tlet descendantsNames = $.map(descendants, function(descendant, _i){return descendant.data.name;});\n\tlet nodes = root.descendants();\n\tfor(let i=0; i<descendants.length; i++){\n\t\tlet descendant = descendants[i];\n\t\tif(node.data.name !== descendant.data.name){\n\t\t\tlet xnew = descendant.x - diff;\n\t\t\tif(overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// test if x position overlaps a node at the same depth\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\n\tfor(let n=0; n<nodes.length; n++) {\n\t\tif(depth == nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) == -1){\n\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// given a persons name return the corresponding d3 tree node\nexport function getNodeByName(nodes, name) {\n\tfor (let i = 0; i < nodes.length; i++) {\n\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\treturn nodes[i];\n\t\telse if (name === nodes[i].name)\n\t\t\treturn nodes[i];\n\t}\n}\n\n// given the name of a url param get the value\nexport function urlParam(name){\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\n\tif (results===null)\n\t   return null;\n\telse\n\t   return results[1] || 0;\n}\n\n// get grandparents index\nfunction get_grandparents_idx(dataset, midx, fidx) {\n\tlet gmidx = midx;\n\tlet gfidx = fidx;\n\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\n\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\n\t}\n\treturn {'midx': gmidx, 'fidx': gfidx};\n}\n\n// check by name if the individual exists\nexport function exists(opts, name){\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\n}\n\n// print options and dataset\nexport function print_opts(opts){\n\t$(\"#pedigree_data\").remove();\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\n\tlet key;\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\n\t\tfor(key in opts.dataset[i]) {\n\t\t\tif(key === 'name') continue;\n\t\t\tif(key === 'parent')\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\n\t\t\telse if (key === 'children') {\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\n\t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\n\t\t\t} else\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\n\t\t}\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\n\n\t}\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\n\tfor(key in opts) {\n\t\tif(key === 'dataset') continue;\n\t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\n\t}\n}\n\nexport function is_fullscreen(){\n\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);\n}\n\n\nexport function get_svg_dimensions(opts) {\n\treturn {'width' : (is_fullscreen()? window.innerWidth  : opts.width),\n\t\t\t'height': (is_fullscreen()? window.innerHeight : opts.height)};\n}\n\nexport function get_tree_dimensions(opts) {\n\t// / get score at each depth used to adjust node separation\n\tlet svg_dimensions = get_svg_dimensions(opts);\n\tlet maxscore = 0;\n\tlet generation = {};\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet depth = getDepth(opts.dataset, opts.dataset[i].name);\n\t\tlet children = getAllChildren(opts.dataset, opts.dataset[i]);\n\n\t\t// score based on no. of children and if parent defined\n\t\tlet score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\n\t\tif(depth in generation)\n\t\t\tgeneration[depth] += score;\n\t\telse\n\t\t\tgeneration[depth] = score;\n\n\t\tif(generation[depth] > maxscore)\n\t\t\tmaxscore = generation[depth];\n\t}\n\n\tlet max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\n\tlet tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\n\t\t\t\t\t   svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\n\t\t\t\t\t   svg_dimensions.height - opts.symbol_size : max_depth);\n\treturn {'width': tree_width, 'height': tree_height};\n}\n\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {getposition, setposition} from './pedcache.js';\n\nlet zm;\n\n// initialise zoom and drag\nexport function init_zoom(opts, svg) {\n\t// offsets\n\tlet xi = opts.symbol_size/2;\n\tlet yi = -opts.symbol_size*2.5;\n\n\tzm = d3.zoom()\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\n\t  .filter(function(e) {\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\n\t\t\t\tif(e.type && e.type === 'wheel') return false\n\t\t\t}\n\t\t\t// ignore dblclick & secondary mouse buttons\n\t\t\treturn (e.type !== 'dblclick') && !e.button})\n\t  .on('zoom', function(e) { zooming(e, opts); });\n\tsvg.call(zm);\n\n\t// set initial position & scale\n\tlet xyk = getposition(opts);\t\t// cached position\n\tlet k = (xyk.length == 3 ? xyk[2] : 1);\n\tlet x = (xyk[0] !== null ? xyk[0]/k: (xi*k));\n\tlet y = (xyk[1] !== null ? xyk[1]/k: (yi*k));\n\n\tvar transform = d3.zoomIdentity\n      .scale(k)\n      .translate(x, y);\n    svg.call(zm.transform, transform);\n}\n\n// scale size the pedigree\nexport function btn_zoom(opts, scale) {\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tsvg.transition().duration(50).call(zm.scaleBy, scale);\n}\n\nexport function scale_to_fit(opts) {\n\tlet d = get_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tlet size = get_svg_size(svg);\n\tlet f = 1;\n\tlet k = (f / Math.max(d.wid/size.w, d.hgt/size.h));\n\n\tif(k < opts.zoomIn) zm.scaleExtent([k, opts.zoomOut]);\n\n\tlet ped = get_pedigree_center(opts);\n\tsvg.call(zm.translateTo, ped.x-(opts.symbol_size), ped.y-(opts.symbol_size));\n\tsetTimeout(function(){svg.transition().duration(700).call(zm.scaleTo, k)}, 400);\n}\n\nfunction zooming(e, opts) {\n\t(opts.DEBUG && console.log(\"zoom\", e.transform));\n\tlet t = e.transform;\n\tlet k = (t.k && t.k !== 1 ? t.k : undefined);\n\tsetposition(opts, t.x, t.y, k);\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tped.attr('transform', 'translate(' + t.x + ',' + t.y + ')' + (k ? ' scale(' + k + ')' : ''));\n}\n\nfunction get_pedigree_center(opts) {\n\tlet b = get_bounds(opts);\n\treturn {x: b.xmin+(b.xmax-b.xmin)/2, y: b.ymin+(b.ymax-b.ymin)/2};\n}\n\n// find width/height of pedigree graphic\nfunction get_dimensions(opts) {\n\tlet b = get_bounds(opts);\n\treturn {wid: Math.abs(b.xmax-b.xmin), hgt: Math.abs(b.ymax-b.ymin)};\n}\n\n/**\n * Get the min/max boundary of the diagram\n */\nexport function get_bounds(opts) {\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tlet xmin = Number.MAX_VALUE;\n\tlet xmax = -1000000;\n\tlet ymin = Number.MAX_VALUE;\n\tlet ymax = -1000000;\n\tlet sym = opts.symbol_size;\n\tped.selectAll('g').each(function(d, _i) {\n\t\tif(d.x && d.data.name !== 'hidden_root' && !d.data.hidden) {\n\t\t\tlet n = getNodeSize(opts, this, sym);\n\t\t\tif(d.x-sym < xmin) xmin = d.x-sym;\n\t\t\tif(d.x+n.w+sym > xmax) xmax = d.x+n.w+sym;\n\t\t\tif(d.y < ymin) ymin = d.y;\n\t\t\tif(d.y+n.h+sym > ymax) ymax = d.y+n.h+sym;\n\t\t}\n\t});\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\n}\n\n/**\n * Get the size of an individual's graphical representation\n */\nfunction getNodeSize(opts, g_elm, sym) {\n\tlet node = d3.select(g_elm).node();\n\tlet dg = node.getBBox();\n\tlet w = dg.width;\n\tlet h = dg.height;\n\tif(w === 0 && h === 0) {\t// pedigree not shown yet (family history section not opened)\n\t\ttry {\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t\tlet text_elements = d3.select(g_elm).selectAll(\".indi_details\"); // get individuals details\n\t\t\tfor(let i=0; i<text_elements._groups[0].length; i++) {\n\t\t\t\tlet txt = text_elements._groups[0][i].firstChild.nodeValue;\n\t\t\t\tlet txtsize = getTextSize(txt, opts.font_family, opts.font_size);\n\t\n\t\t\t\tw = Math.max(txtsize.w+sym/2, w);\n\t\t\t\th = Math.max((sym*2)+(i*txtsize.h), h);\n\t\t\t}\n\t\t} catch(err) {\n\t\t\tconsole.error(err);\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t}\n\t}\n\treturn {w:w, h:h};\n}\n\n/**\n * Calculate width and height of text\n */\nfunction getTextSize(txt, font, fontSize) {\n\t  let o = $('<div></div>')\n\t            .text(txt)\n\t            .css(\n\t\t\t\t\t{'position': 'absolute',\n\t\t\t\t\t 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden',\n\t\t\t\t\t 'font': font || 'Helvetica',\n\t\t\t\t\t 'fontSize': fontSize || '1em'})\n\t            .appendTo($('body'));\n\t  let s = {w: o.width(), h:o.height()};\n\t  o.remove();\n\t  return s;\n}\n\nfunction get_svg_size(svg) {\n\treturn {w: svg.node().clientWidth, h:svg.node().clientHeight};\n}\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// undo, redo, reset buttons\nimport * as pedcache from './pedcache.js';\nimport {rebuild, build} from './pedigree.js';\nimport {btn_zoom, scale_to_fit} from './zoom.js';\nimport {copy_dataset, getProbandIndex, is_fullscreen} from './utils.js';\n\nexport function addButtons(options) {\n\tlet opts = $.extend({\n        // defaults\n\t\tbtn_target: 'pedigree_history'\n    }, options );\n\n\tlet btns = [{\"fa\": \"fa-undo pull-left\", \"title\": \"undo\"},\n\t\t\t\t{\"fa\": \"fa-redo pull-left\", \"title\": \"redo\"},\n\t\t\t\t{\"fa\": \"fa-refresh pull-left\", \"title\": \"reset\"}];\n\n\tbtns.push({\"fa\": \"fa-crosshairs pull-right\", \"title\": \"scale-to-fit\"});\n\tif(opts.zoomSrc && (opts.zoomSrc.indexOf('button') > -1)) {\n\t\tif(opts.zoomOut != 1)\n\t\t\tbtns.push({\"fa\": \"fa-minus-circle pull-right\", \"title\": \"zoom-out\"});\n\t\tif(opts.zoomIn != 1)\n\t\t\tbtns.push({\"fa\": \"fa-plus-circle pull-right\", \"title\": \"zoom-in\"});\n\t}\n\tbtns.push({\"fa\": \"fa-arrows-alt pull-right\", \"title\": \"fullscreen\"});\n\n\tlet lis = \"\";\n\tfor(let i=0; i<btns.length; i++) {\n\t\tlis += '<span>';\n\t\tlis += '&nbsp;<i class=\"fa fa-lg ' + btns[i].fa + '\" ' +\n\t\t               (btns[i].fa == \"fa-arrows-alt pull-right\" ? 'id=\"fullscreen\" ' : '') +\n\t\t               ' aria-hidden=\"true\" title=\"'+ btns[i].title +'\"></i>';\n\t\tlis += '</span>';\n\t}\n\t$( \"#\"+opts.btn_target ).append(lis);\n\taddPbuttonEvents(opts);\n}\n\nfunction addPbuttonEvents(opts) {\n\t// fullscreen\n    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(_e)  {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\t\topts.dataset = local_dataset;\n\t\t}\n\t\trebuild(opts);\n\t\tsetTimeout(function(){ scale_to_fit(opts); }, 500);\n    });\n\n\t$('#fullscreen').on('click', function(_e) {\n\t\t// toggle fullscreen\n\t\tif (!is_fullscreen()) {\n\t\t\tlet target = $(\"#\"+opts.targetDiv)[0];\n\t\t\tif (target.requestFullscreen) {\n                target.requestFullscreen();\n            } else if (document.documentElement.mozRequestFullScreen) {\n\t\t\t\ttarget.mozRequestFullScreen(); // Firefox\n            } else if (document.documentElement.webkitRequestFullscreen) {\n                target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); // Chrome and Safari\n            } else if (document.documentElement.msRequestFullscreen) {\n                target.msRequestFullscreen(); // IE\n            }\n\t\t} else {\n            if (document.exitFullscreen) {\n                document.exitFullscreen();\n            } else if (document.msExitFullscreen) {\n                document.msExitFullscreen();\n            } else if (document.mozCancelFullScreen) {\n                document.mozCancelFullScreen();\n            } else if (document.webkitExitFullscreen) {\n                document.webkitExitFullscreen();\n            }\n\t\t}\n\t});\n\n\t// press and hold to zoom in/out\n\tlet timeoutId = 0;\n\tfunction zoomIn() {btn_zoom(opts, 1.05);}\n\tfunction zoomOut() {btn_zoom(opts, 0.95);}\n\t$('.fa-plus-circle, .fa-minus-circle').on('mousedown', function() {\n\t    timeoutId = setInterval(($( this ).hasClass( \"fa-plus-circle\" ) ? zoomIn : zoomOut), 50);\n\t}).on('mouseup mouseleave', function() {\n\t    clearInterval(timeoutId);\n\t});\n\n\t// undo/redo/reset\n\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\n\t\te.stopPropagation();\n\t\tif($(e.target).hasClass(\"disabled\"))\n\t\t\treturn false;\n\n\t\tif($(e.target).hasClass('fa-undo')) {\n\t\t\topts.dataset = pedcache.previous(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\tbuild(opts);\n\t\t} else if ($(e.target).hasClass('fa-redo')) {\n\t\t\topts.dataset = pedcache.next(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\tbuild(opts);\n\t\t} else if ($(e.target).hasClass('fa-refresh')) {\n\t\t\t$('<div id=\"msgDialog\">Resetting the pedigree may result in loss of some data.</div>').dialog({\n\t\t\t\ttitle: 'Confirm Reset',\n\t\t\t\tresizable: false,\n\t\t\t\theight: \"auto\",\n\t\t\t\twidth: 400,\n\t\t\t\tmodal: true,\n\t\t\t\tbuttons: {\n\t\t\t\t\tContinue: function() {\n\t\t\t\t\t\treset(opts, opts.keep_proband_on_reset);\n\t\t\t\t\t\t$(this).dialog( \"close\" );\n\t\t\t\t\t},\n\t\t\t\t\tCancel: function() {\n\t\t\t\t\t\t$(this).dialog( \"close\" );\n\t\t\t\t\t\treturn;\n\t\t\t\t    }\n\t\t\t\t}\n\t\t\t});\n\t\t} else if ($(e.target).hasClass('fa-crosshairs')) {\n\t\t\tscale_to_fit(opts);\n\t\t} \n\t\t// trigger fhChange event\n\t\t$(document).trigger('fhChange', [opts]);\n\t});\n}\n\n// reset pedigree and clear the history\nfunction reset(opts, keep_proband) {\n\tlet proband;\n\tif(keep_proband) {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tlet newdataset =  copy_dataset(local_dataset);\n\t\tproband = newdataset[getProbandIndex(newdataset)];\n\t\t//let children = pedigree_util.getChildren(newdataset, proband);\n\t\tproband.name = \"ch1\";\n\t\tproband.mother = \"f21\";\n\t\tproband.father = \"m21\";\n\t\t// clear pedigree data but keep proband data and risk factors\n\t\tpedcache.clear_pedigree_data(opts)\n\t} else {\n\t\tproband = {\n\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"\n\t\t};\n\t\tpedcache.clear(opts); // clear all storage data\n\t}\n\n\tdelete opts.dataset;\n\n\tlet selected = $(\"input[name='default_fam']:checked\");\n\tif(selected.length > 0 && selected.val() == 'extended2') {    // secondary relatives\n\t\topts.dataset = [\n\t\t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\n\t\t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\n\t\t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\n\t\t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\n\t\t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\n\t\t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\tproband,\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\n\t\t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\n\t\t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"}];\n\t} else if(selected.length > 0 && selected.val() == 'extended1') {    // primary relatives\n\t\topts.dataset = [\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\tproband,\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"}];\n\t} else {\n\t\topts.dataset = [\n\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t{\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\tproband];\n\t}\n\trebuild(opts);\n}\n\nexport function updateButtons(opts) {\n\tlet current = pedcache.get_count(opts);\n\tlet nstore = pedcache.nstore(opts);\n\tlet id = \"#\"+opts.btn_target;\n\tif(nstore <= current)\n\t\t$(id+\" .fa-redo\").addClass('disabled');\n\telse\n\t\t$(id+\" .fa-redo\").removeClass('disabled');\n\n\tif(current > 1)\n\t\t$(id+\" .fa-undo\").removeClass('disabled');\n\telse\n\t\t$(id+\" .fa-undo\").addClass('disabled');\n}\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport * as pedigree_util from './utils.js';\n\n// cancers, genetic & pathology tests\nexport let cancers = {\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\n\t};\nexport let genetic_test1 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d', 'rad51c', 'brip1'];\nexport let genetic_test2 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1'];\n\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\n\n// risk factor to storage\nlet RISK_FACTOR_STORE = new Object();\n\n// get surgical ops and PRS for canrisk header\nexport function get_meta() {\n\tlet meta = get_surgical_ops();\n\tlet prs;\n\ttry {\n\t\tprs = get_prs_values();\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\n\t\t}\n\t} catch(err) { console.warn(\"PRS\", prs); }\n\treturn meta;\n}\n\n// return a non-anonimised pedigree format\nexport function get_non_anon_pedigree(dataset, meta, version=2, ethnicity=undefined) {\n\treturn get_pedigree(dataset, undefined, meta, false, version, ethnicity);\n}\n\n//check if input has a value\nexport function hasInput(id) {\n\treturn $.trim($('#'+id).val()).length !== 0;\n}\n\n//return true if the object is empty\nlet isEmpty = function(myObj) {\n\tfor(let key in myObj) {\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\n//get breast and ovarian PRS values\nexport function get_prs_values() {\n\tlet prs = {};\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\n\t\tprs['breast_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\n\t\tprs['ovarian_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\n\t\t};\n\t}\n\tconsole.log(prs);\n\treturn (isEmpty(prs) ? 0 : prs);\n}\n\nfunction get_surgical_ops() {\n\tlet meta = \"\";\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";OVARY2=y\";\n\t}\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";MAST2=y\";\n\t}\n\treturn meta;\n}\n\nexport function readCanRisk(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet hdr = [];  // collect risk factor header lines\n\tconst regexp = /([0-9])/;\n\tlet version = 2;\n\tlet gt = (version === 1 ? genetic_test1 : genetic_test2);\n\tlet ncol = [26, 27, 27];\t// number of columns - v1, v2, v3\n\t// assumes two line header\n\tfor(let i = 0;i < lines.length;i++){\n\t\tlet ln = lines[i].trim();\n\t\tif(ln.indexOf(\"##\") === 0) {\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0) {\n\t\t\t\tconst match = ln.match(regexp);\n\t\t\t\tversion = parseInt(match[1]);\n\t\t\t\tgt = (version === 1 ? genetic_test1 : genetic_test2);\n\t\t\t\tconsole.log(\"CanRisk File Format version \"+version);\n\n\t\t\t\tif(ln.indexOf(\";\") > -1) {   // contains surgical op data\n\t\t\t\t\tlet ops = ln.split(\";\");\n\t\t\t\t\tfor(let j=1; j<ops.length; j++) {\n\t\t\t\t\t\tlet opdata = ops[j].split(\"=\");\n\t\t\t\t\t\tif(opdata.length === 2) {\n\t\t\t\t\t\t\thdr.push(ops[j]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet delim = /\\t/;\n\t\tif(ln.indexOf('\\t') < 0) {\n\t\t\tdelim = /\\s+/;\n\t\t\tconsole.log(\"NOT TAB DELIM\");\n\t\t}\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\n\n\t\tif(attr.length > 1) {\n\t\t\tif(attr.length !== ncol[version-1]) {\n\t\t\t\tconsole.error(ln, attr);\n\t\t\t\tthrow 'Found number of columns '+attr.length+'; expected '+ncol[version-1]+' for CanRisk version '+version;\n\t\t\t}\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] == 1) indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\n\t\t\t\tif(gene_test[0] !== '0') {\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N'))\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\n\t\t\t\t} else {\n\t\t\t\t\tif(gene_test[1] === 'P' || gene_test[1] === 'N')\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tlet path_test = attr[idx].split(\":\");\n\t\t\tfor(let j=0; j<path_test.length; j++) {\n\t\t\t\tif(path_test[j] !== '0') {\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\treturn [hdr, ped];\n}\n\n/**\n * Get the mammographic density formatted CanRisk data file line\n */\nexport function get_mdensity(mdensity) {\n\tconst regexp = /^(birads|Volpara|Stratus)=/i;\n\tif(regexp.test(mdensity))\n\t\treturn \"\\n##\"+mdensity;\n\t\t\n\tconst birads = /^(1|2|3|4|a|b|c|d)$/i\n\tif(birads.test(mdensity))\n\t\treturn \"\\n##birads=\"+mdensity;\n\n\tconsole.error(\"Unrecognised mammographic density format :: \" + mdensity);\n\treturn \"\"\n}\n\n/**\n * Get CanRisk formated pedigree.\n */\nexport function get_pedigree(dataset, famid, meta, isanon, version=2, ethnicity=undefined) {\n\tlet msg = \"##CanRisk \" + (version === 1 ? \"1.0\" : (version === 2 ? \"2.0\" : \"3.0\"));\n\tif(!famid) {\n\t\tfamid = \"XXXX\";\n\t}\n\tif(meta) {\n\t\tmsg += meta;\n\t}\n\tif(typeof isanon === 'undefined') {\n\t\tisanon = true;\n\t}\n\t// array of individuals excluded from the calculation\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\n\n\t// female risk factors\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\n\tlet sex = 'F';\n\tif(probandIdx) {\n\t\tsex = dataset[probandIdx].sex;\n\t}\n\n\tif(sex !== 'M') {\n\t\tlet menarche    = get_risk_factor('menarche_age');\n\t\tlet parity      = get_risk_factor('parity');\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\n\t\tlet mht_use     = get_risk_factor('mht');\n\t\tlet bmi         = get_risk_factor('bmi');\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\n\t\tlet hgt         = get_risk_factor('height');\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\n\t\tlet endo        = get_risk_factor('endometriosis');\n\n\t\tif(menarche !== undefined)\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\n\t\tif(parity !== undefined)\n\t\t\tmsg += \"\\n##parity=\"+parity;\n\t\tif(first_birth !== undefined)\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\n\t\tif(oc_use !== undefined)\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\n\t\tif(mht_use !== undefined)\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\n\t\tif(bmi !== undefined)\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\n\t\tif(alcohol !== undefined)\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\n\t\tif(menopause !== undefined)\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\n\t\tif(mdensity !== undefined)\n\t\t\tmsg += get_mdensity(mdensity);\n\t\tif(hgt !== undefined)\n\t\t\tmsg += \"\\n##height=\"+hgt;\n\t\tif(tl !== undefined)\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\n\t\t\t\tmsg += \"\\n##TL=Y\";\n\t\t\telse\n\t\t\t\tmsg += \"\\n##TL=N\";\n\n\t\tif(endo !== undefined)\n\t\t\tmsg += \"\\n##endo=\"+endo;\n\t}\n\t\n\tif(version > 2 && ethnicity !== undefined) {\n\t\tmsg += \"\\n##ethnicity=\"+ethnicity;\n\t}\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\"\n\n\tlet gt = (version === 1 ? genetic_test1 : genetic_test2);\n\tfor(let i=0; i<gt.length; i++) {\n\t\tmsg += \"\\t\"+gt[i].toUpperCase();\n\t}\n\tmsg += \"\\tER:PR:HER2:CK14:CK56\";\n\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet p = dataset[i];\n\t\tif($.inArray(p.name, excl) != -1) {\n\t\t\tconsole.log('EXCLUDE: '+p.name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\n\t\tif(isanon)\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\n\t\telse\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) == -1)? p.father : 0)+'\\t';\t// max 7 chars\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) == -1)? p.mother : 0)+'\\t';\t// max 7 chars\n\t\tmsg += p.sex+'\\t';\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\n\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\tif(diagnosis_age in p)\n\t\t\t\tmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\n\t\t\telse\n\t\t\t\tmsg += '0\\t';\n\t\t});\n\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\n\n\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\tif(gt[j]+'_gene_test' in p &&\n\t\t\t   p[gt[j]+'_gene_test']['type'] !== '-' &&\n\t\t\t   p[gt[j]+'_gene_test']['result'] !== '-') {\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['type'] + ':';\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['result'] + '\\t';\n\t\t\t} else {\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\n\t\t\t}\n\t\t}\n\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\n\t\t\t} else {\n\t\t\t\tmsg += '0';\n\t\t\t}\n\t\t\tif(j<(pathology_tests.length-1))\n\t\t\t\tmsg += \":\";\n\t\t}\n\t}\n\tconsole.log(msg, RISK_FACTOR_STORE);\n\treturn msg;\n}\n\nexport function show_risk_factor_store() {\n\tconsole.log(\"RISK_FACTOR_STORE::\");\n\t$.each(RISK_FACTOR_STORE, function(name, val){\n\t\tconsole.log(name + \" : \" + val);\n\t});\n}\n\nexport function save_risk_factor(risk_factor_name, val) {\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\n}\n\nexport function get_risk_factor(risk_factor_name) {\n\tlet key = store_name(risk_factor_name);\n\tif(key in RISK_FACTOR_STORE) {\n\t\treturn RISK_FACTOR_STORE[key];\n\t}\n\treturn undefined;\n}\n\n// remove risk factor from storage\nexport function remove_risk_factor(risk_factor_name) {\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\n}\n\n// prefix risk factor name with the app/page name\nexport function store_name(risk_factor_name) {\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\n\t       '::' + risk_factor_name;\n}\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree I/O\nimport * as utils from './utils.js';\nimport * as pedcache from './pedcache.js';\nimport {rebuild} from './pedigree.js';\nimport {readCanRisk, cancers, genetic_test1, pathology_tests} from './canrisk_file.js';\nimport {get_bounds} from './zoom.js';\n\n\nexport function addIO(opts) {\n\t$('#load').change(function(e) {\n\t\tload(e, opts);\n\t});\n\n\t$('#save').click(function(_e) {\n\t\tsave(opts);\n\t});\n\n\t$('#print').click(function(_e) {\n\t\tprint(get_printable_svg(opts));\n\t});\n\n\t$('#svg_download').click(function(_e) {\n\t\tsvg_download(get_printable_svg(opts));\n\t});\n\n\t$('#png_download').click(function(_e) {\n\t\tlet deferred = svg2img($('svg'), \"pedigree\");\n\t\t$.when.apply($,[deferred]).done(function() {\n\t\t\tlet obj = getByName(arguments, \"pedigree\");\n\t\t\tif(utils.isEdge() || utils.isIE()) {\n\t\t\t\tlet html=\"<img src='\"+obj.img+\"' alt='canvas image'/>\";\n\t\t\t\tlet newTab = window.open();\t\t// pop-ups need to be enabled\n\t\t\t\tnewTab.document.write(html);\n\t\t\t} else {\n\t\t\t\tlet a\t  = document.createElement('a');\n\t\t\t\ta.href\t = obj.img;\n\t\t\t\ta.download = 'plot.png';\n\t\t\t\ta.target   = '_blank';\n\t\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t\t\t}\n\t\t});\n\t});\n}\n\n/**\n * Get object from array by the name attribute.\n */\nfunction getByName(arr, name) {\n\treturn $.grep(arr, function(o){ return o && o.name == name; })[0];\n}\n\n/**\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\n */\nexport function svg2img(svg, deferred_name, options) {\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\n\tif(!options) options = defaults;\n\t$.each(defaults, function(key, value) {\n\t\tif(!(key in options)) {options[key] = value;}\n\t});\n\n\t// set SVG background to white - fix for jpeg creation\n\tif (svg.find(\".pdf-white-bg\").length === 0){\n\t\tlet d3obj = d3.select(svg.get(0));\n\t\td3obj.append(\"rect\")\n\t\t\t.attr(\"width\", \"100%\")\n\t\t\t.attr(\"height\", \"100%\")\n\t\t\t.attr(\"class\", \"pdf-white-bg\")\n\t\t\t.attr(\"fill\", \"white\");\n\t\td3obj.select(\".pdf-white-bg\").lower();\n\t}\n\n\tlet deferred = $.Deferred();\n\tlet svgStr;\n\tif (typeof window.XMLSerializer != \"undefined\") {\n\t\tsvgStr = (new XMLSerializer()).serializeToString(svg.get(0));\n\t} else if (typeof svg.xml != \"undefined\") {\n\t\tsvgStr = svg.get(0).xml;\n\t}\n\n\tlet imgsrc = 'data:image/svg+xml;base64,'+ btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\n\tlet canvas = document.createElement(\"canvas\");\n\tcanvas.width = svg.width()*options.resolution;\n\tcanvas.height = svg.height()*options.resolution;\n\tlet context = canvas.getContext(\"2d\");\n\tlet img = document.createElement(\"img\");\n\timg.onload = function() {\n\t\tif(utils.isIE()) {\n\t\t\t// change font so it isn't tiny\n\t\t\tsvgStr = svgStr.replace(/ font-size=\"\\d?.\\d*em\"/g, '');\n\t\t\tsvgStr = svgStr.replace(/<text /g, '<text font-size=\"12px\" ');\n\t\t\tlet v = canvg.Canvg.fromString(context, svgStr, {\n\t\t\t\tscaleWidth: canvas.width,\n\t\t\t\tscaleHeight: canvas.height,\n\t\t\t\tignoreDimensions: true\n\t\t\t});\n\t\t\tv.start();\n\t\t\tconsole.log(deferred_name, options.img_type, \"use canvg to create image\");\n\t\t} else {\n\t\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\n\t\t\tconsole.log(deferred_name, options.img_type);\n\t\t}\n\t\tdeferred.resolve({'name': deferred_name, 'resolution': options.resolution, 'img':canvas.toDataURL(options.img_type, 1), 'w':canvas.width, 'h':canvas.height});\n\t};\n\timg.src = imgsrc;\n\treturn deferred.promise();\n}\n\nfunction getMatches(str, myRegexp) {\n\tlet matches = [];\n\tlet match;\n\tlet c = 0;\n\tmyRegexp.lastIndex = 0;\n\twhile ((match = myRegexp.exec(str))) {\n\t\tc++;\n\t\tif(c > 400) {\n\t\t\tconsole.error(\"getMatches: counter exceeded 800\");\n\t\t\treturn -1;\n\t\t}\n\t\tmatches.push(match);\n\t\tif (myRegexp.lastIndex === match.index) {\n\t\t\tmyRegexp.lastIndex++;\n\t\t}\n\t}\n\treturn matches;\n}\n\n// find all url's to make unique\nfunction unique_urls(svg_html) {\n\tlet matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g);\n\tif(matches === -1)\n\t\treturn \"ERROR DISPLAYING PEDIGREE\"\n\n\t$.each(matches, function(_index, match) {\n\t\tlet quote = (match[1] ? match[1] : \"\");\n\t\tlet val = match[2];\n\t\tlet m1 = \"id=\\\"\" + val + \"\\\"\";\n\t\tlet m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\n\n\t\tlet newval = val+utils.makeid(2);\n\t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\"+newval+\"\\\"\" );\n\t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\"+newval+\")\" );\n   });\n\treturn svg_html;\n}\n\n// return a copy pedigree svg\nexport function copy_svg(opts) {\n\tlet svg_node = get_printable_svg(opts);\n\tlet d3obj = d3.select(svg_node.get(0));\n\n\t// remove unused elements\n\td3obj.selectAll(\".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection\").remove();\n\td3obj.selectAll(\"text\")\n\t  .filter(function(){\n\t\t return d3.select(this).text().length === 0\n\t  }).remove();\n\treturn $(unique_urls(svg_node.html()));\n}\n\n// get printable svg div, adjust size to tree dimensions and scale to fit\nfunction get_printable_svg(opts) {\n\tlet local_dataset = pedcache.current(opts); // get current dataset\n\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\topts.dataset = local_dataset;\n\t}\n\n\tlet svg_div = $('<div></div>');  \t\t\t\t// create a new div\n\tlet svg = $('#'+opts.targetDiv).find('svg').clone().appendTo(svg_div);\n\n\tlet a4 = {w: (595-40), h: (842-50)};\n\t\n\tlet b = get_bounds(opts);\n\tlet d = {w: Math.abs(b.xmax-b.xmin), h: Math.abs(b.ymax-b.ymin)};\n\tlet f = 1;\n\tlet k = (f / Math.max(d.w/a4.w, d.h/a4.h));\n\n\tlet xi = -(b.xmin-(opts.symbol_size))*k;\n\tlet yi = -(b.ymin-(opts.symbol_size))*k;\n\n\tsvg.attr('width', a4.w);\n\tsvg.attr('height', d.h*k);\t\n\n\tsvg.find(\".diagram\").attr(\"transform\", \"translate(\"+xi+\", \"+yi+\") scale(\"+k+\")\");\n\treturn svg_div;\n}\n\n// download the SVG to a file\nexport function svg_download(svg){\n\tlet a\t  = document.createElement('a');\n\ta.href\t = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svg.html() ) ) );\n\ta.download = 'plot.svg';\n\ta.target   = '_blank';\n\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n}\n\n// open print window for a given element\nexport function print(el, id){\n\tif(el.constructor !== Array)\n\t\tel = [el];\n\n\tlet width = $(window).width()*0.9;\n\tlet height = $(window).height()-10;\n\tlet cssFiles = [\n\t\t'/static/css/canrisk.css',\n\t\t'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css'\n\t];\n\tlet printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\n\tlet headContent = '';\n\tfor(let i=0; i<cssFiles.length; i++)\n\t\theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\n\theadContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\n\n\tlet html = \"\";\n\tfor(let i=0; i<el.length; i++) {\n\t\tif(i === 0 && id)\n\t\t\thtml += id;\n\t\thtml += $(el[i]).html();\n\t\tif(i < el.length-1)\n\t\t\thtml += '<div class=\"page-break\"> </div>';\n\t}\n\n\tprintWindow.document.write(headContent);\n\tprintWindow.document.write(html);\n\tprintWindow.document.close();\n\n\tprintWindow.focus();\n\tsetTimeout(function() {\n\t\tprintWindow.print();\n\t\tprintWindow.close();\n\t}, 300);\n}\n\n// save content to a file\nexport function save_file(opts, content, filename, type){\n\tif(opts.DEBUG)\n\t\tconsole.log(content);\n\tif(!filename) filename = \"ped.txt\";\n\tif(!type) type = \"text/plain\";\n\n   let file = new Blob([content], {type: type});\n   if (window.navigator.msSaveOrOpenBlob) \t// IE10+\n\t   window.navigator.msSaveOrOpenBlob(file, filename);\n   else { \t\t\t\t\t\t\t\t\t// other browsers\n\t   let a = document.createElement(\"a\");\n\t   let url = URL.createObjectURL(file);\n\t   a.href = url;\n\t   a.download = filename;\n\t   document.body.appendChild(a);\n\t   a.click();\n\t   setTimeout(function() {\n\t\t   document.body.removeChild(a);\n\t\t   window.URL.revokeObjectURL(url);\n\t\t}, 0);\n\t}\n}\n\nfunction save(opts){\n\tlet content = JSON.stringify(pedcache.current(opts));\n\tsave_file(opts, content);\n}\n\nfunction canrisk_validation(opts) {\n\t$.each(opts.dataset, function(_idx, p) {\n\t\tif(!p.hidden && p.sex === 'M' && !utils.isProband(p)) {\n\t\t\tif(p[cancers['breast_cancer2']]) {\n\t\t\t\tlet msg = 'Male family member ('+p.display_name+') with contralateral breast cancer found. '+\n\t\t\t\t\t\t  'Please note that as the risk models do not take this into account the second '+\n\t\t\t\t\t\t  'breast cancer is ignored.'\n\t\t\t\tconsole.error(msg);\n\t\t\t\tdelete p[cancers['breast_cancer2']];\n\t\t\t\tutils.messages(\"Warning\", msg);\n\t\t\t}\n\t\t}\n\t});\n}\n\n/** Read and load pedigree data string */\nexport function load_data(d, opts) {\n\tif(opts.DEBUG) console.log(d);\n\tlet risk_factors;\n\ttry {\n\t\tif(d.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\n\t\t\topts.dataset = readBoadiceaV4(d, 4);\n\t\t\tcanrisk_validation(opts);\n\t\t} else if(d.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\n\t\t\topts.dataset = readBoadiceaV4(d, 2);\n\t\t\tcanrisk_validation(opts);\n\t\t} else if(d.indexOf(\"##\") === 0 && d.indexOf(\"CanRisk\") !== -1) {\n\t\t\tlet canrisk_data = readCanRiskFile(d);\n\t\t\trisk_factors = canrisk_data[0];\n\t\t\topts.dataset = canrisk_data[1];\n\t\t\tcanrisk_validation(opts);\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tlet ped = JSON.parse(d);\n\t\t\t\tlet to_process = true;\n\t\t\t\tfor(let i=0;i<ped.length;i++) {\n\t\t\t\t\tif(ped[i].top_level) {\n\t\t\t\t\t\tto_process = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\topts.dataset = (to_process ? process_ped(ped) : ped);\n\t\t\t} catch(err) {\n\t\t\t\topts.dataset = readLinkage(d);\n\t\t\t}\n\t\t}\n\t\tutils.validate_pedigree(opts);\n\t} catch(err1) {\n\t\tconsole.error(err1, d);\n\t\tutils.messages(\"File Error\", ( err1.message ? err1.message : err1));\n\t\treturn;\n\t}\n\tif(opts.DEBUG) console.log(opts.dataset);\n\ttry{\n\t\tpedcache.setposition(opts);\t\t// clear position\n\t\trebuild(opts);\n\t\tconsole.log(risk_factors);\n\t\t// load risk factors - fire riskfactorChange event\n\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\n\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\n\t\n\t\ttry {\n\t\t\t// update FH section\n\t\t\tacc_FamHist_ticked();\n\t\t\tacc_FamHist_Leave();\n\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\n\t\t} catch(err3) {\n\t\t\t// ignore error\n\t\t}\n\t} catch(err2) {\n\t\tutils.messages(\"File Error\", ( err2.message ? err2.message : err2));\n\t}\n}\n\nfunction load(e, opts) {\n\tlet f = e.target.files[0];\n\tif(f) {\n\t\tlet reader = new FileReader();\n\t\treader.onload = function(e) {\n\t\t\tload_data(e.target.result, opts)\n\t\t};\n\t\treader.onerror = function(event) {\n\t\t\tutils.messages(\"File Error\", \"File could not be read! Code \" + event.target.error.code);\n\t\t};\n\t\treader.readAsText(f);\n\t} else {\n\t\tconsole.error(\"File could not be read!\");\n\t}\n\t$(\"#load\")[0].value = ''; // reset value\n}\n\n//\n// https://www.cog-genomics.org/plink/1.9/formats#ped\n// https://www.cog-genomics.org/plink/1.9/formats#fam\n//\t1. Family ID ('FID')\n//\t2. Within-family ID ('IID'; cannot be '0')\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\n//  7. Genotypes (column 7 onwards);\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\nexport function readLinkage(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet famid;\n\tfor(let i = 0;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t   if(attr.length < 5)\n\t\t   throw('unknown format');\n\t   let sex = (attr[4] == '1' ? 'M' : (attr[4] == '2' ? 'F' : 'U'));\n\t   let indi = {\n\t\t\t'famid': attr[0],\n\t\t\t'display_name': attr[1],\n\t\t\t'name':\tattr[1],\n\t\t\t'sex': sex\n\t\t};\n\t\tif(attr[2] !== \"0\") indi.father = attr[2];\n\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\n\n\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\n\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\n\t\t\tbreak;\n\t\t}\n\t\tif(attr[5] == \"2\") indi.affected = 2;\n\t\t// add genotype columns\n\t\tif(attr.length > 6) {\n\t\t\tindi.alleles = \"\";\n\t\t\tfor(let j=6; j<attr.length; j+=2) {\n\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\n\t\t\t}\n\t\t}\n\n\t\tped.unshift(indi);\n\t\tfamid = attr[0];\n\t}\n\treturn process_ped(ped);\n}\n\nexport function readCanRiskFile(boadicea_lines) {\n\tlet [hdr, ped] = readCanRisk(boadicea_lines);\n\ttry {\n\t\treturn [hdr, process_ped(ped)];\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn [hdr, ped];\n\t}\n}\n\n// read boadicea format v4 & v2\nexport function readBoadiceaV4(boadicea_lines, version) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\t// assumes two line header\n\tfor(let i = 2;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t\tif(attr.length > 1) {\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] == 1) indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(_cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(version === 4) {\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, P = positive, N = negative\n\t\t\t\tfor(let j=0; j<5; j++) {\n\t\t\t\t\tidx+=2;\n\t\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\n\t\t\t\t\t\t\tindi[genetic_test1[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (version === 2) {\n\t\t\t\t// genetic test BRCA1, BRCA2\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\n\t\t\t\tidx+=2; \t// gtest\n\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T')) {\n\t\t\t\t\t\tif(attr[idx-1] === 'N') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '1') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '2') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '3') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t}\n\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t\tif(attr[idx] !== '0') {\n\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = attr[idx];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +attr[idx]);\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\n\ttry {\n\t\treturn process_ped(ped);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn ped;\n\t}\n}\n\nfunction process_ped(ped) {\n\t// find the level of individuals in the pedigree\n\tfor(let j=0;j<2;j++) {\n\t\tfor(let i=0;i<ped.length;i++) {\n\t\t\tgetLevel(ped, ped[i].name);\n\t\t}\n\t}\n\n\tfix_n_balance_levels(ped);\n\n\t// find the max level (i.e. top_level)\n\tlet max_level = 0;\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(ped[i].level && ped[i].level > max_level)\n\t\t\tmax_level = ped[i].level;\n\t}\n\n\t// identify top_level and other nodes without parents\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(utils.getDepth(ped, ped[i].name) == 1) {\n\t\t\tif(ped[i].level && ped[i].level == max_level) {\n\t\t\t\tped[i].top_level = true;\n\t\t\t} else {\n\t\t\t\tped[i].noparents = true;\n\n\t\t\t\t// 1. look for partners parents\n\t\t\t\tlet pidx = getPartnerIdx(ped, ped[i]);\n\t\t\t\tif(pidx > -1) {\n\t\t\t\t\tif(ped[pidx].mother) {\n\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\n\t\t\t\t\t\tped[i].father = ped[pidx].father;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// 2. or adopt parents from level above\n\t\t\t\tif(!ped[i].mother){\n\t\t\t\t\tfor(let j=0; j<ped.length; j++) {\n\t\t\t\t\t\tif(ped[i].level == (ped[j].level-1)) {\n\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\n\t\t\t\t\t\t\tif(pidx > -1 && i !== pidx) {\n\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tdelete ped[i].top_level;\n\t\t}\n\t}\n\treturn ped;\n}\n\n// get the partners for a given node\nfunction getPartnerIdx(dataset, anode) {\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother)\n\t\t\treturn utils.getIdxByName(dataset, bnode.father);\n\t\telse if(anode.name === bnode.father)\n\t\t\treturn utils.getIdxByName(dataset, bnode.mother);\n\t}\n\treturn -1;\n}\n\n// for a given individual assign levels to a parents ancestors\nfunction getLevel(dataset, name) {\n\tlet idx = utils.getIdxByName(dataset, name);\n\tlet level = (dataset[idx].level ? dataset[idx].level : 0);\n\tupdate_parents_level(idx, level, dataset);\n}\n\n// recursively update parents levels\nfunction update_parents_level(idx, level, dataset) {\n\tlet parents = ['mother', 'father'];\n\tlevel++;\n\tfor(let i=0; i<parents.length; i++) {\n\t\tlet pidx = utils.getIdxByName(dataset, dataset[idx][parents[i]]);\n\t\tif(pidx >= 0) {\n\t\t\tlet ma = dataset[utils.getIdxByName(dataset, dataset[idx].mother)];\n\t\t\tlet pa = dataset[utils.getIdxByName(dataset, dataset[idx].father)];\n\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\n\t\t\t\tma.level = level;\n\t\t\t\tpa.level = level;\n\t\t\t}\n\n\t\t\tif(ma.level < pa.level) {\n\t\t\t\tma.level = pa.level;\n\t\t\t} else if(pa.level < ma.level) {\n\t\t\t\tpa.level = ma.level;\n\t\t\t}\n\t\t\tupdate_parents_level(pidx, level, dataset);\n\t\t}\n\t}\n}\n\n// for a pedigree fix the levels of children nodes to be consistent with parent\nfunction fix_n_balance_levels(ped) {\n\tlet updated = false;\n\tlet l = ped.length;\n\n\tfor(let i=0;i<l;i++) {\n\t\tlet children = utils.getChildren(ped, ped[i]);\n\t\tlet prt_lvl = ped[i].level;\n\t\tfor(let j=0;j<children.length;j++){\n\t\t\tif(prt_lvl - children[j].level > 1) {\n\t\t\t\tchildren[j].level = prt_lvl-1;\n\t\t\t\tlet ptrs = utils.get_partners(ped, children[j]);\n\n\t\t\t\tfor(let k=0;k<ptrs.length;k++){\n\t\t\t\t\tlet p = utils.getNodeByName(ped, ptrs[k])\n\t\t\t\t\tp.level = prt_lvl-1;\n\n\t\t\t\t\tlet m = utils.getNodeByName(ped, p.mother);\n\t\t\t\t\tlet f = utils.getNodeByName(ped, p.father);\n\t\t\t\t\tif(m) m.level = prt_lvl;\n\t\t\t\t\tif(f) f.level = prt_lvl;\n\t\t\t\t}\n\t\t\t\tupdated = true;\n\t\t\t}\n\t\t}\n\t}\n\treturn updated;\n}\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n\n// set two siblings as twins\nexport function setMzTwin(dataset, d1, d2, twin_type) {\n\tif(!d1[twin_type]) {\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\n\t\tif(!d1[twin_type])\n\t\t\treturn false;\n\t}\n\td2[twin_type] = d1[twin_type];\n\tif(d1.yob)\n\t\td2.yob = d1.yob;\n\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\td2.age = d1.age;\n\treturn true;\n}\n\n// get a new unique twins ID, max of 10 twins in a pedigree\nexport function getUniqueTwinID(dataset, twin_type) {\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tif(dataset[i][twin_type]) {\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\n\t\t\tif (idx > -1)\n\t\t\t\tmz.splice(idx, 1);\n\t\t}\n\t}\n\tif(mz.length > 0)\n\t\treturn mz[0];\n\treturn undefined;\n}\n\n// sync attributes of twins\nexport function syncTwins(dataset, d1) {\n\tif(!d1.mztwin && !d1.dztwin)\n\t\treturn;\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet d2 = dataset[i];\n\t\tif(d2[twin_type] && d1[twin_type] == d2[twin_type] && d2.name !== d1.name) {\n\t\t\tif(twin_type === \"mztwin\")\n\t\t\t  d2.sex = d1.sex;\n\t\t\tif(d1.yob)\n\t\t\t\td2.yob = d1.yob;\n\t\t\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\t\t\td2.age = d1.age;\n\t\t}\n\t}\n}\n\n// check integrity twin settings\nexport function checkTwins(dataset) {\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tfor(let j=0; j<twin_types.length; j++) {\n\t\t\tlet twin_type = twin_types[j];\n\t\t\tif(dataset[i][twin_type]) {\n\t\t\t\tlet count = 0;\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\n\t\t\t\t\tif(dataset[j][twin_type] == dataset[i][twin_type])\n\t\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t\tif(count < 2)\n\t\t\t\t\tdelete dataset[i][[twin_type]];\n\t\t\t}\n\t\t}\n\t}\n}","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree form\nimport {rebuild} from './pedigree.js';\nimport {syncTwins} from './twins.js';\nimport {copy_dataset, getNodeByName} from './utils.js';\nimport {current as pedcache_current} from './pedcache.js';\n\n\n// handle family history change events (undo/redo/delete)\n$(document).on('fhChange', function(e, opts){\n\ttry {\n\t\tlet id = $('#id_name').val();  // get name from hidden field\n\t\tlet node = getNodeByName(pedcache_current(opts), id)\n\t\tif(node === undefined)\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\n\t\telse\n\t\t\t$('form > fieldset').prop('disabled', false);\n\t} catch(err) {\n\t\tconsole.warn(err);\n\t}\n})\n\n// update status field and age label - 0 = alive, 1 = dead\nexport function updateStatus(status) {\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\n\t(status == 1 ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\n\t$('#id_age_'+status).removeClass(\"hidden\");\n\t$('#id_age_'+(status == 1 ? '0' : '1')).addClass(\"hidden\");\n}\n\nexport function nodeclick(node) {\n\t$('form > fieldset').prop('disabled', false);\n\t// clear values\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\n\t$('#person_details select').val('').prop('selected', true);\n\n\t// assign values to input fields in form\n\tif(node.sex === 'M' || node.sex === 'F')\n\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\n\telse\n\t\t$('input[name=sex]').prop('checked', false);\n\tupdate_cancer_by_sex(node);\n\n\tif(!('status' in node))\n\t\tnode.status = 0;\n\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\n\t// show lock symbol for age and yob synchronisation\n\tupdateStatus(node.status);\n\n\tif('proband' in node) {\n\t\t$('#id_proband').prop('checked', node.proband);\n\t\t$('#id_proband').prop(\"disabled\", true);\n\t} else {\n\t\t$('#id_proband').prop('checked', false);\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\n\t}\n\n\tif('exclude' in node) {\n\t\t$('#id_exclude').prop('checked', node.exclude);\n\t} else {\n\t\t$('#id_exclude').prop('checked', false);\n\t}\n\n/*\t\tif('ashkenazi' in node) {\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\n\t\t} else {\n\t\t\t$('#id_ashkenazi').prop('checked', false);\n\t\t}*/\n\n\t// year of birth\n\tif('yob' in node) {\n\t\t$('#id_yob_0').val(node.yob);\n\t} else {\n\t\t$('#id_yob_0').val('-');\n\t}\n\n\t// clear pathology\n\t$('select[name$=\"_bc_pathology\"]').val('-');\n\t// clear gene tests\n\t$('select[name*=\"_gene_test\"]').val('-');\n\n\t// disable sex radio buttons if the person has a partner\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\n\n\t// disable pathology for male relatives (as not used by model)\n\t// and if no breast cancer age of diagnosis\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\n\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\n\n\t// approximate diagnosis age\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\n\tupdate_diagnosis_age_widget();\n\n\tfor(let key in node) {\n\t\tif(key !== 'proband' && key !== 'sex') {\n\t\t\tif($('#id_'+key).length) {\t// input value\n\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\n\t\t\t\t\t$('#id_'+key).val(node[key].type);\n\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key).val(node[key]);\n\t\t\t\t}\n\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\n\t\t\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n}\n\nfunction update_ashkn(newdataset) {\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tif($('#orig_ashk').is(':checked')) {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tif(p.proband)\n\t\t\t\tp.ashkenazi = 1;\n\t\t});\n\t} else {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tdelete p.ashkenazi;\n\t\t});\n\t}\n}\n\n// Save Ashkenazi status\nexport function save_ashkn(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet newdataset = copy_dataset(dataset);\n\tupdate_ashkn(newdataset);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\nexport function save(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet name = $('#id_name').val();\n\tlet newdataset = copy_dataset(dataset);\n\tlet person = getNodeByName(newdataset, name);\n\tif(!person) {\n\t\tconsole.warn('person not found when saving details');\n\t\treturn;\n\t}\n\t$(\"#\"+opts.targetDiv).empty();\n\n\t// individual's personal and clinical details\n\tlet yob = $('#id_yob_0').val();\n\tif(yob && yob !== '') {\n\t\tperson.yob = yob;\n\t} else {\n\t\tdelete person.yob;\n\t}\n\n\t// current status: 0 = alive, 1 = dead\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\n\tif(status.length > 0){\n\t\tperson.status = status.val();\n\t}\n\n\t// booleans switches\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tlet s = $('#id_'+attr);\n\t\tif(s.length > 0){\n\t\t\tconsole.log(s.is(\":checked\"));\n\t\t\tif(s.is(\":checked\"))\n\t\t\t\tperson[attr] = true;\n\t\t\telse\n\t\t\t\tdelete person[attr];\n\t\t}\n\t}\n\n\t// current sex\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\n\tif(sex.length > 0){\n\t\tperson.sex = sex.val();\n\t\tupdate_cancer_by_sex(person);\n\t}\n\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tupdate_ashkn(newdataset);\n\n\tif($('#id_approx').is(':checked')) // approximate diagnosis age\n\t\tperson.approx_diagnosis_age = true;\n\telse\n\t\tdelete person.approx_diagnosis_age;\n\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\n\n\t\tif($(this).val()) {\n\t\t\tlet val = $(this).val();\n\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\n\t\t\t\tval = round5(val);\n\t\t\tperson[name] = val;\n\t\t} else {\n\t\t\tdelete person[name];\n\t\t}\n\t});\n\n\t// cancer checkboxes\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\n\t\tif(this.checked)\n\t\t\tperson[$(this).attr('name')] = true;\n\t\telse\n\t\t\tdelete person[$(this).attr('name')];\n\t});\n\n\t// pathology tests\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tperson[$(this).attr('name')] = $(this).val();\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// genetic tests\n\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tlet tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\n\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n\n\tsyncTwins(newdataset, person);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\nexport function update_diagnosis_age_widget() {\n\tif($(\"#id_approx\").is(':checked')) {\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\n\t} else {\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\n\t}\n}\n\n// males should not have ovarian cancer and females should not have prostate cancer\nfunction update_cancer_by_sex(node) {\n\t$('#cancer .row').show();\n\tif(node.sex === 'M') {\n\t\tdelete node.ovarian_cancer_diagnosis_age;\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\n\t} else if(node.sex === 'F') {\n\t\tdelete node.prostate_cancer_diagnosis_age;\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\n\t}\n}\n\n// round to 5, 15, 25, 35 ....\nfunction round5(x1) {\n\tlet x2 = (Math.round((x1-1) / 10) * 10);\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\n}\n\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree widgets\nimport {rebuild} from './pedigree.js';\nimport * as utils from './utils.js';\nimport {save} from './popup_form.js';\nimport {current as pedcache_current} from './pedcache.js';\nimport {getUniqueTwinID, setMzTwin, checkTwins} from './twins.js';\n\n\nlet dragging;\nlet last_mouseover;\n//\n// Add widgets to nodes and bind events\nexport function addWidgets(opts, node) {\n\n\t// popup gender selection box\n\tlet font_size = parseInt($(\"body\").css('font-size'));\n\tlet popup_selection = d3.select('.diagram');\n\tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\n\t\t\t\t\t\t\t.attr(\"rx\", 6)\n\t\t\t\t\t\t\t.attr(\"ry\", 6)\n\t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t\t\t\t\t.style(\"opacity\", 0)\n\t\t\t\t\t\t\t.attr(\"width\",  font_size*7.9)\n\t\t\t\t\t\t\t.attr(\"height\", font_size*2)\n\t\t\t\t\t\t\t.style(\"stroke\", \"darkgrey\")\n\t\t\t\t\t\t\t.attr(\"fill\", \"white\");\n\n\tlet square = popup_selection.append(\"text\")  // male\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.1em\")\n\t\t.attr(\"class\", \"popup_selection fa-square persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size/3)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf096 \");\n\tlet square_title = square.append(\"svg:title\").text(\"add male\");\n\n\tlet circle = popup_selection.append(\"text\")  // female\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.1em\")\n\t\t.attr(\"class\", \"popup_selection fa-circle persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size*1.71)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf10c \");\n\tlet circle_title = circle.append(\"svg:title\").text(\"add female\");\n\n\tlet unspecified = popup_selection.append(\"text\")  // unspecified\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.1em\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size*0.065)\n\t\t.attr(\"y\", -font_size*0.065)\n\t\t.attr(\"class\", \"popup_selection fa-unspecified popup_selection_rotate45 persontype\")\n\t\t.text(\"\\uf096 \");\n\tunspecified.append(\"svg:title\").text(\"add unspecified\");\n\n\tlet dztwin = popup_selection.append(\"text\")  // dizygotic twins\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.6em\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"class\", \"popup_selection fa-angle-up persontype dztwin\")\n\t\t.attr(\"x\", font_size*4.62)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf106 \");\n\tdztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\n\n\tlet mztwin = popup_selection.append(\"text\")  // monozygotic twins\n\t.attr('font-family', 'FontAwesome')\n\t.style(\"opacity\", 0)\n\t.style(\"font-size\", \"1.6em\")\n\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t.attr(\"class\", \"popup_selection fa-caret-up persontype mztwin\")\n\t.attr(\"x\", font_size*6.4)\n\t.attr(\"y\", font_size*1.5)\n\t.text(\"\\uf0d8 \");\n\tmztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\n\n\tlet add_person = {};\n\t// click the person type selection\n\td3.selectAll(\".persontype\")\n\t  .on(\"click\", function () {\n\t\tlet newdataset = utils.copy_dataset(pedcache_current(opts));\n\t\tlet mztwin = d3.select(this).classed(\"mztwin\");\n\t\tlet dztwin = d3.select(this).classed(\"dztwin\");\n\t\tlet twin_type;\n\t\tlet sex;\n\t\tif(mztwin || dztwin) {\n\t\t\tsex = add_person.node.datum().data.sex;\n\t\t\ttwin_type = (mztwin ? \"mztwin\" : \"dztwin\");\n\t\t} else {\n\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\n\t\t}\n\n\t\tif(add_person.type === 'addsibling')\n\t\t\taddsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\n\t\telse if(add_person.type === 'addchild')\n\t\t\taddchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\n\t\telse\n\t\t\treturn;\n\t\topts.dataset = newdataset;\n\t\trebuild(opts);\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\tadd_person = {};\n\t  })\n\t  .on(\"mouseover\", function() {\n\t\t  if(add_person.node)\n\t\t\t  add_person.node.select('rect').style(\"opacity\", 0.2);\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t  // add tooltips to font awesome widgets\n\t\t  if(add_person.type === 'addsibling'){\n\t\t\t if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add brother\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add sister\");\n\t\t  } else if(add_person.type === 'addchild'){\n\t\t\t  if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add son\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add daughter\");\n\t\t  }\n\t  });\n\n\t// handle mouse out of popup selection\n\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\n\t\t// hide rect and popup selection\n\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) == -1)\n\t\t\tadd_person.node.select('rect').style(\"opacity\", 0);\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t});\n\n\n\t// drag line between nodes to create partners\n\tdrag_handle(opts);\n\n\t// rectangle used to highlight on mouse over\n\tnode.filter(function (d) {\n\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\n\t\t})\n\t\t.append(\"rect\")\n\t\t.attr(\"class\", 'indi_rect')\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.attr(\"x\", function(_d) { return - 0.75*opts.symbol_size; })\n\t\t.attr(\"y\", function(_d) { return - opts.symbol_size; })\n\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\n\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\n\t\t.style(\"stroke\", \"black\")\n\t\t.style(\"stroke-width\", 0.7)\n\t\t.style(\"opacity\", 0)\n\t\t.attr(\"fill\", \"lightgrey\");\n\n\t// widgets\n\tlet fx = function(_d) {return off - 0.75*opts.symbol_size;};\n\tlet fy = opts.symbol_size -2;\n\tlet off = 0;\n\tlet widgets = {\n\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\n\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\n\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\n\t\t'addparents': {\n\t\t\t'text': '\\uf062', 'title': 'add parents',\n\t\t\t'fx': - 0.75*opts.symbol_size,\n\t\t\t'fy': - opts.symbol_size + 11\n\t\t},\n\t\t'delete': {\n\t\t\t'text': 'X', 'title': 'delete',\n\t\t\t'fx': opts.symbol_size/2 - 1,\n\t\t\t'fy': - opts.symbol_size + 12,\n\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\n\t\t}\n\t};\n\n\tif(opts.edit) {\n\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': -font_size/2+2, 'fy': -opts.symbol_size + 11};\n\t}\n\n\tfor(let key in widgets) {\n\t\tlet widget = node.filter(function (d) {\n\t\t\t\treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\n\t\t\t\t\t\t!((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\n\t\t\t\t\t\t!(d.data.parent_node !== undefined && d.data.parent_node.length > 1 && key === 'addpartner') &&\n\t\t\t\t\t\t!(d.data.parent_node === undefined && key === 'addchild') &&\n\t\t\t\t\t\t!((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\n\t\t\t})\n\t\t\t.append(\"text\")\n\t\t\t.attr(\"class\", key)\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.attr(\"xx\", function(d){return d.x;})\n\t\t\t.attr(\"yy\", function(d){return d.y;})\n\t\t\t.attr(\"x\", widgets[key].fx)\n\t\t\t.attr(\"y\", widgets[key].fy)\n\t\t\t.attr('font-size', '0.85em' )\n\t\t\t.text(widgets[key].text);\n\n\t\tif('styles' in widgets[key])\n\t\t\tfor(let style in widgets[key].styles){\n\t\t\t\twidget.attr(style, widgets[key].styles[style]);\n\t\t\t}\n\n\t\twidget.append(\"svg:title\").text(widgets[key].title);\n\t\toff += 17;\n\t}\n\n\t// add sibling or child\n\td3.selectAll(\".addsibling, .addchild\")\n\t  .on(\"mouseover\", function () {\n\t\t  let type = d3.select(this).attr('class');\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\n\n\t\t  //let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\n\t\t  let x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\n\t\t  let y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\n\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\n\t\t  d3.selectAll('.popup_selection_rotate45')\n\t\t\t.attr(\"transform\", \"translate(\"+(x+3*font_size)+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\n\t  });\n\n\t// handle widget clicks\n\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\n\t  .on(\"click\", function (e) {\n\t\t  e.stopPropagation();\n\t\tlet opt = d3.select(this).attr('class');\n\t\tlet d = d3.select(this.parentNode).datum();\n\t\tif(opts.DEBUG) {\n\t\t\tconsole.log(opt);\n\t\t}\n\n\t\tlet newdataset;\n\t\tif(opt === 'settings') {\n\t\t\tif(typeof opts.edit === 'function') {\n\t\t\t\topts.edit(opts, d);\n\t\t\t} else {\n\t\t\t\topenEditDialog(opts, d);\n\t\t\t}\n\t\t} else if(opt === 'delete') {\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\tdelete_node_dataset(newdataset, d.data, opts, onDone);\n\t\t} else if(opt === 'addparents') {\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\topts.dataset = newdataset;\n\t\t\taddparents(opts, newdataset, d.data.name);\n\t\t\trebuild(opts);\n\t\t} else if(opt === 'addpartner') {\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\taddpartner(opts, newdataset, d.data.name);\n\t\t\topts.dataset = newdataset;\n\t\t\trebuild(opts);\n\t\t}\n\t\t// trigger fhChange event\n\t\t$(document).trigger('fhChange', [opts]);\n\t});\n\n\t// other mouse events\n\tlet highlight = [];\n\n\tnode.filter(function (d) { return !d.data.hidden; })\n\t.on(\"click\", function (e, d) {\n\t\tif (e.ctrlKey) {\n\t\t\tif(highlight.indexOf(d) == -1)\n\t\t\t\thighlight.push(d);\n\t\t\telse\n\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\n\t\t} else\n\t\t\thighlight = [d];\n\n\t\tif('nodeclick' in opts) {\n\t\t\topts.nodeclick(d.data);\n\t\t\td3.selectAll(\".indi_rect\").style(\"opacity\", 0);\n\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) != -1;}).style(\"opacity\", 0.5);\n\t\t}\n\t})\n\t.on(\"mouseover\", function(e, d){\n\t\te.stopPropagation();\n\t\tlast_mouseover = d;\n\t\tif(dragging) {\n\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\n\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\n\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 1);\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 0);\n\n\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\n\t})\n\t.on(\"mouseout\", function(d){\n\t\tif(dragging)\n\t\t\treturn;\n\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 0);\n\t\tif(highlight.indexOf(d) == -1)\n\t\t\td3.select(this).select('rect').style(\"opacity\", 0);\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 1);\n\t\t// hide popup if it looks like the mouse is moving north\n\t\tlet xcoord = d3.pointer(d)[0];\n\t\tlet ycoord = d3.pointer(d)[1];\n\t\tif(ycoord < 0.8*opts.symbol_size)\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\tif(!dragging) {\n\t\t\t// hide popup if it looks like the mouse is moving north, south or west\n\t\t\tif( Math.abs(ycoord) > 0.25*opts.symbol_size ||\n\t\t\t\tMath.abs(ycoord) < -0.25*opts.symbol_size ||\n\t\t\t\txcoord < 0.2*opts.symbol_size){\n\t\t\t\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\t\t}\n        }\n\t});\n}\n\nfunction onDone(opts, dataset) {\n\t// assign new dataset and rebuild pedigree\n\topts.dataset = dataset;\n\trebuild(opts);\n}\n\n// drag line between nodes to create partners\nfunction drag_handle(opts) {\n\tlet line_drag_selection = d3.select('.diagram');\n\tlet dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\n        .attr(\"stroke-width\", 6)\n        .style(\"stroke-dasharray\", (\"2, 1\"))\n        .attr(\"stroke\",\"black\")\n        .call(d3.drag()\n                .on(\"start\", dragstart)\n                .on(\"drag\", drag)\n                .on(\"end\", dragstop));\n\tdline.append(\"svg:title\").text(\"drag to create consanguineous partners\");\n\n\tsetLineDragPosition(0, 0, 0, 0);\n\n\tfunction dragstart() {\n\t\tdragging = last_mouseover;\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"darkred\");\n\t}\n\n\tfunction dragstop(_d) {\n\t\tif(last_mouseover &&\n\t\t   dragging.data.name !== last_mouseover.data.name &&\n\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\n\t\t\t// make partners\n\t\t\tlet child = {\"name\": utils.makeid(4), \"sex\": 'U',\n\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\n\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\n\t\t\tlet newdataset = utils.copy_dataset(opts.dataset);\n\t\t\topts.dataset = newdataset;\n\n\t\t\tlet idx = utils.getIdxByName(opts.dataset, dragging.data.name)+1;\n\t\t\topts.dataset.splice(idx, 0, child);\n\t\t\trebuild(opts);\n\t\t}\n\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"black\");\n\t\tdragging = undefined;\n\t\treturn;\n\t}\n\n\tfunction drag(e) {\n\t\te.sourceEvent.stopPropagation();\n\t\tlet dx = e.dx;\n\t\tlet dy = e.dy;\n\t\tlet xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\n        let ynew = parseFloat(d3.select(this).attr('y2'))+ dy;\n        setLineDragPosition(opts.symbol_size-10, 0, xnew, ynew);\n\t}\n}\n\n/**\n * Set the position and start and end of consanguineous widget.\n */\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\n\tif(translate) {\n\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\n\t}\n\td3.selectAll('.line_drag_selection')\n\t\t.attr(\"x1\", x1)\n\t\t.attr(\"y1\", y1)\n\t\t.attr(\"x2\", x2)\n\t\t.attr(\"y2\", y2);\n}\n\nfunction capitaliseFirstLetter(string) {\n    return string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\nfunction openEditDialog(opts, d) {\n\t$('#node_properties').dialog({\n\t    autoOpen: false,\n\t    title: d.data.display_name,\n\t    width: ($(window).width() > 400 ? 450 : $(window).width()- 30)\n\t});\n\n\tlet table = \"<table id='person_details' class='table'>\";\n\n\ttable += \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\"+\n\t(d.data.name ? d.data.name : \"\")+\"></td></tr>\";\n\ttable += \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\"+\n\t\t\t(d.data.display_name ? d.data.display_name : \"\")+\"></td></tr>\";\n\n\ttable += \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value=\"+\n\t\t\t(d.data.age ? d.data.age : \"\")+\"></td></tr>\";\n\n\ttable += \"<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value=\"+\n\t\t(d.data.yob ? d.data.yob : \"\")+\"></td></tr>\";\n\n\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" '+(d.data.sex === 'M' ? \"checked\" : \"\")+'>Male</label>' +\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" '+(d.data.sex === 'F' ? \"checked\" : \"\")+'>Female</label>' +\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"U\">Unknown</label>' +\n\t\t\t '</td></tr>';\n\n\t// alive status = 0; dead status = 1\n\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" '+(parseInt(d.data.status) === 0 ? \"checked\" : \"\")+'>&thinsp;Alive</label>' +\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" '+(parseInt(d.data.status) === 1 ? \"checked\" : \"\")+'>&thinsp;Deceased</label>' +\n\t\t\t '</td></tr>';\n\t$(\"#id_status input[value='\"+d.data.status+\"']\").prop('checked', true);\n\n\t// switches\n\tlet switches = [\"adopted_in\", \"adopted_out\", \"miscarriage\", \"stillbirth\", \"termination\"];\n\ttable += '<tr><td colspan=\"2\"><strong>Reproduction:</strong></td></tr>';\n\ttable += '<tr><td colspan=\"2\">';\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tif(iswitch === 2)\n\t\t\ttable += '</td></tr><tr><td colspan=\"2\">';\n\t\ttable +=\n\t\t '<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"id_'+attr +\n\t\t    '\" name=\"'+attr+'\" value=\"0\" '+(d.data[attr] ? \"checked\" : \"\")+'>&thinsp;' +\n\t\t    capitaliseFirstLetter(attr.replace('_', ' '))+'</label>'\n\t}\n\ttable += '</td></tr>';\n\n\t//\n\tlet exclude = [\"children\", \"name\", \"parent_node\", \"top_level\", \"id\", \"noparents\",\n\t\t           \"level\", \"age\", \"sex\", \"status\", \"display_name\", \"mother\", \"father\",\n\t\t           \"yob\", \"mztwin\", \"dztwin\"];\n\t$.merge(exclude, switches);\n\ttable += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\n\t$.each(opts.diseases, function(k, v) {\n\t\texclude.push(v.type+\"_diagnosis_age\");\n\n\t\tlet disease_colour = '&thinsp;<span style=\"padding-left:5px;background:'+opts.diseases[k].colour+'\"></span>';\n\t\tlet diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\n\n\t\ttable += \"<tr><td style='text-align:right'>\"+capitaliseFirstLetter(v.type.replace(\"_\", \" \"))+\n\t\t\t\t\tdisease_colour+\"&nbsp;</td><td>\" +\n\t\t\t\t\t\"<input class='form-control' id='id_\" +\n\t\t\t\t\tv.type + \"_diagnosis_age_0' max='110' min='0' name='\" +\n\t\t\t\t\tv.type + \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\n\t\t\t\t\t(diagnosis_age !== undefined ? diagnosis_age : \"\") +\"'></td></tr>\";\n\t});\n\n\ttable += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\n\t$.each(d.data, function(k, v) {\n\t\tif($.inArray(k, exclude) == -1) {\n\t\t\tlet kk = capitaliseFirstLetter(k);\n\t\t\tif(v === true || v === false) {\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='checkbox' id='id_\" + k + \"' name='\" +\n\t\t\t\t\t\tk+\"' value=\"+v+\" \"+(v ? \"checked\" : \"\")+\"></td></tr>\";\n\t\t\t} else if(k.length > 0){\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='text' id='id_\" +\n\t\t\t\t\t\tk+\"' name='\"+k+\"' value=\"+v+\"></td></tr>\";\n\t\t\t}\n\t\t}\n    });\n\ttable += \"</table>\";\n\n\t$('#node_properties').html(table);\n\t$('#node_properties').dialog('open');\n\n\t$('#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]').change(function() {\n\t\tsave(opts);\n    });\n\treturn;\n}\n\n\n\n// add children to a given node\nexport function addchild(dataset, node, sex, nchild, twin_type) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tif (typeof nchild === typeof undefined)\n\t\tnchild = 1;\n\tlet children = utils.getAllChildren(dataset, node);\n\tlet ptr_name, idx;\n\tif (children.length === 0) {\n\t\tlet partner = addsibling(dataset, node, node.sex === 'F' ? 'M': 'F', node.sex === 'F');\n\t\tpartner.noparents = true;\n\t\tptr_name = partner.name;\n\t\tidx = utils.getIdxByName(dataset, node.name)+1;\n\t} else {\n\t\tlet c = children[0];\n\t\tptr_name = (c.father === node.name ? c.mother : c.father);\n\t\tidx = utils.getIdxByName(dataset, c.name);\n\t}\n\n\tlet twin_id;\n\tif(twin_type)\n\t\ttwin_id = getUniqueTwinID(dataset, twin_type);\n\tlet newchildren = [];\n\tfor (let i = 0; i < nchild; i++) {\n\t\tlet child = {\"name\": utils.makeid(4), \"sex\": sex,\n\t\t\t\t\t \"mother\": (node.sex === 'F' ? node.name : ptr_name),\n\t\t\t\t\t \"father\": (node.sex === 'F' ? ptr_name : node.name)};\n\t\tdataset.splice(idx, 0, child);\n\n\t\tif(twin_type)\n\t\t\tchild[twin_type] = twin_id;\n\t\tnewchildren.push(child);\n\t}\n\treturn newchildren;\n}\n\n//\nexport function addsibling(dataset, node, sex, add_lhs, twin_type) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tlet newbie = {\"name\": utils.makeid(4), \"sex\": sex};\n\tif(node.top_level) {\n\t\tnewbie.top_level = true;\n\t} else {\n\t\tnewbie.mother = node.mother;\n\t\tnewbie.father = node.father;\n\t}\n\tlet idx = utils.getIdxByName(dataset, node.name);\n\n\tif(twin_type) {\n\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\n\t}\n\n\tif(add_lhs) { // add to LHS\n\t\tif(idx > 0) idx--;\n\t} else\n\t\tidx++;\n\tdataset.splice(idx, 0, newbie);\n\treturn newbie;\n}\n\n// add parents to the 'node'\nexport function addparents(opts, dataset, name) {\n\tlet mother, father;\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flat_tree = utils.flatten(root);\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\n\tlet node  = tree_node.data;\n\tlet depth = tree_node.depth;   // depth of the node in relation to the root (depth = 1 is a top_level node)\n\n\tlet pid = -101;\n\tlet ptr_name;\n\tlet children = utils.getAllChildren(dataset, node);\n\tif(children.length > 0){\n\t\tptr_name = children[0].mother == node.name ? children[0].father : children[0].mother;\n\t\tpid = utils.getNodeByName(flat_tree, ptr_name).data.id;\n\t}\n\n\tlet i;\n\tif(depth == 1) {\n\t\tmother = {\"name\": utils.makeid(4), \"sex\": \"F\", \"top_level\": true};\n\t\tfather = {\"name\": utils.makeid(4), \"sex\": \"M\", \"top_level\": true};\n\t\tdataset.splice(0, 0, mother);\n\t\tdataset.splice(0, 0, father);\n\n\t\tfor(i=0; i<dataset.length; i++){\n\t\t\tif(dataset[i].top_level && dataset[i].name !== mother.name && dataset[i].name !== father.name){\n\t\t\t\tdelete dataset[i].top_level;\n\t\t\t\tdataset[i].noparents = true;\n\t\t\t\tdataset[i].mother = mother.name;\n\t\t\t\tdataset[i].father = father.name;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet node_mother = utils.getNodeByName(flat_tree, tree_node.data.mother);\n\t\tlet node_father = utils.getNodeByName(flat_tree, tree_node.data.father);\n\t\tlet node_sibs = utils.getAllSiblings(dataset, node);\n\n\t\t// lhs & rhs id's for siblings of this node\n\t\tlet rid = 10000;\n\t\tlet lid = tree_node.data.id;\n\t\tfor(i=0; i<node_sibs.length; i++){\n\t\t\tlet sid = utils.getNodeByName(flat_tree, node_sibs[i].name).data.id;\n\t\t\tif(sid < rid && sid > tree_node.data.id)\n\t\t\t\trid = sid;\n\t\t\tif(sid < lid)\n\t\t\t\tlid = sid;\n\t\t}\n\t\tlet add_lhs = (lid >= tree_node.data.id || (pid == lid && rid < 10000));\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\n\t\tlet midx;\n\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\n\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\n\t\t\tmidx = utils.getIdxByName(dataset, node.father);\n\t\telse\n\t\t\tmidx = utils.getIdxByName(dataset, node.mother);\n\n\t\tlet parent = dataset[midx];\n\t\tfather = addsibling(dataset, parent, 'M', add_lhs);\n\t\tmother = addsibling(dataset, parent, 'F', add_lhs);\n\n\t\tlet faidx = utils.getIdxByName(dataset, father.name);\n\t\tlet moidx = utils.getIdxByName(dataset, mother.name);\n\t\tif(faidx > moidx) {\t\t\t\t   // switch to ensure father on lhs of mother\n\t\t\tlet tmpfa = dataset[faidx];\n\t\t\tdataset[faidx] = dataset[moidx];\n\t\t\tdataset[moidx] = tmpfa;\n\t\t}\n\n\t\tlet orphans = utils.getAdoptedSiblings(dataset, node);\n\t\tlet nid = tree_node.data.id;\n\t\tfor(i=0; i<orphans.length; i++){\n\t\t\tlet oid = utils.getNodeByName(flat_tree, orphans[i].name).data.id;\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\n\t\t\tif((add_lhs || nid < oid) && oid < rid){\n\t\t\t\tlet oidx = utils.getIdxByName(dataset, orphans[i].name);\n\t\t\t\tdataset[oidx].mother = mother.name;\n\t\t\t\tdataset[oidx].father = father.name;\n\t\t\t}\n\t\t}\n\t}\n\n\tif(depth == 2) {\n\t\tmother.top_level = true;\n\t\tfather.top_level = true;\n\t} else if(depth > 2) {\n\t\tmother.noparents = true;\n\t\tfather.noparents = true;\n\t}\n\tlet idx = utils.getIdxByName(dataset, node.name);\n\tdataset[idx].mother = mother.name;\n\tdataset[idx].father = father.name;\n\tdelete dataset[idx].noparents;\n\n\tif('parent_node' in node) {\n\t\tlet ptr_node = dataset[utils.getIdxByName(dataset, ptr_name)];\n\t\tif('noparents' in ptr_node) {\n\t\t\tptr_node.mother = mother.name;\n\t\t\tptr_node.father = father.name;\n\t\t}\n\t}\n}\n\n// add partner\nexport function addpartner(opts, dataset, name) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flat_tree = utils.flatten(root);\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\n\n\tlet partner = addsibling(dataset, tree_node.data, tree_node.data.sex === 'F' ? 'M' : 'F', tree_node.data.sex === 'F');\n\tpartner.noparents = true;\n\n\tlet child = {\"name\": utils.makeid(4), \"sex\": \"M\"};\n\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\n\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\n\n\tlet idx = utils.getIdxByName(dataset, tree_node.data.name)+2;\n\tdataset.splice(idx, 0, child);\n}\n\n// get adjacent nodes at the same depth\nfunction adjacent_nodes(root, node, excludes) {\n\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), node.depth, excludes);\n\tlet lhs_node, rhs_node;\n\tfor(let i=0; i<dnodes.length; i++) {\n\t\tif(dnodes[i].x < node.x)\n\t\t\tlhs_node = dnodes[i];\n\t\tif(!rhs_node && dnodes[i].x > node.x)\n\t\t\trhs_node = dnodes[i];\n\t}\n\treturn [lhs_node, rhs_node];\n}\n\n// delete a node and descendants\nexport function delete_node_dataset(dataset, node, opts, onDone) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet fnodes = utils.flatten(root);\n\tlet deletes = [];\n\tlet i, j;\n\n\t// get d3 data node\n\tif(node.id === undefined) {\n\t\tlet d3node = utils.getNodeByName(fnodes, node.name);\n\t\tif(d3node !== undefined)\n\t\t\tnode = d3node.data;\n\t}\n\n\tif(node.parent_node) {\n\t\tfor(i=0; i<node.parent_node.length; i++){\n\t\t\tlet parent = node.parent_node[i];\n\t\t\tlet ps = [utils.getNodeByName(dataset, parent.mother.name),\n\t\t\t\t\t  utils.getNodeByName(dataset, parent.father.name)];\n\t\t\t// delete parents\n\t\t\tfor(j=0; j<ps.length; j++) {\n\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ps[j].name), 1);\n\t\t\t\t\tdeletes.push(ps[j]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet children = parent.children;\n\t\t\tlet children_names = $.map(children, function(p, _i){return p.name;});\n\t\t\tfor(j=0; j<children.length; j++) {\n\t\t\t\tlet child = utils.getNodeByName(dataset, children[j].name);\n\t\t\t\tif(child){\n\t\t\t\t\tchild.noparents = true;\n\t\t\t\t\tlet ptrs = utils.get_partners(dataset, child);\n\t\t\t\t\tlet ptr;\n\t\t\t\t\tif(ptrs.length > 0)\n\t\t\t\t\t\tptr = utils.getNodeByName(dataset, ptrs[0]);\n\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\n\t\t\t\t\t\tchild.mother = ptr.mother;\n\t\t\t\t\t\tchild.father = ptr.father;\n\t\t\t\t\t} else if(ptr) {\n\t\t\t\t\t\tlet child_node  = utils.getNodeByName(fnodes, child.name);\n\t\t\t\t\t\tlet adj = adjacent_nodes(root, child_node, children_names);\n\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\n\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, child.name), 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tdataset.splice(utils.getIdxByName(dataset, node.name), 1);\n\t}\n\n\t// delete ancestors\n\tconsole.log(deletes);\n\tfor(i=0; i<deletes.length; i++) {\n\t\tlet del = deletes[i];\n\t\tlet sibs = utils.getAllSiblings(dataset, del);\n\t\tconsole.log('DEL', del.name, sibs);\n\t\tif(sibs.length < 1) {\n\t\t\tconsole.log('del sibs', del.name, sibs);\n\t\t\tlet data_node  = utils.getNodeByName(fnodes, del.name);\n\t\t\tlet ancestors = data_node.ancestors();\n\t\t\tfor(j=0; j<ancestors.length; j++) {\n\t\t\t\tconsole.log(ancestors[i]);\n\t\t\t\tif(ancestors[j].data.mother){\n\t\t\t\t\tconsole.log('DELETE ', ancestors[j].data.mother, ancestors[j].data.father);\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.mother.name), 1);\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.father.name), 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// check integrity of mztwins settings\n\tcheckTwins(dataset);\n\n\tlet uc;\n\ttry\t{\n\t\t// validate new pedigree dataset\n\t\tlet newopts = $.extend({}, opts);\n\t\tnewopts.dataset = utils.copy_dataset(dataset);\n\t\tutils.validate_pedigree(newopts);\n\t\t// check if pedigree is split\n\t\tuc = utils.unconnected(dataset);\n\t} catch(err) {\n\t\tutils.messages('Warning', 'Deletion of this pedigree member is disallowed.')\n\t\tthrow err;\n\t}\n\tif(uc.length > 0) {\n\t\t// check & warn only if this is a new split\n\t\tif(utils.unconnected(opts.dataset).length === 0) {\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", uc);\n\t\t\tutils.messages(\"Warning\", \"Deleting this will split the pedigree. Continue?\", onDone, opts, dataset);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif(onDone) {\n\t\tonDone(opts, dataset);\n\t}\n\treturn dataset;\n}\n\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {prefixInObj} from './utils.js';\n\nexport function addLabels(opts, node) {\n\t// names of individuals\n\taddLabel(opts, node, -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\n\t\t\tfunction(d) {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\n\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';}, undefined, ['display_name']);\n\n\tlet font_size = parseInt(getPx(opts)) + 4;\n\t// display age/yob label first\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') > -1 || arr.indexOf('yob') > -1) {\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\n\t\t}\n\t}\n\n\t// individuals disease details\n\tfor(let i=0;i<opts.diseases.length; i++) {\n\t\tlet disease = opts.diseases[i].type;\n\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, [disease], font_size); },\n\t\t\t\tfunction(d) {\n\t\t\t\t\tlet dis = disease.replace('_', ' ').replace('cancer', 'ca.');\n\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\n\t\t\t\t}, 'indi_details', [disease]);\n\t}\n\n\t// display other labels defined in opts.labels e.g. alleles/genotype data\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') === -1 && arr.indexOf('yob') === -1) {\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\n\t\t}\n\t}\n}\n\nfunction get_text(d, arr) {\n\tlet txt = \"\";\n\tfor(let l=0; l<arr.length; l++) {\n\t\tlet this_label = arr[l];\n\t\tif(d.data[this_label]) {\n\t\t\tif(this_label === 'alleles') {\n\t\t\t\tlet vars = d.data.alleles.split(';');\n\t\t\t\tfor(let ivar = 0;ivar < vars.length;ivar++) {\n\t\t\t\t\tif(vars[ivar] !== \"\") txt += vars[ivar] + ';';\n\t\t\t\t}\n\t\t\t} else if(this_label === 'age') {\n\t\t\t\ttxt += d.data[this_label] +'y ';\n\t\t\t} else if(this_label === 'stillbirth') {\n\t\t\t\ttxt += \"SB\";\n\t\t\t} else if(this_label.match(\"_gene_test$\") && 'result' in d.data[this_label]) {\n\t\t\t\tlet r = d.data[this_label]['result'].toUpperCase();\n\t\t\t\t//let t = d.data[this_label]['type'];\n\t\t\t\tif(r !== \"-\") {\n\t\t\t\t\ttxt += this_label.replace('_gene_test', '').toUpperCase()\n\t\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t\t}\n\t\t\t} else if(this_label.match(\"_bc_pathology$\")) {\n\t\t\t\tlet r = d.data[this_label].toUpperCase();\n\t\t\t\ttxt += this_label.replace('_bc_pathology', '').toUpperCase()\n\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t} else {\n\t\t\t  txt += d.data[this_label];\n\t\t\t}\n\t\t}\n\t}\n\tif(txt !== \"\") return txt;\n}\n\nfunction ypos(d, arr, font_size) {\n\tif(!node_has_label(d, arr)) return;\n\td.y_offset = (!d.y_offset ? font_size*2.35 : d.y_offset+font_size);\n\treturn d.y_offset;\n}\n\nfunction node_has_label(d, labels) {\n\tfor(let l=0; l<labels.length; l++) {\n\t\tif(prefixInObj(labels[l], d.data)) return true;\n\t}\n\treturn false;\n}\n\n// add label to node\nfunction addLabel(opts, node, fx, fy, ftext, class_label, labels) {\n\tnode.filter(function (d) {\n\t\treturn !d.data.hidden && (!labels || node_has_label(d, labels));\n\t}).append(\"text\")\n\t.attr(\"class\", (class_label ? class_label + ' ped_label' : 'ped_label'))\n\t.attr(\"x\", fx)\n\t.attr(\"y\", fy)\n\t.attr(\"font-family\", opts.font_family)\n\t.attr(\"font-size\", opts.font_size)\n\t.attr(\"font-weight\", opts.font_weight)\n\t.text(ftext);\n}\n\n// get height in pixels\nfunction getPx(opts){\n\tlet emVal = opts.font_size;\n\tif (emVal === parseInt(emVal, 10)) // test if integer\n\t\treturn emVal;\n\n\tif(emVal.indexOf(\"px\") > -1)\n\t\treturn emVal.replace('px', '');\n\telse if(emVal.indexOf(\"em\") === -1)\n\t\treturn emVal;\n\temVal = parseFloat(emVal.replace('em', ''));\n\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\n}\n","/**\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree Tree Builder\nimport  * as utils from './utils.js';\nimport * as pbuttons from './pbuttons.js';\nimport * as pedcache from './pedcache.js';\nimport * as io from './io.js';\nimport {addWidgets} from './widgets.js';\nimport {init_zoom} from './zoom.js';\nimport {addLabels} from './labels.js';\n\n\nexport function build(options) {\n\tlet opts = $.extend({ // defaults\n\t\ttargetDiv: 'pedigree_edit',\n\t\tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\n\t\twidth: 600,\n\t\theight: 400,\n\t\tsymbol_size: 35,\n\t\tzoomSrc: ['wheel', 'button'],\n\t\tzoomIn: 1.0,\n\t\tzoomOut: 1.0,\n\t\tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\n\t\t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\n\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#4DAA4D'},\n\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\n\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\n\t\tlabels: ['stillbirth', ['age', 'yob'], 'alleles',\n\t\t\t\t\t\t\t   ['brca1_gene_test', 'brca2_gene_test', 'palb2_gene_test', 'chek2_gene_test', 'atm_gene_test'],\n\t\t\t\t\t\t\t   ['rad51d_gene_test', 'rad51c_gene_test', 'brip1_gene_test'],\n\t\t\t\t\t\t\t   ['er_bc_pathology', 'pr_bc_pathology', 'her2_bc_pathology', 'ck14_bc_pathology', 'ck56_bc_pathology']],\n\t\tkeep_proband_on_reset: false,\n\t\tfont_size: '.75em',\n\t\tfont_family: 'Helvetica',\n\t\tfont_weight: 700,\n\t\tbackground: \"#EEE\",\n\t\tnode_background: '#fdfdfd',\n\t\tvalidate: true,\n\t\tDEBUG: false}, options );\n\n\tif ( $( \"#fullscreen\" ).length === 0 ) {\n\t\t// add undo, redo, fullscreen buttons and event listeners once\n\t\tpbuttons.addButtons(opts, rebuild, build);\n\t\tio.addIO(opts);\n\t}\n\n\tif(pedcache.nstore(opts) == -1)\n\t\tpedcache.init_cache(opts);\n\n\tpbuttons.updateButtons(opts);\n\n\t// validate pedigree data\n\tutils.validate_pedigree(opts);\n\t// group top level nodes by partners\n\topts.dataset = group_top_level(opts.dataset);\n\n\tif(opts.DEBUG)\n\t\tutils.print_opts(opts);\n\tlet svg_dimensions = utils.get_svg_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv)\n\t\t\t\t .append(\"svg:svg\")\n\t\t\t\t .attr(\"width\", svg_dimensions.width)\n\t\t\t\t .attr(\"height\", svg_dimensions.height);\n\n\tsvg.append(\"rect\")\n\t\t.attr(\"width\", \"100%\")\n\t\t.attr(\"height\", \"100%\")\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.style(\"stroke\", \"darkgrey\")\n\t\t.style(\"fill\", opts.background) // or none\n\t\t.style(\"stroke-width\", 1);\n\n\tlet ped = svg.append(\"g\")\n\t\t\t .attr(\"class\", \"diagram\");\n\n\tlet top_level = $.map(opts.dataset, function(val, _i){return 'top_level' in val && val.top_level ? val : null;});\n\tlet hidden_root = {\n\t\tname : 'hidden_root',\n\t\tid : 0,\n\t\thidden : true,\n\t\tchildren : top_level\n\t};\n\n\tlet partners = utils.buildTree(opts, hidden_root, hidden_root)[0];\n\tlet root = d3.hierarchy(hidden_root);\n\tutils.roots[opts.targetDiv] = root;\n\n\t// / get score at each depth used to adjust node separation\n\tlet tree_dimensions = utils.get_tree_dimensions(opts);\n\tif(opts.DEBUG)\n\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\n\t\t\t\t\t' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\n\n\tlet treemap = d3.tree().separation(function(a, b) {\n\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? 1.2 : 2.2;\n\t}).size([tree_dimensions.width, tree_dimensions.height]);\n\n\tlet nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\n\tlet flattenNodes = nodes.descendants();\n\n\t// check the number of visible nodes equals the size of the pedigree dataset\n\tlet vis_nodes = $.map(opts.dataset, function(p, _i){return p.hidden ? null : p;});\n\tif(vis_nodes.length != opts.dataset.length) {\n\t\tthrow utils.create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\n\t}\n\n\tutils.adjust_coords(opts, nodes, flattenNodes);\n\n\tlet ptrLinkNodes = utils.linkNodes(flattenNodes, partners);\n\tcheck_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines\n\n\tlet node = ped.selectAll(\".node\")\n\t\t\t\t  .data(nodes.descendants())\n\t\t\t\t  .enter()\n\t\t\t\t  .append(\"g\")\n\t\t\t\t\t.attr(\"transform\", function(d, _i) {\n\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\n\t\t\t\t\t});\n\n\t// provide a border to the node\n\tnode.filter(function (d) {return !d.data.hidden;})\n\t\t.append(\"path\")\n\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(_d) { return (opts.symbol_size * opts.symbol_size) + 2;})\n\t\t\t\t.type(function(d) {\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\t\treturn d.data.sex == \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t})\n\t\t.style(\"stroke-width\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".3em\" : \".1em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\t// set a clippath\n\tnode.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\n\t\t.append(\"clipPath\")\n\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\n\t\t.attr(\"class\", \"node\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(d) {\n\t\t\t\tif (d.data.hidden)\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\n\t\t\t})\n\t\t\t.type(function(d) {\n\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\treturn d.data.sex == \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\n\n\t// pie plots for disease colours\n\tlet pienode = node.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);}).selectAll(\"pienode\")\n\t   .data(function(d) {\t \t\t// set the disease data for the pie plot\n\t\t   let ncancers = 0;\n\t\t   let cancers = $.map(opts.diseases, function(_val, i){\n\t\t\t   if(utils.prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\n\t\t   });\n\t\t   if(ncancers === 0) cancers = [1];\n\t\t   return [$.map(cancers, function(val, _i){\n\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\n\t\t\t\t\t\t'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\n\t\t\t\t\t\t'affected': d.data.affected,\n\t\t\t\t\t\t'exclude': d.data.exclude};})];\n\t   })\n\t   .enter()\n\t\t.append(\"g\");\n\n\tpienode.selectAll(\"path\")\n\t\t.data(d3.pie().value(function(d) {return d.cancer;}))\n\t\t.enter().append(\"path\")\n\t\t\t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\n\t\t\t.attr(\"class\", \"pienode\")\n\t\t\t.attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\n\t\t\t.style(\"fill\", function(d, i) {\n\t\t\t\tif(d.data.exclude)\n\t\t\t\t\treturn 'lightgrey';\n\t\t\t\tif(d.data.ncancers === 0) {\n\t\t\t\t\tif(d.data.affected)\n\t\t\t\t\t\treturn 'darkgrey';\n\t\t\t\t\treturn opts.node_background;\n\t\t\t\t}\n\t\t\t\treturn opts.diseases[i].colour;\n\t\t\t});\n\n\t// adopted in/out brackets\n\tnode.filter(function (d) {return !d.data.hidden && (d.data.adopted_in || d.data.adopted_out);})\n\t\t.append(\"path\")\n\t\t.attr(\"d\", function(_d) { {\n\t\t\tlet dx = -(opts.symbol_size * 0.66);\n\t\t\tlet dy = -(opts.symbol_size * 0.64);\n\t\t\tlet indent = opts.symbol_size/4;\n\t\t\treturn get_bracket(dx, dy, indent, opts)+get_bracket(-dx, dy, -indent, opts);\n\t\t\t}})\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t})\n\t\t.style(\"stroke-width\", function (_d) {\n\t\t\treturn \".1em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\n\t// alive status = 0; dead status = 1\n\tnode.filter(function (d) {return d.data.status == 1;})\n\t\t.append('line')\n\t\t\t.style(\"stroke\", \"black\")\n\t\t\t.attr(\"x1\", function(_d, _i) {return -0.6*opts.symbol_size;})\n\t\t\t.attr(\"y1\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"x2\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"y2\", function(_d, _i) {return -0.6*opts.symbol_size;});\n\n/*\n * let warn = node.filter(function (d) { return (!d.data.age || !d.data.yob) && !d.data.hidden; }).append(\"text\") .attr('font-family', 'FontAwesome')\n * .attr(\"x\", \".25em\") .attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size)) .html(\"\\uf071\"); warn.append(\"svg:title\").text(\"incomplete\");\n */\n\t// add display names and labels defined by opts.labels\n\taddLabels(opts, node);\n\n\t//\n\taddWidgets(opts, node);\n\n\t// links between partners\n\tlet clash_depth = {};\n\n\t// get path looping over node(s)\n\tlet draw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\n\t\tlet extend = function(i, l) {\n\t\t\tif(i+1 < l)   // && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\n\t\t\t\treturn extend(++i);\n\t\t\treturn i;\n\t\t};\n\t\tlet path = \"\";\n\t\tfor(let j=0; j<clash.length; j++) {\n\t\t\tlet k = extend(j, clash.length);\n\t\t\tlet dx1 = clash[j] - dx - cshift;\n\t\t\tlet dx2 = clash[k] + dx + cshift;\n\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\n\t\t\t\tparent_node.y = dy2;\n\n\t\t\tpath += \"L\" + dx1 + \",\" +  (dy1 - cshift) +\n\t\t\t\t\t\"L\" + dx1 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy1 - cshift);\n\t\t\tj = k;\n\t\t}\n\t\treturn path;\n\t}\n\n\n\tpartners = ped.selectAll(\".partner\")\n\t\t.data(ptrLinkNodes)\n\t\t.enter()\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke\", \"#000\")\n\t\t\t.attr(\"shape-rendering\", \"auto\")\n\t\t\t.attr('d', function(d, _i) {\n\t\t\t\tlet node1 = utils.getNodeByName(flattenNodes, d.mother.data.name);\n\t\t\t\tlet node2 = utils.getNodeByName(flattenNodes, d.father.data.name);\n\t\t\t\tlet consanguity = utils.consanguity(node1, node2, opts);\n\t\t\t\tlet divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\n\n\t\t\t\tlet x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\n\t\t\t\tlet x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\n\t\t\t\tlet dy1 = d.mother.y;\n\t\t\t\tlet dy2, dx, parent_node;\n\n\t\t\t\t// identify clashes with other nodes at the same depth\n\t\t\t\tlet clash = check_ptr_link_clashes(opts, d);\n\t\t\t\tlet path = \"\";\n\t\t\t\tif(clash) {\n\t\t\t\t\tif(d.mother.depth in clash_depth)\n\t\t\t\t\t\tclash_depth[d.mother.depth] += 4;\n\t\t\t\t\telse\n\t\t\t\t\t\tclash_depth[d.mother.depth] = 4;\n\n\t\t\t\t\tdy1 -= clash_depth[d.mother.depth];\n\t\t\t\t\tdx = clash_depth[d.mother.depth] + opts.symbol_size/2 + 2;\n\n\t\t\t\t\tlet parent_nodes = d.mother.data.parent_node;\n\t\t\t\t\tlet parent_node_name = parent_nodes[0];\n\t\t\t\t\tfor(let ii=0; ii<parent_nodes.length; ii++) {\n\t\t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\n\t\t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\n\t\t\t\t\t\t\tparent_node_name = parent_nodes[ii].name;\n\t\t\t\t\t}\n\t\t\t\t\tparent_node = utils.getNodeByName(flattenNodes, parent_node_name);\n\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\n\t\t\t\t\tclash.sort(function (a,b) {return a - b;});\n\n\t\t\t\t\tdy2 = (dy1-opts.symbol_size/2-3);\n\t\t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\n\t\t\t\t}\n\n\t\t\t\tlet divorce_path = \"\";\n\t\t\t\tif(divorced && !clash)\n\t\t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-6) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+6) +\n\t\t\t\t\t\t\t\t   \"M\" + (x1+((x2-x1)*.66)+10) + \",\" + (dy1-6) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-2)  + \",\" + (dy1+6);\n\t\t\t\tif(consanguity) {  // consanguinous, draw double line between partners\n\t\t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\n\t\t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\n\n\t\t\t\t\tlet cshift = 3;\n\t\t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {\t  // DIFFERENT LEVEL\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\n\t\t\t\t\t} else {\t\t\t\t\t\t   // SAME LEVEL\n\t\t\t\t\t\tlet path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\n\t\t\t});\n\n\t// links to children\n\tped.selectAll(\".link\")\n\t\t.data(root.links(nodes.descendants()))\n\t\t.enter()\n\t\t\t.filter(function (d) {\n\t\t\t\t// filter unless debug is set\n\t\t\t\treturn (opts.DEBUG ||\n\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\n\t\t\t})\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke-width\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 1;\n\t\t\t\treturn (opts.DEBUG ? 2 : 1);\n\t\t\t})\n\t\t\t.attr(\"stroke\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 'pink';\n\t\t\t\treturn \"#000\";\n\t\t\t})\n\t\t\t.attr(\"stroke-dasharray\", function(d, _i) {\n\t\t\t\tif(!d.target.data.adopted_in) return null;\n\t\t\t\tlet dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\n\t\t\t\tlet dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\n\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\n\t\t\t\tfor(let usedlen = 0; usedlen < dash_len; usedlen += 10)\n\t\t\t\t\t$.merge(dash_array, [5, 5]);\n\t\t\t\treturn dash_array;\n\t\t\t})\n\t\t\t.attr(\"shape-rendering\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\n\t\t\t\t\treturn \"geometricPrecision\";\n\t\t\t\treturn \"auto\";\n\t\t\t})\n\t\t\t.attr(\"d\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\n\t\t\t\t\t// get twin position\n\t\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\t\tif(twins.length >= 1) {\n\t\t\t\t\t\tlet twinx = 0;\n\t\t\t\t\t\tlet xmin = d.target.x;\n\t\t\t\t\t\t//let xmax = d.target.x;\n\t\t\t\t\t\tfor(let t=0; t<twins.length; t++) {\n\t\t\t\t\t\t\tlet thisx = utils.getNodeByName(flattenNodes, twins[t].name).x;\n\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\n\t\t\t\t\t\t\t//if(xmax < thisx) xmax = thisx;\n\t\t\t\t\t\t\ttwinx += thisx;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet xmid = ((d.target.x + twinx) / (twins.length+1));\n\t\t\t\t\t\tlet ymid = ((d.source.y + d.target.y) / 2);\n\n\t\t\t\t\t\tlet xhbar = \"\";\n\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\n\t\t\t\t\t\t\t// horizontal bar for mztwins\n\t\t\t\t\t\t\tlet xx = (xmid + d.target.x)/2;\n\t\t\t\t\t\t\tlet yy = (ymid + (d.target.y-opts.symbol_size/2))/2;\n\t\t\t\t\t\t\txhbar = \"M\" + xx + \",\" + yy +\n\t\t\t\t\t\t\t\t\t\"L\" + (xmid + (xmid-xx)) + \" \" + yy;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t\t\t   \"V\" + ymid +\n\t\t\t\t\t\t\t   \"H\" + xmid +\n\t\t\t\t\t\t\t   \"L\" + (d.target.x) + \" \" + (d.target.y-opts.symbol_size/2) +\n\t\t\t\t\t\t\t   xhbar;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(d.source.data.mother) {   // check parents depth to see if they are at the same level in the tree\n\t\t\t\t\tlet ma = utils.getNodeByName(flattenNodes, d.source.data.mother.name);\n\t\t\t\t\tlet pa = utils.getNodeByName(flattenNodes, d.source.data.father.name);\n\n\t\t\t\t\tif(ma.depth !== pa.depth) {\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + ((ma.y + pa.y) / 2) +\n\t\t\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t   \"V\" + ((d.source.y + d.target.y) / 2) +\n\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t});\n\n\t// draw proband arrow\n\tlet probandIdx  = utils.getProbandIndex(opts.dataset);\n\tif(typeof probandIdx !== 'undefined') {\n\t\tlet probandNode = utils.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\n\t\tlet triid = \"triangle\"+utils.makeid(3);\n\t\tped.append(\"svg:defs\").append(\"svg:marker\")\t// arrow head\n\t\t\t.attr(\"id\", triid)\n\t\t\t.attr(\"refX\", 6)\n\t\t\t.attr(\"refY\", 6)\n\t\t\t.attr(\"markerWidth\", 20)\n\t\t\t.attr(\"markerHeight\", 20)\n\t\t\t.attr(\"orient\", \"auto\")\n\t\t\t.append(\"path\")\n\t\t\t.attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\n\t\t\t.style(\"fill\", \"black\");\n\n\t\tped.append(\"line\")\n\t\t\t.attr(\"x1\", probandNode.x-opts.symbol_size/0.7)\n\t\t\t.attr(\"y1\", probandNode.y+opts.symbol_size/1.4)\n\t\t\t.attr(\"x2\", probandNode.x-opts.symbol_size/1.4)\n\t\t\t.attr(\"y2\", probandNode.y+opts.symbol_size/4)\n\t\t\t.attr(\"stroke-width\", 1)\n\t\t\t.attr(\"stroke\", \"black\")\n\t\t\t.attr(\"marker-end\", \"url(#\"+triid+\")\");\n\t}\n\n\t// drag and zoom\n\tinit_zoom(opts, svg);\n\treturn opts;\n}\n\nfunction has_gender(sex) {\n\treturn sex === \"M\" || sex === \"F\";\n}\n\n//adopted in/out brackets\nfunction get_bracket(dx, dy, indent, opts) {\n\treturn \t\"M\" + (dx+indent) + \",\" + dy +\n\t\t\t\"L\" + dx + \" \" + dy +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + (dx+indent) + \",\" + (dy+(opts.symbol_size *  1.28))\n}\n\n// check for crossing of partner lines\nfunction check_ptr_links(opts, ptrLinkNodes){\n\tfor(let a=0; a<ptrLinkNodes.length; a++) {\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\n\t\tif(clash)\n\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\n\t}\n}\n\nexport function check_ptr_link_clashes(opts, anode) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flattenNodes = utils.flatten(root);\n\tlet mother, father;\n\tif('name' in anode) {\n\t\tanode = utils.getNodeByName(flattenNodes, anode.name);\n\t\tif(!('mother' in anode.data))\n\t\t\treturn null;\n\t\tmother = utils.getNodeByName(flattenNodes, anode.data.mother);\n\t\tfather = utils.getNodeByName(flattenNodes, anode.data.father);\n\t} else {\n\t\tmother = anode.mother;\n\t\tfather = anode.father;\n\t}\n\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\n\tlet dy = mother.y;\n\n\t// identify clashes with other nodes at the same depth\n\tlet clash = $.map(flattenNodes, function(bnode, _i){\n\t\treturn !bnode.data.hidden &&\n\t\t\t\tbnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\n\t\t\t\tbnode.y == dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\n\t});\n\treturn clash.length > 0 ? clash : null;\n}\n\n// group top_level nodes by their partners\nfunction group_top_level(dataset) {\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t// calculate top_level nodes\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tif(utils.getDepth(dataset, dataset[i].name) == 2)\n\t\t\tdataset[i].top_level = true;\n\t}\n\n\tlet top_level = [];\n\tlet top_level_seen = [];\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tlet node = dataset[i];\n\t\tif('top_level' in node && $.inArray(node.name, top_level_seen) == -1){\n\t\t\ttop_level_seen.push(node.name);\n\t\t\ttop_level.push(node);\n\t\t\tlet ptrs = utils.get_partners(dataset, node);\n\t\t\tfor(let j=0; j<ptrs.length; j++){\n\t\t\t\tif($.inArray(ptrs[j], top_level_seen) == -1) {\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\n\t\t\t\t\ttop_level.push(utils.getNodeByName(dataset, ptrs[j]));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tlet newdataset = $.map(dataset, function(val, _i){return 'top_level' in val && val.top_level ? null : val;});\n\tfor (let i = top_level.length; i > 0; --i)\n\t\tnewdataset.unshift(top_level[i-1]);\n\treturn newdataset;\n}\n\nexport function rebuild(opts) {\n\t$(\"#\"+opts.targetDiv).empty();\n\tpedcache.init_cache(opts);\n\ttry {\n\t\tbuild(opts);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\tthrow e;\n\t}\n\n\ttry {\n\t\ttemplates.update(opts);\n\t} catch(e) {\n\t\t// templates not declared\n\t}\n}\n","/**\n/* Functions used by 3rd party apps\n/*\n/* © 2023 Cambridge University\n/* SPDX-FileCopyrightText: 2023 Cambridge University\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {copy_dataset, getNodeByName, getProbandIndex} from './utils.js';\nimport {rebuild} from './pedigree.js';\nimport {delete_node_dataset} from './widgets.js';\nimport {addchild} from './widgets.js';\nimport {syncTwins} from './twins.js';\nimport * as pedcache from './pedcache.js';\n\n\n// Set or remove node attributes.\n// If a value is not provided the attribute is removed.\n// 'key' can be a list of keys or a single key.\nexport function node_attr(opts, name, keys, value){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(newdataset, name);\n\tif(!node){\n\t\tconsole.warn(\"No person defined\");\n\t\treturn;\n\t}\n\n\tif(!$.isArray(keys)) {\n\t\tkeys = [keys];\n\t}\n\n\tif(value) {\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\n\t\t\tif(k in node && keys.length === 1) {\n\t\t\t\tif(node[k] === value)\n\t\t\t\t\treturn;\n\t\t\t\ttry {\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\n\t\t\t\t\t   return;\n\t\t\t\t} catch(e){\n\t\t\t\t\t// continue regardless of error\n\t\t\t\t}\n\t\t\t}\n\t\t\tnode[k] = value;\n\t\t}\n\t} else {\n\t\tlet found = false;\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\n\t\t\tif(k in node) {\n\t\t\t\tdelete node[k];\n\t\t\t\tfound = true;\n\t\t\t}\n\t\t}\n\t\tif(!found)\n\t\t\treturn;\n\t}\n\tsyncTwins(newdataset, node);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\n// Set or remove proband attributes.\n// If a value is not provided the attribute is removed from the proband.\n// 'key' can be a list of keys or a single key.\nexport function proband_attr(opts, keys, value){\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\n\tnode_attr(opts, proband.name, keys, value);\n}\n\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\n\tif(!proband){\n\t\tconsole.warn(\"No proband defined\");\n\t\treturn;\n\t}\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\n\tnewchild.age = age;\n\tnewchild.yob = yob;\n\tif(breastfeeding !== undefined)\n\t\tnewchild.breastfeeding = breastfeeding;\n\topts.dataset = newdataset;\n\trebuild(opts);\n\treturn newchild.name;\n}\n\n// delete node using the name\nexport function delete_node_by_name(opts, name){\n\tfunction onDone(opts, dataset) {\n\t\t// assign new dataset and rebuild pedigree\n\t\topts.dataset = dataset;\n\t\trebuild(opts);\n\t}\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(pedcache.current(opts), name);\n\tif(!node){\n\t\tconsole.warn(\"No node defined\");\n\t\treturn;\n\t}\n\tdelete_node_dataset(newdataset, node, opts, onDone);\n}\n"],"names":["max_limit","dict_cache","has_browser_storage","opts","store_type","undefined","mod","localStorage","setItem","removeItem","e","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","name","clear_pedigree_data","prefix","store","items","i","length","key","indexOf","push","get_count","count","set_count","init_cache","dataset","JSON","stringify","console","warn","nstore","current","parse","previous","next","parseInt","clear","clear_browser_store","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","arr","roots","isIE","ua","navigator","userAgent","isEdge","match","create_err","err","error","Error","validate_pedigree","validate","DEBUG","log","call","this","display_name","uniquenames","famids","p","hidden","mother","father","midx","getIdxByName","fidx","sex","$","inArray","famid","join","uc","unconnected","copy_dataset","id","sort","a","b","disallowed","newdataset","obj","prefixInObj","found","each","k","_n","messages","title","msg","onConfirm","dialog","modal","width","buttons","Yes","No","text","click","makeid","len","possible","charAt","Math","floor","random","buildTree","person","root","partnerLinks","children","getChildren","nodes","flatten","partners","_i","child","_j","m","getNodeByName","f","contains_parent","merge","ptr","parent","setChildrenId","gp","gmidx","gfidx","get_grandparents_idx","updateParent","parent_node","mztwin","dztwins","twins","getTwins","twin","dztwin","isProband","attr","combineArrays","arr1","arr2","include_children","connected","get_partners","getAllChildren","_child_idx","anode","ptrs","bnode","target","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","map","val","proband","sibs","getSiblings","twin_type","getAllSiblings","getAdoptedSiblings","getDepth","idx","depth","top_level","getNodesAtDepth","fnodes","exclude_names","data","linkNodes","flattenNodes","links","ancestors","node","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","_index","flat","forEach","adjust_coords","xmid","overlap","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","xnew","n","abs","symbol_size","print_opts","remove","append","is_fullscreen","document","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement","get_svg_dimensions","window","innerWidth","height","innerHeight","get_tree_dimensions","svg_dimensions","maxscore","generation","score","max_depth","Object","keys","time","d","Date","getHours","slice","getMinutes","getSeconds","getFullYear","getMonth","getDate","age","yob","status","year","sum","string","toUpperCase","is_proband","results","RegExp","exec","location","href","pedcache","zm","init_zoom","svg","xi","yi","d3","scaleExtent","zoomIn","zoomOut","filter","zoomSrc","type","button","on","transform","t","ped","select","targetDiv","zooming","xyk","zoomIdentity","scale","translate","btn_zoom","transition","duration","scaleBy","scale_to_fit","get_bounds","wid","xmax","xmin","hgt","ymax","ymin","get_dimensions","size","w","clientWidth","h","clientHeight","get_svg_size","max","get_pedigree_center","translateTo","setTimeout","scaleTo","Number","MAX_VALUE","sym","selectAll","g_elm","dg","getBBox","text_elements","_groups","txtsize","getTextSize","firstChild","nodeValue","font_family","font_size","getNodeSize","txt","font","fontSize","o","css","position","float","visibility","appendTo","s","addButtons","options","extend","btns","fa","lis","_e","local_dataset","rebuild","exitFullscreen","msExitFullscreen","mozCancelFullScreen","webkitExitFullscreen","requestFullscreen","documentElement","mozRequestFullScreen","webkitRequestFullscreen","Element","ALLOW_KEYBOARD_INPUT","msRequestFullscreen","timeoutId","setInterval","hasClass","clearInterval","stopPropagation","empty","build","resizable","Continue","keep_proband","selected","reset","keep_proband_on_reset","Cancel","trigger","addPbuttonEvents","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test1","genetic_test2","pathology_tests","RISK_FACTOR_STORE","hasInput","trim","get_prs_values","prs","alpha","zscore","percent","myObj","prototype","hasOwnProperty","isEmpty","readCanRisk","boadicea_lines","lines","split","hdr","regexp","version","gt","ncol","ln","ops","j","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","result","path_test","unshift","get_mdensity","mdensity","test","get_pedigree","meta","isanon","ethnicity","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","tl","endo","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","ovarian_cancer_prs","addIO","files","reader","FileReader","onload","load_data","onerror","event","utils","code","readAsText","value","load","content","save_file","save","print","get_printable_svg","svg_download","deferred","svg2img","when","apply","done","getByName","arguments","html","img","open","write","createElement","download","body","appendChild","removeChild","grep","deferred_name","defaults","iscanvg","resolution","img_type","find","d3obj","get","lower","svgStr","Deferred","XMLSerializer","serializeToString","xml","imgsrc","btoa","unescape","encodeURIComponent","canvas","context","getContext","canvg","Canvg","fromString","scaleWidth","scaleHeight","ignoreDimensions","start","drawImage","resolve","toDataURL","src","promise","unique_urls","svg_html","matches","str","myRegexp","c","lastIndex","index","getMatches","quote","m1","m2","newval","svg_div","clone","a4","constructor","Array","cssFiles","printWindow","headContent","close","focus","filename","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","risk_factors","readBoadiceaV4","canrisk_data","readCanRiskFile","to_process","process_ped","readLinkage","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","affected","alleles","_cancer","getLevel","updated","l","prt_lvl","level","fix_n_balance_levels","max_level","pidx","getPartnerIdx","update_parents_level","parents","ma","pa","svg_node","getUniqueTwinID","mz","splice","syncTwins","d1","d2","updateStatus","removeClass","addClass","update_ashkn","is","pedcache_current","switches","iswitch","update_cancer_by_sex","approx_diagnosis_age","substring","round5","checked","tres","valid","update_diagnosis_age_widget","prop","hide","show","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","x1","x2","round","dragging","last_mouseover","addWidgets","popup_selection","style","square_title","circle_title","add_person","classed","datum","addsibling","addchild","highlight","dragstart","dragstop","_d","setLineDragPosition","drag","sourceEvent","dx","dy","ynew","drag_handle","fx","off","fy","widgets","addpartner","addparents","delete","styles","fill","edit","settings","widget","parentNode","opt","autoOpen","table","capitaliseFirstLetter","diseases","v","disease_colour","colour","kk","openEditDialog","delete_node_dataset","onDone","ctrlKey","nodeclick","xcoord","pointer","ycoord","y1","y2","nchild","ptr_name","twin_id","partner","newchildren","add_lhs","newbie","setMzTwin","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","faidx","moidx","tmpfa","orphans","nid","oid","oidx","ptr_node","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","deletes","d3node","ps","children_names","adj","del","twin_types","checkTwins","newopts","addLabels","addLabel","emVal","getComputedStyle","getPx","ilab","labels","label","isArray","ypos","get_text","disease","dis","this_label","vars","ivar","r","node_has_label","y_offset","ftext","class_label","font_weight","background","node_background","pbuttons","io","top_level_seen","group_top_level","hidden_root","hierarchy","tree_dimensions","tree","separation","treemap","ptrLinkNodes","clash","check_ptr_link_clashes","check_ptr_links","enter","has_gender","miscarriage","termination","symbol","symbolTriangle","symbolCircle","symbolSquare","pienode","ncancers","_val","pie","arc","innerRadius","outerRadius","adopted_in","adopted_out","indent","get_bracket","clash_depth","draw_path","dy1","dy2","cshift","path","dx1","dx2","insert","divorced","parent_nodes","parent_node_name","divorce_path","source","dash_len","dash_array","usedlen","twinx","thisx","ymid","xhbar","xx","yy","probandNode","triid","templates","update","node_attr","breastfeeding","newchild"],"mappings":"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"}