/*! pedigreejs 2017-09-19 */

!function(a,b,c){function d(a){for(var b=0;b<a.length;b++)f(a,a[b].name);var c=0;for(b=0;b<a.length;b++)a[b].level&&a[b].level>c&&(c=a[b].level);for(b=0;b<a.length;b++)if(1==pedigree_util.getDepth(a,a[b].name))if(a[b].level&&a[b].level==c)a[b].top_level=!0;else{a[b].noparents=!0;var d=e(a,a[b]);if(d>-1&&a[d].mother&&(a[b].mother=a[d].mother,a[b].father=a[d].father),!a[b].mother)for(var g=0;g<a.length;g++)a[b].level==a[g].level-1&&(d=e(a,a[g]))>-1&&(a[b].mother="F"===a[g].sex?a[g].name:a[d].name,a[b].father="M"===a[g].sex?a[g].name:a[d].name)}else delete a[b].top_level;return a}function e(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(b.name===d.mother)return pedigree_util.getIdxByName(a,d.father);if(b.name===d.father)return pedigree_util.getIdxByName(a,d.mother)}return-1}function f(a,b){var c=pedigree_util.getIdxByName(a,b);g(c,a[c].level?a[c].level:0,a)}function g(a,b,c){var d=["mother","father"];b++;for(var e=0;e<d.length;e++){var f=pedigree_util.getIdxByName(c,c[a][d[e]]);f>=0&&((!c[f].level||c[f].level<b)&&(c[pedigree_util.getIdxByName(c,c[a].mother)].level=b,c[pedigree_util.getIdxByName(c,c[a].father)].level=b),g(f,b,c))}}a.cancers={breast_cancer:"breast_cancer_diagnosis_age",breast_cancer2:"breast_cancer2_diagnosis_age",ovarian_cancer:"ovarian_cancer_diagnosis_age",prostate_cancer:"prostate_cancer_diagnosis_age",pancreatic_cancer:"pancreatic_cancer_diagnosis_age"},a.genetic_test=["brca1","brca2","palb2","atm","chek2"],a.pathology_tests=["er","pr","her2","ck14","ck56"],a.add=function(c){b("#load").change(function(b){a.load(b,c)}),b("#save").click(function(b){a.save(c)}),b("#print").click(function(b){a.print(a.get_printable_svg(c))}),b("#svg_download").click(function(b){a.svg_download(a.get_printable_svg(c))}),b("#png_download").click(function(d){var e,f=b(a.get_printable_svg(c)).appendTo("body")[0],g=f.querySelector("svg");void 0!==window.XMLSerializer?e=(new XMLSerializer).serializeToString(g):void 0!==g.xml&&(e=g.xml);var h=document.createElement("canvas"),i=g.getBoundingClientRect();h.width=i.width,h.height=i.height;var j=h.getContext("2d"),k=document.createElement("img");k.setAttribute("src","data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))),k.onload=function(){j.drawImage(k,0,0);var a=h.toDataURL("image/png"),b=document.createElement("a");b.href=a,b.download="plot.png",b.target="_blank",document.body.appendChild(b),b.click(),document.body.removeChild(b),setTimeout(function(){f.remove()},200)}})},a.copy_svg_html=function(b){for(var c=a.get_printable_svg(b).html(),d=/url\(\#(.*?)\)/g,e=d.exec(c);null!==e;){var f=e[1];c=c.replace(new RegExp(f,"g"),f+ptree.makeid(2)),e=d.exec(c)}return c},a.get_printable_svg=function(a){var d=pedcache.current(a);d!==c&&null!==d&&(a.dataset=d);var e=ptree.get_tree_dimensions(a),f=b("#"+a.targetDiv).find("svg").parent();if(a.width<e.width||a.height<e.height){var g=e.width,h=e.height+100,i=1;if(e.width>595||e.height>842){g=595,h=842;var j=595/e.width,k=842/e.height;i=j<k?j:k}f=b("<div></div>"),f.append(b("svg").parent().html());var l=f.find("svg");l.attr("width",g),l.attr("height",h);var m=1.5*-a.symbol_size*i;l.find(".diagram").attr("transform","translate(0, "+m+") scale("+i+")")}return f},a.svg_download=function(a){var b=document.createElement("a");b.href="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(a.html()))),b.download="plot.svg",b.target="_blank",document.body.appendChild(b),b.click(),document.body.removeChild(b)},a.print=function(a){a.constructor!==Array&&(a=[a]);for(var c=2*b(window).width()/3,d=b(window).height()-40,e=["/static/css/output.css","https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"],f=window.open("","PrintMap","width="+c+",height="+d),g="",h=0;h<e.length;h++)g+='<link href="'+e[h]+'" rel="stylesheet" type="text/css" media="all">';for(g+="<style>body {font-size: "+b("body").css("font-size")+";}</style>",html="",h=0;h<a.length;h++)html+=b(a[h]).html(),h<a.length-1&&(html+='<div style="page-break-before:always"> </div>');f.document.write(g),f.document.write(html),f.document.close(),f.focus(),setTimeout(function(){f.print(),f.close()},100)},a.save=function(a){var b=JSON.stringify(pedcache.current(a));a.DEBUG&&console.log(b);var c="data:application/csv;charset=utf-8,"+encodeURIComponent(b);window.open(c,"boadicea_pedigree")},a.load=function(c,d){var e=c.target.files[0];if(e){var f=new FileReader;f.onload=function(b){if(d.DEBUG&&console.log(b.target.result),b.target.result.startsWith("BOADICEA import pedigree file format 4.0"))d.dataset=a.readBoadiceaV4(b.target.result);else try{d.dataset=JSON.parse(b.target.result)}catch(c){d.dataset=a.readLinkage(b.target.result)}console.log(d.dataset),ptree.rebuild(d)},f.onerror=function(a){console.error("File could not be read! Code "+a.target.error.code)},f.readAsText(e)}else console.error("File could not be read!");b("#load")[0].value=""},a.readLinkage=function(a){for(var c,e=a.trim().split("\n"),f=[],g=0;g<e.length;g++){var h=b.map(e[g].trim().split(/\s+/),function(a,b){return a.trim()});if(h.length<5)throw"unknown format";var i="1"==h[4]?"M":"2"==h[4]?"F":"U",j={famid:h[0],display_name:h[1],name:h[1],sex:i};if("0"!==h[2]&&(j.father=h[2]),"0"!==h[3]&&(j.mother=h[3]),void 0!==c&&c!==j.famid){console.error("multiple family IDs found only using famid = "+c);break}if("2"==h[5]&&(j.affected=2),h.length>6){j.alleles="";for(var k=6;k<h.length;k+=2)j.alleles+=h[k]+"/"+h[k+1]+";"}f.unshift(j),c=h[0]}return d(f)},a.readBoadiceaV4=function(c){for(var e=c.trim().split("\n"),f=[],g=2;g<e.length;g++){var h=b.map(e[g].trim().split(/\s+/),function(a,b){return a.trim()});if(h.length>1){var i={famid:h[0],display_name:h[1],name:h[3],sex:h[6],status:h[8]};1==h[2]&&(i.proband=!0),"0"!==h[4]&&(i.father=h[4]),"0"!==h[5]&&(i.mother=h[5]),"0"!==h[7]&&(i.mztwin=h[7]),"0"!==h[9]&&(i.age=h[9]),"0"!==h[10]&&(i.yob=h[10]);var j=11;b.each(a.cancers,function(a,b){"0"!==h[j]&&(i[b]=h[j]),j++}),"0"!==h[j++]&&(i.ashkenazi=1);for(var k=0;k<a.genetic_test.length;k++)j+=2,"0"!==h[j-2]&&("S"!==h[j-2]&&"T"!==h[j-2]||"P"!==h[j-1]&&"N"!==h[j-1]?console.warn("UNRECOGNISED GENE TEST ON LINE "+(g+1)+": "+h[j-2]+" "+h[j-1]):i[a.genetic_test[k]+"_gene_test"]={type:h[j-2],result:h[j-1]});for(k=0;k<a.pathology_tests.length;k++)"0"!==h[j]&&("N"===h[j]||"P"===h[j]?i[a.pathology_tests[k]+"_bc_pathology"]=h[j]:console.warn("UNRECOGNISED PATHOLOGY ON LINE "+(g+1)+": "+a.pathology_tests[k]+" "+h[j])),j++;f.unshift(i)}}return d(f)}}(window.io=window.io||{},jQuery),function(a,b,c){function d(b,c,d,e,f){if("parent_node"in b?b.parent_node.push(c):b.parent_node=[c],b.mztwin||b.dztwins)for(var g=a.getTwins(f.dataset,b),h=0;h<g.length;h++){var i=a.getNodeByName(e,g[h].name);i&&(i.id=d++)}return d}function e(a,d){return a.sort(function(a,b){return a.mztwin&&b.mztwin&&a.mztwin==b.mztwin?0:a.dztwin&&b.dztwin&&a.dztwin==b.dztwin?0:a.mztwin||b.mztwin||a.dztwin||b.dztwin?1:0}),b.each(a,function(a,b){b.id===c&&(b.id=d++)}),d}function f(a,b,c){for(var d=0;d<a.length;d++)if(a[d].mother===b&&a[d].father===c)return!0;return!1}function g(c,d,e,f){for(var g=d.descendants(),h=b.map(g,function(a,b){return a.data.name}),i=f.descendants(),j=0;j<g.length;j++){var k=g[j];if(d.data.name!==k.data.name){var l=k.x-e;if(a.overlap(c,i,l,k.depth,h))return!0}}return!1}a.buildTree=function(g,h,i,j,k){typeof h.children==typeof c&&(h.children=a.getChildren(g.dataset,h)),typeof j==typeof c&&(j=[],k=1);var l=a.flatten(i),m=[];return b.each(h.children,function(d,e){b.each(g.dataset,function(b,d){if((e.name===d.mother||e.name===d.father)&&e.id===c){var h=a.getNodeByName(l,d.mother),i=a.getNodeByName(l,d.father);h=h!==c?h:a.getNodeByName(g.dataset,d.mother),i=i!==c?i:a.getNodeByName(g.dataset,d.father),f(m,h,i)||m.push({mother:h,father:i})}})}),b.merge(j,m),b.each(m,function(b,c){var f=c.mother,i=c.father;f.children=[];var j={name:ptree.makeid(4),hidden:!0,parent:null,father:i,mother:f,children:a.getChildren(g.dataset,f,i)},m=a.getIdxByName(g.dataset,f.name),n=a.getIdxByName(g.dataset,i.name);"id"in i||"id"in f||(k=e(h.children,k));var o=a.get_grandparents_idx(g.dataset,m,n);o.fidx<o.midx?(i.id=k++,j.id=k++,f.id=k++):(f.id=k++,j.id=k++,i.id=k++),k=d(f,j,k,l,g),k=d(i,j,k,l,g),h.children.push(j)}),k=e(h.children,k),b.each(h.children,function(b,c){k=a.buildTree(g,c,i,j,k)[1]}),[j,k]},a.isProband=function(a){return typeof b(a).attr("proband")!=typeof c&&!1!==b(a).attr("proband")},a.setProband=function(a,c,d){b.each(a,function(a,b){c===b.name?b.proband=d:delete b.proband})},a.getProbandIndex=function(c){var d;return b.each(c,function(b,c){if(a.isProband(c))return d=b}),d},a.getChildren=function(a,c,d){var e=[];return"F"===c.sex&&b.each(a,function(a,b){c.name===b.mother&&(d&&d.name!=b.father||e.push(b))}),e},a.getSiblings=function(a,c,d){return!c.mother||c.noparents?[]:b.map(a,function(a,b){return a.name===c.name||"noparents"in a||!a.mother||a.mother!==c.mother||a.father!==c.father||d&&a.sex!=d?null:a})},a.getAllSiblings=function(a,c,d){return b.map(a,function(a,b){return a.name===c.name||"noparents"in a||!a.mother||a.mother!==c.mother||a.father!==c.father||d&&a.sex!=d?null:a})},a.getTwins=function(c,d){var e=a.getSiblings(c,d),f=d.mztwin?"mztwin":"dztwin";return b.map(e,function(a,b){return a.name!==d.name&&a[f]==d[f]?a:null})},a.getAdoptedSiblings=function(a,c){return b.map(a,function(a,b){return a.name!==c.name&&"noparents"in a&&a.mother===c.mother&&a.father===c.father?a:null})},a.getAllChildren=function(a,c,d){return b.map(a,function(a,b){return"noparents"in a||a.mother!==c.name&&a.father!==c.name||d&&a.sex!==d?null:a})},a.getDepth=function(b,c){for(var d=a.getIdxByName(b,c),e=1;d>=0&&("mother"in b[d]||b[d].top_level);)d=a.getIdxByName(b,b[d].mother),e++;return e},a.getIdxByName=function(a,c){var d=-1;return b.each(a,function(a,b){if(c===b.name)return d=a}),d},a.getNodesAtDepth=function(a,c,d){return b.map(a,function(a,e){return a.depth!=c||a.data.hidden||-1!=b.inArray(a.data.name,d)?null:a}).sort(function(a,b){return a.x-b.x})},a.linkNodes=function(b,c){for(var d=[],e=0;e<c.length;e++)d.push({mother:a.getNodeByName(b,c[e].mother.name),father:a.getNodeByName(b,c[e].father.name)});return d},a.ancestors=function(b,c){function d(c){c.data&&(c=c.data),"mother"in c&&"father"in c&&!("noparents"in c)&&(d(a.getNodeByName(b,c.mother)),d(a.getNodeByName(b,c.father))),e.push(c)}var e=[];return d(c),e},a.consanguity=function(c,d,e){var f=a.ancestors(e.dataset,c),g=a.ancestors(e.dataset,d),h=b.map(f,function(a,b){return a.name}),i=b.map(g,function(a,b){return a.name}),j=!1;return b.each(h,function(a,c){if(-1!==b.inArray(c,i))return j=!0,!1}),j},a.flatten=function(a){function b(a){a.children&&a.children.forEach(b),c.push(a)}var c=[];return b(a),c},a.adjust_coords=function(b,d,e){function f(h){if(h.children&&(h.children.forEach(f),h.data.father!==c)){var i=a.getNodeByName(e,h.data.father.name),j=a.getNodeByName(e,h.data.mother.name),k=(i.x+j.x)/2;if(a.overlap(b,d.descendants(),k,h.depth,[h.data.name]))(h.x<i.x&&h.x<j.x||h.x>i.x&&h.x>j.x)&&(h.x=k);else{h.x=k;var l=h.x-k;if(2==h.children.length&&(h.children[0].data.hidden||h.children[1].data.hidden)){if(!h.children[0].data.hidden||!h.children[1].data.hidden){var m=h.children[0].data.hidden?h.children[1]:h.children[0],n=h.children[0].data.hidden?h.children[0]:h.children[1];(m.x<n.x&&k<n.x||m.x>n.x&&k>n.x)&&!a.overlap(b,d.descendants(),k,m.depth,[m.data.name])&&(m.x=k)}}else if(1!=h.children.length||h.children[0].data.hidden){if(0!==l&&!g(b,h,l,d))if(1==h.children.length)h.children[0].x=k;else{var o=h.descendants();b.DEBUG&&console.log("ADJUSTING "+h.data.name+" NO. DESCENDANTS "+o.length+" diff="+l);for(var p=0;p<o.length;p++)h.data.name!==o[p].data.name&&(o[p].x-=l)}}else a.overlap(b,d.descendants(),k,h.children[0].depth,[h.children[0].data.name])||(h.children[0].x=k)}}}f(d),f(d)},a.overlap=function(a,c,d,e,f){for(var g=0;g<c.length;g++)if(e==c[g].depth&&-1==b.inArray(c[g].data.name,f)&&Math.abs(d-c[g].x)<1.15*a.symbol_size)return!0;return!1},a.getNodeByName=function(a,b){for(var c=0;c<a.length;c++){if(a[c].data&&b===a[c].data.name)return a[c];if(b===a[c].name)return a[c]}},a.urlParam=function(a){var b=new RegExp("[?&]"+a+"=([^&#]*)").exec(window.location.href);return null===b?null:b[1]||0},a.get_grandparents_idx=function(b,c,d){for(var e=c,f=d;"mother"in b[e]&&"mother"in b[f]&&!("noparents"in b[e])&&!("noparents"in b[f]);)e=a.getIdxByName(b,b[e].mother),f=a.getIdxByName(b,b[f].mother);return{midx:e,fidx:f}},a.print_opts=function(a){b("#pedigree_data").remove(),b("body").append("<div id='pedigree_data'></div>");for(var d,e=0;e<a.dataset.length;e++){var f="<div class='row'><strong class='col-md-1 text-right'>"+a.dataset[e].name+"</strong><div class='col-md-11'>";for(d in a.dataset[e])"name"!==d&&("parent"===d?f+="<span>"+d+":"+a.dataset[e][d].name+"; </span>":"children"===d?a.dataset[e][d][0]!==c&&(f+="<span>"+d+":"+a.dataset[e][d][0].name+"; </span>"):f+="<span>"+d+":"+a.dataset[e][d]+"; </span>");b("#pedigree_data").append(f+"</div></div>")}b("#pedigree_data").append("<br /><br />");for(d in a)"dataset"!==d&&b("#pedigree_data").append("<span>"+d+":"+a[d]+"; </span>")}}(window.pedigree_util=window.pedigree_util||{},jQuery),function(a,b,c){function d(b){function c(a){return console.error(a),new Error(a)}if(b.validate){if("function"==typeof b.validate)return b.DEBUG&&console.log("CALLING CONFIGURED VALIDATION FUNCTION"),b.validate.call(this,b);for(var d=0;d<b.dataset.length;d++)if(!d.hidden&&(b.dataset[d].mother||b.dataset[d].father)){var e=b.dataset[d].name,f=b.dataset[d].mother,g=b.dataset[d].father;if(!f||!g)throw c("MISSING PARENT FOR "+e);var h=pedigree_util.getIdxByName(b.dataset,f),i=pedigree_util.getIdxByName(b.dataset,g);if(-1===h)throw c("MISSING MOTHER FOR "+e);if(-1===i)throw c("MISSING FATHER FOR "+e);if("F"!==b.dataset[h].sex)throw c("MOTHERS SEX NOT FEMALE: "+b.dataset[d].sex);if("M"!==b.dataset[i].sex)throw c("FATHERS SEX NOT MALE: "+b.dataset[d].sex)}a.unconnected(b.dataset).length>0&&console.warn("individuals unconnected to pedigree ",unconnected)}}function e(a,c){var d=!1;return c&&b.each(c,function(b,c){if(0===b.indexOf(a+"_")||b===a)return d=!0}),d}function f(a,c,d){if(-1!=b.inArray(c.name,a)){g(a,j(d,c));var e=pedigree_util.getAllChildren(d,c);b.each(e,function(c,e){-1==b.inArray(e.name,a)&&(a.push(e.name),g(a,j(d,e)))})}}function g(a,c){for(var d=0;d<c.length;d++)-1==b.inArray(c[d],a)&&a.push(c[d])}function h(b,c){for(var d=0;d<c.length;d++){var e=a.check_ptr_link_clashes(b,c[d]);e&&console.log("CLASH :: "+c[d].mother.data.name+" "+c[d].father.data.name,e)}}function i(a){return{width:pbuttons.is_fullscreen()?window.innerWidth:a.width,height:pbuttons.is_fullscreen()?window.innerHeight:a.height}}function j(a,c){for(var d=[],e=0;e<a.length;e++){var f=a[e];c.name===f.mother&&-1==b.inArray(f.father,d)?d.push(f.father):c.name===f.father&&-1==b.inArray(f.mother,d)&&d.push(f.mother)}return d}function k(a){for(var c=0;c<a.length;c++)2==pedigree_util.getDepth(a,a[c].name)&&(a[c].top_level=!0);var d=[],e=[];for(c=0;c<a.length;c++){var f=a[c];if("top_level"in f&&-1==b.inArray(f.name,e)){e.push(f.name),d.push(f);for(var g=j(a,f),h=0;h<g.length;h++)-1==b.inArray(g[h],e)&&(e.push(g[h]),d.push(pedigree_util.getNodeByName(a,g[h])))}}var i=b.map(a,function(a,b){return"top_level"in a&&a.top_level?null:a});for(c=d.length;c>0;--c)i.unshift(d[c-1]);return i}function l(a){if(a===parseInt(a,10))return a;if(a.indexOf("px")>-1)return a.replace("px","");if(-1===a.indexOf("em"))return a;var c=b('<div style="display: none; font-size: '+a+'; margin: 0; padding:0; height: auto; line-height: 1; border:0;">&nbsp;</div>').appendTo("body"),d=c.height();return c.remove(),d}function m(a,b,c,d,e,f,g){b.filter(function(b){return!(b.data.hidden&&!a.DEBUG)}).append("text").attr("class",g+" ped_label"||"ped_label").attr("x",d).attr("y",e).attr("font-family",a.font_family).attr("font-size",a.font_size).attr("font-weight",a.font_weight).text(f)}function n(a,b,c,d){return!(!b[d]&&(b[d]=o(a,d),!b[d]))&&(c[d]=b[d],b.yob&&(c.yob=b.yob),!b.age||0!=b.status&&b.status||(c.age=b.age),!0)}function o(a,b){for(var d=[1,2,3,4,5,6,7,8,9,"A"],e=0;e<a.length;e++)if(a[e][b]){var f=d.indexOf(a[e][b]);f>-1&&d.splice(f,1)}return d.length>0?d[0]:c}function p(a){for(var b=["mztwin","dztwin"],c=0;c<a.length;c++)for(var d=0;d<b.length;d++){var e=b[d];if(a[c][e]){for(var f=0,d=0;d<a.length;d++)a[d][e]==a[c][e]&&f++;f<2&&delete a[c][[e]]}}}function q(a,b,c){for(var d,e,f=pedigree_util.getNodesAtDepth(pedigree_util.flatten(a),b.depth,c),g=0;g<f.length;g++)f[g].x<b.x&&(d=f[g]),!e&&f[g].x>b.x&&(e=f[g]);return[d,e]}a.roots={},a.build=function(f){function g(){var a=d3.event.transform,b=[a.x+parseInt(q),a.y+parseInt(r)];1==a.k?pedcache.setposition(j,b[0],b[1]):pedcache.setposition(j,b[0],b[1],a.k),t.attr("transform","translate("+b[0]+","+b[1]+") scale("+a.k+")")}var j=b.extend({targetDiv:"pedigree_edit",dataset:[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},{name:"ch1",display_name:"me",sex:"F",mother:"f21",father:"m21",proband:!0}],width:600,height:400,symbol_size:35,zoomIn:1,zoomOut:1,diseases:[{type:"breast_cancer",colour:"#F68F35"},{type:"breast_cancer2",colour:"pink"},{type:"ovarian_cancer",colour:"#4DAA4D"},{type:"pancreatic_cancer",colour:"#4289BA"},{type:"prostate_cancer",colour:"#D5494A"}],labels:["stillbirth","age","yob","alleles"],font_size:".75em",font_family:"Helvetica",font_weight:700,background:"#EEE",node_background:"#fdfdfd",validate:!0,DEBUG:!1},f);0===b("#fullscreen").length&&(pbuttons.add(j),io.add(j)),-1==pedcache.nstore(j)&&pedcache.add(j),pbuttons.updateButtons(j),d(j),j.dataset=k(j.dataset),j.DEBUG&&pedigree_util.print_opts(j);var n=i(j),o=d3.select("#"+j.targetDiv).append("svg:svg").attr("width",n.width).attr("height",n.height);o.append("rect").attr("width","100%").attr("height","100%").attr("rx",6).attr("ry",6).style("stroke","darkgrey").style("fill",j.background).style("stroke-width",1);var p=pedcache.getposition(j),q=p[0],r=p[1],s=1;3==p.length&&(s=p[2]),null===q&&(q=j.symbol_size/2,r=2.5*-j.symbol_size);var t=o.append("g").attr("class","diagram").attr("transform","translate("+q+","+r+") scale("+s+")"),u=b.map(j.dataset,function(a,b){return"top_level"in a&&a.top_level?a:null}),v={name:"hidden_root",id:0,hidden:!0,children:u},w=pedigree_util.buildTree(j,v,v)[0],x=d3.hierarchy(v);a.roots[j.targetDiv]=x;var y=a.get_tree_dimensions(j);j.DEBUG&&console.log("opts.width="+n.width+" width="+y.width+" opts.height="+n.height+" height="+y.height);var z=d3.tree().separation(function(a,b){return a.data.hidden||b.data.hidden?1.2:a.parent===b.parent&&("noparents"in a.data||"noparents"in b.data||"top_level"in a.data)?1.2:a.parent===b.parent?1:1.2}).size([y.width,y.height]),A=z(x.sort(function(a,b){return a.data.id-b.data.id})),B=A.descendants();if(b.map(j.dataset,function(a,b){return a.hidden?null:a}).length!=j.dataset.length)throw create_err("NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET");pedigree_util.adjust_coords(j,A,B);var C=pedigree_util.linkNodes(B,w);h(j,C);var D=t.selectAll(".node").data(A.descendants()).enter().append("g").attr("transform",function(a,b){return"translate("+a.x+","+a.y+")"});D.append("path").filter(function(a){return!a.data.hidden}).attr("shape-rendering","geometricPrecision").attr("transform",function(a){return"U"==a.data.sex?"rotate(45)":""}).attr("d",d3.symbol().size(function(a){return j.symbol_size*j.symbol_size+2}).type(function(a){return a.data.miscarriage||a.data.termination?d3.symbolTriangle:"F"==a.data.sex?d3.symbolCircle:d3.symbolSquare})).style("stroke",function(a){return a.data.age&&a.data.yob&&!a.data.exclude?"#303030":"grey"}).style("stroke-width",function(a){return a.data.age&&a.data.yob&&!a.data.exclude?".3em":".1em"}).style("stroke-dasharray",function(a){return a.data.exclude?"3, 3":null}).style("fill","none"),D.append("clipPath").attr("id",function(a){return a.data.name}).append("path").filter(function(a){return!(a.data.hidden&&!j.DEBUG)}).attr("class","node").attr("transform",function(a){return"U"==a.data.sex?"rotate(45)":""}).attr("d",d3.symbol().size(function(a){return a.data.hidden?j.symbol_size*j.symbol_size/5:j.symbol_size*j.symbol_size}).type(function(a){return a.data.miscarriage||a.data.termination?d3.symbolTriangle:"F"==a.data.sex?d3.symbolCircle:d3.symbolSquare})),D.selectAll("pienode").data(function(a){var c=0,d=b.map(j.diseases,function(b,d){return e(j.diseases[d].type,a.data)?(c++,1):0});return 0===c&&(d=[1]),[b.map(d,function(b,d){return{cancer:b,ncancers:c,id:a.data.name,sex:a.data.sex,proband:a.data.proband,hidden:a.data.hidden,affected:a.data.affected,exclude:a.data.exclude}})]}).enter().append("g").selectAll("path").data(d3.pie().value(function(a){return a.cancer})).enter().append("path").attr("clip-path",function(a){return"url(#"+a.data.id+")"}).attr("class","pienode").attr("d",d3.arc().innerRadius(0).outerRadius(j.symbol_size)).style("fill",function(a,b){return a.data.exclude?"lightgrey":0===a.data.ncancers?a.data.affected?"darkgrey":j.node_background:j.diseases[b].colour}),D.append("path").filter(function(a){return!a.data.hidden&&a.data.adopted}).attr("d",function(a){function b(a,b,c){return"M"+(a+c)+","+b+"L"+a+" "+b+"L"+a+" "+(b+1.28*j.symbol_size)+"L"+a+" "+(b+1.28*j.symbol_size)+"L"+(a+c)+","+(b+1.28*j.symbol_size)}var c=-.66*j.symbol_size,d=-.64*j.symbol_size,e=j.symbol_size/4;return b(c,d,e)+b(-c,d,-e)}).style("stroke",function(a){return a.data.age&&a.data.yob&&!a.data.exclude?"#303030":"grey"}).style("stroke-width",function(a){return".1em"}).style("stroke-dasharray",function(a){return a.data.exclude?"3, 3":null}).style("fill","none");D.append("line").filter(function(a){return 1==a.data.status}).style("stroke","black").attr("x1",function(a,b){return-.6*j.symbol_size}).attr("y1",function(a,b){return.6*j.symbol_size}).attr("x2",function(a,b){return.6*j.symbol_size}).attr("y2",function(a,b){return-.6*j.symbol_size});m(j,D,".25em",-.4*j.symbol_size,-.1*j.symbol_size,function(a){return j.DEBUG?("display_name"in a.data?a.data.display_name:a.data.name)+"  "+a.data.id:"display_name"in a.data?a.data.display_name:""});for(var E=parseInt(l(j.font_size))+4,F=0;F<j.labels.length;F++){var G=j.labels[F];m(j,D,".25em",-.7*j.symbol_size,function(a){if(a.data[G])return a.y_offset=0!==F&&a.y_offset?a.y_offset+E:2.25*E,a.y_offset},function(a){if(a.data[G]){if("alleles"===G){for(var b="",c=a.data.alleles.split(";"),d=0;d<c.length;d++)""!==c[d]&&(b+=c[d]+";");return b}return"age"===G?a.data[G]+"y":"stillbirth"===G?"SB":a.data[G]}},"indi_details")}for(var H=0;H<j.diseases.length;H++){var I=j.diseases[H].type;m(j,D,".25em",-j.symbol_size,function(a){for(var b=a.y_offset?a.y_offset+E:2.2*E,c=0;c<j.diseases.length&&I!==j.diseases[c].type;c++)e(j.diseases[c].type,a.data)&&(b+=E-1);return b},function(a){var b=I.replace("_"," ").replace("cancer","ca.");return I+"_diagnosis_age"in a.data?b+": "+a.data[I+"_diagnosis_age"]:""},"indi_details")}widgets.addWidgets(j,D);var J={};w=t.selectAll(".partner").data(C).enter().insert("path","g").attr("fill","none").attr("stroke","#000").attr("shape-rendering","auto").attr("d",function(b,c){var d=pedigree_util.getNodeByName(B,b.mother.data.name),e=pedigree_util.getNodeByName(B,b.father.data.name),f=pedigree_util.consanguity(d,e,j),g=b.mother.x<b.father.x?b.mother.x:b.father.x,h=b.mother.x<b.father.x?b.father.x:b.mother.x,i=b.mother.y,k=a.check_ptr_link_clashes(j,b),l="";if(k){b.mother.depth in J?J[b.mother.depth]+=4:J[b.mother.depth]=4,i-=J[b.mother.depth];for(var m=J[b.mother.depth]+j.symbol_size/2+2,n=b.mother.data.parent_node,o=n[0],p=0;p<n.length;p++)n[p].father.name===b.father.data.name&&n[p].mother.name===b.mother.data.name&&(o=n[p].name);var q=pedigree_util.getNodeByName(B,o);q.y=i,k.sort(function(a,b){return a-b});var r=i-j.symbol_size/2-3;draw_path=function(a,b,c,d,e,f){extend=function(a,b){return a+1<b?extend(++a):a};for(var g="",h=0;h<a.length;h++){var i=extend(h,a.length),j=a[h]-b-f,k=a[i]+b+f;e.x>j&&e.x<k&&(e.y=d),g+="L"+j+","+(c-f)+"L"+j+","+(d-f)+"L"+k+","+(d-f)+"L"+k+","+(c-f),h=i}return g},l=draw_path(k,m,i,r,q,0)}if(f){var s=3;return"M"+g+","+i+l+"L"+h+","+i+",M"+g+","+(i-s)+(k?draw_path(k,m,i,r,q,s):"")+"L"+h+","+(i-s)}return"M"+g+","+i+l+"L"+h+","+i});var K=(t.selectAll(".link").data(x.links(A.descendants())).enter().filter(function(a){return j.DEBUG||a.target.data.noparents===c&&null!==a.source.parent&&!a.target.data.hidden}).insert("path","g").attr("fill","none").attr("stroke-width",function(a,b){return a.target.data.noparents!==c||null===a.source.parent||a.target.data.hidden?1:j.DEBUG?2:1}).attr("stroke",function(a,b){return a.target.data.noparents!==c||null===a.source.parent||a.target.data.hidden?"pink":"#000"}).attr("shape-rendering",function(a,b){return a.target.data.mztwin||a.target.data.dztwin?"geometricPrecision":"auto"}).attr("d",function(a,b){if(j.DEBUG||a.target.data.noparents===c&&null!==a.source.parent&&!a.target.data.hidden){if(a.target.data.mztwin||a.target.data.dztwin){var d=pedigree_util.getTwins(j.dataset,a.target.data);if(d.length>=1){for(var e=0,f=a.target.x,g=a.target.x,h=0;h<d.length;h++){var i=pedigree_util.getNodeByName(B,d[h].name).x;f>i&&(f=i),g<i&&(g=i),e+=i}var k=(a.target.x+e)/(d.length+1),l=(a.source.y+a.target.y)/2,m="";if(f===a.target.x&&a.target.data.mztwin){var n=(k+a.target.x)/2,o=(l+(a.target.y-j.symbol_size/2))/2;m="M"+n+","+o+"L"+(k+(k-n))+" "+o}return"M"+a.source.x+","+a.source.y+"V"+l+"H"+k+"L"+a.target.x+" "+(a.target.y-j.symbol_size/2)+m}}return"M"+a.source.x+","+a.source.y+"V"+(a.source.y+a.target.y)/2+"H"+a.target.x+"V"+a.target.y}}),pedigree_util.getProbandIndex(j.dataset));if(K){var L=pedigree_util.getNodeByName(B,j.dataset[K].name);t.append("svg:defs").append("svg:marker").attr("id","triangle").attr("refX",6).attr("refY",6).attr("markerWidth",20).attr("markerHeight",20).attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").style("fill","black"),t.append("line").attr("x1",L.x-j.symbol_size).attr("y1",L.y+j.symbol_size).attr("x2",L.x-j.symbol_size/2).attr("y2",L.y+j.symbol_size/2).attr("stroke-width",1).attr("stroke","black").attr("marker-end","url(#triangle)")}return s=d3.zoom().scaleExtent([j.zoomIn,j.zoomOut]).on("zoom",g),o.call(s),j},a.unconnected=function(a){var c=a[pedigree_util.getProbandIndex(a)];c||(console.warn("No target defined"),c=a[0]);for(var d=[c.name],e=!0,g=0;e&&g<200;){g++;var h=d.length;b.each(a,function(e,g){if(-1!=b.inArray(g.name,d)){for(var h=j(a,g),i=g.name===c.name||!g.noparents,k=0;k<h.length;k++)pedigree_util.getNodeByName(a,h[k]).noparents||(i=!0);i&&(g.mother&&-1==b.inArray(g.mother,d)&&d.push(g.mother),g.father&&-1==b.inArray(g.father,d)&&d.push(g.father))}else!g.noparents&&(g.mother&&-1!=b.inArray(g.mother,d)||g.father&&-1!=b.inArray(g.father,d))&&d.push(g.name);f(d,g,a)}),e=h!=d.length}var i=b.map(a,function(a,b){return a.name});return b.map(i,function(a,c){return-1==b.inArray(a,d)?a:null})},a.check_ptr_link_clashes=function(c,d){var e,f,g=a.roots[c.targetDiv],h=pedigree_util.flatten(g);if("name"in d){if(d=pedigree_util.getNodeByName(h,d.name),!("mother"in d.data))return null;e=pedigree_util.getNodeByName(h,d.data.mother),f=pedigree_util.getNodeByName(h,d.data.father)}else e=d.mother,f=d.father;var i=e.x<f.x?e.x:f.x,j=e.x<f.x?f.x:e.x,k=e.y,l=b.map(h,function(a,b){return!a.data.hidden&&a.data.name!==e.data.name&&a.data.name!==f.data.name&&a.y==k&&a.x>i&&a.x<j?a.x:null});return l.length>0?l:null},a.get_tree_dimensions=function(a){for(var b=i(a),c=0,d={},e=0;e<a.dataset.length;e++){var f=pedigree_util.getDepth(a.dataset,a.dataset[e].name),g=pedigree_util.getAllChildren(a.dataset,a.dataset[e]),h=1+(g.length>0?.55+.25*g.length:0)+(a.dataset[e].father?.25:0);f in d?d[f]+=h:d[f]=h,d[f]>c&&(c=d[f])}var j=Object.keys(d).length*a.symbol_size*3.5;return{width:b.width-a.symbol_size>c*a.symbol_size*1.65?b.width-a.symbol_size:c*a.symbol_size*1.65,height:b.height-a.symbol_size>j?b.height-a.symbol_size:j}},a.rebuild=function(c){b("#"+c.targetDiv).empty(),pedcache.add(c);try{a.build(c)}catch(a){console.error(a)}try{templates.update(c)}catch(a){}},a.copy_dataset=function(a){a[0].id&&a.sort(function(a,b){return a.id&&b.id?a.id>b.id?1:b.id>a.id?-1:0:0});for(var b=["id","parent_node"],c=[],d=0;d<a.length;d++){var e={};for(var f in a[d])-1==b.indexOf(f)&&(e[f]=a[d][f]);c.push(e)}return c},a.addchild=function(d,e,f,g,h){if(h&&-1===b.inArray(h,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+h);typeof g==typeof c&&(g=1);var i,j,k=pedigree_util.getAllChildren(d,e);if(0===k.length){var l=a.addsibling(d,e,"F"===e.sex?"M":"F");l.noparents=!0,i=l.name,j=pedigree_util.getIdxByName(d,e.name)+1}else{var m=k[0];i=m.father===e.name?m.mother:m.father,j=pedigree_util.getIdxByName(d,m.name)}if(h)var n=o(d,h);for(var p=0;p<g;p++){var q={name:a.makeid(4),sex:f,mother:"F"===e.sex?e.name:i,father:"F"===e.sex?i:e.name};d.splice(j,0,q),h&&(q[h]=n)}},a.addsibling=function(c,d,e,f,g){if(g&&-1===b.inArray(g,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+g);var h={name:a.makeid(4),sex:e};d.top_level?h.top_level=!0:(h.mother=d.mother,h.father=d.father);var i=pedigree_util.getIdxByName(c,d.name);return g&&n(c,c[i],h,g),f?i>0&&i--:i++,c.splice(i,0,h),h},a.syncTwins=function(a,b){if(b.mztwin||b.dztwin)for(var c=b.mztwin?"mztwin":"dztwin",d=0;d<a.length;d++){var e=a[d];e[c]&&b[c]==e[c]&&e.name!==b.name&&("mztwin"===c&&(e.sex=b.sex),b.yob&&(e.yob=b.yob),!b.age||0!=b.status&&b.status||(e.age=b.age))}},a.addparents=function(b,c,d){var e,f,g,h=a.roots[b.targetDiv],i=pedigree_util.flatten(h),j=pedigree_util.getNodeByName(i,d),k=j.data,l=j.depth,m=-101,n=pedigree_util.getAllChildren(c,k);n.length>0&&(g=n[0].mother==k.name?n[0].father:n[0].mother,m=pedigree_util.getNodeByName(i,g).data.id);var o;if(1==l)for(e={name:a.makeid(4),sex:"F",top_level:!0},f={name:a.makeid(4),sex:"M",top_level:!0},c.splice(0,0,f),c.splice(0,0,e),o=0;o<c.length;o++)c[o].top_level&&c[o].name!==e.name&&c[o].name!==f.name&&(delete c[o].top_level,c[o].noparents=!0,c[o].mother=e.name,c[o].father=f.name);else{var p=pedigree_util.getNodeByName(i,j.data.mother),q=pedigree_util.getNodeByName(i,j.data.father),r=pedigree_util.getAllSiblings(c,k),s=1e4,t=j.data.id;for(o=0;o<r.length;o++){var u=pedigree_util.getNodeByName(i,r[o].name).data.id;u<s&&u>j.data.id&&(s=u),u<t&&(t=u)}var v=t>=j.data.id||m==t&&s<1e4;b.DEBUG&&console.log("lid="+t+" rid="+s+" nid="+j.data.id+" ADD_LHS="+v);var w;w=!v&&q.data.id>p.data.id||v&&q.data.id<p.data.id?pedigree_util.getIdxByName(c,k.father):pedigree_util.getIdxByName(c,k.mother);var x=c[w];e=a.addsibling(c,x,"F",v),f=a.addsibling(c,x,"M",v);var y=pedigree_util.getAdoptedSiblings(c,k),z=j.data.id;for(o=0;o<y.length;o++){var A=pedigree_util.getNodeByName(i,y[o].name).data.id;if(b.DEBUG&&console.log("ORPHAN="+o+" "+y[o].name+" "+(z<A&&A<s)+" nid="+z+" oid="+A+" rid="+s),(v||z<A)&&A<s){var B=pedigree_util.getIdxByName(c,y[o].name);c[B].mother=e.name,c[B].father=f.name}}}2==l?(e.top_level=!0,f.top_level=!0):l>2&&(e.noparents=!0,f.noparents=!0);var C=pedigree_util.getIdxByName(c,k.name);if(c[C].mother=e.name,c[C].father=f.name,delete c[C].noparents,"parent_node"in k){var D=c[pedigree_util.getIdxByName(c,g)];"noparents"in D&&(D.mother=e.name,D.father=f.name)}},a.addpartner=function(b,c,d){var e=a.roots[b.targetDiv],f=pedigree_util.flatten(e),g=pedigree_util.getNodeByName(f,d),h=a.addsibling(c,g.data,"F"===g.data.sex?"M":"F");h.noparents=!0;var i={name:a.makeid(4),sex:"M"};i.mother="F"===g.data.sex?g.data.name:h.name,i.father="F"===g.data.sex?h.name:g.data.name;var j=pedigree_util.getIdxByName(c,g.data.name)+2;c.splice(j,0,i)},a.delete_node_dataset=function(d,e,f){var g,h,i=a.roots[f.targetDiv],k=pedigree_util.flatten(i),l=[];if(e.parent_node)for(g=0;g<e.parent_node.length;g++){var m=e.parent_node[g],n=[pedigree_util.getNodeByName(d,m.mother.name),pedigree_util.getNodeByName(d,m.father.name)];for(h=0;h<n.length;h++)(n[h].name===e.name||n[h].noparents!==c||n[h].top_level)&&(d.splice(pedigree_util.getIdxByName(d,n[h].name),1),l.push(n[h]));var o=m.children,r=b.map(o,function(a,b){return a.name});for(h=0;h<o.length;h++){var s=pedigree_util.getNodeByName(d,o[h].name);if(s){s.noparents=!0,ptrs=j(d,s);var t;if(ptrs.length>0&&(t=pedigree_util.getNodeByName(d,ptrs[0])),t&&t.mother!==s.mother)s.mother=t.mother,s.father=t.father;else if(t){var u=pedigree_util.getNodeByName(k,s.name),v=q(i,u,r);s.mother=v[0]?v[0].data.mother:v[1]?v[1].data.mother:null,s.father=v[0]?v[0].data.father:v[1]?v[1].data.father:null}else d.splice(pedigree_util.getIdxByName(d,s.name),1)}}}else d.splice(pedigree_util.getIdxByName(d,e.name),1);for(console.log(l),g=0;g<l.length;g++){var w=l[g],x=pedigree_util.getAllSiblings(d,w);if(console.log("DEL",w.name,x),x.length<1){console.log("del sibs",w.name,x);var y=pedigree_util.getNodeByName(k,w.name),z=y.ancestors();for(h=0;h<z.length;h++)console.log(z[g]),z[h].data.mother&&(console.log("DELETE ",z[h].data.mother,z[h].data.father),d.splice(pedigree_util.getIdxByName(d,z[h].data.mother.name),1),d.splice(pedigree_util.getIdxByName(d,z[h].data.father.name),1))}}p(d);var A=a.unconnected(d);return A.length>0&&0===a.unconnected(f.dataset).length&&(console.error("individuals unconnected to pedigree ",A),confirm("Deleting this will split the pedigree. Continue?")||(d=a.copy_dataset(f.dataset))),d},a.makeid=function(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",d=0;d<a;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b}}(window.ptree=window.ptree||{},jQuery),function(a,b,c){function d(a){b("#cancer .row").show(),"M"===a.sex?(delete a.ovarian_cancer_diagnosis_age,b("[id^='id_ovarian_cancer_diagnosis_age']").closest(".row").hide()):"F"===a.sex&&(delete a.prostate_cancer_diagnosis_age,b("[id^='id_prostate_cancer_diagnosis_age']").closest(".row").hide())}function e(a){var b=10*Math.round((a-1)/10);return a<b?b-5:b+5}a.update=function(c){b(".node_save").click(function(){a.save(c)}),b("#id_proband, #id_exclude").click(function(a){var d=pedcache.current(c);c.dataset=ptree.copy_dataset(d);var e=b("#id_name").val();if("id_proband"===b(this).attr("id"))pedigree_util.setProband(c.dataset,e,b(this).is(":checked"));else{var f=pedigree_util.getIdxByName(c.dataset,e);b(this).is(":checked")?c.dataset[f].exclude=!0:delete c.dataset[f].exclude}pedcache.add(c),b("#"+c.targetDiv).empty(),ptree.build(c)}),b("input[id$='_mut_sensitivity'], input[id$='_mut_frequency']").prop("disabled",!0),b("#id_use_custom_mutation_sensitivities").change(function(){b("input[id$='_mut_sensitivity']").prop("disabled",!b(this).is(":checked"))}),b("#id_mutation_frequencies").change(function(){if(b("input[id$='_mut_frequency']").prop("disabled","Custom"!==this.value),a.mutation_frequencies&&"Custom"!==this.value){var c=a.mutation_frequencies[this.value];for(var d in c)b("#id_"+d.toLowerCase()+"_mut_frequency").val(c[d])}})},a.nodeclick=function(c){b("form > fieldset").removeAttr("disabled"),b("#person_details").find("input[type=text], input[type=number]").val(""),b("#person_details select").val("").prop("selected",!0),"M"===c.sex||"F"===c.sex?b('input[name=sex][value="'+c.sex+'"]').prop("checked",!0):b("input[name=sex]").prop("checked",!1),d(c),"status"in c||(c.status=0),b('input[name=status][value="'+c.status+'"]').prop("checked",!0),"proband"in c?b("#id_proband").prop("checked",c.proband):b("#id_proband").prop("checked",!1),"exclude"in c?b("#id_exclude").prop("checked",c.exclude):b("#id_exclude").prop("checked",!1),"yob"in c?b("#id_yob_0").val(c.yob):b("#id_yob_0").val("-"),b('select[name$="_bc_pathology"]').val("-"),b('select[name*="_gene_test"]').val("-"),b("input[id^='id_sex_']").prop("disabled",!(!c.parent_node||"U"===c.sex)),b("select[id$='_bc_pathology']").prop("disabled","M"===c.sex),b("#id_approx").prop("checked",!!c.approx_diagnosis_age),a.update_diagnosis_age_widget();for(var f in c)"proband"!==f&&"sex"!==f&&(b("#id_"+f).length?-1!==f.indexOf("_gene_test")&&null!==c[f]&&"object"==typeof c[f]?(b("#id_"+f).val(c[f].type),b("#id_"+f+"_result").val(c[f].result)):b("#id_"+f).val(c[f]):-1!==f.indexOf("_diagnosis_age")&&(b("#id_approx").is(":checked")?b("#id_"+f+"_1").val(e(c[f])).prop("selected",!0):b("#id_"+f+"_0").val(c[f])));try{b("#person_details").find("form").valid()}catch(a){console.warn("valid() not found")}},a.save=function(a){var c=pedcache.current(a),f=b("#id_name").val(),g=ptree.copy_dataset(c),h=pedigree_util.getNodeByName(g,f);if(!h)return void console.warn("person not found when saving details");b("#"+a.targetDiv).empty();var i=b("#id_yob_0").val();i&&""!==i?h.yob=i:delete h.yob;var j=b("#id_status").find("input[type='radio']:checked");j.length>0&&(h.status=j.val());for(var k=["miscarriage","adopted","termination","stillbirth"],l=0;l<k.length;l++){var m=k[l],n=b("#id_"+m);n.length>0&&(console.log(n.is(":checked")),n.is(":checked")?h[m]=!0:delete h[m])}var o=b("#id_sex").find("input[type='radio']:checked");o.length>0&&(h.sex=o.val(),d(h)),b("#id_approx").is(":checked")?h.approx_diagnosis_age=!0:delete h.approx_diagnosis_age,b("#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible").each(function(){var a=this.name.indexOf("_diagnosis_age")>-1?this.name.substring(0,this.name.length-2):this.name;if(b(this).val()){var c=b(this).val();a.indexOf("_diagnosis_age")>-1&&b("#id_approx").is(":checked")&&(c=e(c)),h[a]=c}else delete h[a]}),b('#person_details input[type="checkbox"][name$="cancer"],input[type="checkbox"][name$="cancer2"]').each(function(){this.checked?h[b(this).attr("name")]=!0:delete h[b(this).attr("name")]}),b('#person_details select[name$="_bc_pathology"]').each(function(){"-"!==b(this).val()?h[b(this).attr("name")]=b(this).val():delete h[b(this).attr("name")]}),b('#person_details select[name$="_gene_test"]').each(function(){if("-"!==b(this).val()){var a=b('select[name="'+b(this).attr("name")+'_result"]');h[b(this).attr("name")]={type:b(this).val(),result:b(a).val()}}else delete h[b(this).attr("name")]});try{b("#person_details").find("form").valid()}catch(a){console.warn("valid() not found")}ptree.syncTwins(g,h),a.dataset=g,ptree.rebuild(a)},a.update_diagnosis_age_widget=function(){b("#id_approx").is(":checked")?(b("[id$='_diagnosis_age_0']").each(function(a){if(""!==b(this).val()){var c=this.name.substring(0,this.name.length-2);b("#id_"+c+"_1").val(e(b(this).val())).prop("selected",!0)}}),b("[id$='_diagnosis_age_0']").hide(),b("[id$='_diagnosis_age_1']").show()):(b("[id$='_diagnosis_age_1']").each(function(a){if(""!==b(this).val()){var c=this.name.substring(0,this.name.length-2);b("#id_"+c+"_0").val(b(this).val())}}),b("[id$='_diagnosis_age_0']").show(),b("[id$='_diagnosis_age_1']").hide())}}(window.pedigree_form=window.pedigree_form||{},jQuery),function(a,b,c){function d(a){b(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(b){var d=pedcache.current(a);d!==c&&null!==d&&(a.dataset=d),ptree.rebuild(a)}),b("#fullscreen").on("click",function(c){if(document.mozFullScreen||document.webkitFullScreen)document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen();else{var d=b("#"+a.targetDiv)[0];d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}}),b("#"+a.btn_target).on("click",function(c){if(c.stopPropagation(),b(c.target).hasClass("disabled"))return!1;if(b(c.target).hasClass("fa-undo"))a.dataset=pedcache.previous(a),b("#"+a.targetDiv).empty(),ptree.build(a);else if(b(c.target).hasClass("fa-repeat"))a.dataset=pedcache.next(a),b("#"+a.targetDiv).empty(),ptree.build(a);else if(b(c.target).hasClass("fa-refresh")){pedcache.clear(a),delete a.dataset;var d=b("input[name='default_fam']:checked");d.length>0&&"extended2"==d.val()?a.dataset=[{name:"wZA",sex:"M",top_level:!0,status:"0",display_name:"paternal grandfather"},{name:"MAk",sex:"F",top_level:!0,status:"0",display_name:"paternal grandmother"},{name:"dOH",sex:"F",top_level:!0,status:"0",display_name:"maternal grandmother"},{name:"zwB",sex:"M",top_level:!0,status:"0",display_name:"maternal grandfather"},{name:"MKg",sex:"F",mother:"MAk",father:"wZA",status:"0",display_name:"paternal aunt"},{name:"xsm",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"paternal uncle"},{name:"m21",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"father"},{name:"f21",sex:"F",mother:"dOH",father:"zwB",status:"0",display_name:"mother"},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"},{name:"ch1",sex:"F",mother:"f21",father:"m21",proband:!0,status:"0",display_name:"me"},{name:"Spj",sex:"M",mother:"f21",father:"m21",noparents:!0,status:"0",display_name:"partner"},{name:"zhk",sex:"F",mother:"ch1",father:"Spj",status:"0",display_name:"daughter"},{name:"Knx",display_name:"son",sex:"M",mother:"ch1",father:"Spj",status:"0"},{name:"uuc",display_name:"maternal aunt",sex:"F",mother:"dOH",father:"zwB",status:"0"},{name:"xIw",display_name:"maternal uncle",sex:"M",mother:"dOH",father:"zwB",status:"0"}]:d.length>0&&"extended1"==d.val()?a.dataset=[{name:"m21",sex:"M",mother:null,father:null,status:"0",display_name:"father",noparents:!0},{name:"f21",sex:"F",mother:null,father:null,status:"0",display_name:"mother",noparents:!0},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"},{name:"ch1",sex:"F",mother:"f21",father:"m21",proband:!0,status:"0",display_name:"me"},{name:"Spj",sex:"M",mother:"f21",father:"m21",noparents:!0,status:"0",display_name:"partner"},{name:"zhk",sex:"F",mother:"ch1",father:"Spj",status:"0",display_name:"daughter"},{name:"Knx",display_name:"son",sex:"M",mother:"ch1",father:"Spj",status:"0"}]:a.dataset=[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},{name:"ch1",display_name:"me",sex:"F",mother:"f21",father:"m21",proband:!0}],ptree.rebuild(a)}})}a.add=function(a){for(var c=b.extend({btn_target:"pedigree_history"},a),e=[{fa:"fa-undo",title:"undo"},{fa:"fa-repeat",title:"redo"},{fa:"fa-refresh",title:"reset"},{fa:"fa-arrows-alt",title:"fullscreen"}],f="",g=0;g<e.length;g++)f+='<li">',f+='&nbsp;<i class="fa fa-lg '+e[g].fa+'" '+("fa-arrows-alt"==e[g].fa?'id="fullscreen" ':"")+' aria-hidden="true" title="'+e[g].title+'"></i>',f+="</li>";b("#"+c.btn_target).append(f),d(c)},a.is_fullscreen=function(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement},a.updateButtons=function(a){var c=pedcache.get_count(a),d=pedcache.nstore(a),e="#"+a.btn_target;d<=c?b(e+" .fa-repeat").addClass("disabled"):b(e+" .fa-repeat").removeClass("disabled"),c>1?b(e+" .fa-undo").removeClass("disabled"):b(e+" .fa-undo").addClass("disabled")}}(window.pbuttons=window.pbuttons||{},jQuery),function(a,b,c){function d(a){try{if("array"===a.store_type)return!1;if("local"!==a.store_type&&"session"!==a.store_type&&a.store_type!==c)return!1;var b="test";return localStorage.setItem(b,b),localStorage.removeItem(b),!0}catch(a){return!1}}function e(a){return"PEDIGREE_"+a.btn_target+"_"}function f(a){return l[e(a)]}function g(a,b){return"local"===a.store_type?localStorage.getItem(b):sessionStorage.getItem(b)}function h(a,b,c){return"local"===a.store_type?localStorage.setItem(b,c):sessionStorage.setItem(b,c)}function i(a){return"local"===a.store_type?localStorage.clear():sessionStorage.clear()}function j(a,b){d(a)?h(a,e(a)+"COUNT",b):l[e(a)+"COUNT"]=b}var k=25,l={};a.get_count=function(a){var b;return b=d(a)?g(a,e(a)+"COUNT"):l[e(a)+"COUNT"],null!==b&&b!==c?b:0},a.add=function(b){if(b.dataset){var g=a.get_count(b);d(b)?h(b,e(b)+g,JSON.stringify(b.dataset)):(console.warn("Local storage not found/supported for this browser!",b.store_type),k=500,f(b)===c&&(l[e(b)]=[]),f(b).push(JSON.stringify(b.dataset))),g<k?g++:g=0,j(b,g)}},a.nstore=function(a){if(!d(a))return f(a)&&f(a).length>0?f(a).length:-1;for(var b=k;b>0;b--)if(null!==g(a,e(a)+(b-1)))return b;return-1},a.current=function(b){var c=a.get_count(b)-1;return-1==c&&(c=k-1),d(b)?JSON.parse(g(b,e(b)+c)):f(b)?JSON.parse(f(b)[c]):void 0},a.last=function(a){if(d(a))for(var b=k;b>0;b--){var h=g(a,e(a)+(b-1));if(null!==h)return j(a,b),JSON.parse(h)}else{var i=f(a);if(i)return JSON.parse(i(i.length-1))}return c},a.previous=function(b,h){if(h===c&&(h=a.get_count(b)-2),h<0){var i=a.nstore(b);h=i<k?i-1:k-1}return j(b,h+1),d(b)?JSON.parse(g(b,e(b)+h)):JSON.parse(f(b)[h])},a.next=function(b,h){return h===c&&(h=a.get_count(b)),h>=k&&(h=0),j(b,parseInt(h)+1),d(b)?JSON.parse(g(b,e(b)+h)):JSON.parse(f(b)[h])},a.clear=function(a){d(a)&&i(a),l={}},a.setposition=function(a,b,c,f){d(a)&&(h(a,e(a)+"_X",b),h(a,e(a)+"_Y",c),f&&h(a,e(a)+"_ZOOM",f))},a.getposition=function(a){if(!d(a)||null===localStorage.getItem(e(a)+"_X")&&null===sessionStorage.getItem(e(a)+"_X"))return[null,null];var b=[parseInt(g(a,e(a)+"_X")),parseInt(g(a,e(a)+"_Y"))];return null!==g(e(a)+"_ZOOM")&&b.push(parseFloat(g(a,e(a)+"_ZOOM"))),b}}(window.pedcache=window.pedcache||{},jQuery),function(a,b,c){function d(a){function b(a){d3.event.sourceEvent.stopPropagation(),h=i,d3.selectAll(".line_drag_selection").attr("stroke","darkred")}function d(b){if(i&&h.data.name!==i.data.name&&h.data.sex!==i.data.sex){var d={name:ptree.makeid(4),sex:"U",mother:"F"===h.data.sex?h.data.name:i.data.name,father:"F"===h.data.sex?i.data.name:h.data.name};newdataset=ptree.copy_dataset(a.dataset),a.dataset=newdataset;var f=pedigree_util.getIdxByName(a.dataset,h.data.name)+1;a.dataset.splice(f,0,d),ptree.rebuild(a)}e(0,0,0,0),d3.selectAll(".line_drag_selection").attr("stroke","black"),h=c}function f(b){d3.event.sourceEvent.stopPropagation();var c=d3.event.dx,d=parseFloat(d3.select(this).attr("x2"))+c;e(a.symbol_size-10,0,d,0)}d3.select(".diagram").append("line").attr("class","line_drag_selection").attr("stroke-width",6).style("stroke-dasharray","2, 1").attr("stroke","black").call(d3.drag().on("start",b).on("drag",f).on("end",d)),e(0,0,0,0)}function e(a,b,c,d,e){e&&d3.selectAll(".line_drag_selection").attr("transform","translate("+e+")"),d3.selectAll(".line_drag_selection").attr("x1",a).attr("y1",b).attr("x2",c).attr("y2",d)}function f(a){return a.charAt(0).toUpperCase()+a.slice(1)}function g(a,d){b("#node_properties").dialog({autoOpen:!1,title:d.data.display_name,width:b(window).width()>400?450:b(window).width()-30});var e="<table id='person_details' class='table'>";e+="<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value="+(d.data.name?d.data.name:"")+"></td></tr>",e+="<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value="+(d.data.display_name?d.data.display_name:"")+"></td></tr>",e+="<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:5em' value="+(d.data.age?d.data.age:"")+"></td></tr>",e+='<tr><td colspan="2" id="id_sex"><label class="radio-inline"><input type="radio" name="sex" value="M" '+("M"===d.data.sex?"checked":"")+'>Male</label><label class="radio-inline"><input type="radio" name="sex" value="F" '+("F"===d.data.sex?"checked":"")+'>Female</label><label class="radio-inline"><input type="radio" name="sex" value="U">Unknown</label></td></tr>',e+='<tr><td colspan="2" id="id_status"><label class="checkbox-inline"><input type="radio" name="status" value="0" '+(0===d.data.status?"checked":"")+'>&thinsp;Alive</label><label class="checkbox-inline"><input type="radio" name="status" value="1" '+(1===d.data.status?"checked":"")+">&thinsp;Deceased</label></td></tr>",b("#id_status input[value='"+d.data.status+"']").prop("checked",!0);var g=["adopted","miscarriage","stillbirth","termination"];e+='<tr><td colspan="2"><strong>Reproduction:</strong></td></tr>',e+='<tr><td colspan="2">';for(var h=0;h<g.length;h++){var i=g[h];e+='<label class="checkbox-inline"><input type="checkbox" id="id_'+i+'" name="'+i+'" value="0" '+(d.data[i]?"checked":"")+">&thinsp;"+f(i)+"</label>"}e+="</td></tr>";var j=["children","name","parent_node","top_level","id","level","age","sex","status","display_name","mother","father"];b.merge(j,g),e+='<tr><td colspan="2"><strong>Age of Diagnosis:</strong></td></tr>',b.each(a.diseases,function(b,g){j.push(g.type+"_diagnosis_age");var h='&thinsp;<span style="padding-left:5px;background:'+a.diseases[b].colour+'"></span>',i=d.data[g.type+"_diagnosis_age"];e+="<tr><td style='text-align:right'>"+f(g.type.replace("_"," "))+h+"&nbsp;</td><td><input class='form-control' id='id_"+g.type+"_diagnosis_age_0' max='110' min='0' name='"+g.type+"_diagnosis_age_0' style='width:5em' type='number' value='"+(i!==c?i:"")+"'></td></tr>"}),e+='<tr><td colspan="2" style="line-height:1px;"></td></tr>',b.each(d.data,function(a,c){if(-1==b.inArray(a,j)){var d=f(a);!0===c||!1===c?e+="<tr><td style='text-align:right'>"+d+"&nbsp;</td><td><input type='checkbox' id='id_"+a+"' name='"+a+"' value="+c+" "+(c?"checked":"")+"></td></tr>":a.length>0&&(e+="<tr><td style='text-align:right'>"+d+"&nbsp;</td><td><input type='text' id='id_"+a+"' name='"+a+"' value="+c+"></td></tr>")}}),e+="</table>",b("#node_properties").html(e),b("#node_properties").dialog("open"),b("#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]").change(function(){pedigree_form.save(a)}),pedigree_form.update(a)}var h,i;a.addWidgets=function(a,f){var j=parseInt(b("body").css("font-size")),k=d3.select(".diagram");k.append("rect").attr("class","popup_selection").attr("rx",6).attr("ry",6).attr("transform","translate(-1000,-100)").style("opacity",0).attr("width",7.9*j).attr("height",2*j).style("stroke","darkgrey").attr("fill","white");var l=k.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("font-size","1.em").attr("class","popup_selection fa-lg fa-square persontype").attr("transform","translate(-1000,-100)").attr("x",j/3).attr("y",1.5*j).text(" "),m=l.append("svg:title").text("add male"),n=k.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("font-size","1.em").attr("class","popup_selection fa-lg fa-circle persontype").attr("transform","translate(-1000,-100)").attr("x",1.7*j).attr("y",1.5*j).text(" "),o=n.append("svg:title").text("add female"),p=k.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("font-size","1.em").attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-lg fa-unspecified popup_selection_rotate45 persontype").text(" "),q=(p.append("svg:title").text("add unspecified"),k.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-2x fa-angle-up persontype dztwin").attr("x",4.6*j).attr("y",1.5*j).text(" ")),r=(q.append("svg:title").text("add dizygotic/fraternal twins"),k.append("text").attr("font-family","FontAwesome").style("opacity",0).attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-2x fa-caret-up persontype mztwin").attr("x",6.2*j).attr("y",1.5*j).text("")),s=(r.append("svg:title").text("add monozygotic/identical twins"),{});d3.selectAll(".persontype").on("click",function(){var b,c,d=ptree.copy_dataset(a.dataset),e=d3.select(this).classed("mztwin"),f=d3.select(this).classed("dztwin");if(e||f?(c=s.node.datum().data.sex,b=e?"mztwin":"dztwin"):c=d3.select(this).classed("fa-square")?"M":d3.select(this).classed("fa-circle")?"F":"U","addsibling"===s.type)ptree.addsibling(d,s.node.datum().data,c,!1,b);else{if("addchild"!==s.type)return;ptree.addchild(d,s.node.datum().data,b?"U":c,b?2:1,b)}a.dataset=d,ptree.rebuild(a),d3.selectAll(".popup_selection").style("opacity",0),s={}}).on("mouseover",function(){s.node&&s.node.select("rect").style("opacity",.2),d3.selectAll(".popup_selection").style("opacity",1),"addsibling"===s.type?d3.select(this).classed("fa-square")?m.text("add brother"):o.text("add sister"):"addchild"===s.type&&(d3.select(this).classed("fa-square")?m.text("add son"):o.text("add daughter"))}),d3.selectAll(".popup_selection").on("mouseout",function(){s.node!==c&&-1==A.indexOf(s.node.datum())&&s.node.select("rect").style("opacity",0),d3.selectAll(".popup_selection").style("opacity",0)}),d(a),f.append("rect").filter(function(b){return!(b.data.hidden&&!a.DEBUG)}).attr("class","indi_rect").attr("rx",6).attr("ry",6).attr("x",function(b){return-.75*a.symbol_size}).attr("y",function(b){return-a.symbol_size}).attr("width",1.5*a.symbol_size+"px").attr("height",2*a.symbol_size+"px").style("stroke","black").style("stroke-width",.7).style("opacity",0).attr("fill","lightgrey");var t=function(b){return v-.75*a.symbol_size},u=a.symbol_size-2,v=0,w={addchild:{text:"",title:"add child",fx:t,fy:u},addsibling:{text:"",title:"add sibling",fx:t,fy:u},addpartner:{text:"",title:"add partner",fx:t,fy:u},addparents:{text:"",title:"add parents",fx:-.75*a.symbol_size,fy:11-a.symbol_size},delete:{text:"X",title:"delete",fx:a.symbol_size/2-1,fy:12-a.symbol_size,styles:{"font-weight":"bold",fill:"darkred","font-family":"monospace"}}};a.edit&&(w.settings={text:"",title:"settings",fx:-j/2+2,fy:11-a.symbol_size});for(var x in w){var y=f.append("text").filter(function(b){return!(b.data.hidden&&!a.DEBUG||(b.data.mother===c||b.data.noparents)&&"addsibling"===x||b.data.parent_node!==c&&b.data.parent_node.length>1&&"addpartner"===x||b.data.parent_node===c&&"addchild"===x||b.data.noparents===c&&b.data.top_level===c&&"addparents"===x)}).attr("class",x).style("opacity",0).attr("font-family","FontAwesome").attr("xx",function(a){return a.x}).attr("yy",function(a){return a.y}).attr("x",w[x].fx).attr("y",w[x].fy).attr("font-size","0.9em").text(w[x].text);if("styles"in w[x])for(var z in w[x].styles)y.attr(z,w[x].styles[z]);y.append("svg:title").text(w[x].title),v+=17}d3.selectAll(".addsibling, .addchild").on("mouseover",function(){var a=d3.select(this).attr("class");d3.selectAll(".popup_selection").style("opacity",1),s={node:d3.select(this.parentNode),type:a};var b=parseInt(d3.select(this).attr("xx"))+parseInt(d3.select(this).attr("x")),c=parseInt(d3.select(this).attr("yy"))+parseInt(d3.select(this).attr("y"));d3.selectAll(".popup_selection").attr("transform","translate("+b+","+(c+2)+")"),d3.selectAll(".popup_selection_rotate45").attr("transform","translate("+(b+3*j)+","+(c+1.2*j)+") rotate(45)")}),d3.selectAll(".addchild, .addpartner, .addparents, .delete, .settings").on("click",function(){var b=d3.select(this).attr("class"),c=d3.select(this.parentNode).datum();a.DEBUG&&console.log(b);var d;"settings"===b?"function"==typeof a.edit?a.edit(a,c):g(a,c):"delete"===b?(d=ptree.copy_dataset(a.dataset),a.dataset=ptree.delete_node_dataset(d,c.data,a),ptree.rebuild(a)):"addparents"===b?(d=ptree.copy_dataset(a.dataset),a.dataset=d,ptree.addparents(a,d,c.data.name),ptree.rebuild(a)):"addpartner"===b&&(d=ptree.copy_dataset(a.dataset),ptree.addpartner(a,d,c.data.name),a.dataset=d,ptree.rebuild(a))});var A=[];f.filter(function(a){return!a.data.hidden}).on("click",function(b){d3.event.ctrlKey?-1==A.indexOf(b)?A.push(b):A.splice(A.indexOf(b),1):A=[b],"nodeclick"in a&&(a.nodeclick(b.data),d3.selectAll(".indi_rect").style("opacity",0),d3.selectAll(".indi_rect").filter(function(a){return-1!=A.indexOf(a)}).style("opacity",.5))}).on("mouseover",function(b){if(d3.event.stopPropagation(),i=b,h)return void(h.data.name!==i.data.name&&h.data.sex!==i.data.sex&&d3.select(this).select("rect").style("opacity",.2));d3.select(this).select("rect").style("opacity",.2),d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").style("opacity",1),d3.select(this).selectAll(".indi_details").style("opacity",0),e(a.symbol_size-10,0,a.symbol_size-2,0,b.x+","+(b.y+2))}).on("mouseout",function(b){h||(d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").style("opacity",0),-1==A.indexOf(b)&&d3.select(this).select("rect").style("opacity",0),d3.select(this).selectAll(".indi_details").style("opacity",1),d3.mouse(this)[1]<.8*a.symbol_size&&d3.selectAll(".popup_selection").style("opacity",0),h||(Math.abs(d3.mouse(this)[1])>.25*a.symbol_size||Math.abs(d3.mouse(this)[1])<-.25*a.symbol_size||d3.mouse(this)[0]<.2*a.symbol_size)&&e(0,0,0,0))})}}(window.widgets=window.widgets||{},jQuery);
//# sourceMappingURL=pedigreejs.min.js.map