{"version":3,"sources":["../../js/io.js","../../js/pedigree.js","../../js/pedigree_form.js","../../js/undo_redo_refresh.js","../../js/widgets.js"],"names":["utils","$","undefined","isIE","ua","navigator","userAgent","indexOf","isEdge","match","getFormattedDate","time","d","Date","getHours","slice","getMinutes","getSeconds","getFullYear","getMonth","getDate","messages","title","msg","onConfirm","opts","dataset","dialog","modal","width","buttons","Yes","this","No","text","click","validate_age_yob","age","yob","status","year","sum","parseInt","Math","abs","capitaliseFirstLetter","string","charAt","toUpperCase","window","jQuery","io","getByName","arr","name","grep","o","getMatches","str","myRegexp","matches","c","lastIndex","exec","console","error","push","index","unique_urls","svg_html","each","quote","val","m1","m2","newval","ptree","makeid","replace","RegExp","process_ped","ped","j","i","length","getLevel","max_level","level","pedigree_util","getDepth","top_level","noparents","pidx","getPartnerIdx","mother","father","sex","anode","bnode","getIdxByName","idx","update_parents_level","parents","ma","pa","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test","pathology_tests","get_prs_values","prs","hasInput","alpha","parseFloat","zscore","percent","log","isEmpty","id","trim","myObj","key","hasOwnProperty","get_surgical_ops","meta","parent","hasClass","add","change","e","load","save","breast_cancer_prs","ovarian_cancer_prs","err","warn","save_canrisk","print","get_printable_svg","svg_download","deferred","svg2img","when","apply","done","obj","arguments","html","img","open","document","write","a","createElement","href","download","target","body","appendChild","removeChild","svg","deferred_name","options","defaults","iscanvg","resolution","img_type","value","find","d3obj","d3","select","get","append","attr","lower","svgStr","Deferred","XMLSerializer","serializeToString","xml","imgsrc","btoa","unescape","encodeURIComponent","canvas","height","context","getContext","onload","v","canvg","Canvg","fromString","scaleWidth","scaleHeight","ignoreDimensions","start","drawImage","resolve","toDataURL","w","h","src","promise","copy_svg","svg_node","selectAll","remove","filter","local_dataset","pedcache","current","tree_dimensions","get_tree_dimensions","svg_div","targetDiv","clone","appendTo","wid","hgt","scale","xscale","yscale","ytransform","symbol_size","el","constructor","Array","cssFiles","printWindow","headContent","css","close","focus","setTimeout","save_file","content","filename","type","DEBUG","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","JSON","stringify","run_prediction","get_non_anon_pedigree","canrisk_validation","p","hidden","isProband","display_name","f","files","reader","FileReader","result","startsWith","readBoadiceaV4","canrisk_data","readCanRiskV1","risk_factors","parse","readLinkage","validate_pedigree","err1","message","rebuild","trigger","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","onerror","event","code","readAsText","boadicea_lines","famid","lines","split","map","indi","affected","alleles","unshift","hdr","ln","ops","opdata","delim","proband","mztwin","cancer","diagnosis_age","ashkenazi","gene_test","path_test","version","updateParent","nodes","parent_node","dztwins","twins","getTwins","twin","getNodeByName","setChildrenId","children","sort","b","dztwin","contains_parent","m","nodesOverlap","node","diff","root","descendants","descendantsNames","descendant","data","xnew","x","overlap","depth","buildTree","person","partnerLinks","getChildren","flatten","partners","child","merge","ptr","midx","fidx","gp","get_grandparents_idx","setProband","is_proband","getProbandIndex","names","inArray","getSiblings","getAllSiblings","sibs","twin_type","getAdoptedSiblings","getAllChildren","getNodesAtDepth","fnodes","exclude_names","linkNodes","flattenNodes","links","ancestors","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","forEach","flat","adjust_coords","xmid","child1","child2","n","urlParam","results","location","gmidx","gfidx","proband_attr","keys","node_attr","newdataset","copy_dataset","isArray","k","found","syncTwins","proband_add_child","breastfeeding","newchild","addchild","delete_node_by_name","onDone","delete_node_dataset","exists","print_opts","prefixInObj","prefix","include_children","connected","combineArrays","get_partners","child_idx","arr1","arr2","check_ptr_links","ptrLinkNodes","clash","check_ptr_link_clashes","get_svg_dimensions","pbuttons","is_fullscreen","innerWidth","innerHeight","ptrs","group_top_level","top_level_seen","getPx","emVal","font_size","getComputedStyle","fontSize","addLabel","size","fx","fy","ftext","class_label","font_family","font_weight","setMzTwin","d1","d2","getUniqueTwinID","mz","splice","checkTwins","twin_types","count","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","roots","build","zoomFn","t","transform","toString","pos","xtransform","y","setposition","extend","zoomIn","zoomOut","diseases","colour","labels","keep_proband_on_reset","background","node_background","validate","nstore","updateButtons","svg_dimensions","style","xytransform","getposition","zoom","hidden_root","hierarchy","treemap","tree","separation","create_err","enter","miscarriage","termination","symbol","symbolTriangle","symbolCircle","symbolSquare","exclude","ncancers","pie","arc","innerRadius","outerRadius","adopted_in","adopted_out","get_bracket","dx","dy","indent","ilab","label","y_offset","vars","ivar","disease","dis","widgets","addWidgets","clash_depth","insert","divorced","x1","x2","dy1","path","parent_nodes","parent_node_name","ii","dy2","draw_path","cshift","l","dx1","dx2","divorce_path","probandIdx","source","dash_len","dash_array","usedlen","twinx","xmin","xmax","thisx","ymid","xhbar","xx","yy","probandNode","triid","scaleExtent","on","call","Error","uniquenames","famids","join","unconnected","nconnect","has_parent","maxscore","generation","score","max_depth","Object","empty","templates","update","disallowed","nchild","ptr_name","partner","addsibling","twin_id","newchildren","add_lhs","newbie","addparents","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","faidx","moidx","tmpfa","orphans","nid","oid","oidx","ptr_node","addpartner","deletes","d3node","ps","children_names","child_node","adj","del","data_node","newopts","len","possible","floor","random","pedigree_form","update_ashkn","is","update_cancer_by_sex","show","ovarian_cancer_diagnosis_age","closest","hide","prop","prostate_cancer_diagnosis_age","round5","round","reset_n_sync","bc_mutation_frequencies","bcmfreq","gene","toLowerCase","obcmfreq","oc_mutation_frequencies","save_ashkn","updateStatus","removeClass","addClass","nodeclick","approx_diagnosis_age","update_diagnosis_age_widget","valid","switches","iswitch","s","substring","checked","tres","mozFullScreen","webkitFullScreen","mozCancelFullScreen","webkitCancelFullScreen","mozRequestFullScreen","webkitRequestFullScreen","Element","ALLOW_KEYBOARD_INPUT","btn_target","stopPropagation","previous","next","resizable","Continue","reset","Cancel","btns","fa","lis","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","keep_proband","clear_pedigree_data","clear","selected","get_count","has_browser_storage","store_type","mod","localStorage","setItem","removeItem","get_prefix","get_arr","dict_cache","get_browser_store","item","getItem","sessionStorage","set_browser_store","clear_browser_store","set_count","max_limit","store","items","last","it","drag_handle","dragstart","sourceEvent","dragging","last_mouseover","dragstop","setLineDragPosition","drag","ynew","y1","y2","translate","openEditDialog","autoOpen","table","disease_colour","kk","popup_selection","square","square_title","circle","circle_title","unspecified","add_person","classed","datum","highlight","off","delete","styles","font-weight","fill","font-family","edit","settings","widget","parentNode","opt","ctrlKey","mouse"],"mappings":"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","file":"pedigreejs.min.js","sourcesContent":["\n// pedigree utils\n(function(utils, $, undefined) {\n\n\tutils.isIE = function() {\n\t\t var ua = navigator.userAgent;\n\t\t /* MSIE used to detect old browsers and Trident used to newer ones*/\n\t\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\n\t}\n\n\tutils.isEdge = function() {\n\t\t return navigator.userAgent.match(/Edge/g);\n\t}\n\n\t/**\n\t *  Get formatted time or data & time\n\t */\n\tutils.getFormattedDate = function(time){\n\t    var d = new Date();\n\t    if(time)\n\t    \treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n\t    else\n\t    \treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n\t }\n\n\t/**\n\t * Show message or confirmation dialog.\n\t * @param title     - dialog window title\n\t * @param msg       - message to diasplay\n\t * @param onConfirm - function to call in a confirmation dialog\n\t * @param opts      - pedigreejs options\n\t * @param dataset    - pedigree dataset\n\t */\n\tutils.messages = function(title, msg, onConfirm, opts, dataset) {\n\t\tif(onConfirm) {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t        modal: true,\n\t\t\t        title: title,\n\t\t\t        width: 350,\n\t\t\t        buttons: {\n\t\t\t        \t\"Yes\": function () {\n\t\t\t                $(this).dialog('close');\n\t\t\t                onConfirm(opts, dataset);\n\t\t\t            },\n\t\t\t            \"No\": function () {\n\t\t\t                $(this).dialog('close');\n\t\t\t            }\n\t\t\t        }\n\t\t\t    });\n\t\t} else {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t    \t\ttitle: title,\n\t    \t\twidth: 350,\n\t    \t\tbuttons: [{\n\t    \t\t\ttext: \"OK\",\n\t    \t\t\tclick: function() { $( this ).dialog( \"close\" );}\n\t    \t\t}]\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Validate age and yob is consistent with current year. The sum of age and\n\t * yob should not be greater than or equal to current year. If alive the\n\t * absolute difference between the sum of age and year of birth and the\n\t * current year should be <= 1.\n\t * @param age    - age in years.\n\t * @param yob    - year of birth.\n\t * @param status - 0 = alive, 1 = dead.\n\t * @return true if age and yob are consistent with current year otherwise false.\n\t */\n\tutils.validate_age_yob = function(age, yob, status) {\n\t\tvar year = new Date().getFullYear();\n\t\tvar sum = parseInt(age) + parseInt(yob);\n\t\tif(status == 1) {   // deceased\n\t\t\treturn year >= sum;\n\t\t}\n\t\treturn Math.abs(year - sum) <= 1 && year >= sum;\n\t}\n\n\tutils.capitaliseFirstLetter = function(string) {\n\t    return string.charAt(0).toUpperCase() + string.slice(1);\n\t}\n}(window.utils = window.utils || {}, jQuery));\n\n\n// pedigree I/O\n(function(io, $, undefined) {\n\n\t// cancers, genetic & pathology tests\n\tio.cancers = {\n\t\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\n\t\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\n\t\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\n\t\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\n\t\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\n\t\t};\n\tio.genetic_test = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d',\t'rad51c', 'brip1'];\n\tio.pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\n\n\t// get breast and ovarian PRS values\n\tio.get_prs_values = function() {\n\t\tvar prs = {};\n\t\tif(io.hasInput(\"breast_prs_a\") && io.hasInput(\"breast_prs_z\")) {\n\t\t\tprs['breast_cancer_prs'] = {\n\t\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\n\t\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\n\t\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\n\t\t\t};\n\t\t}\n\t\tif(io.hasInput(\"ovarian_prs_a\") && io.hasInput(\"ovarian_prs_z\")) {\n\t\t\tprs['ovarian_cancer_prs'] = {\n\t\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\n\t\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\n\t\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\n\t\t\t};\n\t\t}\n\t\tconsole.log(prs);\n\t\treturn (isEmpty(prs) ? 0 : prs);\n\t}\n\n\t// check if input has a value\n\tio.hasInput = function(id) {\n\t\treturn $.trim($('#'+id).val()).length !== 0;\n\t}\n\n\t// return true if the object is empty\n\tvar isEmpty = function(myObj) {\n\t    for(var key in myObj) {\n\t        if (myObj.hasOwnProperty(key)) {\n\t            return false;\n\t        }\n\t    }\n\t    return true;\n\t}\n\n\tio.get_surgical_ops = function() {\n\t\tvar meta = \"\";\n\t\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\n\t\t\tmeta += \";OVARY2=y\";\n\t\t}\n\t\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\n\t\t\tmeta += \";MAST2=y\";\n\t\t}\n\t\treturn meta;\n\t};\n\n\tio.add = function(opts) {\n\t\t$('#load').change(function(e) {\n\t\t\tio.load(e, opts);\n\t\t});\n\n\t\t$('#save').click(function(e) {\n\t\t\tio.save(opts);\n\t\t});\n\n\t\t$('#save_canrisk').click(function(e) {\n\t\t\tvar meta = io.get_surgical_ops();\n\t\t\ttry {\n\t\t\t\tvar prs = io.get_prs_values();\n\t\t    \tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\n\t\t    \t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\n\t\t    \t}\n\t\t    \tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\n\t\t    \t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\n\t\t    \t}\n\t\t\t} catch(err) { console.warn(\"PRS\", prs); }\n\t\t\tio.save_canrisk(opts, meta);\n\t\t});\n\n\t\t$('#print').click(function(e) {\n\t\t\tio.print(io.get_printable_svg(opts));\n\t\t});\n\n\t\t$('#svg_download').click(function(e) {\n\t\t\tio.svg_download(io.get_printable_svg(opts));\n\t\t});\n\n\t\t$('#png_download').click(function(e) {\n\t\t\tvar deferred = io.svg2img($('svg'), \"pedigree\");\n\t\t    $.when.apply($,[deferred]).done(function() {\n\t\t    \tvar obj = getByName(arguments, \"pedigree\");\n\t\t        if(utils.isEdge() || utils.isIE()) {\n\t\t        \tvar html=\"<img src='\"+obj.img+\"' alt='canvas image'/>\";\n\t\t\t        var newTab = window.open();\n\t\t\t        newTab.document.write(html);\n\t\t        } else {\n\t\t\t\t\tvar a      = document.createElement('a');\n\t\t\t\t\ta.href     = obj.img;\n\t\t\t\t\ta.download = 'plot.png';\n\t\t\t\t\ta.target   = '_blank';\n\t\t\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t\t        }\n\t\t    });\n\t\t});\n\t};\n\n\t/**\n\t * Get object from array by the name attribute.\n\t */\n\tfunction getByName(arr, name) {\n\t\treturn $.grep(arr, function(o){ return o && o.name == name; })[0];\n\t}\n\n\t/**\n\t * Given a SVG document element convert to image (e.g. jpeg, png - default png).\n\t */\n    io.svg2img = function(svg, deferred_name, options) {\n    \tvar defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\n    \tif(!options) options = defaults;\n    \t$.each(defaults, function(key, value) {\n    \t\tif(!(key in options)) {options[key] = value;}\n    \t});\n\n    \t// set SVG background to white - fix for jpeg creation\n    \tif (svg.find(\".pdf-white-bg\").length === 0){\n\t    \tvar d3obj = d3.select(svg.get(0));\n\t    \td3obj.append(\"rect\")\n\t\t        .attr(\"width\", \"100%\")\n\t\t        .attr(\"height\", \"100%\")\n\t\t        .attr(\"class\", \"pdf-white-bg\")\n\t\t        .attr(\"fill\", \"white\");\n\t        d3obj.select(\".pdf-white-bg\").lower();\n    \t}\n\n    \tvar deferred = $.Deferred();\n    \tvar svgStr;\n\t    if (typeof window.XMLSerializer != \"undefined\") {\n\t    \tsvgStr = (new XMLSerializer()).serializeToString(svg.get(0));\n\t    } else if (typeof svg.xml != \"undefined\") {\n\t    \tsvgStr = svg.get(0).xml;\n\t    }\n\n\t    var imgsrc = 'data:image/svg+xml;base64,'+ btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\n    \tvar canvas = document.createElement(\"canvas\");\n\t    canvas.width = svg.width()*options.resolution;\n\t    canvas.height = svg.height()*options.resolution;\n    \tvar context = canvas.getContext(\"2d\");\n\t    var img = document.createElement(\"img\");\n\t    img.onload = function() {\n\t        if(utils.isIE() || options.iscanvg) {\n\t        \t// change font so it isn't tiny\n\t        \tsvgStr = svgStr.replace(/ font-size=\"\\d?.\\d*em\"/g, '');\n\t        \tsvgStr = svgStr.replace(/<text /g, '<text font-size=\"12px\" ');\n\t        \tv = canvg.Canvg.fromString(context, svgStr, {\n\t    \t\t\t  scaleWidth: canvas.width,\n\t    \t\t\t  scaleHeight: canvas.height,\n\t    \t\t\t  ignoreDimensions: true\n\t        \t});\n\t        \tv.start();\n\t        \tconsole.log(deferred_name, options.img_type, \"use canvg to create image\");\n\t        } else {\n    \t\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\n    \t\t\tconsole.log(deferred_name, options.img_type);\n    \t\t}\n\t        deferred.resolve({'name': deferred_name, 'resolution': options.resolution, 'img':canvas.toDataURL(options.img_type, 1), 'w':canvas.width, 'h':canvas.height});\n    \t};\n    \timg.src = imgsrc;\n    \treturn deferred.promise();\n    }\n\n    function getMatches(str, myRegexp) {\n\t    var matches = [];\n\t    var match;\n\t    var c = 0;\n\t    myRegexp.lastIndex = 0;\n\t    while (match = myRegexp.exec(str)) {\n\t    \tc++;\n\t    \tif(c > 400) {\n\t    \t\tconsole.error(\"getMatches: counter exceeded 800\");\n\t    \t\treturn -1;\n\t    \t}\n\t        matches.push(match);\n\t        if (myRegexp.lastIndex === match.index) {\n\t        \tmyRegexp.lastIndex++;\n\t        }\n\t    }\n\t    return matches;\n    }\n\n    // find all url's to make unique\n    function unique_urls(svg_html) {\n\t    var matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}\\#(.*?)(&quot;|\"|'){0,1}\\)/g);\n\t    if(matches === -1)\n\t    \treturn \"ERROR DISPLAYING PEDIGREE\"\n\n\t    $.each(matches, function(index, match) {\n    \t\tvar quote = (match[1] ? match[1] : \"\");\n    \t\tvar val = match[2];\n    \t\tvar m1 = \"id=\\\"\" + val + \"\\\"\";\n    \t\tvar m2 = \"url\\\\(\" + quote + \"\\#\" + val + quote + \"\\\\)\";\n\n    \t\tvar newval = val+ptree.makeid(2);\n    \t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\"+newval+\"\\\"\" );\n    \t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\"+newval+\")\" );\n\t   });\n\t\treturn svg_html;\n    }\n\n\t// return a copy pedigree svg\n\tio.copy_svg = function(opts) {\n\t\tvar svg_node = io.get_printable_svg(opts);\n\t\tvar d3obj = d3.select(svg_node.get(0));\n\n\t\t// remove unused elements\n\t\td3obj.selectAll(\".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection\").remove();\n\t\td3obj.selectAll(\"text\")\n\t\t  .filter(function(){\n\t\t\t return d3.select(this).text().length === 0\n\t\t  }).remove();\n\t\treturn $(unique_urls(svg_node.html()));\n\t}\n\n\t// get printable svg div, adjust size to tree dimensions and scale to fit\n\tio.get_printable_svg = function(opts) {\n\t\tvar local_dataset = pedcache.current(opts); // get current dataset\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\t\topts.dataset = local_dataset;\n\t\t}\n\n\t\tvar tree_dimensions = ptree.get_tree_dimensions(opts);\n\t\tvar svg_div = $('<div></div>');  \t\t\t\t// create a new div\n\t\tvar svg = $('#'+opts.targetDiv).find('svg').clone().appendTo(svg_div);\n\t\tif(opts.width < tree_dimensions.width || opts.height < tree_dimensions.height ||\n\t\t   tree_dimensions.width > 595 || tree_dimensions.height > 842) {\n\t\t\tvar wid = tree_dimensions.width;\n\t\t    var hgt = tree_dimensions.height + 100;\n\t\t    var scale = 1.0;\n\n\t\t    if(tree_dimensions.width > 595 || tree_dimensions.height > 842) {   // scale to fit A4\n\t\t    \tif(tree_dimensions.width > 595)  wid = 595;\n\t\t    \tif(tree_dimensions.height > 842) hgt = 842;\n\t\t    \tvar xscale = wid/tree_dimensions.width;\n\t\t    \tvar yscale = hgt/tree_dimensions.height;\n\t\t    \tscale = (xscale < yscale ? xscale : yscale);\n\t\t    }\n\n\t\t    svg.attr('width', wid);\t\t// adjust dimensions\n\t\t    svg.attr('height', hgt);\n\n\t\t    var ytransform = (-opts.symbol_size*1.5*scale);\n\t\t    svg.find(\".diagram\").attr(\"transform\", \"translate(0, \"+ytransform+\") scale(\"+scale+\")\");\n\t\t}\n\t\treturn svg_div;\n\t};\n\n\t// download the SVG to a file\n\tio.svg_download = function(svg){\n\t\tvar a      = document.createElement('a');\n\t\ta.href     = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svg.html() ) ) );\n\t\ta.download = 'plot.svg';\n\t\ta.target   = '_blank';\n\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t};\n\n\t// open print window for a given element\n\tio.print = function(el, id){\n        if(el.constructor !== Array)\n        \tel = [el];\n\n        var width = $(window).width()*0.9;\n        var height = $(window).height()-10;\n        var cssFiles = [\n        \t'/static/css/canrisk.css',\n        \t'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css'\n        ];\n        var printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\n        var headContent = '';\n        for(var i=0; i<cssFiles.length; i++)\n        \theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\n        headContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\n\n            /*var headContent2 = '';\n            var links = document.getElementsByTagName('link');\n            for(var i=0;i<links.length; i++) {\n            \tvar html = links[i].outerHTML;\n            \tif(html.indexOf('href=\"http') !== -1)\n            \t\theadContent2 += html;\n            }\n            headContent2 += html;\n            var scripts = document.getElementsByTagName('script');\n            for(var i=0;i<scripts.length; i++) {\n            \tvar html = scripts[i].outerHTML;\n            \tif(html.indexOf('src=\"http') !== -1)\n            \t\theadContent += html;\n            }*/\n\n        html = \"\";\n        for(i=0; i<el.length; i++) {\n        \tif(i === 0 && id)\n        \t\thtml += id;\n        \thtml += $(el[i]).html();\n        \tif(i < el.length-1)\n        \t\thtml += '<div class=\"page-break\"> </div>';\n        }\n\n        printWindow.document.write(headContent);\n        printWindow.document.write(html);\n        printWindow.document.close();\n\n        printWindow.focus();\n        setTimeout(function() {\n        \tprintWindow.print();\n        \tprintWindow.close();\n        }, 300);\n\t};\n\n\t// save content to a file\n\tio.save_file = function(opts, content, filename, type){\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log(content);\n\t\tif(!filename) filename = \"ped.txt\";\n\t\tif(!type) type = \"text/plain\";\n\n\t   var file = new Blob([content], {type: type});\n\t   if (window.navigator.msSaveOrOpenBlob) \t// IE10+\n\t\t   window.navigator.msSaveOrOpenBlob(file, filename);\n\t   else { \t\t\t\t\t\t\t\t\t// other browsers\n\t\t   var a = document.createElement(\"a\");\n\t\t   var url = URL.createObjectURL(file);\n\t\t   a.href = url;\n\t\t   a.download = filename;\n\t\t   document.body.appendChild(a);\n\t\t   a.click();\n\t\t   setTimeout(function() {\n\t\t\t   document.body.removeChild(a);\n\t\t\t   window.URL.revokeObjectURL(url);\n\t\t\t}, 0);\n\t\t}\n\t}\n\n\tio.save = function(opts){\n\t\tvar content = JSON.stringify(pedcache.current(opts));\n\t\tio.save_file(opts, content);\n\t};\n\n\tio.save_canrisk = function(opts, meta){\n\t\tio.save_file(opts, run_prediction.get_non_anon_pedigree(pedcache.current(opts), meta), \"canrisk.txt\");\n\t};\n\n\tio.canrisk_validation = function(opts) {\n\t\t$.each(opts.dataset, function(idx, p) {\n\t\t\tif(!p.hidden && p.sex === 'M' && !pedigree_util.isProband(p)) {\n\t\t\t\tif(p[io.cancers['breast_cancer2']]) {\n\t\t\t\t\tvar msg = 'Male family member ('+p.display_name+') with contralateral breast cancer found. '+\n\t\t\t\t\t          'Please note that as the risk models do not take this into account the second '+\n\t\t\t\t\t          'breast cancer is ignored.'\n\t\t\t\t\tconsole.error(msg);\n\t\t\t\t\tdelete p[io.cancers['breast_cancer2']];\n\t\t\t\t\tutils.messages(\"Warning\", msg);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tio.load = function(e, opts) {\n\t    var f = e.target.files[0];\n\t\tif(f) {\n\t\t\tvar reader = new FileReader();\n\t\t\treader.onload = function(e) {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\tconsole.log(e.target.result);\n\t\t\t\ttry {\n\t\t\t\t\tif(e.target.result.startsWith(\"BOADICEA import pedigree file format 4.0\")) {\n\t\t\t\t\t\topts.dataset = io.readBoadiceaV4(e.target.result, 4);\n\t\t\t\t\t\tio.canrisk_validation(opts);\n\t\t\t\t\t} else if(e.target.result.startsWith(\"BOADICEA import pedigree file format 2.0\")) {\n\t\t\t\t\t\topts.dataset = io.readBoadiceaV4(e.target.result, 2);\n\t\t\t\t\t\tio.canrisk_validation(opts);\n\t\t\t\t\t} else if(e.target.result.startsWith(\"##\") && e.target.result.indexOf(\"CanRisk\") !== -1) {\n\t\t\t\t\t\tvar canrisk_data = io.readCanRiskV1(e.target.result);\n\t\t\t\t\t\tvar risk_factors = canrisk_data[0];\n\t\t\t\t\t\topts.dataset = canrisk_data[1];\n\t\t\t\t\t\tio.canrisk_validation(opts);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\topts.dataset = JSON.parse(e.target.result);\n\t\t\t\t\t\t} catch(err) {\n\t\t\t\t\t\t\topts.dataset = io.readLinkage(e.target.result);\n\t\t\t\t\t    }\n\t\t\t\t\t}\n\t\t\t\t\tptree.validate_pedigree(opts);\n\t\t\t\t} catch(err1) {\n\t\t\t\t\tconsole.error(err1, e.target.result);\n\t\t\t\t\tutils.messages(\"File Error\", ( err1.message ? err1.message : err1));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconsole.log(opts.dataset);\n\t\t\t\ttry{\n\t\t\t\t\tptree.rebuild(opts);\n\t\t\t\t\tif(risk_factors !== undefined) {\n\t\t\t\t\t\tconsole.log(risk_factors);\n\t\t\t\t\t\t// load risk factors - fire riskfactorChange event\n\t\t\t\t\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\n\t\t\t\t\t}\n\t\t\t\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// update FH section\n\t\t\t\t\t\tacc_FamHist_ticked();\n\t\t\t\t\t\tacc_FamHist_Leave();\n\t\t\t\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\n\t\t\t\t\t} catch(err3) {}\n\t\t\t\t} catch(err2) {\n\t\t\t\t\tutils.messages(\"File Error\", ( err2.message ? err2.message : err2));\n\t\t\t\t}\n\t\t\t};\n\t\t\treader.onerror = function(event) {\n\t\t\t    utils.messages(\"File Error\", \"File could not be read! Code \" + event.target.error.code);\n\t\t\t};\n\t\t\treader.readAsText(f);\n\t\t} else {\n\t\t\tconsole.error(\"File could not be read!\");\n\t\t}\n\t\t$(\"#load\")[0].value = ''; // reset value\n\t};\n\n\t//\n\t// https://www.cog-genomics.org/plink/1.9/formats#ped\n\t// https://www.cog-genomics.org/plink/1.9/formats#fam\n\t//\t1. Family ID ('FID')\n\t//\t2. Within-family ID ('IID'; cannot be '0')\n\t//\t3. Within-family ID of father ('0' if father isn't in dataset)\n\t//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\n\t//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\n\t//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\n\t//  7. Genotypes (column 7 onwards);\n\t//     columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\n\tio.readLinkage = function(boadicea_lines) {\n\t\tvar lines = boadicea_lines.trim().split('\\n');\n\t\tvar ped = [];\n\t\tvar famid;\n\t\tfor(var i = 0;i < lines.length;i++){\n\t\t   var attr = $.map(lines[i].trim().split(/\\s+/), function(val, i){return val.trim();});\n\t\t   if(attr.length < 5)\n\t\t\t   throw('unknown format');\n\t\t   var sex = (attr[4] == '1' ? 'M' : (attr[4] == '2' ? 'F' : 'U'));\n\t\t   var indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[1],\n\t\t\t\t'sex': sex\n\t\t\t};\n\t\t\tif(attr[2] !== \"0\") indi.father = attr[2];\n\t\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\n\n\t\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\n\t\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(attr[5] == \"2\") indi.affected = 2;\n\t\t\t// add genotype columns\n\t\t\tif(attr.length > 6) {\n\t\t\t\tindi.alleles = \"\";\n\t\t\t\tfor(var j=6; j<attr.length; j+=2) {\n\t\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tped.unshift(indi);\n\t\t\tfamid = attr[0];\n\t\t}\n\t\treturn process_ped(ped);\n\t};\n\n\tio.readCanRiskV1 = function(boadicea_lines) {\n\t\tvar lines = boadicea_lines.trim().split('\\n');\n\t\tvar ped = [];\n\t\tvar hdr = [];  // collect risk factor header lines\n\t\t// assumes two line header\n\t\tfor(var i = 0;i < lines.length;i++){\n\t\t\tvar ln = lines[i].trim();\n\t\t    if(ln.startsWith(\"##\")) {\n\t\t    \tif(ln.startsWith(\"##CanRisk\") && ln.indexOf(\";\") > -1) {   // contains surgical op data\n\t\t    \t\tvar ops = ln.split(\";\");\n\t\t    \t\tfor(var j=1; j<ops.length; j++) {\n\t\t    \t\t\tvar opdata = ops[j].split(\"=\");\n\t\t    \t\t\tif(opdata.length === 2) {\n\t\t    \t\t\t\thdr.push(ops[j]);\n\t\t    \t\t\t}\n\t\t    \t\t}\n\t\t    \t}\n\t\t    \tif(ln.indexOf(\"CanRisk\") === -1 && !ln.startsWith(\"##FamID\")) {\n\t\t    \t\thdr.push(ln.replace(\"##\", \"\"));\n\t\t    \t}\n\t\t    \tcontinue;\n\t\t    }\n\n\t\t    var delim = /\\t/;\n\t\t    if(ln.indexOf('\\t') < 0) {\n\t\t    \tdelim = /\\s+/;\n\t\t    \tconsole.log(\"NOT TAB DELIM\");\n\t\t    }\n\t\t    var attr = $.map(ln.split(delim), function(val, i){return val.trim();});\n\n\t\t\tif(attr.length > 1) {\n\t\t\t\tvar indi = {\n\t\t\t\t\t'famid': attr[0],\n\t\t\t\t\t'display_name': attr[1],\n\t\t\t\t\t'name':\tattr[3],\n\t\t\t\t\t'sex': attr[6],\n\t\t\t\t\t'status': attr[8]\n\t\t\t\t};\n\t\t\t\tif(attr[2] == 1) indi.proband = true;\n\t\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\t\tvar idx = 11;\n\t\t\t\t$.each(io.cancers, function(cancer, diagnosis_age) {\n\t\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t\t}\n\t\t\t\t\tidx++;\n\t\t\t\t});\n\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\n\t\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\t\tfor(var j=0; j<io.genetic_test.length; j++) {\n\t\t\t\t\tvar gene_test = attr[idx].split(\":\");\n\t\t\t\t\tif(gene_test[0] !== '0') {\n\t\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N'))\n\t\t\t\t\t\t\tindi[io.genetic_test[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\n\t\t\t\t\t}\n\t\t\t\t\tidx++;\n\t\t\t\t}\n\t\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\t\tvar path_test = attr[idx].split(\":\");\n\t\t\t\tfor(j=0; j<path_test.length; j++) {\n\t\t\t\t\tif(path_test[j] !== '0') {\n\t\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\n\t\t\t\t\t\t\tindi[io.pathology_tests[j] + '_bc_pathology'] = path_test[j];\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +io.pathology_tests[j] + \" \" +path_test[j]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tped.unshift(indi);\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\treturn [hdr, process_ped(ped)];\n\t\t} catch(e) {\n\t\t\tconsole.error(e);\n\t\t\treturn [hdr, ped];\n\t\t}\n\t};\n\n\t// read boadicea format v4 & v2\n\tio.readBoadiceaV4 = function(boadicea_lines, version) {\n\t\tvar lines = boadicea_lines.trim().split('\\n');\n\t\tvar ped = [];\n\t\t// assumes two line header\n\t\tfor(var i = 2;i < lines.length;i++){\n\t\t   var attr = $.map(lines[i].trim().split(/\\s+/), function(val, i){return val.trim();});\n\t\t\tif(attr.length > 1) {\n\t\t\t\tvar indi = {\n\t\t\t\t\t'famid': attr[0],\n\t\t\t\t\t'display_name': attr[1],\n\t\t\t\t\t'name':\tattr[3],\n\t\t\t\t\t'sex': attr[6],\n\t\t\t\t\t'status': attr[8]\n\t\t\t\t};\n\t\t\t\tif(attr[2] == 1) indi.proband = true;\n\t\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\t\tvar idx = 11;\n\t\t\t\t$.each(io.cancers, function(cancer, diagnosis_age) {\n\t\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t\t}\n\t\t\t\t\tidx++;\n\t\t\t\t});\n\n\t\t\t\tif(version === 4) {\n\t\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\n\t\t\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\t\t\tfor(var j=0; j<5; j++) {\n\t\t\t\t\t\tidx+=2;\n\t\t\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\n\t\t\t\t\t\t\t\tindi[io.genetic_test[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else if (version === 2) {\n\t\t\t\t\t// genetic test BRCA1, BRCA2\n\t\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\n\t\t\t\t\tidx+=2; \t// gtest\n\t\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T')) {\n\t\t\t\t\t\t\tif(attr[idx-1] === 'N') {\n\t\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\t} else if(attr[idx-1] === '1') {\n\t\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\t} else if(attr[idx-1] === '2') {\n\t\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\t} else if(attr[idx-1] === '3') {\n\t\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t}\n\n\t\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\t\tfor(j=0; j<io.pathology_tests.length; j++) {\n\t\t\t\t\tif(attr[idx] !== '0') {\n\t\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\n\t\t\t\t\t\t\tindi[io.pathology_tests[j] + '_bc_pathology'] = attr[idx];\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +io.pathology_tests[j] + \" \" +attr[idx]);\n\t\t\t\t\t}\n\t\t\t\t\tidx++;\n\t\t\t\t}\n\t\t\t\tped.unshift(indi);\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\treturn process_ped(ped);\n\t\t} catch(e) {\n\t\t\tconsole.error(e);\n\t\t\treturn ped;\n\t\t}\n\t};\n\n\tfunction process_ped(ped) {\n\t\t// find the level of individuals in the pedigree\n\t\tfor(var j=0;j<2;j++) {\n\t\t\tfor(var i=0;i<ped.length;i++) {\n\t\t\t\tgetLevel(ped, ped[i].name);\n\t\t\t}\n\t\t}\n\n\t\t// find the max level (i.e. top_level)\n\t\tvar max_level = 0;\n\t\tfor(i=0;i<ped.length;i++) {\n\t\t\tif(ped[i].level && ped[i].level > max_level)\n\t\t\t\tmax_level = ped[i].level;\n\t\t}\n\n\t\t// identify top_level and other nodes without parents\n\t\tfor(i=0;i<ped.length;i++) {\n\t\t\tif(pedigree_util.getDepth(ped, ped[i].name) == 1) {\n\t\t\t\tif(ped[i].level && ped[i].level == max_level) {\n\t\t\t\t\tped[i].top_level = true;\n\t\t\t\t} else {\n\t\t\t\t\tped[i].noparents = true;\n\n\t\t\t\t\t// 1. look for partners parents\n\t\t\t\t\tvar pidx = getPartnerIdx(ped, ped[i]);\n\t\t\t\t\tif(pidx > -1) {\n\t\t\t\t\t\tif(ped[pidx].mother) {\n\t\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\n\t\t\t\t\t\t\tped[i].father = ped[pidx].father;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// 2. or adopt parents from level above\n\t\t\t\t\tif(!ped[i].mother){\n\t\t\t\t\t\tfor(var j=0; j<ped.length; j++) {\n\t\t\t\t\t\t\tif(ped[i].level == (ped[j].level-1)) {\n\t\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\n\t\t\t\t\t\t\t\tif(pidx > -1) {\n\t\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdelete ped[i].top_level;\n\t\t\t}\n\t\t}\n\t\treturn ped;\n\t}\n\n\t// get the partners for a given node\n\tfunction getPartnerIdx(dataset, anode) {\n\t\tvar ptrs = [];\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tvar bnode = dataset[i];\n\t\t\tif(anode.name === bnode.mother)\n\t\t\t\treturn pedigree_util.getIdxByName(dataset, bnode.father);\n\t\t\telse if(anode.name === bnode.father)\n\t\t\t\treturn pedigree_util.getIdxByName(dataset, bnode.mother);\n\t\t}\n\t\treturn -1;\n\t}\n\n\t// for a given individual assign levels to a parents ancestors\n\tfunction getLevel(dataset, name) {\n\t\tvar idx = pedigree_util.getIdxByName(dataset, name);\n\t\tvar level = (dataset[idx].level ? dataset[idx].level : 0);\n\t\tupdate_parents_level(idx, level, dataset);\n\t}\n\n\t// recursively update parents levels\n\tfunction update_parents_level(idx, level, dataset) {\n\t\tvar parents = ['mother', 'father'];\n\t\tlevel++;\n\t\tfor(var i=0; i<parents.length; i++) {\n\t\t\tvar pidx = pedigree_util.getIdxByName(dataset, dataset[idx][parents[i]]);\n\t\t\tif(pidx >= 0) {\n\t\t\t\tvar ma = dataset[pedigree_util.getIdxByName(dataset, dataset[idx].mother)];\n\t\t\t\tvar pa = dataset[pedigree_util.getIdxByName(dataset, dataset[idx].father)];\n\t\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\n\t\t\t\t\tma.level = level;\n\t\t\t\t\tpa.level = level;\n\t\t\t\t}\n\n\t\t\t\tif(ma.level < pa.level) {\n\t\t\t\t\tma.level = pa.level;\n\t\t\t\t} else if(pa.level < ma.level) {\n\t\t\t\t\tpa.level = ma.level;\n\t\t\t\t}\n\t\t\t\tupdate_parents_level(pidx, level, dataset);\n\t\t\t}\n\t\t}\n\t}\n\n}(window.io = window.io || {}, jQuery));\n","// Pedigree Tree Utils\n(function(pedigree_util, $, undefined) {\n\n\tpedigree_util.buildTree = function(opts, person, root, partnerLinks, id) {\n\t\tif (typeof person.children === typeof undefined)\n\t\t\tperson.children = pedigree_util.getChildren(opts.dataset, person);\n\n\t\tif (typeof partnerLinks === typeof undefined) {\n\t\t\tpartnerLinks = [];\n\t\t\tid = 1;\n\t\t}\n\n\t\tvar nodes = pedigree_util.flatten(root);\n\t\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\n\t\tvar partners = [];\n\t\t$.each(person.children, function(i, child) {\n\t\t\t$.each(opts.dataset, function(j, p) {\n\t\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\n\t\t\t\t\tvar m = pedigree_util.getNodeByName(nodes, p.mother);\n\t\t\t\t\tvar f = pedigree_util.getNodeByName(nodes, p.father);\n\t\t\t\t\tm = (m !== undefined? m : pedigree_util.getNodeByName(opts.dataset, p.mother));\n\t\t\t\t\tf = (f !== undefined? f : pedigree_util.getNodeByName(opts.dataset, p.father));\n\t\t\t\t\tif(!contains_parent(partners, m, f))\n\t\t\t\t\t\tpartners.push({'mother': m, 'father': f});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\t$.merge(partnerLinks, partners);\n\n\t\t$.each(partners, function(i, ptr) {\n\t\t\tvar mother = ptr.mother;\n\t\t\tvar father = ptr.father;\n\t\t\tmother.children = [];\n\t\t\tvar parent = {\n\t\t\t\t\tname : ptree.makeid(4),\n\t\t\t\t\thidden : true,\n\t\t\t\t\tparent : null,\n\t\t\t\t\tfather : father,\n\t\t\t\t\tmother : mother,\n\t\t\t\t\tchildren : pedigree_util.getChildren(opts.dataset, mother, father)\n\t\t\t};\n\n\t\t\tvar midx = pedigree_util.getIdxByName(opts.dataset, mother.name);\n\t\t\tvar fidx = pedigree_util.getIdxByName(opts.dataset, father.name);\n\t\t\tif(!('id' in father) && !('id' in mother))\n\t\t\t\tid = setChildrenId(person.children, id);\n\n\t\t\t// look at grandparents index\n\t\t\tvar gp = pedigree_util.get_grandparents_idx(opts.dataset, midx, fidx);\n\t\t\tif(gp.fidx < gp.midx) {\n\t\t\t\tfather.id = id++;\n\t\t\t\tparent.id = id++;\n\t\t\t\tmother.id = id++;\n\t\t\t} else {\n\t\t\t\tmother.id = id++;\n\t\t\t\tparent.id = id++;\n\t\t\t\tfather.id = id++;\n\t\t\t}\n\t\t\tid = updateParent(mother, parent, id, nodes, opts);\n\t\t\tid = updateParent(father, parent, id, nodes, opts);\n\t\t\tperson.children.push(parent);\n\t\t});\n\t\tid = setChildrenId(person.children, id);\n\n\t\t$.each(person.children, function(i, p) {\n\t\t\tid = pedigree_util.buildTree(opts, p, root, partnerLinks, id)[1];\n\t\t});\n\t\treturn [partnerLinks, id];\n\t};\n\n\t// update parent node and sort twins\n\tfunction updateParent(p, parent, id, nodes, opts) {\n\t\t// add to parent node\n\t\tif('parent_node' in p)\n\t\t\tp.parent_node.push(parent);\n\t\telse\n\t\t\tp.parent_node = [parent];\n\n\t\t// check twins lie next to each other\n\t\tif(p.mztwin || p.dztwins) {\n\t\t\tvar twins = pedigree_util.getTwins(opts.dataset, p);\n\t\t\tfor(var i=0; i<twins.length; i++) {\n\t\t\t\tvar twin = pedigree_util.getNodeByName(nodes, twins[i].name);\n\t\t\t\tif(twin)\n\t\t\t\t\ttwin.id = id++;\n\t\t\t}\n\t\t}\n\t\treturn id;\n\t}\n\n\tfunction setChildrenId(children, id) {\n\t\t// sort twins to lie next to each other\n\t\tchildren.sort(function(a, b) {\n\t\t\tif(a.mztwin && b.mztwin && a.mztwin == b.mztwin)\n\t\t\t\treturn 0;\n\t\t\telse if(a.dztwin && b.dztwin && a.dztwin == b.dztwin)\n\t\t\t\treturn 0;\n\t\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\n\t\t\t\treturn 1;\n\t\t\treturn 0;\n\t\t});\n\n\t\t$.each(children, function(i, p) {\n\t\t\tif(p.id === undefined) p.id = id++;\n\t\t});\n\t\treturn id;\n\t}\n\n\tpedigree_util.isProband = function(obj) {\n\t\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n\t};\n\n\tpedigree_util.setProband = function(dataset, name, is_proband) {\n\t\t$.each(dataset, function(i, p) {\n\t\t\tif (name === p.name)\n\t\t\t\tp.proband = is_proband;\n\t\t\telse\n\t\t\t\tdelete p.proband;\n\t\t});\n\t};\n\n\tpedigree_util.getProbandIndex = function(dataset) {\n\t\tvar proband;\n\t\t$.each(dataset, function(i, val) {\n\t\t\tif (pedigree_util.isProband(val)) {\n\t\t\t\tproband = i;\n\t\t\t\treturn proband;\n\t\t\t}\n\t\t});\n\t\treturn proband;\n\t};\n\n\tpedigree_util.getChildren = function(dataset, mother, father) {\n\t\tvar children = [];\n\t\tvar names = [];\n\t\tif(mother.sex === 'F')\n\t\t\t$.each(dataset, function(i, p) {\n\t\t\t\tif(mother.name === p.mother)\n\t\t\t\t\tif(!father || father.name == p.father) {\n\t\t\t\t\t\tif($.inArray(p.name, names) === -1){\n\t\t\t\t\t\t\tchildren.push(p);\n\t\t\t\t\t\t\tnames.push(p.name);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t});\n\t\treturn children;\n\t};\n\n\tfunction contains_parent(arr, m, f) {\n\t\tfor(var i=0; i<arr.length; i++)\n\t\t\tif(arr[i].mother === m && arr[i].father === f)\n\t\t\t\treturn true;\n\t\treturn false;\n\t}\n\n\t// get the siblings of a given individual - sex is an optional parameter\n\t// for only returning brothers or sisters\n\tpedigree_util.getSiblings = function(dataset, person, sex) {\n\t\tif(person === undefined || !person.mother || person.noparents)\n\t\t\treturn [];\n\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t       (p.mother === person.mother && p.father === person.father) &&\n\t\t\t       (!sex || p.sex == sex) ? p : null;\n\t\t});\n\t};\n\n\t// get the siblings + adopted siblings\n\tpedigree_util.getAllSiblings = function(dataset, person, sex) {\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t       (p.mother === person.mother && p.father === person.father) &&\n\t\t\t       (!sex || p.sex == sex) ? p : null;\n\t\t});\n\t};\n\n\t// get the mono/di-zygotic twin(s)\n\tpedigree_util.getTwins = function(dataset, person) {\n\t\tvar sibs = pedigree_util.getSiblings(dataset, person);\n\t\tvar twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\n\t\treturn $.map(sibs, function(p, i){\n\t\t\treturn p.name !== person.name && p[twin_type] == person[twin_type] ? p : null;\n\t\t});\n\t};\n\n\t// get the adopted siblings of a given individual\n\tpedigree_util.getAdoptedSiblings = function(dataset, person) {\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn  p.name !== person.name && 'noparents' in p &&\n\t\t\t       (p.mother === person.mother && p.father === person.father) ? p : null;\n\t\t});\n\t};\n\n\tpedigree_util.getAllChildren = function(dataset, person, sex) {\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn !('noparents' in p) &&\n\t\t\t       (p.mother === person.name || p.father === person.name) &&\n\t\t\t       (!sex || p.sex === sex) ? p : null;\n\t\t});\n\t};\n\n\t// get the depth of the given person from the root\n\tpedigree_util.getDepth = function(dataset, name) {\n\t\tvar idx = pedigree_util.getIdxByName(dataset, name);\n\t\tvar depth = 1;\n\n\t\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\t\tidx = pedigree_util.getIdxByName(dataset, dataset[idx].mother);\n\t\t\tdepth++;\n\t\t}\n\t\treturn depth;\n\t};\n\n\t// given an array of people get an index for a given person\n\tpedigree_util.getIdxByName = function(arr, name) {\n\t\tvar idx = -1;\n\t\t$.each(arr, function(i, p) {\n\t\t\tif (name === p.name) {\n\t\t\t\tidx = i;\n\t\t\t\treturn idx;\n\t\t\t}\n\t\t});\n\t\treturn idx;\n\t};\n\n\t// get the nodes at a given depth sorted by their x position\n\tpedigree_util.getNodesAtDepth = function(fnodes, depth, exclude_names) {\n\t\treturn $.map(fnodes, function(p, i){\n\t\t\treturn p.depth == depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) == -1 ? p : null;\n\t\t}).sort(function (a,b) {return a.x - b.x;});\n\t};\n\n\t// convert the partner names into corresponding tree nodes\n\tpedigree_util.linkNodes = function(flattenNodes, partners) {\n\t\tvar links = [];\n\t\tfor(var i=0; i< partners.length; i++)\n\t\t\tlinks.push({'mother': pedigree_util.getNodeByName(flattenNodes, partners[i].mother.name),\n\t\t\t\t\t\t'father': pedigree_util.getNodeByName(flattenNodes, partners[i].father.name)});\n\t\treturn links;\n\t};\n\n\t// get ancestors of a node\n\tpedigree_util.ancestors = function(dataset, node) {\n\t\tvar ancestors = [];\n\t\tfunction recurse(node) {\n\t\t\tif(node.data) node = node.data;\n\t\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\n\t\t\t\trecurse(pedigree_util.getNodeByName(dataset, node.mother));\n\t\t\t\trecurse(pedigree_util.getNodeByName(dataset, node.father));\n\t\t\t}\n\t\t\tancestors.push(node);\n\t\t}\n\t\trecurse(node);\n\t\treturn ancestors;\n\t}\n\n\t// test if two nodes are consanguinous partners\n\tpedigree_util.consanguity = function(node1, node2, opts) {\n\t\tif(node1.depth !== node2.depth) // parents at different depths\n\t\t\treturn true;\n\t\tvar ancestors1 = pedigree_util.ancestors(opts.dataset, node1);\n\t\tvar ancestors2 = pedigree_util.ancestors(opts.dataset, node2);\n\t\tvar names1 = $.map(ancestors1, function(ancestor, i){return ancestor.name;});\n\t\tvar names2 = $.map(ancestors2, function(ancestor, i){return ancestor.name;});\n  \t\tvar consanguity = false;\n  \t\t$.each(names1, function( index, name ) {\n  \t\t\tif($.inArray(name, names2) !== -1){\n  \t\t\t\tconsanguity = true;\n  \t\t\t\treturn false;\n  \t\t\t}\n  \t\t});\n  \t\treturn consanguity;\n\t}\n\n\t// return a flattened representation of the tree\n\tpedigree_util.flatten = function(root) {\n\t\tvar flat = [];\n\t\tfunction recurse(node) {\n\t\t\tif(node.children)\n\t\t\t\tnode.children.forEach(recurse);\n\t\t\tflat.push(node);\n\t\t}\n\t\trecurse(root);\n\t\treturn flat;\n\t};\n\n\t// Adjust D3 layout positioning.\n\t// Position hidden parent node centring them between father and mother nodes. Remove kinks\n\t// from links - e.g. where there is a single child plus a hidden child\n\tpedigree_util.adjust_coords  = function(opts, root, flattenNodes) {\n\t\tfunction recurse(node) {\n\t\t\tif (node.children) {\n\t\t\t\tnode.children.forEach(recurse);\n\n\t\t\t\tif(node.data.father !== undefined) { \t// hidden nodes\n\t\t\t\t\tvar father = pedigree_util.getNodeByName(flattenNodes, node.data.father.name);\n\t\t\t\t\tvar mother = pedigree_util.getNodeByName(flattenNodes, node.data.mother.name);\n\t\t\t\t\tvar xmid = (father.x + mother.x) /2;\n\t\t\t\t\tif(!pedigree_util.overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\n\t\t\t\t\t\tvar diff = node.x - xmid;\n\t\t\t\t\t\tif(node.children.length == 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\n\t\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\n\t\t\t\t\t\t\t\tvar child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\n\t\t\t\t\t\t\t\tvar child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\n\t\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\n\t\t\t\t\t\t\t\t    !pedigree_util.overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\n\t\t\t\t\t\t\t\t\tchild1.x = xmid;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if(node.children.length == 1 && !node.children[0].data.hidden) {\n\t\t\t\t\t\t\tif(!pedigree_util.overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\n\t\t\t\t\t\t\t\tif(node.children.length == 1) {\n\t\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tvar descendants = node.descendants();\n\t\t\t\t\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\n\t\t\t\t\t\t\t\t\tfor(var i=0; i<descendants.length; i++) {\n\t\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\n\t\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\n\t\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\trecurse(root);\n\t\trecurse(root);\n\t};\n\n\t// test if moving siblings by diff overlaps with other nodes\n\tfunction nodesOverlap(opts, node, diff, root) {\n\t\tvar descendants = node.descendants();\n\t\tvar descendantsNames = $.map(descendants, function(descendant, i){return descendant.data.name;});\n\t\tvar nodes = root.descendants();\n\t\tfor(var i=0; i<descendants.length; i++){\n\t\t\tvar descendant = descendants[i];\n\t\t\tif(node.data.name !== descendant.data.name){\n\t\t\t\tvar xnew = descendant.x - diff;\n\t\t\t\tif(pedigree_util.overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t// test if x position overlaps a node at the same depth\n\tpedigree_util.overlap = function(opts, nodes, xnew, depth, exclude_names) {\n\t\tfor(var n=0; n<nodes.length; n++) {\n\t\t\tif(depth == nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) == -1){\n\t\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t};\n\n\t// given a persons name return the corresponding d3 tree node\n\tpedigree_util.getNodeByName = function(nodes, name) {\n\t\tfor (var i = 0; i < nodes.length; i++) {\n\t\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\t\treturn nodes[i];\n\t\t\telse if (name === nodes[i].name)\n\t\t\t\treturn nodes[i];\n\t\t}\n\t};\n\n\t// given the name of a url param get the value\n\tpedigree_util.urlParam = function(name){\n\t    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);\n\t    if (results===null)\n\t       return null;\n\t    else\n\t       return results[1] || 0;\n\t};\n\n\t// get grandparents index\n\tpedigree_util.get_grandparents_idx = function(dataset, midx, fidx) {\n\t\tvar gmidx = midx;\n\t\tvar gfidx = fidx;\n\t\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\n\t\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\n\t\t\tgmidx = pedigree_util.getIdxByName(dataset, dataset[gmidx].mother);\n\t\t\tgfidx = pedigree_util.getIdxByName(dataset, dataset[gfidx].mother);\n\t\t}\n\t\treturn {'midx': gmidx, 'fidx': gfidx};\n\t};\n\n\t// Set or remove proband attributes.\n\t// If a value is not provided the attribute is removed from the proband.\n\t// 'key' can be a list of keys or a single key.\n\tpedigree_util.proband_attr = function(opts, keys, value){\n\t\tvar proband = opts.dataset[ pedigree_util.getProbandIndex(opts.dataset) ];\n\t\tpedigree_util.node_attr(opts, proband.name, keys, value);\n\t}\n\n\t// Set or remove node attributes.\n\t// If a value is not provided the attribute is removed.\n\t// 'key' can be a list of keys or a single key.\n\tpedigree_util.node_attr = function(opts, name, keys, value){\n\t\tvar newdataset = ptree.copy_dataset(pedcache.current(opts));\n\t\tvar node = pedigree_util.getNodeByName(newdataset, name);\n\t\tif(!node){\n\t\t\tconsole.warn(\"No person defined\");\n\t\t\treturn;\n\t\t}\n\n\t\tif(!$.isArray(keys)) {\n\t\t\tkeys = [keys];\n\t\t}\n\n\t\tif(value) {\n\t\t\tfor(var i=0; i<keys.length; i++) {\n\t\t\t\tvar k = keys[i];\n\t\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\n\t\t\t\tif(k in node && keys.length === 1) {\n\t\t\t\t\tif(node[k] === value)\n\t\t\t\t\t\treturn;\n\t\t\t\t\ttry{\n\t\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\n\t\t\t\t\t\t   return;\n\t\t\t\t\t} catch(e){}\n\t\t\t\t}\n\t\t\t\tnode[k] = value;\n\t\t\t}\n\t\t} else {\n\t\t\tvar found = false;\n\t\t\tfor(var i=0; i<keys.length; i++) {\n\t\t\t\tvar k = keys[i];\n\t\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\n\t\t\t\tif(k in node) {\n\t\t\t\t\tdelete node[k];\n\t\t\t\t\tfound = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(!found)\n\t\t\t\treturn;\n\t\t}\n        ptree.syncTwins(newdataset, node);\n\t\topts.dataset = newdataset;\n\t\tptree.rebuild(opts);\n\t}\n\n\t// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\n\tpedigree_util.proband_add_child = function(opts, sex, age, yob, breastfeeding){\n\t\tvar newdataset = ptree.copy_dataset(pedcache.current(opts));\n\t\tvar proband = newdataset[ pedigree_util.getProbandIndex(newdataset) ];\n\t\tif(!proband){\n\t\t\tconsole.warn(\"No proband defined\");\n\t\t\treturn;\n\t\t}\n\t\tvar newchild = ptree.addchild(newdataset, proband, sex, 1)[0];\n\t    newchild.age = age;\n\t    newchild.yob = yob;\n\t    if(breastfeeding !== undefined)\n\t    \tnewchild.breastfeeding = breastfeeding;\n\t\topts.dataset = newdataset;\n\t\tptree.rebuild(opts);\n\t\treturn newchild.name;\n\t}\n\n\t// delete node using the name\n\tpedigree_util.delete_node_by_name = function(opts, name){\n\t\tfunction onDone(opts, dataset) {\n\t\t\t// assign new dataset and rebuild pedigree\n\t\t\topts.dataset = dataset;\n\t\t\tptree.rebuild(opts);\n\t\t}\n\t\tvar newdataset = ptree.copy_dataset(pedcache.current(opts));\n\t\tvar node = pedigree_util.getNodeByName(pedcache.current(opts), name);\n\t\tif(!node){\n\t\t\tconsole.warn(\"No node defined\");\n\t\t\treturn;\n\t\t}\n\t\tptree.delete_node_dataset(newdataset, node, opts, onDone);\n\t}\n\n\t// check by name if the individual exists\n\tpedigree_util.exists = function(opts, name){\n\t\treturn pedigree_util.getNodeByName(pedcache.current(opts), name) !== undefined;\n\t}\n\n\t// print options and dataset\n\tpedigree_util.print_opts = function(opts){\n    \t$(\"#pedigree_data\").remove();\n    \t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\n    \tvar key;\n    \tfor(var i=0; i<opts.dataset.length; i++) {\n    \t\tvar person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\n    \t\tfor(key in opts.dataset[i]) {\n    \t\t\tif(key === 'name') continue;\n    \t\t\tif(key === 'parent')\n    \t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\n    \t\t\telse if (key === 'children') {\n    \t\t\t\tif (opts.dataset[i][key][0] !== undefined)\n    \t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\n    \t\t\t} else\n    \t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\n    \t\t}\n    \t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\n\n    \t}\n    \t$(\"#pedigree_data\").append(\"<br /><br />\");\n    \tfor(key in opts) {\n    \t\tif(key === 'dataset') continue;\n    \t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\n    \t}\n\t};\n}(window.pedigree_util = window.pedigree_util || {}, jQuery));\n\n\n// Pedigree Tree Builder\n(function(ptree, $, undefined) {\n\tptree.roots = {};\n\tptree.build = function(options) {\n        var opts = $.extend({ // defaults\n        \ttargetDiv: 'pedigree_edit',\n        \tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n        \t\t       {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n        \t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\n        \twidth: 600,\n        \theight: 400,\n        \tsymbol_size: 35,\n        \tzoomIn: 1.0,\n        \tzoomOut: 1.0,\n        \tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\n        \t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\n\t\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#4DAA4D'},\n\t\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\n\t\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\n\t\t\tlabels: ['stillbirth', 'age', 'yob', 'alleles'],\n\t\t\tkeep_proband_on_reset: false,\n\t\t\tfont_size: '.75em',\n\t\t\tfont_family: 'Helvetica',\n\t\t\tfont_weight: 700,\n\t\t\tbackground: \"#EEE\",\n\t\t\tnode_background: '#fdfdfd',\n\t\t\tvalidate: true,\n        \tDEBUG: false}, options );\n\n        if ( $( \"#fullscreen\" ).length === 0 ) {\n        \t// add undo, redo, fullscreen buttons and event listeners once\n\t\t\tpbuttons.add(opts);\n\t\t\tio.add(opts);\n        }\n\n        if(pedcache.nstore(opts) == -1)\n        \tpedcache.add(opts);\n\n        pbuttons.updateButtons(opts);\n\n        // validate pedigree data\n        ptree.validate_pedigree(opts);\n        // group top level nodes by partners\n        opts.dataset = group_top_level(opts.dataset);\n\n        if(opts.DEBUG)\n        \tpedigree_util.print_opts(opts);\n        var svg_dimensions = get_svg_dimensions(opts);\n        var svg = d3.select(\"#\"+opts.targetDiv)\n\t\t\t\t\t .append(\"svg:svg\")\n\t\t\t\t\t .attr(\"width\", svg_dimensions.width)\n\t\t\t\t\t .attr(\"height\", svg_dimensions.height);\n\n\t\tsvg.append(\"rect\")\n\t\t\t.attr(\"width\", \"100%\")\n\t\t\t.attr(\"height\", \"100%\")\n\t\t\t.attr(\"rx\", 6)\n\t\t\t.attr(\"ry\", 6)\n\t\t\t.style(\"stroke\", \"darkgrey\")\n       \t\t.style(\"fill\", opts.background) // or none\n       \t\t.style(\"stroke-width\", 1);\n\n\t\tvar xytransform = pedcache.getposition(opts);  // cached position\n\t\tvar xtransform = xytransform[0];\n\t\tvar ytransform = xytransform[1];\n\t\tvar zoom = 1;\n\t\tif(xytransform.length == 3){\n\t\t\tzoom = xytransform[2];\n\t\t}\n\n\t\tif(xtransform === null || ytransform === null) {\n\t\t\txtransform = opts.symbol_size/2;\n\t\t\tytransform = (-opts.symbol_size*2.5);\n\t\t}\n\t\tvar ped = svg.append(\"g\")\n\t\t\t\t .attr(\"class\", \"diagram\")\n\t             .attr(\"transform\", \"translate(\"+xtransform+\",\" + ytransform + \") scale(\"+zoom+\")\");\n\n\t\tvar top_level = $.map(opts.dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t\tvar hidden_root = {\n\t\t\tname : 'hidden_root',\n\t\t\tid : 0,\n\t\t\thidden : true,\n\t\t\tchildren : top_level\n\t\t};\n\n\t\tvar partners = pedigree_util.buildTree(opts, hidden_root, hidden_root)[0];\n\t\tvar root = d3.hierarchy(hidden_root);\n\t\tptree.roots[opts.targetDiv] = root;\n\n\t\t/// get score at each depth used to adjust node separation\n\t\tvar tree_dimensions = ptree.get_tree_dimensions(opts);\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\n\t\t\t\t\t    ' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\n\n\t\tvar treemap = d3.tree().separation(function(a, b) {\n\t\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? 1.2 : 2.2;\n\t\t}).size([tree_dimensions.width, tree_dimensions.height]);\n\n\t\tvar nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\n\t\tvar flattenNodes = nodes.descendants();\n\n\t\t// check the number of visible nodes equals the size of the pedigree dataset\n\t\tvar vis_nodes = $.map(opts.dataset, function(p, i){return p.hidden ? null : p;});\n\t\tif(vis_nodes.length != opts.dataset.length) {\n\t\t\tthrow create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\n\t\t}\n\n\t\tpedigree_util.adjust_coords(opts, nodes, flattenNodes);\n\n\t\tvar ptrLinkNodes = pedigree_util.linkNodes(flattenNodes, partners);\n\t\tcheck_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines\n\n\t\tvar node = ped.selectAll(\".node\")\n\t\t\t\t\t  .data(nodes.descendants())\n\t\t\t\t\t  .enter()\n\t\t\t\t\t   \t.append(\"g\")\n\t\t\t\t\t   \t.attr(\"transform\", function(d, i) {\n\t\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\n\t\t\t\t\t\t});\n\n\t\t// provide a border to the node\n\t\tnode.append(\"path\")\n\t\t\t.filter(function (d) {return !d.data.hidden;})\n\t\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\n\t\t\t.attr(\"transform\", function(d) {return d.data.sex == \"U\" && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t\t.attr(\"d\", d3.symbol().size(function(d) { return (opts.symbol_size * opts.symbol_size) + 2;})\n\t\t\t\t\t.type(function(d) {\n\t\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\t\t\treturn d.data.sex == \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\n\t\t\t.style(\"stroke\", function (d) {\n\t\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t\t})\n\t\t\t.style(\"stroke-width\", function (d) {\n\t\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".3em\" : \".1em\";\n\t\t\t})\n\t\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t\t.style(\"fill\", \"none\");\n\n\t\t// set a clippath\n\t\tnode.append(\"clipPath\")\n\t\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\n\t\t\t.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\n\t\t\t.attr(\"class\", \"node\")\n\t\t\t.attr(\"transform\", function(d) {return d.data.sex == \"U\" && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t\t.attr(\"d\", d3.symbol().size(function(d) {\n\t\t\t\t\tif (d.data.hidden)\n\t\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size;\n\t\t\t\t})\n\t\t\t\t.type(function(d) {\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\t\treturn d.data.sex == \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\n\n\t\t// pie plots for disease colours\n\t\tvar pienode = node.selectAll(\"pienode\")\n\t\t   .data(function(d) {     \t\t// set the disease data for the pie plot\n\t\t\t   var ncancers = 0;\n\t\t\t   var cancers = $.map(opts.diseases, function(val, i){\n\t\t\t\t   if(prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\n\t\t\t   });\n\t\t\t   if(ncancers === 0) cancers = [1];\n\t\t\t   return [$.map(cancers, function(val, i){\n\t\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\n\t\t\t\t\t   \t   'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\n\t\t\t\t\t   \t   'affected': d.data.affected,\n\t\t\t\t\t   \t   'exclude': d.data.exclude};})];\n\t\t   })\n\t\t   .enter()\n\t\t    .append(\"g\");\n\n\t\tpienode.selectAll(\"path\")\n\t\t    .data(d3.pie().value(function(d) {return d.cancer;}))\n\t\t    .enter().append(\"path\")\n\t\t    \t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\n\t\t\t    .attr(\"class\", \"pienode\")\n\t\t\t    .attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\n\t\t\t    .style(\"fill\", function(d, i) {\n\t\t\t    \tif(d.data.exclude)\n\t\t\t    \t\treturn 'lightgrey';\n\t\t\t    \tif(d.data.ncancers === 0) {\n\t\t\t    \t\tif(d.data.affected)\n\t\t\t    \t\t\treturn 'darkgrey';\n\t\t\t\t    \treturn opts.node_background;\n\t\t\t    \t}\n\t\t\t    \treturn opts.diseases[i].colour;\n\t\t\t    });\n\n\t\t// adopted in/out brackets\n\t\tnode.append(\"path\")\n\t\t\t.filter(function (d) {return !d.data.hidden && (d.data.adopted_in || d.data.adopted_out);})\n\t\t\t.attr(\"d\", function(d) { {\n\t\t\t\tfunction get_bracket(dx, dy, indent) {\n\t\t\t\t\treturn \t\"M\" + (dx+indent) + \",\" + dy +\n\t\t\t\t\t\t\t\"L\" + dx + \" \" + dy +\n\t\t\t\t\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\t\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\t\t\t\t\"L\" + (dx+indent) + \",\" + (dy+(opts.symbol_size *  1.28))\n\t\t\t\t}\n\t\t\t\tvar dx = -(opts.symbol_size * 0.66);\n\t\t\t\tvar dy = -(opts.symbol_size * 0.64);\n\t\t\t\tvar indent = opts.symbol_size/4;\n\t\t\t\treturn get_bracket(dx, dy, indent)+get_bracket(-dx, dy, -indent);\n\t\t\t\t}})\n\t\t\t.style(\"stroke\", function (d) {\n\t\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t\t})\n\t\t\t.style(\"stroke-width\", function (d) {\n\t\t\t\treturn \".1em\";\n\t\t\t})\n\t\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t\t.style(\"fill\", \"none\");\n\n\n\t\t// alive status = 0; dead status = 1\n\t\tvar status = node.append('line')\n\t\t.filter(function (d) {return d.data.status == 1;})\n\t\t    .style(\"stroke\", \"black\")\n\t\t    .attr(\"x1\", function(d, i) {return -0.6*opts.symbol_size;})\n\t\t    .attr(\"y1\", function(d, i) {return 0.6*opts.symbol_size;})\n\t\t    .attr(\"x2\", function(d, i) {return 0.6*opts.symbol_size;})\n\t\t    .attr(\"y2\", function(d, i) {return -0.6*opts.symbol_size;});\n\n\t\t// names of individuals\n\t\taddLabel(opts, node, \".25em\", -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\n\t\t\t\tfunction(d) {\n\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\n\t\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';});\n\n/*\t\tvar warn = node.filter(function (d) {\n    \t\treturn (!d.data.age || !d.data.yob) && !d.data.hidden;\n\t\t}).append(\"text\")\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.attr(\"x\", \".25em\")\n\t\t.attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size))\n\t\t.html(\"\\uf071\");\n\t\twarn.append(\"svg:title\").text(\"incomplete\");*/\n\n\t\tvar font_size = parseInt(getPx(opts)) + 4;\n\t\t// display label defined in opts.labels e.g. alleles/genotype data\n\t\tfor(var ilab=0; ilab<opts.labels.length; ilab++) {\n\t\t\tvar label = opts.labels[ilab];\n\t\t\taddLabel(opts, node, \".25em\", -(0.7 * opts.symbol_size),\n\t\t\t\tfunction(d) {\n\t\t\t\t\tif(!d.data[label])\n\t\t\t\t\t\treturn;\n\t\t\t\t\td.y_offset = (ilab === 0 || !d.y_offset ? font_size*2.25 : d.y_offset+font_size);\n\t\t\t\t\treturn d.y_offset;\n\t\t\t\t},\n\t\t\t\tfunction(d) {\n\t\t\t\t\tif(d.data[label]) {\n\t\t\t\t\t\tif(label === 'alleles') {\n\t\t\t\t\t\t\tvar alleles = \"\";\n\t\t\t\t\t\t\tvar vars = d.data.alleles.split(';');\n\t\t\t\t\t\t\tfor(var ivar = 0;ivar < vars.length;ivar++) {\n\t\t\t\t\t\t\t\tif(vars[ivar] !== \"\") alleles += vars[ivar] + ';';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn alleles;\n\t\t\t\t\t\t} else if(label === 'age') {\n\t\t\t\t\t\t\treturn d.data[label] +'y';\n\t\t\t\t\t\t} else if(label === 'stillbirth') {\n\t\t\t\t\t\t\treturn \"SB\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn d.data[label];\n\t\t\t\t\t}\n\t\t\t\t}, 'indi_details');\n\t\t}\n\n\t\t// individuals disease details\n\t\tfor(var i=0;i<opts.diseases.length; i++) {\n\t\t\tvar disease = opts.diseases[i].type;\n\t\t\taddLabel(opts, node, \".25em\", -(opts.symbol_size),\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tvar y_offset = (d.y_offset ? d.y_offset+font_size: font_size*2.2);\n\t\t\t\t\t\tfor(var j=0;j<opts.diseases.length; j++) {\n\t\t\t\t\t\t\tif(disease === opts.diseases[j].type)\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tif(prefixInObj(opts.diseases[j].type, d.data))\n\t\t\t\t\t\t\t\ty_offset += font_size-1;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn y_offset;\n\t\t\t\t\t},\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tvar dis = disease.replace('_', ' ').replace('cancer', 'ca.');\n\t\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\n\t\t\t\t\t}, 'indi_details');\n\t\t}\n\n\t\t//\n\t\twidgets.addWidgets(opts, node);\n\n\t\t// links between partners\n\t\tvar clash_depth = {};\n\t\tpartners = ped.selectAll(\".partner\")\n\t\t  \t.data(ptrLinkNodes)\n\t\t  \t.enter()\n\t\t  \t\t.insert(\"path\", \"g\")\n\t\t  \t\t.attr(\"fill\", \"none\")\n\t\t  \t\t.attr(\"stroke\", \"#000\")\n\t\t  \t\t.attr(\"shape-rendering\", \"auto\")\n\t\t  \t\t.attr('d', function(d, i) {\n\t\t  \t\t\tvar node1 = pedigree_util.getNodeByName(flattenNodes, d.mother.data.name);\n\t\t  \t\t\tvar node2 = pedigree_util.getNodeByName(flattenNodes, d.father.data.name);\n\t\t  \t\t\tvar consanguity = pedigree_util.consanguity(node1, node2, opts);\n\t\t  \t\t\tvar divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\n\n\t\t  \t\t\tvar x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\n\t  \t\t\t\tvar x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\n\t  \t\t\t\tvar dy1 = d.mother.y;\n\n\t  \t\t\t\t// identify clashes with other nodes at the same depth\n\t\t  \t\t\tvar clash = ptree.check_ptr_link_clashes(opts, d);\n\t\t  \t\t\tvar path = \"\";\n\t\t  \t\t\tif(clash) {\n\t\t  \t\t\t\tif(d.mother.depth in clash_depth)\n\t\t  \t\t\t\t\tclash_depth[d.mother.depth] += 4;\n\t\t  \t\t\t\telse\n\t\t  \t\t\t\t\tclash_depth[d.mother.depth] = 4;\n\n\t\t  \t\t\t\tdy1 -= clash_depth[d.mother.depth];\n\t\t  \t\t\t\tvar dx = clash_depth[d.mother.depth] + opts.symbol_size/2 + 2;\n\n\t\t  \t\t\t\tvar parent_nodes = d.mother.data.parent_node;\n\t\t  \t\t\t\tvar parent_node_name = parent_nodes[0];\n\t\t  \t\t\t\tfor(var ii=0; ii<parent_nodes.length; ii++) {\n\t\t  \t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\n\t\t  \t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\n\t\t  \t\t\t\t\t\t parent_node_name = parent_nodes[ii].name;\n\t\t  \t\t\t\t}\n\t\t  \t\t\t\tvar parent_node = pedigree_util.getNodeByName(flattenNodes, parent_node_name);\n\t\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\n\t\t  \t\t\t\tclash.sort(function (a,b) {return a - b;});\n\n\t\t  \t\t\t\tvar dy2 = (dy1-opts.symbol_size/2-3);\n\t\t  \t\t\t\t// get path looping over node(s)\n\t\t  \t\t\t\tdraw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\n\t\t\t  \t\t\t\textend = function(i, l) {\n\t\t\t  \t\t\t\t\tif(i+1 < l)   //  && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\n\t\t\t  \t\t\t\t\t\treturn extend(++i);\n\t\t\t  \t\t\t\t\treturn i;\n\t\t\t  \t\t\t\t};\n\t\t  \t\t\t\t\tvar path = \"\";\n\t\t\t  \t\t\t\tfor(var j=0; j<clash.length; j++) {\n\t\t\t  \t\t\t\t\tvar k = extend(j, clash.length);\n\t\t\t  \t\t\t\t\tvar dx1 = clash[j] - dx - cshift;\n\t\t\t  \t\t\t\t\tvar dx2 = clash[k] + dx + cshift;\n\t\t\t  \t\t\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\n\t\t\t  \t\t\t\t\t\tparent_node.y = dy2;\n\n\t\t  \t\t\t\t\t\tpath += \"L\" + dx1 + \",\" +  (dy1 - cshift) +\n\t\t\t  \t\t\t\t\t        \"L\" + dx1 + \",\" +  (dy2 - cshift) +\n\t\t\t  \t\t\t\t\t        \"L\" + dx2 + \",\" +  (dy2 - cshift) +\n\t\t\t  \t\t\t\t\t        \"L\" + dx2 + \",\" +  (dy1 - cshift);\n\t\t  \t\t\t\t\t\tj = k;\n\t\t\t  \t\t\t\t}\n\t\t\t  \t\t\t\treturn path;\n\t\t  \t\t\t\t}\n\t\t  \t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\n\t\t  \t\t\t}\n\n\t\t  \t\t\tvar divorce_path = \"\";\n\t\t  \t\t\tif(divorced && !clash)\n\t\t  \t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-6) +\n\t\t  \t\t\t\t               \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+6) +\n\t\t  \t\t\t\t               \"M\" + (x1+((x2-x1)*.66)+10) + \",\" + (dy1-6) +\n\t\t  \t\t\t\t               \"L\"+  (x1+((x2-x1)*.66)-2)  + \",\" + (dy1+6);\n\t\t  \t\t\tif(consanguity) {  // consanguinous, draw double line between partners\n\t\t  \t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\n\t\t  \t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\n\n\t\t  \t\t\t\tvar cshift = 3;\n\t\t  \t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {      // DIFFERENT LEVEL\n\t\t  \t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\n\t  \t\t\t\t                \"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\n\t\t  \t\t\t\t} else {                           // SAME LEVEL\n\t\t\t  \t\t\t\tvar path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\n\t\t\t  \t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\n\t\t\t  \t\t\t\t        \"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\n\t\t  \t\t\t\t}\n\t\t  \t\t\t}\n\t\t  \t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\n\t\t  \t\t});\n\n\t\t// links to children\n\t\tvar links = ped.selectAll(\".link\")\n\t\t\t.data(root.links(nodes.descendants()))\n\t\t\t.enter()\n\t\t\t\t.filter(function (d) {\n\t\t\t\t\t// filter unless debug is set\n\t\t\t\t\treturn (opts.DEBUG ||\n\t\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\n\t\t\t\t})\n\t\t\t\t.insert(\"path\", \"g\")\n\t\t\t\t.attr(\"fill\", \"none\")\n\t\t\t\t.attr(\"stroke-width\", function(d, i) {\n\t\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\t\treturn 1;\n\t\t\t\t\treturn (opts.DEBUG ? 2 : 1);\n\t\t\t\t})\n\t\t\t\t.attr(\"stroke\", function(d, i) {\n\t\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\t\treturn 'pink';\n\t\t\t\t\treturn \"#000\";\n\t\t\t\t})\n\t\t\t\t.attr(\"stroke-dasharray\", function(d, i) {\n\t\t\t\t\tif(!d.target.data.adopted_in) return null;\n\t\t\t\t\tvar dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\n\t\t\t\t\tvar dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\n\t\t\t\t\tvar twins = pedigree_util.getTwins(opts.dataset, d.target.data);\n\t\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\n\t\t\t\t\tfor(var usedlen = 0; usedlen < dash_len; usedlen += 10)\n\t\t\t\t\t\t$.merge(dash_array, [5, 5]);\n\t\t\t\t\treturn dash_array;\n\t\t\t\t})\n\t\t\t\t.attr(\"shape-rendering\", function(d, i) {\n\t\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\n\t\t\t\t\t\treturn \"geometricPrecision\";\n\t\t\t\t\treturn \"auto\";\n\t\t\t\t})\n\t\t\t\t.attr(\"d\", function(d, i) {\n\t\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\n\t\t\t\t\t\t// get twin position\n\t\t\t\t\t\tvar twins = pedigree_util.getTwins(opts.dataset, d.target.data);\n\t\t\t\t\t\tif(twins.length >= 1) {\n\t\t\t\t\t\t\tvar twinx = 0;\n\t\t\t\t\t\t\tvar xmin = d.target.x;\n\t\t\t\t\t\t\tvar xmax = d.target.x;\n\t\t\t\t\t\t\tfor(var t=0; t<twins.length; t++) {\n\t\t\t\t\t\t\t\tvar thisx = pedigree_util.getNodeByName(flattenNodes, twins[t].name).x;\n\t\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\n\t\t\t\t\t\t\t\tif(xmax < thisx) xmax = thisx;\n\t\t\t\t\t\t\t\ttwinx += thisx;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvar xmid = ((d.target.x + twinx) / (twins.length+1));\n\t\t\t\t\t\t\tvar ymid = ((d.source.y + d.target.y) / 2);\n\n\t\t\t\t\t\t\tvar xhbar = \"\";\n\t\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\n\t\t\t\t\t\t\t\t// horizontal bar for mztwins\n\t\t\t\t\t\t\t\tvar xx = (xmid + d.target.x)/2;\n\t\t\t\t\t\t\t\tvar yy = (ymid + (d.target.y-opts.symbol_size/2))/2;\n\t\t\t\t\t\t\t\txhbar = \"M\" + xx + \",\" + yy +\n\t\t\t\t\t\t\t\t     \t\"L\" + (xmid + (xmid-xx)) + \" \" + yy;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t\t           \"V\" + ymid +\n\t\t\t\t\t\t           \"H\" + xmid +\n\t\t\t\t\t\t           \"L\" + (d.target.x) + \" \" + (d.target.y-opts.symbol_size/2) +\n\t\t\t\t\t\t           xhbar;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif(d.source.data.mother) {   // check parents depth to see if they are at the same level in the tree\n\t\t\t\t\t\tvar ma = pedigree_util.getNodeByName(flattenNodes, d.source.data.mother.name);\n\t\t\t\t\t\tvar pa = pedigree_util.getNodeByName(flattenNodes, d.source.data.father.name);\n\n\t\t\t\t\t\tif(ma.depth !== pa.depth) {\n\t\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + ((ma.y + pa.y) / 2) +\n\t\t\t\t\t\t\t       \"H\" + (d.target.x) +\n\t\t\t\t\t\t           \"V\" + (d.target.y);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t       \"V\" + ((d.source.y + d.target.y) / 2) +\n\t\t\t\t\t       \"H\" + (d.target.x) +\n\t\t\t\t\t       \"V\" + (d.target.y);\n\t\t\t\t});\n\n\t\t// draw proband arrow\n\t\tvar probandIdx  = pedigree_util.getProbandIndex(opts.dataset);\n\t\tif(typeof probandIdx !== 'undefined') {\n\t\t\tvar probandNode = pedigree_util.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\n\t\t\tvar triid = \"triangle\"+ptree.makeid(3);\n\t\t\tped.append(\"svg:defs\").append(\"svg:marker\")    // arrow head\n\t\t\t    .attr(\"id\", triid)\n\t\t\t    .attr(\"refX\", 6)\n\t\t\t    .attr(\"refY\", 6)\n\t\t\t    .attr(\"markerWidth\", 20)\n\t\t\t    .attr(\"markerHeight\", 20)\n\t\t\t    .attr(\"orient\", \"auto\")\n\t\t\t    .append(\"path\")\n\t\t\t    .attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\n\t\t\t    .style(\"fill\", \"black\");\n\n\t\t\tped.append(\"line\")\n\t\t        .attr(\"x1\", probandNode.x-opts.symbol_size)\n\t\t        .attr(\"y1\", probandNode.y+opts.symbol_size)\n\t\t        .attr(\"x2\", probandNode.x-opts.symbol_size/2)\n\t\t        .attr(\"y2\", probandNode.y+opts.symbol_size/2)\n\t\t        .attr(\"stroke-width\", 1)\n\t\t        .attr(\"stroke\", \"black\")\n\t\t        .attr(\"marker-end\", \"url(#\"+triid+\")\");\n\t\t}\n\t\t// drag and zoom\n\t\tzoom = d3.zoom()\n\t\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\n\t\t  .on('zoom', zoomFn);\n\n\t\tfunction zoomFn() {\n\t\t\tvar t = d3.event.transform;\n\t\t\tif(utils.isIE() && t.x.toString().length > 10)\t// IE fix for drag off screen\n\t\t\t\treturn;\n\t\t\tvar pos = [(t.x + parseInt(xtransform)), (t.y + parseInt(ytransform))];\n\t\t\tif(t.k == 1) {\n\t\t\t\tpedcache.setposition(opts, pos[0], pos[1]);\n\t\t\t} else {\n\t\t\t\tpedcache.setposition(opts, pos[0], pos[1], t.k);\n\t\t\t}\n\t\t\tped.attr('transform', 'translate(' + pos[0] + ',' + pos[1] + ') scale(' + t.k + ')');\n\t\t}\n\t\tsvg.call(zoom);\n\t\treturn opts;\n\t};\n\n\t// validate pedigree data\n\tptree.validate_pedigree = function(opts){\n\t\tif(opts.validate) {\n\t\t\tif (typeof opts.validate == 'function') {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\n\t\t\t\treturn opts.validate.call(this, opts);;\n\t\t    }\n\n\t\t\tfunction create_err(err) {\n\t\t\t\tconsole.error(err);\n\t\t\t\treturn new Error(err);\n\t\t\t}\n\n\t\t\t// check consistency of parents sex\n\t\t\tvar uniquenames = [];\n\t\t\tvar famids = [];\n\t\t\tfor(var p=0; p<opts.dataset.length; p++) {\n\t\t\t\tif(!p.hidden) {\n\t\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\n\t\t\t\t\t\tvar display_name = opts.dataset[p].display_name;\n\t\t\t\t\t\tif(!display_name)\n\t\t\t\t\t\t\tdisplay_name = 'unnamed';\n\t\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\n\t\t\t\t\t\tvar mother = opts.dataset[p].mother;\n\t\t\t\t\t\tvar father = opts.dataset[p].father;\n\t\t\t\t\t\tif(!mother || !father) {\n\t\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar midx = pedigree_util.getIdxByName(opts.dataset, mother);\n\t\t\t\t\t\tvar fidx = pedigree_util.getIdxByName(opts.dataset, father);\n\t\t\t\t\t\tif(midx === -1)\n\t\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\n\t\t\t\t\t\t\t\t\t         display_name+' is missing from the pedigree.');\n\t\t\t\t\t\tif(fidx === -1)\n\t\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\n\t\t\t\t\t\t\t\t\t         display_name+' is missing from the pedigree.');\n\t\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\n\t\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\n\t\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\n\t\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\n\t\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\n\t\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(!opts.dataset[p].name)\n\t\t\t\t\tthrow create_err(display_name+' has no IndivID.');\n\t\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\n\t\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\n\t\t\t\tuniquenames.push(opts.dataset[p].name);\n\n\t\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\n\t\t\t\t\tfamids.push(opts.dataset[p].famid);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(famids.length > 1) {\n\t\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\n\t\t\t}\n\t\t\t// warn if there is a break in the pedigree\n\t\t\tvar unconnected = ptree.unconnected(opts.dataset);\n\t\t\tif(unconnected.length > 0)\n\t\t\t\tconsole.warn(\"individuals unconnected to pedigree \", unconnected);\n\t\t}\n\t}\n\n\t// check if the object contains a key with a given prefix\n\tfunction prefixInObj(prefix, obj) {\n\t\tvar found = false;\n\t\tif(obj)\n\t\t\t$.each(obj, function(k, n){\n\t\t\t    if(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\n\t\t\t    \tfound = true;\n\t\t\t    \treturn found;\n\t\t\t    }\n\t\t\t});\n\t\treturn found;\n\t}\n\n\t// return a list of individuals that aren't connected to the target\n\tptree.unconnected = function(dataset){\n\t\tvar target = dataset[ pedigree_util.getProbandIndex(dataset) ];\n\t\tif(!target){\n\t\t\tconsole.warn(\"No target defined\");\n\t\t\tif(dataset.length == 0) {\n\t\t\t\tthrow \"empty pedigree data set\";\n\t\t\t}\n\t\t\ttarget = dataset[0];\n\t\t}\n        var connected = [target.name];\n        var change = true;\n        var ii = 0;\n        while(change && ii < 200) {\n        \tii++;\n        \tvar nconnect = connected.length;\n            $.each(dataset, function( idx, p ) {\n            \tif($.inArray( p.name, connected ) != -1) {\n            \t\t// check if this person or a partner has a parent\n            \t\tvar ptrs = get_partners(dataset, p);\n            \t\tvar has_parent = (p.name === target.name || !p.noparents);\n            \t\tfor(var i=0; i<ptrs.length; i++){\n            \t\t\tif(!pedigree_util.getNodeByName(dataset, ptrs[i]).noparents)\n            \t\t\t\thas_parent = true;\n            \t\t}\n\n            \t\tif(has_parent){\n\t            \t\tif(p.mother && $.inArray( p.mother, connected ) == -1)\n\t            \t\t\tconnected.push(p.mother);\n\t            \t\tif(p.father && $.inArray( p.father, connected ) == -1)\n\t            \t\t\tconnected.push(p.father);\n            \t\t}\n            \t} else if( !p.noparents &&\n            \t\t\t  ((p.mother && $.inArray( p.mother, connected ) != -1) ||\n            \t\t\t   (p.father && $.inArray( p.father, connected ) != -1))){\n            \t\tconnected.push(p.name);\n            \t}\n        \t\t// include any children\n            \tinclude_children(connected, p, dataset);\n            });\n            change = (nconnect != connected.length);\n        }\n        var names = $.map(dataset, function(val, i){return val.name;});\n        return $.map(names, function(name, i){return $.inArray(name, connected) == -1 ? name : null;});\n\t};\n\n\tfunction include_children(connected, p, dataset) {\n\t\tif($.inArray( p.name, connected ) == -1)\n\t\t\treturn;\n\t\tcombineArrays(connected, get_partners(dataset, p));\n\t\tvar children = pedigree_util.getAllChildren(dataset, p);\n    \t$.each(children, function( child_idx, child ) {\n    \t\tif($.inArray( child.name, connected ) == -1) {\n    \t\t\tconnected.push(child.name);\n    \t\t\tcombineArrays(connected, get_partners(dataset, child));\n    \t\t}\n    \t});\n\t}\n\n\t// combine arrays ignoring duplicates\n\tfunction combineArrays(arr1, arr2) {\n\t    for(var i=0; i<arr2.length; i++)\n\t    \tif($.inArray( arr2[i], arr1 ) == -1) arr1.push(arr2[i]);\n\t}\n\n\t// check for crossing of partner lines\n\tfunction check_ptr_links(opts, ptrLinkNodes){\n\t\tfor(var a=0; a<ptrLinkNodes.length; a++) {\n\t\t\tvar clash = ptree.check_ptr_link_clashes(opts, ptrLinkNodes[a]);\n\t\t\tif(clash)\n\t\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\n\t\t}\n\t}\n\n\tptree.check_ptr_link_clashes = function(opts, anode) {\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar flattenNodes = pedigree_util.flatten(root);\n\t\tvar mother, father;\n\t\tif('name' in anode) {\n\t\t\tanode = pedigree_util.getNodeByName(flattenNodes, anode.name);\n\t\t\tif(!('mother' in anode.data))\n\t\t\t\treturn null;\n\t\t\tmother = pedigree_util.getNodeByName(flattenNodes, anode.data.mother);\n\t\t\tfather = pedigree_util.getNodeByName(flattenNodes, anode.data.father);\n\t\t} else {\n\t\t\tmother = anode.mother;\n\t\t\tfather = anode.father;\n\t\t}\n\n\t\tvar x1 = (mother.x < father.x ? mother.x : father.x);\n\t\tvar x2 = (mother.x < father.x ? father.x : mother.x);\n\t\tvar dy = mother.y;\n\n\t\t// identify clashes with other nodes at the same depth\n  \t\tvar clash = $.map(flattenNodes, function(bnode, i){\n  \t\t\treturn !bnode.data.hidden &&\n  \t\t\t\t    bnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\n  \t\t\t\t    bnode.y == dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\n  \t\t});\n  \t\treturn clash.length > 0 ? clash : null;\n\t};\n\n\tfunction get_svg_dimensions(opts) {\n        return {'width' : (pbuttons.is_fullscreen()? window.innerWidth  : opts.width),\n        \t    'height': (pbuttons.is_fullscreen()? window.innerHeight : opts.height)};\n\t}\n\n\tptree.get_tree_dimensions = function(opts) {\n\t\t/// get score at each depth used to adjust node separation\n\t\tvar svg_dimensions = get_svg_dimensions(opts);\n\t\tvar maxscore = 0;\n\t\tvar generation = {};\n\t\tfor(var i=0; i<opts.dataset.length; i++) {\n\t\t\tvar depth = pedigree_util.getDepth(opts.dataset, opts.dataset[i].name);\n\t\t\tvar children = pedigree_util.getAllChildren(opts.dataset, opts.dataset[i]);\n\n\t\t\t// score based on no. of children and if parent defined\n\t\t\tvar score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\n\t\t\tif(depth in generation)\n\t\t\t\tgeneration[depth] += score;\n\t\t\telse\n\t\t\t\tgeneration[depth] = score;\n\n\t\t\tif(generation[depth] > maxscore)\n\t\t\t\tmaxscore = generation[depth];\n\t\t}\n\n\t\tvar max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\n\t\tvar tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\n\t\t\t\t           svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\n\t\tvar tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\n\t\t      \t\t       svg_dimensions.height - opts.symbol_size : max_depth);\n\t\treturn {'width': tree_width, 'height': tree_height};\n\t};\n\n\t// get the partners for a given node\n\tfunction get_partners(dataset, anode) {\n\t\tvar ptrs = [];\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tvar bnode = dataset[i];\n\t\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) == -1)\n\t\t\t\tptrs.push(bnode.father);\n\t\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) == -1)\n\t\t\t\tptrs.push(bnode.mother);\n\t\t}\n\t\treturn ptrs;\n\t}\n\n\t// group top_level nodes by their partners\n\tfunction group_top_level(dataset) {\n\t\t// var top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t\t// calculate top_level nodes\n\t\tfor(var i=0;i<dataset.length;i++) {\n\t\t\tif(pedigree_util.getDepth(dataset, dataset[i].name) == 2)\n\t\t\t\tdataset[i].top_level = true;\n\t\t}\n\n\t\tvar top_level = [];\n        var top_level_seen = [];\n        for(i=0;i<dataset.length;i++) {\n        \tvar node = dataset[i];\n        \tif('top_level' in node && $.inArray(node.name, top_level_seen) == -1){\n        \t\ttop_level_seen.push(node.name);\n        \t\ttop_level.push(node);\n        \t\tvar ptrs = get_partners(dataset, node);\n        \t\tfor(var j=0; j<ptrs.length; j++){\n        \t\t\tif($.inArray(ptrs[j], top_level_seen) == -1) {\n\t        \t\t\ttop_level_seen.push(ptrs[j]);\n\t        \t\t\ttop_level.push(pedigree_util.getNodeByName(dataset, ptrs[j]));\n        \t\t\t}\n        \t\t}\n        \t}\n        }\n\n        var newdataset = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? null : val;});\n        for (i = top_level.length; i > 0; --i)\n        \tnewdataset.unshift(top_level[i-1]);\n        return newdataset;\n\t}\n\n\t// get height in pixels\n\tfunction getPx(opts){\n\t\tvar emVal = opts.font_size;\n\t\tif (emVal === parseInt(emVal, 10)) // test if integer\n\t\t\treturn emVal;\n\n\t\tif(emVal.indexOf(\"px\") > -1)\n\t\t\treturn emVal.replace('px', '');\n\t\telse if(emVal.indexOf(\"em\") === -1)\n\t\t\treturn emVal;\n\t\temVal = parseFloat(emVal.replace('em', ''));\n\t\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\n\t};\n\n\t// Add label\n\tfunction addLabel(opts, node, size, fx, fy, ftext, class_label) {\n\t\tnode.filter(function (d) {\n    \t\treturn d.data.hidden && !opts.DEBUG ? false : true;\n\t\t}).append(\"text\")\n\t\t.attr(\"class\", class_label + ' ped_label' || \"ped_label\")\n\t\t.attr(\"x\", fx)\n\t\t.attr(\"y\", fy)\n\t\t//.attr(\"dy\", size)\n\t\t.attr(\"font-family\", opts.font_family)\n\t\t.attr(\"font-size\", opts.font_size)\n\t\t.attr(\"font-weight\", opts.font_weight)\n\t\t.text(ftext);\n    }\n\n\tptree.rebuild = function(opts) {\n\t\t$(\"#\"+opts.targetDiv).empty();\n\t\tpedcache.add(opts);\n\t\ttry {\n\t\t\tptree.build(opts);\n\t\t} catch(e) {\n\t\t\tconsole.error(e);\n\t\t\tthrow e;\n\t\t}\n\n\t\ttry {\n\t\t\ttemplates.update(opts);\n\t\t} catch(e) {\n\t\t\t// templates not declared\n\t\t}\n\t};\n\n\tptree.copy_dataset = function(dataset) {\n\t\tif(dataset[0].id) { // sort by id\n\t\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\n\t\t}\n\n\t\tvar disallowed = [\"id\", \"parent_node\"];\n\t\tvar newdataset = [];\n\t\tfor(var i=0; i<dataset.length; i++){\n\t\t\tvar obj = {};\n\t\t\tfor(var key in dataset[i]) {\n\t\t\t\tif(disallowed.indexOf(key) == -1)\n\t\t\t\t\tobj[key] = dataset[i][key];\n\t\t\t}\n\t\t\tnewdataset.push(obj);\n\t\t}\n\t\treturn newdataset;\n\t};\n\n\t// add children to a given node\n\tptree.addchild = function(dataset, node, sex, nchild, twin_type) {\n\t\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\t\tif (typeof nchild === typeof undefined)\n\t\t\tnchild = 1;\n\t\tvar children = pedigree_util.getAllChildren(dataset, node);\n\t\tvar ptr_name, idx;\n\t\tif (children.length === 0) {\n\t\t\tvar partner = ptree.addsibling(dataset, node, node.sex === 'F' ? 'M': 'F', node.sex === 'F');\n\t\t\tpartner.noparents = true;\n\t\t\tptr_name = partner.name;\n\t\t\tidx = pedigree_util.getIdxByName(dataset, node.name)+1;\n\t\t} else {\n\t\t\tvar c = children[0];\n\t\t\tptr_name = (c.father === node.name ? c.mother : c.father);\n\t\t\tidx = pedigree_util.getIdxByName(dataset, c.name);\n\t\t}\n\n\t\tif(twin_type)\n\t\t\tvar twin_id = getUniqueTwinID(dataset, twin_type);\n\t\tvar newchildren = [];\n\t\tfor (var i = 0; i < nchild; i++) {\n\t\t\tvar child = {\"name\": ptree.makeid(4), \"sex\": sex,\n\t\t\t\t\t     \"mother\": (node.sex === 'F' ? node.name : ptr_name),\n\t\t\t\t         \"father\": (node.sex === 'F' ? ptr_name : node.name)};\n\t\t\tdataset.splice(idx, 0, child);\n\n\t\t\tif(twin_type)\n\t\t\t\tchild[twin_type] = twin_id;\n\t\t\tnewchildren.push(child);\n\t\t}\n\t\treturn newchildren;\n\t};\n\n\t//\n\tptree.addsibling = function(dataset, node, sex, add_lhs, twin_type) {\n\t\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\t\tvar newbie = {\"name\": ptree.makeid(4), \"sex\": sex};\n\t\tif(node.top_level) {\n\t\t\tnewbie.top_level = true;\n\t\t} else {\n\t\t\tnewbie.mother = node.mother;\n\t\t\tnewbie.father = node.father;\n\t\t}\n\t\tvar idx = pedigree_util.getIdxByName(dataset, node.name);\n\n\t\tif(twin_type) {\n\t\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\n\t\t}\n\n\t\tif(add_lhs) { // add to LHS\n\t\t\tif(idx > 0) idx--;\n\t\t} else\n\t\t\tidx++;\n\t\tdataset.splice(idx, 0, newbie);\n\t\treturn newbie;\n\t};\n\n\t// set two siblings as twins\n\tfunction setMzTwin(dataset, d1, d2, twin_type) {\n\t\tif(!d1[twin_type]) {\n\t\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\n\t\t\tif(!d1[twin_type])\n\t\t\t\treturn false;\n\t\t}\n\t\td2[twin_type] = d1[twin_type];\n\t\tif(d1.yob)\n\t\t\td2.yob = d1.yob;\n\t\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\t\td2.age = d1.age;\n\t\treturn true;\n\t}\n\n\t// get a new unique twins ID, max of 10 twins in a pedigree\n\tfunction getUniqueTwinID(dataset, twin_type) {\n\t\tvar mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tif(dataset[i][twin_type]) {\n\t\t\t\tvar idx = mz.indexOf(dataset[i][twin_type]);\n\t\t\t\tif (idx > -1)\n\t\t\t\t\tmz.splice(idx, 1);\n\t\t\t}\n\t\t}\n\t\tif(mz.length > 0)\n\t\t\treturn mz[0];\n\t\treturn undefined;\n\t}\n\n\t// sync attributes of twins\n\tptree.syncTwins = function(dataset, d1) {\n\t\tif(!d1.mztwin && !d1.dztwin)\n\t\t\treturn;\n\t\tvar twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tvar d2 = dataset[i];\n\t\t\tif(d2[twin_type] && d1[twin_type] == d2[twin_type] && d2.name !== d1.name) {\n\t\t\t\tif(twin_type === \"mztwin\")\n\t\t\t\t  d2.sex = d1.sex;\n\t\t\t\tif(d1.yob)\n\t\t\t\t\td2.yob = d1.yob;\n\t\t\t\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\t\t\t\td2.age = d1.age;\n\t\t\t}\n\t\t}\n\t};\n\n\t// check integrity twin settings\n\tfunction checkTwins(dataset) {\n\t\tvar twin_types = [\"mztwin\", \"dztwin\"];\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tfor(var j=0; j<twin_types.length; j++) {\n\t\t\t\tvar twin_type = twin_types[j];\n\t\t\t\tif(dataset[i][twin_type]) {\n\t\t\t\t\tvar count = 0;\n\t\t\t\t\tfor(var j=0; j<dataset.length; j++) {\n\t\t\t\t\t\tif(dataset[j][twin_type] == dataset[i][twin_type])\n\t\t\t\t\t\t\tcount++;\n\t\t\t\t\t}\n\t\t\t\t\tif(count < 2)\n\t\t\t\t\t\tdelete dataset[i][[twin_type]];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// add parents to the 'node'\n\tptree.addparents = function(opts, dataset, name) {\n\t\tvar mother, father;\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar flat_tree = pedigree_util.flatten(root);\n\t\tvar tree_node = pedigree_util.getNodeByName(flat_tree, name);\n\t\tvar node  = tree_node.data;\n\t\tvar depth = tree_node.depth;   // depth of the node in relation to the root (depth = 1 is a top_level node)\n\n\t\tvar pid = -101;\n\t\tvar ptr_name;\n\t\tvar children = pedigree_util.getAllChildren(dataset, node);\n\t\tif(children.length > 0){\n\t\t\tptr_name = children[0].mother == node.name ? children[0].father : children[0].mother;\n\t\t\tpid = pedigree_util.getNodeByName(flat_tree, ptr_name).data.id;\n\t\t}\n\n\t\tvar i;\n\t\tif(depth == 1) {\n\t\t\tmother = {\"name\": ptree.makeid(4), \"sex\": \"F\", \"top_level\": true};\n\t\t\tfather = {\"name\": ptree.makeid(4), \"sex\": \"M\", \"top_level\": true};\n\t\t\tdataset.splice(0, 0, mother);\n\t\t\tdataset.splice(0, 0, father);\n\n\t\t\tfor(i=0; i<dataset.length; i++){\n\t\t\t\tif(dataset[i].top_level && dataset[i].name !== mother.name && dataset[i].name !== father.name){\n\t\t\t\t\tdelete dataset[i].top_level;\n\t\t\t\t\tdataset[i].noparents = true;\n\t\t\t\t\tdataset[i].mother = mother.name;\n\t\t\t\t\tdataset[i].father = father.name;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tvar node_mother = pedigree_util.getNodeByName(flat_tree, tree_node.data.mother);\n\t\t\tvar node_father = pedigree_util.getNodeByName(flat_tree, tree_node.data.father);\n\t\t\tvar node_sibs = pedigree_util.getAllSiblings(dataset, node);\n\n\t\t\t// lhs & rhs id's for siblings of this node\n\t\t\tvar rid = 10000;\n\t\t\tvar lid = tree_node.data.id;\n\t\t\tfor(i=0; i<node_sibs.length; i++){\n\t\t\t\tvar sid = pedigree_util.getNodeByName(flat_tree, node_sibs[i].name).data.id;\n\t\t\t\tif(sid < rid && sid > tree_node.data.id)\n\t\t\t\t\trid = sid;\n\t\t\t\tif(sid < lid)\n\t\t\t\t\tlid = sid;\n\t\t\t}\n\t\t\tvar add_lhs = (lid >= tree_node.data.id || (pid == lid && rid < 10000));\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\n\t\t\tvar midx;\n\t\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\n\t\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\n\t\t\t\tmidx = pedigree_util.getIdxByName(dataset, node.father);\n\t\t\telse\n\t\t\t\tmidx = pedigree_util.getIdxByName(dataset, node.mother);\n\n\t\t\tvar parent = dataset[midx];\n\t\t\tfather = ptree.addsibling(dataset, parent, 'M', add_lhs);\n\t\t\tmother = ptree.addsibling(dataset, parent, 'F', add_lhs);\n\n\t\t\tvar faidx = pedigree_util.getIdxByName(dataset, father.name);\n\t\t\tvar moidx = pedigree_util.getIdxByName(dataset, mother.name);\n\t\t\tif(faidx > moidx) {                   // switch to ensure father on lhs of mother\n\t\t\t\tvar tmpfa = dataset[faidx];\n\t\t\t\tdataset[faidx] = dataset[moidx];\n\t\t\t\tdataset[moidx] = tmpfa;\n\t\t\t}\n\n\t\t\tvar orphans = pedigree_util.getAdoptedSiblings(dataset, node);\n\t\t\tvar nid = tree_node.data.id;\n\t\t\tfor(i=0; i<orphans.length; i++){\n\t\t\t\tvar oid = pedigree_util.getNodeByName(flat_tree, orphans[i].name).data.id;\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\n\t\t\t\tif((add_lhs || nid < oid) && oid < rid){\n\t\t\t\t\tvar oidx = pedigree_util.getIdxByName(dataset, orphans[i].name);\n\t\t\t\t\tdataset[oidx].mother = mother.name;\n\t\t\t\t\tdataset[oidx].father = father.name;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif(depth == 2) {\n\t\t\tmother.top_level = true;\n\t\t\tfather.top_level = true;\n\t\t} else if(depth > 2) {\n\t\t\tmother.noparents = true;\n\t\t\tfather.noparents = true;\n\t\t}\n\t\tvar idx = pedigree_util.getIdxByName(dataset, node.name);\n\t\tdataset[idx].mother = mother.name;\n\t\tdataset[idx].father = father.name;\n\t\tdelete dataset[idx].noparents;\n\n\t\tif('parent_node' in node) {\n\t\t\tvar ptr_node = dataset[pedigree_util.getIdxByName(dataset, ptr_name)];\n\t\t\tif('noparents' in ptr_node) {\n\t\t\t\tptr_node.mother = mother.name;\n\t\t\t\tptr_node.father = father.name;\n\t\t\t}\n\t\t}\n\t};\n\n\t// add partner\n\tptree.addpartner = function(opts, dataset, name) {\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar flat_tree = pedigree_util.flatten(root);\n\t\tvar tree_node = pedigree_util.getNodeByName(flat_tree, name);\n\n\t\tvar partner = ptree.addsibling(dataset, tree_node.data, tree_node.data.sex === 'F' ? 'M' : 'F', tree_node.data.sex === 'F');\n\t\tpartner.noparents = true;\n\n\t\tvar child = {\"name\": ptree.makeid(4), \"sex\": \"M\"};\n\t\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\n\t\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\n\n\t\tvar idx = pedigree_util.getIdxByName(dataset, tree_node.data.name)+2;\n\t\tdataset.splice(idx, 0, child);\n\t};\n\n\t// get adjacent nodes at the same depth\n\tfunction adjacent_nodes(root, node, excludes) {\n\t\tvar dnodes = pedigree_util.getNodesAtDepth(pedigree_util.flatten(root), node.depth, excludes);\n\t\tvar lhs_node, rhs_node;\n\t\tfor(var i=0; i<dnodes.length; i++) {\n\t\t\tif(dnodes[i].x < node.x)\n\t\t\t\tlhs_node = dnodes[i];\n\t\t\tif(!rhs_node && dnodes[i].x > node.x)\n\t\t\t\trhs_node = dnodes[i];\n\t\t}\n\t\treturn [lhs_node, rhs_node];\n\t}\n\n\t// delete a node and descendants\n\tptree.delete_node_dataset = function(dataset, node, opts, onDone) {\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar fnodes = pedigree_util.flatten(root);\n\t\tvar deletes = [];\n\t\tvar i, j;\n\n\t\t// get d3 data node\n\t\tif(node.id === undefined) {\n\t\t\tvar d3node = pedigree_util.getNodeByName(fnodes, node.name);\n\t\t\tif(d3node !== undefined)\n\t\t\t\tnode = d3node.data;\n\t\t}\n\n\t\tif(node.parent_node) {\n\t\t\tfor(i=0; i<node.parent_node.length; i++){\n\t\t\t\tvar parent = node.parent_node[i];\n\t\t\t\tvar ps = [pedigree_util.getNodeByName(dataset, parent.mother.name),\n\t\t\t\t\t      pedigree_util.getNodeByName(dataset, parent.father.name)];\n\t\t\t\t// delete parents\n\t\t\t\tfor(j=0; j<ps.length; j++) {\n\t\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\n\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, ps[j].name), 1);\n\t\t\t\t\t\tdeletes.push(ps[j]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvar children = parent.children;\n\t\t\t\tvar children_names = $.map(children, function(p, i){return p.name;});\n\t\t\t\tfor(j=0; j<children.length; j++) {\n\t\t\t\t\tvar child = pedigree_util.getNodeByName(dataset, children[j].name);\n\t\t\t\t\tif(child){\n\t\t\t\t\t\tchild.noparents = true;\n\t\t\t\t\t\tvar ptrs = get_partners(dataset, child);\n\t\t\t\t\t\tvar ptr;\n\t\t\t\t\t\tif(ptrs.length > 0)\n\t\t\t\t\t\t\tptr = pedigree_util.getNodeByName(dataset, ptrs[0]);\n\t\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\n\t\t\t\t\t\t\tchild.mother = ptr.mother;\n\t\t\t\t\t\t\tchild.father = ptr.father;\n\t\t\t\t\t\t} else if(ptr) {\n\t\t\t\t\t\t\tvar child_node  = pedigree_util.getNodeByName(fnodes, child.name);\n\t\t\t\t\t\t\tvar adj = adjacent_nodes(root, child_node, children_names);\n\t\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\n\t\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, child.name), 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, node.name), 1);\n\t\t}\n\n\t\t// delete ancestors\n\t\tconsole.log(deletes);\n\t\tfor(i=0; i<deletes.length; i++) {\n\t\t\tvar del = deletes[i];\n\t\t\tvar sibs = pedigree_util.getAllSiblings(dataset, del);\n\t\t\tconsole.log('DEL', del.name, sibs);\n\t\t\tif(sibs.length < 1) {\n\t\t\t\tconsole.log('del sibs', del.name, sibs);\n\t\t\t\tvar data_node  = pedigree_util.getNodeByName(fnodes, del.name);\n\t\t\t\tvar ancestors = data_node.ancestors();\n\t\t\t\tfor(j=0; j<ancestors.length; j++) {\n\t\t\t\t\tconsole.log(ancestors[i]);\n\t\t\t\t\tif(ancestors[j].data.mother){\n\t\t\t\t\t\tconsole.log('DELETE ', ancestors[j].data.mother, ancestors[j].data.father);\n\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, ancestors[j].data.mother.name), 1);\n\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, ancestors[j].data.father.name), 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// check integrity of mztwins settings\n\t\tcheckTwins(dataset);\n\n\t\ttry\t{\n\t\t\t// validate new pedigree dataset\n\t\t\tvar newopts = $.extend({}, opts);\n\t\t\tnewopts.dataset = ptree.copy_dataset(dataset);\n\t\t\tptree.validate_pedigree(newopts);\n\t\t\t// check if pedigree is split\n\t\t\tvar unconnected = ptree.unconnected(dataset);\n\t\t} catch(err) {\n\t\t\tutils.messages('Warning', 'Deletion of this pedigree member is disallowed.')\n\t\t\tthrow err;\n\t\t}\n\t\tif(unconnected.length > 0) {\n\t\t\t// check & warn only if this is a new split\n\t\t\tif(ptree.unconnected(opts.dataset).length === 0) {\n\t\t\t\tconsole.error(\"individuals unconnected to pedigree \", unconnected);\n\t\t\t\tutils.messages(\"Warning\", \"Deleting this will split the pedigree. Continue?\", onDone, opts, dataset);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif(onDone) {\n\t\t\tonDone(opts, dataset);\n\t\t}\n\t\treturn dataset;\n\t};\n\n\tptree.makeid = function(len) {\n\t    var text = \"\";\n\t    var possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n\t    for( var i=0; i < len; i++ )\n\t        text += possible.charAt(Math.floor(Math.random() * possible.length));\n\t    return text;\n\t};\n\n}(window.ptree = window.ptree || {}, jQuery));\n","\n// pedigree form\n(function(pedigree_form, $, undefined) {\n\n\t$(\"#select_all_gene_tests\").on('change', function (e) {\n\t    if(this.value === \"S\") {\n\t    \t// select all mutation search to be negative\n\t    \t$(\"#gene_test\").find(\"select[name$='_gene_test']\").val(\"S\").change();\n\t\t\t$(\"#gene_test\").find(\"select[name$='_gene_test_result']\").val(\"N\").change();\n\t    } else if(this.value === \"T\") {\n\t    \t// select all direct gene tests to be negative\n\t    \t$(\"#gene_test\").find(\"select[name$='_gene_test']\").val(\"T\").change();\n\t\t\t$(\"#gene_test\").find(\"select[name$='_gene_test_result']\").val(\"N\").change();\n\t    } else if(this.value === \"N\") {\n\t    \t// select all gene tests to be negative\n\t    \t$(\"#gene_test\").find(\"select[name$='_gene_test_result']\").val(\"N\").change();\n\t    } else if(this.value === \"reset\") {\n\t    \t$(\"#gene_test\").find(\"select[name$='_gene_test']\").val(\"-\").change();\n\t    \t$(\"#gene_test\").find(\"select[name$='_gene_test_result']\").val(\"-\").change();\n\t    }\n\t});\n\n\t$('#acc_FamHist_div').on('click', '#id_proband, #id_exclude', function(e) {\n\t\tvar name = $('#id_name').val();\n\t\tif($(this).attr(\"id\") === 'id_proband' && $(this).is(':checked')) {\n\t\t\tvar msg = $(\"#proband_switch_dialog\").text();\n\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t    \t\ttitle: $(\"#proband_switch_dialog\").data(\"title\"),\n\t    \t\twidth: 350,\n\t    \t\tbuttons: [{\n\t    \t\t\t\ttext: $(\"#proband_switch_dialog\").data(\"continue\"),\n\t\t    \t\t    click: function() {\n\t\t    \t\t    \t$(this).dialog('close');\n\t\t\t                var dataset = pedcache.current(opts);\n\t\t\t                opts.dataset = ptree.copy_dataset(dataset);\n\t\t\t                pedigree_util.setProband(opts.dataset, name, true);\n\t\t\t                ptree.rebuild(opts);\n\t\t\t                reset_n_sync(opts);\n\t\t\t                $('#id_proband').prop(\"disabled\", true);\n\t\t    \t\t    }\n\t    \t\t\t},{\n\t\t    \t\t    text: $(\"#proband_switch_dialog\").data(\"cancel\"),\n\t\t    \t\t    click: function() {\n\t\t    \t\t    \t $(this).dialog('close');\n\t\t\t\t             $(\"#id_proband\").prop('checked', false);\n\t\t\t\t             $('#id_proband').prop(\"disabled\", false);\n\t\t    \t\t    }\n\t    \t\t\t}]\n\t\t\t});\n\t\t} else if($(this).attr(\"id\") === 'id_exclude') {\n\t\t\tvar dataset = pedcache.current(opts);\n            opts.dataset = ptree.copy_dataset(dataset);\n\t\t\tvar idx = pedigree_util.getIdxByName(opts.dataset, name);\n\t\t\tif($(this).is(':checked'))\n\t\t\t\topts.dataset[idx].exclude = true;\n\t\t\telse\n\t\t\t\tdelete opts.dataset[idx].exclude;\n\t\t\tptree.rebuild(opts);\n\t\t}\n\t});\n\n\tpedigree_form.update = function(opts) {\n\t\t$('.node_save').click(function() {\n\t\t\tpedigree_form.save(opts);\n\t\t});\n\n\t\t// advanced options - model parameters\n\t\t$(\"input[id$='_mut_sensitivity'], input[id$='_mut_frequency']\").prop('disabled', true);\n\t\t$('#id_use_custom_mutation_sensitivities').change(function() {\n\t\t\t$(\"input[id$='_mut_sensitivity']\").prop('disabled', !$(this).is(\":checked\"));\n\t\t});\n\n\t\t$('#id_mutation_frequencies').change(function() {\n\t\t\t$(\"input[id$='_mut_frequency']\").prop('disabled', (this.value !== 'Custom'));\n\t\t\t// note pedigree_form.mutation_frequencies is set in the view see pedigree_section_js.html\n\t\t\tif(pedigree_form.bc_mutation_frequencies && this.value !== 'Custom') {\n\t\t\t\tvar bcmfreq = pedigree_form.bc_mutation_frequencies[this.value];\n\t\t\t\tfor (var gene in bcmfreq)\n\t\t\t\t\t$('#id_'+gene.toLowerCase()+'_bc_mut_frequency').val(bcmfreq[gene]);\n\n\t\t\t\tvar obcmfreq = pedigree_form.oc_mutation_frequencies[this.value];\n\t\t\t\tfor (var gene in obcmfreq)\n\t\t\t\t\t$('#id_'+gene.toLowerCase()+'_oc_mut_frequency').val(obcmfreq[gene]);\n\t\t\t}\n\n\t\t\tif(this.value === 'Ashkenazi') {  // update canrisk FH radio settings\n\t\t\t\t$('#orig_ashk').prop( \"checked\", true );\n\t\t\t} else {\n\t\t\t\t$('#orig_unk').prop( \"checked\", true );\n\t\t\t}\n\t\t\tpedigree_form.save_ashkn(opts); // save ashkenazi updates\n\t\t});\n\t};\n\n\t// handle family history change events (undo/redo/delete)\n\t$(document).on('fhChange', function(e, opts){\n\t\ttry {\n\t\t\tvar id = $('#id_name').val();  // get name from hidden field\n\t\t\tvar node = pedigree_util.getNodeByName(pedcache.current(opts), id)\n\t\t\tif(node === undefined)\n\t\t\t\t$('form > fieldset').prop(\"disabled\", true);\n\t\t\telse\n\t\t\t\t$('form > fieldset').prop('disabled', false);\n\t\t} catch(err) {\n\t\t\tconsole.warn(err);\n\t\t}\n    })\n\n    // update status field and age label - 0 = alive, 1 = dead\n    pedigree_form.updateStatus = function(status) {\n\t\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\n\t\t(status == 1 ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\n\t\t$('#id_age_'+status).removeClass(\"hidden\");\n\t\t$('#id_age_'+(status == 1 ? '0' : '1')).addClass(\"hidden\");\n\t}\n\n\tpedigree_form.nodeclick = function(node) {\n\t\t$('form > fieldset').prop('disabled', false);\n\t\t// clear values\n\t\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\n\t\t$('#person_details select').val('').prop('selected', true);\n\n\t\t// assign values to input fields in form\n\t\tif(node.sex === 'M' || node.sex === 'F')\n\t\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\n\t\telse\n\t\t\t$('input[name=sex]').prop('checked', false);\n\t\tupdate_cancer_by_sex(node);\n\n\t\tif(!('status' in node))\n\t\t\tnode.status = 0;\n\t\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\n\t\t// show lock symbol for age and yob synchronisation\n\t\tpedigree_form.updateStatus(node.status);\n\n\t\tif('proband' in node) {\n\t\t\t$('#id_proband').prop('checked', node.proband);\n\t\t\t$('#id_proband').prop(\"disabled\", true);\n\t\t} else {\n\t\t\t$('#id_proband').prop('checked', false);\n\t\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\n\t\t}\n\n\t\tif('exclude' in node) {\n\t\t\t$('#id_exclude').prop('checked', node.exclude);\n\t\t} else {\n\t\t\t$('#id_exclude').prop('checked', false);\n\t\t}\n\n/*\t\tif('ashkenazi' in node) {\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\n\t\t} else {\n\t\t\t$('#id_ashkenazi').prop('checked', false);\n\t\t}*/\n\n\t\t// year of birth\n\t\tif('yob' in node) {\n\t\t\t$('#id_yob_0').val(node.yob);\n\t\t} else {\n\t\t\t$('#id_yob_0').val('-');\n\t\t}\n\n\t\t// clear pathology\n\t\t$('select[name$=\"_bc_pathology\"]').val('-');\n\t\t// clear gene tests\n\t\t$('select[name*=\"_gene_test\"]').val('-');\n\n\t\t// disable sex radio buttons if the person has a partner\n\t\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\n\n\t\t// disable pathology for male relatives (as not used by model)\n\t\t// and if no breast cancer age of diagnosis\n\t\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\n\t\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\n\n\t\t// approximate diagnosis age\n\t\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\n\t\tpedigree_form.update_diagnosis_age_widget();\n\n\t\tfor(var key in node) {\n\t\t\tif(key !== 'proband' && key !== 'sex') {\n\t\t\t\tif($('#id_'+key).length) {\t// input value\n\t\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\n\t\t\t\t\t\t$('#id_'+key).val(node[key].type);\n\t\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$('#id_'+key).val(node[key]);\n\t\t\t\t\t}\n\t\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\n\t\t\t\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\t$('#person_details').find('form').valid();\n\t\t} catch(err) {\n\t\t\tconsole.warn('valid() not found');\n\t\t}\n\t};\n\n\tfunction update_ashkn(newdataset) {\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\t\tif($('#orig_ashk').is(':checked')) {\n\t\t\t$.each(newdataset, function(i, p) {\n\t\t\t\tif(p.proband)\n\t\t\t\t\tp.ashkenazi = 1;\n\t\t\t});\n\t\t} else {\n\t\t\t$.each(newdataset, function(i, p) {\n\t\t\t\tdelete p.ashkenazi;\n\t\t\t});\n\t\t}\n\t}\n\n\t// Save Ashkenazi status\n\tpedigree_form.save_ashkn = function(opts) {\n\t\tvar dataset = pedcache.current(opts);\n\t\tvar newdataset = ptree.copy_dataset(dataset);\n\t\tupdate_ashkn(newdataset);\n\t\topts.dataset = newdataset;\n\t\tptree.rebuild(opts);\n\t}\n\n    pedigree_form.save = function(opts) {\n\t\tvar dataset = pedcache.current(opts);\n\t\tvar name = $('#id_name').val();\n\t\tvar newdataset = ptree.copy_dataset(dataset);\n\t\tvar person = pedigree_util.getNodeByName(newdataset, name);\n\t\tif(!person) {\n\t\t\tconsole.warn('person not found when saving details');\n\t\t\treturn;\n\t\t}\n\t\t$(\"#\"+opts.targetDiv).empty();\n\n\t\t// individual's personal and clinical details\n\t\tvar yob = $('#id_yob_0').val();\n\t\tif(yob && yob !== '') {\n\t\t\tperson.yob = yob;\n\t\t} else {\n\t\t\tdelete person.yob;\n\t\t}\n\n\t\t// current status: 0 = alive, 1 = dead\n\t\tvar status = $('#id_status').find(\"input[type='radio']:checked\");\n\t\tif(status.length > 0){\n\t\t\tperson.status = status.val();\n\t\t}\n\n\t\t// booleans switches\n\t\tvar switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\n\t\tfor(var iswitch=0; iswitch<switches.length; iswitch++){\n\t\t\tvar attr = switches[iswitch];\n\t\t\tvar s = $('#id_'+attr);\n\t\t\tif(s.length > 0){\n\t\t\t\tconsole.log(s.is(\":checked\"));\n\t\t\t\tif(s.is(\":checked\"))\n\t\t\t\t\tperson[attr] = true;\n\t\t\t\telse\n\t\t\t\t\tdelete person[attr];\n\t\t\t}\n\t\t}\n\n\t\t// current sex\n\t\tvar sex = $('#id_sex').find(\"input[type='radio']:checked\");\n\t\tif(sex.length > 0){\n\t\t\tperson.sex = sex.val();\n\t\t\tupdate_cancer_by_sex(person);\n\t\t}\n\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\t\tupdate_ashkn(newdataset);\n\n\t\tif($('#id_approx').is(':checked')) // approximate diagnosis age\n\t\t\tperson.approx_diagnosis_age = true;\n\t\telse\n\t\t\tdelete person.approx_diagnosis_age;\n\n\t\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\n\t\t\tvar name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\n\n\t\t\tif($(this).val()) {\n\t\t\t\tvar val = $(this).val();\n\t\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\n\t\t\t\t\tval = round5(val);\n\t\t\t\tperson[name] = val;\n\t\t\t} else {\n\t\t\t\tdelete person[name];\n\t\t\t}\n        });\n\n\t\t// cancer checkboxes\n\t\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\n\t\t\tif(this.checked)\n\t\t\t\tperson[$(this).attr('name')] = true;\n\t\t\telse\n\t\t\t\tdelete person[$(this).attr('name')];\n\t\t});\n\n\t\t// pathology tests\n\t\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\n\t\t\tif($(this).val() !== '-') {\n\t\t\t\tperson[$(this).attr('name')] = $(this).val();\n\t\t\t} else {\n\t\t\t\tdelete person[$(this).attr('name')];\n\t\t\t}\n\t\t});\n\n\t\t// genetic tests\n\t\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\n\t\t\tif($(this).val() !== '-') {\n\t\t\t\tvar tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\n\t\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\n\t\t\t} else {\n\t\t\t\tdelete person[$(this).attr('name')];\n\t\t\t}\n\t\t});\n\n\t\ttry {\n\t\t\t$('#person_details').find('form').valid();\n\t\t} catch(err) {\n\t\t\tconsole.warn('valid() not found');\n\t\t}\n\n\t\tptree.syncTwins(newdataset, person);\n\t\topts.dataset = newdataset;\n\t\tptree.rebuild(opts);\n    };\n\n    pedigree_form.update_diagnosis_age_widget = function() {\n\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t$(\"[id$='_diagnosis_age_0']\").each(function( index ) {\n\t\t\t\tif($(this).val() !== '') {\n\t\t\t\t\tvar name = this.name.substring(0, this.name.length-2);\n\t\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$(\"[id$='_diagnosis_age_0']\").hide();\n\t\t\t$(\"[id$='_diagnosis_age_1']\").show();\n\t\t} else {\n\t\t\t$(\"[id$='_diagnosis_age_1']\").each(function( index ) {\n\t\t\t\tif($(this).val() !== '') {\n\t\t\t\t\tvar name = this.name.substring(0, this.name.length-2);\n\t\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$(\"[id$='_diagnosis_age_0']\").show();\n\t\t\t$(\"[id$='_diagnosis_age_1']\").hide();\n\t\t}\n    };\n\n    // males should not have ovarian cancer and females should not have prostate cancer\n    function update_cancer_by_sex(node) {\n\t\t$('#cancer .row').show();\n\t\tif(node.sex === 'M') {\n\t\t\tdelete node.ovarian_cancer_diagnosis_age;\n\t\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\n\t\t} else if(node.sex === 'F') {\n\t\t\tdelete node.prostate_cancer_diagnosis_age;\n\t\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\n\t\t}\n    }\n\n    // round to 5, 15, 25, 35 ....\n    function round5(x1) {\n    \tvar x2 = (Math.round((x1-1) / 10) * 10);\n    \treturn (x1 < x2 ? x2 - 5 : x2 + 5);\n    }\n\n}(window.pedigree_form = window.pedigree_form || {}, jQuery));\n","//\n// undo, redo, reset buttons\n(function(pbuttons, $, undefined) {\n\n\tpbuttons.add = function(options) {\n\t\tvar opts = $.extend({\n            // defaults\n\t\t\tbtn_target: 'pedigree_history'\n        }, options );\n\n\t\tvar btns = [{\"fa\": \"fa-undo\", \"title\": \"undo\"},\n\t\t\t\t\t{\"fa\": \"fa-repeat\", \"title\": \"redo\"},\n\t\t\t\t\t{\"fa\": \"fa-refresh\", \"title\": \"reset\"},\n\t\t\t\t\t{\"fa\": \"fa-arrows-alt\", \"title\": \"fullscreen\"}];\n\t\tvar lis = \"\";\n\t\tfor(var i=0; i<btns.length; i++) {\n\t\t\tlis += '<li\">';\n\t\t\tlis += '&nbsp;<i class=\"fa fa-lg ' + btns[i].fa + '\" ' +\n\t\t\t               (btns[i].fa == \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : '') +\n\t\t\t               ' aria-hidden=\"true\" title=\"'+ btns[i].title +'\"></i>';\n\t\t\tlis += '</li>';\n\t\t}\n\t\t$( \"#\"+opts.btn_target ).append(lis);\n\t\tclick(opts);\n\t};\n\n\tpbuttons.is_fullscreen = function(){\n\t\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement);\n\t};\n\n\tfunction click(opts) {\n\t\t// fullscreen\n\t    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(e)  {\n\t\t\tvar local_dataset = pedcache.current(opts);\n\t    \tif (local_dataset !== undefined && local_dataset !== null) {\n\t    \t\topts.dataset = local_dataset;\n\t    \t}\n\t\t\tptree.rebuild(opts);\n\t    });\n\n\t\t$('#fullscreen').on('click', function(e) {\n\t\t\tif (!document.mozFullScreen && !document.webkitFullScreen) {\n\t\t\t\tvar target = $(\"#\"+opts.targetDiv)[0];\n\t\t\t\tif(target.mozRequestFullScreen)\n\t\t\t\t\ttarget.mozRequestFullScreen();\n\t\t\t    else\n\t\t\t    \ttarget.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);\n\t\t\t} else {\n\t\t\t\tif(document.mozCancelFullScreen)\n\t\t\t        document.mozCancelFullScreen();\n\t\t\t    else\n\t\t\t    \tdocument.webkitCancelFullScreen();\n\t\t\t}\n\t\t});\n\n\t\t// undo/redo/reset\n\t\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\n\t\t\te.stopPropagation();\n\t\t\tif($(e.target).hasClass(\"disabled\"))\n\t\t\t\treturn false;\n\n\t\t\tif($(e.target).hasClass('fa-undo')) {\n\t\t\t\topts.dataset = pedcache.previous(opts);\n\t\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t\tptree.build(opts);\n\t\t\t} else if ($(e.target).hasClass('fa-repeat')) {\n\t\t\t\topts.dataset = pedcache.next(opts);\n\t\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t\tptree.build(opts);\n\t\t\t} else if ($(e.target).hasClass('fa-refresh')) {\n\t\t\t\t$('<div id=\"msgDialog\">Resetting the pedigree may result in loss of some data.</div>').dialog({\n\t\t\t\t\ttitle: 'Confirm Reset',\n\t\t\t\t\tresizable: false,\n\t\t\t\t\theight: \"auto\",\n\t\t\t\t\twidth: 400,\n\t\t\t\t\tmodal: true,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\tContinue: function() {\n\t\t\t\t\t    \tpbuttons.reset(opts, opts.keep_proband_on_reset);\n\t\t\t\t\t    \t$(this).dialog( \"close\" );\n\t\t\t\t\t\t},\n\t\t\t\t\t\tCancel: function() {\n\t\t\t\t\t\t\t$(this).dialog( \"close\" );\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t    }\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\t// trigger fhChange event\n\t\t\t$(document).trigger('fhChange', [opts]);\n\t\t});\n\t}\n\n\t// reset pedigree and clear the history\n\tpbuttons.reset = function(opts, keep_proband) {\n\t\tif(keep_proband) {\n\t\t\tvar local_dataset = pedcache.current(opts);\n\t\t\tvar newdataset =  ptree.copy_dataset(local_dataset);\n\t\t\tvar proband = newdataset[pedigree_util.getProbandIndex(newdataset)];\n\t\t\t//var children = pedigree_util.getChildren(newdataset, proband);\n\t\t\tproband.name = \"ch1\";\n\t\t\tproband.mother = \"f21\";\n\t\t\tproband.father = \"m21\";\n\t\t\t// clear pedigree data but keep proband data and risk factors\n\t\t\tpedcache.clear_pedigree_data(opts)\n\t\t} else {\n\t\t\tvar proband = {\n\t\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"\n\t\t\t};\n\t\t\tpedcache.clear(opts); // clear all storage data\n\t\t}\n\n\t\tdelete opts.dataset;\n\n\t\tvar selected = $(\"input[name='default_fam']:checked\");\n\t\tif(selected.length > 0 && selected.val() == 'extended2') {    // secondary relatives\n        \topts.dataset = [\n        \t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\n        \t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\n        \t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\n        \t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\n        \t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\n        \t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\n        \t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\n        \t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\n        \t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n        \t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n        \t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n        \t\tproband,\n        \t\t//{\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"},\n        \t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n        \t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\n        \t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\n        \t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"}];\n\t\t} else if(selected.length > 0 && selected.val() == 'extended1') {    // primary relatives\n\t\t\topts.dataset = [\n\t\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\n\t\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\n\t\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\t\tproband,\n\t\t\t\t//{\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"},\n\t\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"}];\n\t\t} else {\n\t\t\topts.dataset = [\n\t\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n    \t\t    {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n    \t\t    proband];\n    \t\t\t//{\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}];\n\t\t}\n\t\tptree.rebuild(opts);\n\t}\n\n\tpbuttons.updateButtons = function(opts) {\n\t\tvar current = pedcache.get_count(opts);\n\t\tvar nstore = pedcache.nstore(opts);\n\t\tvar id = \"#\"+opts.btn_target;\n\t\tif(nstore <= current)\n\t\t\t$(id+\" .fa-repeat\").addClass('disabled');\n\t\telse\n\t\t\t$(id+\" .fa-repeat\").removeClass('disabled');\n\n\t\tif(current > 1)\n\t\t\t$(id+\" .fa-undo\").removeClass('disabled');\n\t\telse\n\t\t\t$(id+\" .fa-undo\").addClass('disabled');\n\t};\n}(window.pbuttons = window.pbuttons || {}, jQuery));\n\n//\n//store a history of pedigree\n(function(pedcache, $, undefined) {\n\tvar count = 0;\n\tvar max_limit = 25;\n\tvar dict_cache = {};\n\n\t// test if browser storage is supported\n\tfunction has_browser_storage(opts) {\n\t    try {\n\t    \tif(opts.store_type === 'array')\n\t    \t\treturn false;\n\n\t    \tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\n\t    \t\treturn false;\n\n\t    \tvar mod = 'test';\n\t        localStorage.setItem(mod, mod);\n\t        localStorage.removeItem(mod);\n\t        return true;\n\t    } catch(e) {\n\t        return false;\n\t    }\n\t}\n\n\tfunction get_prefix(opts) {\n\t\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\n\t}\n\n\t// use dict_cache to store cache as an array\n\tfunction get_arr(opts) {\n\t\treturn dict_cache[get_prefix(opts)];\n\t}\n\n\tfunction get_browser_store(opts, item) {\n\t\tif(opts.store_type === 'local')\n\t\t\treturn localStorage.getItem(item);\n\t\telse\n\t\t\treturn sessionStorage.getItem(item);\n\t}\n\n\tfunction set_browser_store(opts, name, item) {\n\t\tif(opts.store_type === 'local')\n\t\t\treturn localStorage.setItem(name, item);\n\t\telse\n\t\t\treturn sessionStorage.setItem(name, item);\n\t}\n\n\t// clear all storage items\n\tfunction clear_browser_store(opts) {\n\t\tif(opts.store_type === 'local')\n\t\t\treturn localStorage.clear();\n\t\telse\n\t\t\treturn sessionStorage.clear();\n\t}\n\n\t// remove all storage items with keys that have the pedigree history prefix\n\tpedcache.clear_pedigree_data = function(opts) {\n\t\tvar prefix = get_prefix(opts);\n\t\tvar store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\t\tvar items = [];\n\t\tfor(var i = 0; i < store.length; i++){\n\t\t\tif(store.key(i).indexOf(prefix) == 0)\n\t\t\t\titems.push(store.key(i));\n\t\t}\n\t\tfor(var i = 0; i < items.length; i++)\n\t\t\tstore.removeItem(items[i]);\n\t}\n\n\tpedcache.get_count = function(opts) {\n\t\tvar count;\n\t\tif (has_browser_storage(opts))\n\t\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\n\t\telse\n\t\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\n\t\tif(count !== null && count !== undefined)\n\t\t\treturn count;\n\t\treturn 0;\n\t};\n\n\tfunction set_count(opts, count) {\n\t\tif (has_browser_storage(opts))\n\t\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\n\t\telse\n\t\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\n\t}\n\n\tpedcache.add = function(opts) {\n\t\tif(!opts.dataset)\n\t\t\treturn;\n\t\tvar count = pedcache.get_count(opts);\n\t\tif (has_browser_storage(opts)) {   // local storage\n\t\t\tset_browser_store(opts, get_prefix(opts)+count, JSON.stringify(opts.dataset));\n\t\t} else {   // TODO :: array cache\n\t\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\n\t\t\tmax_limit = 500;\n\t\t\tif(get_arr(opts) === undefined)\n\t\t\t\tdict_cache[get_prefix(opts)] = [];\n\t\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\n\t\t}\n\t\tif(count < max_limit)\n\t\t\tcount++;\n\t\telse\n\t\t\tcount = 0;\n\t\tset_count(opts, count);\n\t};\n\n\tpedcache.nstore = function(opts) {\n\t\tif(has_browser_storage(opts)) {\n\t\t\tfor(var i=max_limit; i>0; i--) {\n\t\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\n\t\t\t\t\treturn i;\n\t\t\t}\n\t\t} else {\n\t\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\n\t\t}\n\t\treturn -1;\n\t};\n\n\tpedcache.current = function(opts) {\n\t\tvar current = pedcache.get_count(opts)-1;\n\t\tif(current == -1)\n\t\t\tcurrent = max_limit;\n\t\tif(has_browser_storage(opts))\n\t\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\n\t\telse if(get_arr(opts))\n\t\t\treturn JSON.parse(get_arr(opts)[current]);\n\t};\n\n\tpedcache.last = function(opts) {\n\t\tif(has_browser_storage(opts)) {\n\t\t\tfor(var i=max_limit; i>0; i--) {\n\t\t\t\tvar it = get_browser_store(opts, get_prefix(opts)+(i-1));\n\t\t\t\tif(it !== null) {\n\t\t\t\t\tset_count(opts, i);\n\t\t\t\t\treturn JSON.parse(it);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tvar arr = get_arr(opts);\n\t\t\tif(arr)\n\t\t\t\treturn JSON.parse(arr(arr.length-1));\n\t\t}\n\t\treturn undefined;\n\t};\n\n\tpedcache.previous = function(opts, previous) {\n\t\tif(previous === undefined)\n\t\t\tprevious = pedcache.get_count(opts) - 2;\n\n\t\tif(previous < 0) {\n\t\t\tvar nstore = pedcache.nstore(opts);\n\t\t\tif(nstore < max_limit)\n\t\t\t\tprevious = nstore - 1;\n\t\t\telse\n\t\t\t\tprevious = max_limit - 1;\n\t\t}\n\t\tset_count(opts, previous + 1);\n\t\tif(has_browser_storage(opts))\n\t\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\n\t\telse\n\t\t\treturn JSON.parse(get_arr(opts)[previous]);\n\t};\n\n\tpedcache.next = function(opts, next) {\n\t\tif(next === undefined)\n\t\t\tnext = pedcache.get_count(opts);\n\t\tif(next >= max_limit)\n\t\t\tnext = 0;\n\n\t\tset_count(opts, parseInt(next) + 1);\n\t\tif(has_browser_storage(opts))\n\t\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\n\t\telse\n\t\t\treturn JSON.parse(get_arr(opts)[next]);\n\t};\n\n\tpedcache.clear = function(opts) {\n\t\tif(has_browser_storage(opts))\n\t\t\tclear_browser_store(opts);\n\t\tdict_cache = {};\n\t};\n\n\t// zoom - store translation coords\n\tpedcache.setposition = function(opts, x, y, zoom) {\n\t\tif(has_browser_storage(opts)) {\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\n\t\t\tif(zoom)\n\t\t\t\tset_browser_store(opts, get_prefix(opts)+'_ZOOM', zoom);\n\t\t} else {\n\t\t\t//TODO\n\t\t}\n\t};\n\n\tpedcache.getposition = function(opts) {\n\t\tif(!has_browser_storage(opts) ||\n\t\t\t(localStorage.getItem(get_prefix(opts)+'_X') === null &&\n\t\t\t sessionStorage.getItem(get_prefix(opts)+'_X') === null))\n\t\t\treturn [null, null];\n\t\tvar pos = [parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\n\t\t\t   \t   parseInt(get_browser_store(opts, get_prefix(opts)+'_Y'))];\n\t\tif(get_browser_store(get_prefix(opts)+'_ZOOM') !== null)\n\t\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\n\t\treturn pos;\n\t};\n\n}(window.pedcache = window.pedcache || {}, jQuery));\n","\n// pedigree widgets\n(function(widgets, $, undefined) {\n\n\tfunction getTranslation(transform) {\n    \t  // Create a dummy g for calculation purposes only. This will never\n    \t  // be appended to the DOM and will be discarded once this function\n    \t  // returns.\n    \t  var g = document.createElementNS(\"http://www.w3.org/2000/svg\", \"g\");\n\n    \t  // Set the transform attribute to the provided string value.\n    \t  g.setAttributeNS(null, \"transform\", transform);\n\n    \t  // consolidate the SVGTransformList containing all transformations\n    \t  // to a single SVGTransform of type SVG_TRANSFORM_MATRIX and get\n    \t  // its SVGMatrix.\n    \t  var matrix = g.transform.baseVal.consolidate().matrix;\n\n    \t  // As per definition values e and f are the ones for the translation.\n    \t  return [matrix.e, matrix.f];\n    \t}\n\n\tvar dragging;\n\tvar last_mouseover;\n\t//\n\t// Add widgets to nodes and bind events\n    widgets.addWidgets = function(opts, node) {\n\n    \t// popup gender selection box\n    \tvar font_size = parseInt($(\"body\").css('font-size'));\n    \tvar popup_selection = d3.select('.diagram');\n    \tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\n    \t\t\t\t\t\t\t.attr(\"rx\", 6)\n    \t\t\t\t\t\t\t.attr(\"ry\", 6)\n    \t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n    \t\t\t\t\t\t\t.style(\"opacity\", 0)\n    \t\t\t\t\t\t\t.attr(\"width\",  font_size*7.9)\n    \t\t\t\t\t\t\t.attr(\"height\", font_size*2)\n    \t\t\t\t\t\t\t.style(\"stroke\", \"darkgrey\")\n    \t\t\t\t\t\t\t.attr(\"fill\", \"white\");\n\n\t\tvar square = popup_selection.append(\"text\")  // male\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-size', '1.em' )\n\t\t\t.attr(\"class\", \"popup_selection fa-lg fa-square persontype\")\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"x\", font_size/3)\n\t\t\t.attr(\"y\", font_size*1.5)\n\t\t\t.text(\"\\uf096 \");\n\t\tvar square_title = square.append(\"svg:title\").text(\"add male\");\n\n\t\tvar circle = popup_selection.append(\"text\")  // female\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-size', '1.em' )\n\t\t\t.attr(\"class\", \"popup_selection fa-lg fa-circle persontype\")\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"x\", font_size*1.7)\n\t\t\t.attr(\"y\", font_size*1.5)\n\t\t\t.text(\"\\uf10c \");\n\t\tvar circle_title = circle.append(\"svg:title\").text(\"add female\");\n\n\t\tvar unspecified = popup_selection.append(\"text\")  // unspecified\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-size', '1.em' )\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"class\", \"popup_selection fa-lg fa-unspecified popup_selection_rotate45 persontype\")\n\t\t\t.text(\"\\uf096 \");\n\t\tvar unspecified_title = unspecified.append(\"svg:title\").text(\"add unspecified\");\n\n\t\tvar dztwin = popup_selection.append(\"text\")  // dizygotic twins\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"class\", \"popup_selection fa-2x fa-angle-up persontype dztwin\")\n\t\t\t.attr(\"x\", font_size*4.6)\n\t\t\t.attr(\"y\", font_size*1.5)\n\t\t\t.text(\"\\uf106 \");\n\t\tvar dztwin_title = dztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\n\n\t\tvar mztwin = popup_selection.append(\"text\")  // monozygotic twins\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"class\", \"popup_selection fa-2x fa-caret-up persontype mztwin\")\n\t\t.attr(\"x\", font_size*6.2)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf0d8\");\n\t\tvar mztwin_title = mztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\n\n\t\tvar add_person = {};\n\t\t// click the person type selection\n\t\td3.selectAll(\".persontype\")\n\t\t  .on(\"click\", function () {\n\t\t\tvar newdataset = ptree.copy_dataset(pedcache.current(opts));\n\t\t\tvar mztwin = d3.select(this).classed(\"mztwin\");\n\t\t\tvar dztwin = d3.select(this).classed(\"dztwin\");\n\t\t\tvar twin_type;\n\t\t\tvar sex;\n\t\t\tif(mztwin || dztwin) {\n\t\t\t\tsex = add_person.node.datum().data.sex;\n\t\t\t\ttwin_type = (mztwin ? \"mztwin\" : \"dztwin\");\n\t\t\t} else {\n\t\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\n\t\t\t}\n\n\t\t\tif(add_person.type === 'addsibling')\n\t\t\t\tptree.addsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\n\t\t\telse if(add_person.type === 'addchild')\n\t\t\t\tptree.addchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\n\t\t\telse\n\t\t\t\treturn;\n\t\t\topts.dataset = newdataset;\n\t\t\tptree.rebuild(opts);\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\t\tadd_person = {};\n\t\t  })\n\t\t  .on(\"mouseover\", function() {\n\t\t\t  if(add_person.node)\n\t\t\t\t  add_person.node.select('rect').style(\"opacity\", 0.2);\n\t\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t\t  // add tooltips to font awesome widgets\n\t\t\t  if(add_person.type === 'addsibling'){\n\t\t\t\t if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t\t  square_title.text(\"add brother\");\n\t\t\t\t  else\n\t\t\t\t\t  circle_title.text(\"add sister\");\n\t\t\t  } else if(add_person.type === 'addchild'){\n\t\t\t\t  if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t\t  square_title.text(\"add son\");\n\t\t\t\t  else\n\t\t\t\t\t  circle_title.text(\"add daughter\");\n\t\t\t  }\n\t\t  });\n\n\t\t// handle mouse out of popup selection\n\t\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\n\t\t\t// hide rect and popup selection\n\t\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) == -1)\n\t\t\t\tadd_person.node.select('rect').style(\"opacity\", 0);\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\t});\n\n\n\t\t// drag line between nodes to create partners\n\t\tdrag_handle(opts);\n\n\t\t// rectangle used to highlight on mouse over\n\t\tnode.append(\"rect\")\n\t\t\t.filter(function (d) {\n\t\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\n\t\t\t})\n\t\t\t.attr(\"class\", 'indi_rect')\n\t\t\t.attr(\"rx\", 6)\n\t\t\t.attr(\"ry\", 6)\n\t\t\t.attr(\"x\", function(d) { return - 0.75*opts.symbol_size; })\n\t\t\t.attr(\"y\", function(d) { return - opts.symbol_size; })\n\t\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\n\t\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\n\t\t\t.style(\"stroke\", \"black\")\n\t\t\t.style(\"stroke-width\", 0.7)\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr(\"fill\", \"lightgrey\");\n\n\t\t// widgets\n\t\tvar fx = function(d) {return off - 0.75*opts.symbol_size;};\n\t\tvar fy = opts.symbol_size -2;\n\t\tvar off = 0;\n\t\tvar widgets = {\n\t\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\n\t\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\n\t\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\n\t\t\t'addparents': {\n\t\t\t\t'text': '\\uf062', 'title': 'add parents',\n\t\t\t\t'fx': - 0.75*opts.symbol_size,\n\t\t\t\t'fy': - opts.symbol_size + 11\n\t\t\t},\n\t\t\t'delete': {\n\t\t\t\t'text': 'X', 'title': 'delete',\n\t\t\t\t'fx': opts.symbol_size/2 - 1,\n\t\t\t\t'fy': - opts.symbol_size + 12,\n\t\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\n\t\t\t}\n\t\t};\n\n\t\tif(opts.edit) {\n\t\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': -font_size/2+2, 'fy': -opts.symbol_size + 11};\n\t\t}\n\n\t\tfor(var key in widgets) {\n\t\t\tvar widget = node.append(\"text\")\n\t\t\t\t.filter(function (d) {\n\t\t\t    \treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\n\t\t\t    \t       !((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\n\t\t\t    \t       !(d.data.parent_node !== undefined && d.data.parent_node.length > 1 && key === 'addpartner') &&\n\t\t\t    \t       !(d.data.parent_node === undefined && key === 'addchild') &&\n\t\t\t    \t       !((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\n\t\t\t\t})\n\t\t\t\t.attr(\"class\", key)\n\t\t\t\t.style(\"opacity\", 0)\n\t\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t\t.attr(\"xx\", function(d){return d.x;})\n\t\t\t\t.attr(\"yy\", function(d){return d.y;})\n\t\t\t\t.attr(\"x\", widgets[key].fx)\n\t\t\t\t.attr(\"y\", widgets[key].fy)\n\t\t\t\t.attr('font-size', '0.9em' )\n\t\t\t\t.text(widgets[key].text);\n\n\t\t\tif('styles' in widgets[key])\n\t\t\t\tfor(var style in widgets[key].styles){\n\t\t\t\t\twidget.attr(style, widgets[key].styles[style]);\n\t\t\t\t}\n\n\t\t\twidget.append(\"svg:title\").text(widgets[key].title);\n\t\t\toff += 17;\n\t\t}\n\n\t\t// add sibling or child\n\t\td3.selectAll(\".addsibling, .addchild\")\n\t\t  .on(\"mouseover\", function () {\n\t\t\t  var type = d3.select(this).attr('class');\n\t\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\n\n\t\t\t  //var translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\n\t\t\t  var x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\n\t\t\t  var y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\n\t\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\n\t\t\t  d3.selectAll('.popup_selection_rotate45')\n\t\t\t  \t.attr(\"transform\", \"translate(\"+(x+3*font_size)+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\n\t\t  });\n\n\t\t// handle widget clicks\n\t\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\n\t\t  .on(\"click\", function () {\n\t\t\td3.event.stopPropagation();\n\t\t\tvar opt = d3.select(this).attr('class');\n\t\t\tvar d = d3.select(this.parentNode).datum();\n\t\t\tif(opts.DEBUG) {\n\t\t\t\tconsole.log(opt);\n\t\t\t}\n\n\t\t\tvar newdataset;\n\t\t\tif(opt === 'settings') {\n\t\t\t\tif(typeof opts.edit === 'function') {\n\t\t\t\t\topts.edit(opts, d);\n\t\t\t\t} else {\n\t\t\t\t\topenEditDialog(opts, d);\n\t\t\t\t}\n\t\t\t} else if(opt === 'delete') {\n\t\t\t\tnewdataset = ptree.copy_dataset(pedcache.current(opts));\n\t\t\t\tfunction onDone(opts, dataset) {\n\t\t\t\t\t// assign new dataset and rebuild pedigree\n\t\t\t\t\topts.dataset = dataset;\n\t\t\t\t\tptree.rebuild(opts);\n\t\t\t\t}\n\t\t\t\tptree.delete_node_dataset(newdataset, d.data, opts, onDone);\n\t\t\t} else if(opt === 'addparents') {\n\t\t\t\tnewdataset = ptree.copy_dataset(pedcache.current(opts));\n\t\t\t\topts.dataset = newdataset;\n\t\t\t\tptree.addparents(opts, newdataset, d.data.name);\n\t\t\t\tptree.rebuild(opts);\n\t\t\t} else if(opt === 'addpartner') {\n\t\t\t\tnewdataset = ptree.copy_dataset(pedcache.current(opts));\n\t\t\t\tptree.addpartner(opts, newdataset, d.data.name);\n\t\t\t\topts.dataset = newdataset;\n\t\t\t\tptree.rebuild(opts);\n\t\t\t}\n\t\t\t// trigger fhChange event\n\t\t\t$(document).trigger('fhChange', [opts]);\n\t\t});\n\n\t\t// other mouse events\n\t\tvar highlight = [];\n\n\t\tnode.filter(function (d) { return !d.data.hidden; })\n\t\t.on(\"click\", function (d) {\n\t\t\tif (d3.event.ctrlKey) {\n\t\t\t\tif(highlight.indexOf(d) == -1)\n\t\t\t\t\thighlight.push(d);\n\t\t\t\telse\n\t\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\n\t\t\t} else\n\t\t\t\thighlight = [d];\n\n\t\t\tif('nodeclick' in opts) {\n\t\t\t\topts.nodeclick(d.data);\n\t\t\t\td3.selectAll(\".indi_rect\").style(\"opacity\", 0);\n\t\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) != -1;}).style(\"opacity\", 0.5);\n\t\t\t}\n     \t})\n\t\t.on(\"mouseover\", function(d){\n\t\t\td3.event.stopPropagation();\n\t\t\tlast_mouseover = d;\n\t\t\tif(dragging) {\n\t\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\n\t\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\n\t\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 1);\n\t\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 0);\n\t\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\n\t\t})\n\t\t.on(\"mouseout\", function(d){\n\t\t\tif(dragging)\n\t\t\t\treturn;\n\n\t\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 0);\n\t\t\tif(highlight.indexOf(d) == -1)\n\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0);\n\t\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 1);\n\t\t\t// hide popup if it looks like the mouse is moving north\n\t        if(d3.mouse(this)[1] < 0.8*opts.symbol_size)\n\t        \td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t        if(!dragging) {\n\t        \t// hide popup if it looks like the mouse is moving north, south or west\n\t        \tif(Math.abs(d3.mouse(this)[1]) > 0.25*opts.symbol_size ||\n\t        \t   Math.abs(d3.mouse(this)[1]) < -0.25*opts.symbol_size ||\n\t        \t   d3.mouse(this)[0] < 0.2*opts.symbol_size){\n\t        \t\tsetLineDragPosition(0, 0, 0, 0);\n\t        \t}\n\t        }\n\t\t});\n\t};\n\n\t// drag line between nodes to create partners\n\tfunction drag_handle(opts) {\n\t\tvar line_drag_selection = d3.select('.diagram');\n\t\tvar dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\n\t        .attr(\"stroke-width\", 6)\n\t        .style(\"stroke-dasharray\", (\"2, 1\"))\n\t        .attr(\"stroke\",\"black\")\n\t        .call(d3.drag()\n\t                .on(\"start\", dragstart)\n\t                .on(\"drag\", drag)\n\t                .on(\"end\", dragstop));\n\t\tdline.append(\"svg:title\").text(\"drag to create consanguineous partners\");\n\n\t\tsetLineDragPosition(0, 0, 0, 0);\n\n\t\tfunction dragstart(d) {\n\t\t\td3.event.sourceEvent.stopPropagation();\n\t\t\tdragging = last_mouseover;\n\t\t\td3.selectAll('.line_drag_selection')\n\t\t\t\t.attr(\"stroke\",\"darkred\");\n\t\t}\n\n\t\tfunction dragstop(d) {\n\t\t\tif(last_mouseover &&\n\t\t\t   dragging.data.name !== last_mouseover.data.name &&\n\t\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\n\t\t\t\t// make partners\n\t\t\t\tvar child = {\"name\": ptree.makeid(4), \"sex\": 'U',\n\t\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\n\t\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\n\t\t\t\tnewdataset = ptree.copy_dataset(opts.dataset);\n\t\t\t\topts.dataset = newdataset;\n\n\t\t\t\tvar idx = pedigree_util.getIdxByName(opts.dataset, dragging.data.name)+1;\n\t\t\t\topts.dataset.splice(idx, 0, child);\n\t\t\t\tptree.rebuild(opts);\n\t\t\t}\n\t\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\t\td3.selectAll('.line_drag_selection')\n\t\t\t\t.attr(\"stroke\",\"black\");\n\t\t\tdragging = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tfunction drag(d) {\n\t\t\td3.event.sourceEvent.stopPropagation();\n\t\t\tvar dx = d3.event.dx;\n\t\t\tvar dy = d3.event.dy;\n            var xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\n            var ynew = parseFloat(d3.select(this).attr('y2'))+ dy;\n            setLineDragPosition(opts.symbol_size-10, 0, xnew, ynew);\n\t\t}\n\t}\n\n\tfunction setLineDragPosition(x1, y1, x2, y2, translate) {\n\t\tif(translate)\n\t\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\n\t\td3.selectAll('.line_drag_selection')\n\t    \t.attr(\"x1\", x1)\n\t    \t.attr(\"y1\", y1)\n\t    \t.attr(\"x2\", x2)\n\t        .attr(\"y2\", y2);\n\t}\n\n\tfunction capitaliseFirstLetter(string) {\n\t    return string.charAt(0).toUpperCase() + string.slice(1);\n\t}\n\n    // if opt.edit is set true (rather than given a function) this is called to edit node attributes\n    function openEditDialog(opts, d) {\n\t\t$('#node_properties').dialog({\n\t\t    autoOpen: false,\n\t\t    title: d.data.display_name,\n\t\t    width: ($(window).width() > 400 ? 450 : $(window).width()- 30)\n\t\t});\n\n\t\tvar table = \"<table id='person_details' class='table'>\";\n\n\t\ttable += \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\"+\n\t\t(d.data.name ? d.data.name : \"\")+\"></td></tr>\";\n\t\ttable += \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\"+\n\t\t\t\t(d.data.display_name ? d.data.display_name : \"\")+\"></td></tr>\";\n\n\t\ttable += \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value=\"+\n\t\t\t\t(d.data.age ? d.data.age : \"\")+\"></td></tr>\";\n\n\t\ttable += \"<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value=\"+\n\t\t\t(d.data.yob ? d.data.yob : \"\")+\"></td></tr>\";\n\n\t\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\n\t\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" '+(d.data.sex === 'M' ? \"checked\" : \"\")+'>Male</label>' +\n\t\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" '+(d.data.sex === 'F' ? \"checked\" : \"\")+'>Female</label>' +\n\t\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"U\">Unknown</label>' +\n\t\t\t\t '</td></tr>';\n\n\t\t// alive status = 0; dead status = 1\n\t\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\n\t\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" '+(parseInt(d.data.status) === 0 ? \"checked\" : \"\")+'>&thinsp;Alive</label>' +\n\t\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" '+(parseInt(d.data.status) === 1 ? \"checked\" : \"\")+'>&thinsp;Deceased</label>' +\n\t\t\t\t '</td></tr>';\n\t\t$(\"#id_status input[value='\"+d.data.status+\"']\").prop('checked', true);\n\n\t\t// switches\n\t\tvar switches = [\"adopted_in\", \"adopted_out\", \"miscarriage\", \"stillbirth\", \"termination\"];\n\t\ttable += '<tr><td colspan=\"2\"><strong>Reproduction:</strong></td></tr>';\n\t\ttable += '<tr><td colspan=\"2\">';\n\t\tfor(var iswitch=0; iswitch<switches.length; iswitch++){\n\t\t\tvar attr = switches[iswitch];\n\t\t\tif(iswitch === 2)\n\t\t\t\ttable += '</td></tr><tr><td colspan=\"2\">';\n\t\t\ttable +=\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"id_'+attr +\n\t\t\t    '\" name=\"'+attr+'\" value=\"0\" '+(d.data[attr] ? \"checked\" : \"\")+'>&thinsp;' +\n\t\t\t    capitaliseFirstLetter(attr.replace('_', ' '))+'</label>'\n\t\t}\n\t\ttable += '</td></tr>';\n\n\t\t//\n\t\tvar exclude = [\"children\", \"name\", \"parent_node\", \"top_level\", \"id\", \"noparents\",\n\t\t\t           \"level\", \"age\", \"sex\", \"status\", \"display_name\", \"mother\", \"father\",\n\t\t\t           \"yob\", \"mztwin\", \"dztwin\"];\n\t\t$.merge(exclude, switches);\n\t\ttable += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\n\t\t$.each(opts.diseases, function(k, v) {\n\t\t\texclude.push(v.type+\"_diagnosis_age\");\n\n\t\t\tvar disease_colour = '&thinsp;<span style=\"padding-left:5px;background:'+opts.diseases[k].colour+'\"></span>';\n\t\t\tvar diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\n\n\t\t\ttable += \"<tr><td style='text-align:right'>\"+capitaliseFirstLetter(v.type.replace(\"_\", \" \"))+\n\t\t\t\t\t\tdisease_colour+\"&nbsp;</td><td>\" +\n\t\t\t\t\t\t\"<input class='form-control' id='id_\" +\n\t\t\t\t\t\tv.type + \"_diagnosis_age_0' max='110' min='0' name='\" +\n\t\t\t\t\t\tv.type + \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\n\t\t\t\t\t\t(diagnosis_age !== undefined ? diagnosis_age : \"\") +\"'></td></tr>\";\n\t\t});\n\n\t\ttable += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\n\t\t$.each(d.data, function(k, v) {\n\t\t\tif($.inArray(k, exclude) == -1) {\n\t\t\t\tvar kk = capitaliseFirstLetter(k);\n\t\t\t\tif(v === true || v === false) {\n\t\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='checkbox' id='id_\" + k + \"' name='\" +\n\t\t\t\t\t\t\tk+\"' value=\"+v+\" \"+(v ? \"checked\" : \"\")+\"></td></tr>\";\n\t\t\t\t} else if(k.length > 0){\n\t\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='text' id='id_\" +\n\t\t\t\t\t\t\tk+\"' name='\"+k+\"' value=\"+v+\"></td></tr>\";\n\t\t\t\t}\n\t\t\t}\n\t    });\n\t\ttable += \"</table>\";\n\n\t\t$('#node_properties').html(table);\n\t\t$('#node_properties').dialog('open');\n\n\t\t//$('#id_name').closest('tr').toggle();\n\t\t$('#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]').change(function() {\n\t    \tpedigree_form.save(opts);\n\t    });\n\t\tpedigree_form.update(opts);\n\t\treturn;\n    }\n\n}(window.widgets = window.widgets || {}, jQuery));\n"]}