{"version":3,"sources":["../../js/io.js","../../js/pedigree.js","../../js/pedigree_form.js","../../js/undo_redo_refresh.js","../../js/widgets.js"],"names":["io","$","undefined","process_ped","ped","i","length","getLevel","name","max_level","level","pedigree_util","getDepth","top_level","noparents","pidx","getPartnerIdx","mother","father","j","sex","dataset","anode","bnode","getIdxByName","idx","update_parents_level","parents","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test","pathology_tests","add","opts","change","e","load","click","save","print","get_printable_svg","svg_download","svgData","wrapper","appendTo","svg","querySelector","window","XMLSerializer","serializeToString","xml","canvas","document","createElement","svgSize","getBoundingClientRect","width","height","ctx","getContext","img","setAttribute","btoa","unescape","encodeURIComponent","onload","drawImage","imgsrc","toDataURL","a","href","download","target","body","appendChild","removeChild","setTimeout","remove","copy_svg_html","svg_html","html","myRegexp","match","exec","val","replace","RegExp","ptree","makeid","local_dataset","pedcache","current","tree_dimensions","get_tree_dimensions","svg_div","targetDiv","find","parent","wid","hgt","scale","xscale","yscale","append","attr","ytransform","symbol_size","el","constructor","Array","cssFiles","printWindow","open","headContent","css","write","close","focus","content","JSON","stringify","DEBUG","console","log","uriContent","f","files","reader","FileReader","result","startsWith","readBoadiceaV4","parse","err","readLinkage","rebuild","onerror","event","error","code","readAsText","value","boadicea_lines","famid","lines","trim","split","map","indi","display_name","affected","alleles","unshift","status","proband","mztwin","age","yob","each","cancer","diagnosis_age","ashkenazi","warn","type","jQuery","updateParent","p","id","nodes","parent_node","push","twins","getMzTwins","twin","getNodeByName","setChildrenId","children","sort","b","contains_parent","arr","m","nodesOverlap","node","diff","root","descendants","descendantsNames","descendant","data","xnew","x","overlap","depth","buildTree","person","partnerLinks","getChildren","flatten","partners","child","merge","ptr","hidden","midx","fidx","gp","get_grandparents_idx","isProband","obj","setProband","is_proband","getProbandIndex","getSiblings","getAllSiblings","sibs","getAdoptedSiblings","getAllChildren","getNodesAtDepth","fnodes","exclude_names","inArray","linkNodes","flattenNodes","links","recurse","forEach","flat","adjust_coords","xmid","child1","child2","n","Math","abs","urlParam","results","location","gmidx","gfidx","print_opts","key","prefixInObj","prefix","found","k","indexOf","include_children","connected","combineArrays","get_partners","child_idx","arr1","arr2","check_ptr_links","ptrLinkNodes","clash","check_ptr_link_clashes","get_svg_dimensions","pbuttons","is_fullscreen","innerWidth","innerHeight","ptrs","group_top_level","top_level_seen","newdataset","getPx","emVal","parseInt","adiv","addLabel","size","fx","fy","ftext","class_label","filter","d","font_family","font_size","font_weight","text","setMzTwin","d1","d2","getUniqueTwinID","mz","splice","checkTwins","count","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","roots","build","options","zoomFn","t","d3","transform","pos","xtransform","y","setposition","extend","zoomIn","zoomOut","diseases","colour","labels","background","node_background","nstore","updateButtons","svg_dimensions","select","style","xytransform","getposition","zoom","hidden_root","hierarchy","treemap","tree","separation","vis_nodes","Error","unconnected","selectAll","enter","symbol","symbolCircle","symbolSquare","exclude","ncancers","pie","arc","innerRadius","outerRadius","ilab","label","y_offset","vars","ivar","disease","dis","widgets","addWidgets","clash_depth","insert","x1","x2","dy1","path","dx","parent_nodes","parent_node_name","ii","l","dy2","dx1","dx2","probandIdx","source","twinx","probandNode","scaleExtent","on","call","nconnect","has_parent","names","dy","maxscore","generation","score","max_depth","Object","keys","empty","templates","update","copy_dataset","disallowed","addchild","nchild","ptr_name","partner","addsibling","c","add_lhs","newbie","syncTwins","addparents","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","orphans","nid","oid","oidx","ptr_node","addpartner","delete_node_dataset","deletes","ps","children_names","child_node","adj","del","data_node","ancestors","confirm","len","possible","charAt","floor","random","pedigree_form","update_cancer_by_sex","show","ovarian_cancer_diagnosis_age","closest","hide","prostate_cancer_diagnosis_age","round5","round","this","is","prop","mutation_frequencies","mfreq","gene","toLowerCase","nodeclick","removeAttr","approx_diagnosis_age","update_diagnosis_age_widget","valid","substring","checked","tres","index","mozFullScreen","webkitFullScreen","mozCancelFullScreen","webkitCancelFullScreen","mozRequestFullScreen","webkitRequestFullScreen","Element","ALLOW_KEYBOARD_INPUT","btn_target","stopPropagation","hasClass","previous","next","clear","selected","btns","fa","title","lis","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","get_count","addClass","removeClass","has_local_storage","mod","localStorage","setItem","removeItem","store_type","get_prefix","get_arr","dict_cache","set_count","max_limit","getItem","last","it","parseFloat","drag_handle","dragstart","sourceEvent","dragging","last_mouseover","dragstop","setLineDragPosition","drag","y1","y2","translate","capitaliseFirstLetter","string","toUpperCase","slice","openEditDialog","dialog","autoOpen","table","v","disease_colour","kk","popup_selection","square","square_title","circle","circle_title","unspecified","add_person","classed","datum","highlight","off","delete","styles","font-weight","fill","font-family","edit","settings","widget","parentNode","opt","ctrlKey","mouse"],"mappings":"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","file":"pedigreejs.min.js","sourcesContent":["\n// pedigree I/O \n(function(io, $, undefined) {\n\n\t// cancers, genetic & pathology tests\n\tio.cancers = {\n\t\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\n\t\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\n\t\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\n\t\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\n\t\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\n\t\t};\n\tio.genetic_test = ['brca1', 'brca2', 'palb2', 'atm', 'chek2'];\n\tio.pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\n\t\n\t\n\tio.add = function(opts) {\n\t\t$('#load').change(function(e) {\n\t\t\tio.load(e, opts);\n\t\t});\n\n\t\t$('#save').click(function(e) {\n\t\t\tio.save(opts);\n\t\t});\n\n\t\t$('#print').click(function(e) {\n\t\t\tio.print(io.get_printable_svg(opts));\n\t\t});\n\n\t\t$('#svg_download').click(function(e) {\n\t\t\tio.svg_download(io.get_printable_svg(opts));\n\t\t});\n\n\t\t$('#png_download').click(function(e) {\n\t\t\tvar wrapper = $(io.get_printable_svg(opts)).appendTo('body')[0];\n\t\t\tvar svg = wrapper.querySelector(\"svg\");\n\t\t\tvar svgData;\n\t\t    if (typeof window.XMLSerializer != \"undefined\") {\n\t\t        svgData = (new XMLSerializer()).serializeToString(svg);\n\t\t    } else if (typeof svg.xml != \"undefined\") {\n\t\t        svgData = svg.xml;\n\t\t    }\n\n\t\t    var canvas = document.createElement(\"canvas\");\n\t\t    var svgSize = svg.getBoundingClientRect();\n\t\t    canvas.width = svgSize.width;\n\t\t    canvas.height = svgSize.height;\n\t\t    var ctx = canvas.getContext(\"2d\");\n\n\t\t    var img = document.createElement(\"img\");\n\t\t    img.setAttribute(\"src\", \"data:image/svg+xml;base64,\" + btoa(unescape(encodeURIComponent(svgData))) );\n\t\t    img.onload = function() {\n\t\t        ctx.drawImage(img, 0, 0);\n\t\t        var imgsrc = canvas.toDataURL(\"image/png\");\n\t\t\t\tvar a      = document.createElement('a');\n\t\t\t\ta.href     = imgsrc;\n\t\t\t\ta.download = 'plot.png';\n\t\t\t\ta.target   = '_blank';\n\t\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t\t        setTimeout(function() {\n\t\t        \twrapper.remove();\n\t\t        }, 200);\n\t\t    };\n\t\t});\n\t};\n\n\t// return a copy of svg html with unique url references (e.g. for clippath)\n\tio.copy_svg_html = function(opts) {\n    \tvar svg_html = io.get_printable_svg(opts).html();\n    \t// find all url's to make unique\n    \tvar myRegexp = /url\\(\\#(.*?)\\)/g;\n\t\tvar match = myRegexp.exec(svg_html);\n\t\twhile (match !== null) {\n\t\t\tvar val = match[1];  // replace all url id's with new unique id's\n\t\t\tsvg_html = svg_html.replace(new RegExp(val, 'g'), val+ptree.makeid(2));\n\t\t\tmatch = myRegexp.exec(svg_html);\n\t\t}\n\t\treturn svg_html;\n\t};\n\n\t// get printable svg div, adjust size to tree dimensions and scale to fit\n\tio.get_printable_svg = function(opts) {\n\t\tvar local_dataset = pedcache.current(opts); // get current dataset\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\t\topts.dataset = local_dataset;\n\t\t}\n\n\t\tvar tree_dimensions = ptree.get_tree_dimensions(opts);\n\t\tvar svg_div = $('#'+opts.targetDiv).find('svg').parent();\n\t\tif(opts.width < tree_dimensions.width || opts.height < tree_dimensions.height) {\n\t\t    var wid = tree_dimensions.width;\n\t\t    var hgt = tree_dimensions.height + 100;\n\t\t    var scale = 1.0;\n\n\t\t    if(tree_dimensions.width > 595 || tree_dimensions.height > 842) {   // scale to fit A4\n\t\t    \twid = 595;\n\t\t    \thgt = 842;\n\t\t    \tvar xscale = 595/tree_dimensions.width;\n\t\t    \tvar yscale = 842/tree_dimensions.height;\n\t\t    \tscale = (xscale < yscale ? xscale : yscale);\n\t\t    }\n\t\t\tsvg_div = $('<div></div>');  \t\t\t\t// create a new div\n\t\t\tsvg_div.append($('svg').parent().html());\t// copy svg html to new div\n\t\t    var svg = svg_div.find( \"svg\" );\n\t\t    svg.attr('width', wid);\t\t// adjust dimensions\n\t\t    svg.attr('height', hgt);\n\n\t\t    var ytransform = (-opts.symbol_size*1.5*scale);\n\t\t    svg.find(\".diagram\").attr(\"transform\", \"translate(0, \"+ytransform+\") scale(\"+scale+\")\");\n\t\t}\n\t\treturn svg_div;\n\t};\n\n\t// download the SVG to a file\n\tio.svg_download = function(svg){\n\t\tvar a      = document.createElement('a');\n\t\ta.href     = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svg.html() ) ) );\n\t\ta.download = 'plot.svg';\n\t\ta.target   = '_blank';\n\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t};\n\n\t// open print window for a given element\n\tio.print = function(el){\n        if(el.constructor !== Array)\n        \tel = [el];\n\n        var width = $(window).width()*2/3;\n        var height = $(window).height()-40;\n        var cssFiles = [\n        \t'/static/css/output.css',\n        \t'https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css'\n        ];\n        var printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\n        var headContent = '';\n        for(var i=0; i<cssFiles.length; i++)\n        \theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\n        headContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\n\n            /*var headContent2 = '';\n            var links = document.getElementsByTagName('link');\n            for(var i=0;i<links.length; i++) {\n            \tvar html = links[i].outerHTML;\n            \tif(html.indexOf('href=\"http') !== -1)\n            \t\theadContent2 += html;\n            }\n            headContent2 += html;          \n            var scripts = document.getElementsByTagName('script');\n            for(var i=0;i<scripts.length; i++) {\n            \tvar html = scripts[i].outerHTML;\n            \tif(html.indexOf('src=\"http') !== -1)\n            \t\theadContent += html;\n            }*/\n\n        html = \"\";\n        for(i=0; i<el.length; i++) {\n        \thtml += $(el[i]).html();\n        \tif(i < el.length-1)\n        \t\thtml += '<div style=\"page-break-before:always\"> </div>';\n        }\n\n        printWindow.document.write(headContent);\n        printWindow.document.write(html);\n        printWindow.document.close();\n\n        printWindow.focus();\n        setTimeout(function() {\n            printWindow.print();\n            printWindow.close();\n        }, 100);\n\t};\n\n\tio.save = function(opts){\n\t\tvar content = JSON.stringify(pedcache.current(opts));\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log(content);\n\t\tvar uriContent = \"data:application/csv;charset=utf-8,\" + encodeURIComponent(content);\n\t\twindow.open(uriContent, 'boadicea_pedigree');\n\t};\n\n\tio.load = function(e, opts) {\n\t    var f = e.target.files[0];\n\t\tif(f) {\n\t\t\tvar reader = new FileReader();\n\t\t\treader.onload = function(e) {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\tconsole.log(e.target.result);\n\n\t\t\t\tif(e.target.result.startsWith(\"BOADICEA import pedigree file format 4.0\"))\n\t\t\t\t\topts.dataset = io.readBoadiceaV4(e.target.result);\n\t\t\t\telse {\n\t\t\t\t\ttry {\n\t\t\t\t\t\topts.dataset = JSON.parse(e.target.result);\n\t\t\t\t\t} catch(err) {\n\t\t\t\t\t\topts.dataset = io.readLinkage(e.target.result);\n\t\t\t\t    }\n\t\t\t\t}\n\t\t\t\tconsole.log(opts.dataset);\n\t\t\t\tptree.rebuild(opts);\n\t\t\t};\n\t\t\treader.onerror = function(event) {\n\t\t\t    console.error(\"File could not be read! Code \" + event.target.error.code);\n\t\t\t};\n\t\t\treader.readAsText(f);\n\t\t} else {\n\t\t\tconsole.error(\"File could not be read!\");\n\t\t}\n\t\t$(\"#load\")[0].value = ''; // reset value\n\t};\n\n\t// \n\t// https://www.cog-genomics.org/plink/1.9/formats#ped\n\t// https://www.cog-genomics.org/plink/1.9/formats#fam\n\t//\t1. Family ID ('FID')\n\t//\t2. Within-family ID ('IID'; cannot be '0')\n\t//\t3. Within-family ID of father ('0' if father isn't in dataset)\n\t//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\n\t//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\n\t//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\n\t//  7. Genotypes (column 7 onwards);\n\t//     columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\n\tio.readLinkage = function(boadicea_lines) {\n\t\tvar lines = boadicea_lines.trim().split('\\n');\n\t\tvar ped = [];\n\t\tvar famid;\n\t\tfor(var i = 0;i < lines.length;i++){\n\t\t   var attr = $.map(lines[i].trim().split(/\\s+/), function(val, i){return val.trim();});\n\t\t   if(attr.length < 5)\n\t\t\t   throw('unknown format');\n\t\t   var sex = (attr[4] == '1' ? 'M' : (attr[4] == '2' ? 'F' : 'U'));\n\t\t   var indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[1],\n\t\t\t\t'sex': sex \n\t\t\t};\n\t\t\tif(attr[2] !== \"0\") indi.father = attr[2];\n\t\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\n\t\t\t\n\t\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\n\t\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(attr[5] == \"2\") indi.affected = 2;\n\t\t\t// add genotype columns\n\t\t\tif(attr.length > 6) {\n\t\t\t\tindi.alleles = \"\";\n\t\t\t\tfor(var j=6; j<attr.length; j+=2) {\n\t\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tped.unshift(indi);\n\t\t\tfamid = attr[0];\n\t\t}\n\t\treturn process_ped(ped);\n\t};\n\n\t// read boadicea format v4\n\tio.readBoadiceaV4 = function(boadicea_lines) {\n\t\tvar lines = boadicea_lines.trim().split('\\n');\n\t\tvar ped = [];\n\t\t// assumes two line header\n\t\tfor(var i = 2;i < lines.length;i++){\n\t\t   var attr = $.map(lines[i].trim().split(/\\s+/), function(val, i){return val.trim();});\n\t\t\tif(attr.length > 1) {\n\t\t\t\tvar indi = {\n\t\t\t\t\t'famid': attr[0],\n\t\t\t\t\t'display_name': attr[1],\n\t\t\t\t\t'name':\tattr[3],\n\t\t\t\t\t'sex': attr[6],\n\t\t\t\t\t'status': attr[8]\n\t\t\t\t};\n\t\t\t\tif(attr[2] == 1) indi.proband = true;\n\t\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\t\tvar idx = 11;\n\t\t\t\t$.each(io.cancers, function(cancer, diagnosis_age) {\n\t\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t\t}\n\t\t\t\t\tidx++;\n\t\t\t\t});\n\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\n\t\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\t\tfor(var j=0; j<io.genetic_test.length; j++) {\n\t\t\t\t\tidx+=2;\n\t\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\n\t\t\t\t\t\t\tindi[io.genetic_test[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\t\tfor(j=0; j<io.pathology_tests.length; j++) {\n\t\t\t\t\tif(attr[idx] !== '0') {\n\t\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\n\t\t\t\t\t\t\tindi[io.pathology_tests[j] + '_bc_pathology'] = attr[idx];\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +io.pathology_tests[j] + \" \" +attr[idx]);\n\t\t\t\t\t}\n\t\t\t\t\tidx++;\n\t\t\t\t}\n\t\t\t\tped.unshift(indi);\n\t\t\t}\n\t\t}\n\t\treturn process_ped(ped);\n\t};\n\n\tfunction process_ped(ped) {\n\t\t// find the level of individuals in the pedigree\n\t\tfor(var i=0;i<ped.length;i++) {\n\t\t\tgetLevel(ped, ped[i].name);\n\t\t}\n\n\t\t// find the max level (i.e. top_level)\n\t\tvar max_level = 0;\n\t\tfor(i=0;i<ped.length;i++) {\n\t\t\tif(ped[i].level && ped[i].level > max_level)\n\t\t\t\tmax_level = ped[i].level;\n\t\t}\n\n\t\t// identify top_level and other nodes without parents\n\t\tfor(i=0;i<ped.length;i++) {\n\t\t\tif(pedigree_util.getDepth(ped, ped[i].name) == 1) {\n\t\t\t\tif(ped[i].level && ped[i].level == max_level) {\n\t\t\t\t\tped[i].top_level = true;\n\t\t\t\t} else {\n\t\t\t\t\tped[i].noparents = true;\n\n\t\t\t\t\t// 1. look for partners parents\n\t\t\t\t\tvar pidx = getPartnerIdx(ped, ped[i]);\n\t\t\t\t\tif(pidx > -1) {\n\t\t\t\t\t\tif(ped[pidx].mother) {\n\t\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\n\t\t\t\t\t\t\tped[i].father = ped[pidx].father;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// 2. or adopt parents from level above\n\t\t\t\t\tif(!ped[i].mother){\n\t\t\t\t\t\tfor(var j=0; j<ped.length; j++) {\n\t\t\t\t\t\t\tif(ped[i].level == (ped[j].level-1)) {\n\t\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\n\t\t\t\t\t\t\t\tif(pidx > -1) {\n\t\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdelete ped[i].top_level;\n\t\t\t}\n\t\t}\n\t\treturn ped;\n\t}\n\n\t// get the partners for a given node\n\tfunction getPartnerIdx(dataset, anode) {\n\t\tvar ptrs = [];\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tvar bnode = dataset[i];\n\t\t\tif(anode.name === bnode.mother)\n\t\t\t\treturn pedigree_util.getIdxByName(dataset, bnode.father);\n\t\t\telse if(anode.name === bnode.father)\n\t\t\t\treturn pedigree_util.getIdxByName(dataset, bnode.mother);\n\t\t}\n\t\treturn -1;\n\t}\n\t\n\t// for a given individual assign levels to a parents ancestors\n\tfunction getLevel(dataset, name) {\n\t\tvar idx = pedigree_util.getIdxByName(dataset, name);\n\t\tvar level = (dataset[idx].level ? dataset[idx].level : 0);\n\t\tupdate_parents_level(idx, level, dataset);\n\t}\n\n\t// recursively update parents levels \n\tfunction update_parents_level(idx, level, dataset) {\n\t\tvar parents = ['mother', 'father'];\n\t\tlevel++;\n\t\tfor(var i=0; i<parents.length; i++) {\n\t\t\tvar pidx = pedigree_util.getIdxByName(dataset, dataset[idx][parents[i]]);\n\t\t\tif(pidx >= 0) {\n\t\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\n\t\t\t\t\tdataset[pedigree_util.getIdxByName(dataset, dataset[idx].mother)].level = level;\n\t\t\t\t\tdataset[pedigree_util.getIdxByName(dataset, dataset[idx].father)].level = level;\n\t\t\t\t}\n\t\t\t\tupdate_parents_level(pidx, level, dataset);\n\t\t\t}\n\t\t}\n\t}\n\n}(window.io = window.io || {}, jQuery));\n","// Pedigree Tree Utils\n(function(pedigree_util, $, undefined) {\n\t\n\tpedigree_util.buildTree = function(opts, person, root, partnerLinks, id) {\n\t\tif (typeof person.children === typeof undefined)\n\t\t\tperson.children = pedigree_util.getChildren(opts.dataset, person);\n\n\t\tif (typeof partnerLinks === typeof undefined) {\n\t\t\tpartnerLinks = [];\n\t\t\tid = 1;\n\t\t}\n\n\t\tvar nodes = pedigree_util.flatten(root);\n\t\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\n\t\tvar partners = [];\n\t\t$.each(person.children, function(i, child) {\n\t\t\t$.each(opts.dataset, function(j, p) {\n\t\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\t\t\t\t\t\n\t\t\t\t\tvar m = pedigree_util.getNodeByName(nodes, p.mother);\n\t\t\t\t\tvar f = pedigree_util.getNodeByName(nodes, p.father);\n\t\t\t\t\tm = (m !== undefined? m : pedigree_util.getNodeByName(opts.dataset, p.mother));\n\t\t\t\t\tf = (f !== undefined? f : pedigree_util.getNodeByName(opts.dataset, p.father));\n\t\t\t\t\tif(!contains_parent(partners, m, f))\n\t\t\t\t\t\tpartners.push({'mother': m, 'father': f});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\t$.merge(partnerLinks, partners);\n\n\t\t$.each(partners, function(i, ptr) {\n\t\t\tvar mother = ptr.mother;\n\t\t\tvar father = ptr.father;\n\t\t\tmother.children = [];\n\t\t\tvar parent = {\n\t\t\t\t\tname : ptree.makeid(4),\n\t\t\t\t\thidden : true,\n\t\t\t\t\tparent : null,\n\t\t\t\t\tfather : father,\n\t\t\t\t\tmother : mother,\n\t\t\t\t\tchildren : pedigree_util.getChildren(opts.dataset, mother, father)\n\t\t\t};\n\n\t\t\tvar midx = pedigree_util.getIdxByName(opts.dataset, mother.name);\n\t\t\tvar fidx = pedigree_util.getIdxByName(opts.dataset, father.name);\n\t\t\tif(!('id' in father) && !('id' in mother))\n\t\t\t\tid = setChildrenId(person.children, id);\n\n\t\t\t// look at grandparents index\n\t\t\tvar gp = pedigree_util.get_grandparents_idx(opts.dataset, midx, fidx);\n\t\t\tif(gp.fidx < gp.midx) {\n\t\t\t\tfather.id = id++;\n\t\t\t\tparent.id = id++;\n\t\t\t\tmother.id = id++;\n\t\t\t} else {\n\t\t\t\tmother.id = id++;\n\t\t\t\tparent.id = id++;\n\t\t\t\tfather.id = id++;\n\t\t\t}\n\t\t\tid = updateParent(mother, parent, id, nodes, opts);\n\t\t\tid = updateParent(father, parent, id, nodes, opts);\n\t\t\tperson.children.push(parent);\n\t\t});\n\t\tid = setChildrenId(person.children, id);\n\n\t\t$.each(person.children, function(i, p) {\n\t\t\tid = pedigree_util.buildTree(opts, p, root, partnerLinks, id)[1];\n\t\t});\n\t\treturn [partnerLinks, id];\n\t};\n\n\t// update parent node and sort twins\n\tfunction updateParent(p, parent, id, nodes, opts) {\n\t\t// add to parent node\n\t\tif('parent_node' in p)\n\t\t\tp.parent_node.push(parent);\n\t\telse\n\t\t\tp.parent_node = [parent];\n\n\t\t// check twins lie next to each other\n\t\tif(p.mztwin) {\n\t\t\tvar twins = pedigree_util.getMzTwins(opts.dataset, p);\n\t\t\tfor(var i=0; i<twins.length; i++) {\n\t\t\t\tvar twin = pedigree_util.getNodeByName(nodes, twins[i].name);\n\t\t\t\tif(twin)\n\t\t\t\t\ttwin.id = id++;\n\t\t\t}\n\t\t}\n\t\treturn id;\n\t}\n\n\tfunction setChildrenId(children, id) {\n\t\t// sort twins to lie next to each other\n\t\tchildren.sort(function(a, b) {\n\t\t\tif(a.mztwin && b.mztwin && a.mztwin == b.mztwin)\n\t\t\t\treturn 0;\n\t\t\telse if(a.mztwin || b.mztwin)\n\t\t\t\treturn 1;\n\t\t\treturn 0;\n\t\t});\n\t\t\n\t\t$.each(children, function(i, p) {\n\t\t\tif(p.id === undefined) p.id = id++;\n\t\t});\n\t\treturn id;\n\t}\n\t\n\tpedigree_util.isProband = function(obj) {\n\t\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n\t};\n\t\n\tpedigree_util.setProband = function(dataset, name, is_proband) {\n\t\t$.each(dataset, function(i, p) {\n\t\t\tif (name === p.name)\n\t\t\t\tp.proband = is_proband;\n\t\t\telse\n\t\t\t\tdelete p.proband;\n\t\t});\n\t};\n\n\tpedigree_util.getProbandIndex = function(dataset) {\n\t\tvar proband;\n\t\t$.each(dataset, function(i, val) {\n\t\t\tif (pedigree_util.isProband(val)) {\n\t\t\t\tproband = i;\n\t\t\t\treturn proband;\n\t\t\t}\n\t\t});\n\t\treturn proband;\n\t};\n\n\tpedigree_util.getChildren = function(dataset, mother, father) {\n\t\tvar children = [];\n\t\tif(mother.sex === 'F')\n\t\t\t$.each(dataset, function(i, p) {\n\t\t\t\tif(mother.name === p.mother)\n\t\t\t\t\tif(!father || father.name == p.father)\n\t\t\t\t\t\tchildren.push(p);\n\t\t\t});\n\t\treturn children;\n\t};\n\t\n\tfunction contains_parent(arr, m, f) {\n\t\tfor(var i=0; i<arr.length; i++)\n\t\t\tif(arr[i].mother === m && arr[i].father === f)\n\t\t\t\treturn true;\n\t\treturn false;\n\t}\n\n\t// get the siblings of a given individual - sex is an optional parameter\n\t// for only returning brothers or sisters\n\tpedigree_util.getSiblings = function(dataset, person, sex) {\n\t\tif(!person.mother || person.noparents)\n\t\t\treturn [];\n\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t       (p.mother === person.mother && p.father === person.father) &&\n\t\t\t       (!sex || p.sex == sex) ? p : null;\n\t\t});\n\t};\n\t\n\t// get the siblings + adopted siblings\n\tpedigree_util.getAllSiblings = function(dataset, person, sex) {\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t       (p.mother === person.mother && p.father === person.father) &&\n\t\t\t       (!sex || p.sex == sex) ? p : null;\n\t\t});\n\t};\n\t\n\t// get the monozygotic twin(s)\n\tpedigree_util.getMzTwins = function(dataset, person) {\n\t\tvar sibs = pedigree_util.getSiblings(dataset, person);\n\t\treturn $.map(sibs, function(p, i){\n\t\t\treturn p.name !== person.name && p.mztwin == person.mztwin ? p : null;\n\t\t});\n\t};\n\t\n\t// get the adopted siblings of a given individual\n\tpedigree_util.getAdoptedSiblings = function(dataset, person) {\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn  p.name !== person.name && 'noparents' in p && \n\t\t\t       (p.mother === person.mother && p.father === person.father) ? p : null;\n\t\t});\n\t};\n\t\n\tpedigree_util.getAllChildren = function(dataset, person, sex) {\n\t\treturn $.map(dataset, function(p, i){\n\t\t\treturn !('noparents' in p) &&\n\t\t\t       (p.mother === person.name || p.father === person.name) &&\n\t\t\t       (!sex || p.sex === sex) ? p : null;\n\t\t});\n\t};\n\t\n\t// get the depth of the given person from the root\n\tpedigree_util.getDepth = function(dataset, name) {\n\t\tvar idx = pedigree_util.getIdxByName(dataset, name);\n\t\tvar depth = 1;\n\n\t\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\t\tidx = pedigree_util.getIdxByName(dataset, dataset[idx].mother);\n\t\t\tdepth++;\n\t\t}\n\t\treturn depth;\n\t};\n\n\t// given an array of people get an index for a given person\n\tpedigree_util.getIdxByName = function(arr, name) {\n\t\tvar idx = -1;\n\t\t$.each(arr, function(i, p) {\n\t\t\tif (name === p.name) {\n\t\t\t\tidx = i;\n\t\t\t\treturn idx;\n\t\t\t}\n\t\t});\n\t\treturn idx;\n\t};\n\n\t// get the nodes at a given depth sorted by their x position\n\tpedigree_util.getNodesAtDepth = function(fnodes, depth, exclude_names) {\n\t\treturn $.map(fnodes, function(p, i){\n\t\t\treturn p.depth == depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) == -1 ? p : null;\n\t\t}).sort(function (a,b) {return a.x - b.x;});\n\t};\n\n\t// convert the partner names into corresponding tree nodes\n\tpedigree_util.linkNodes = function(flattenNodes, partners) {\n\t\tvar links = [];\n\t\tfor(var i=0; i< partners.length; i++)\n\t\t\tlinks.push({'mother': pedigree_util.getNodeByName(flattenNodes, partners[i].mother.name),\n\t\t\t\t\t\t'father': pedigree_util.getNodeByName(flattenNodes, partners[i].father.name)});\n\t\treturn links;\n\t};\n\n\t// return a flattened representation of the tree\n\tpedigree_util.flatten = function(root) {\n\t\tvar flat = [];\n\t\tfunction recurse(node) {\n\t\t\tif(node.children)\n\t\t\t\tnode.children.forEach(recurse);\n\t\t\tflat.push(node);\n\t\t}\n\t\trecurse(root);\n\t\treturn flat;\n\t};\n\t\n\t// Adjust D3 layout positioning.\n\t// Position hidden parent node centring them between father and mother nodes. Remove kinks\n\t// from links - e.g. where there is a single child plus a hidden child\n\tpedigree_util.adjust_coords  = function(opts, root, flattenNodes) {\n\t\tfunction recurse(node) {\n\t\t\tif (node.children) {\n\t\t\t\tnode.children.forEach(recurse);\n\n\t\t\t\tif(node.data.father !== undefined) { \t// hidden nodes\n\t\t\t\t\tvar father = pedigree_util.getNodeByName(flattenNodes, node.data.father.name);\n\t\t\t\t\tvar mother = pedigree_util.getNodeByName(flattenNodes, node.data.mother.name);\n\t\t\t\t\tvar xmid = (father.x + mother.x) /2;\n\t\t\t\t\tif(!pedigree_util.overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\n\t\t\t\t\t\tvar diff = node.x - xmid;\n\t\t\t\t\t\tif(node.children.length == 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\n\t\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\n\t\t\t\t\t\t\t\tvar child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\n\t\t\t\t\t\t\t\tvar child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\n\t\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\n\t\t\t\t\t\t\t\t    !pedigree_util.overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\n\t\t\t\t\t\t\t\t\tchild1.x = xmid;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if(node.children.length == 1 && !node.children[0].data.hidden) {\n\t\t\t\t\t\t\tif(!pedigree_util.overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\n\t\t\t\t\t\t\t\tif(node.children.length == 1) {\n\t\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tvar descendants = node.descendants();\n\t\t\t\t\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\n\t\t\t\t\t\t\t\t\tfor(var i=0; i<descendants.length; i++) {\n\t\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\n\t\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\n\t\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\trecurse(root);\n\t\trecurse(root);\n\t};\n\n\t// test if moving siblings by diff overlaps with other nodes\n\tfunction nodesOverlap(opts, node, diff, root) {\n\t\tvar descendants = node.descendants();\n\t\tvar descendantsNames = $.map(descendants, function(descendant, i){return descendant.data.name;});\n\t\tvar nodes = root.descendants();\n\t\tfor(var i=0; i<descendants.length; i++){\n\t\t\tvar descendant = descendants[i];\n\t\t\tif(node.data.name !== descendant.data.name){\n\t\t\t\tvar xnew = descendant.x - diff;\n\t\t\t\tif(pedigree_util.overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t// test if x position overlaps a node at the same depth\n\tpedigree_util.overlap = function(opts, nodes, xnew, depth, exclude_names) {\n\t\tfor(var n=0; n<nodes.length; n++) {\n\t\t\tif(depth == nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) == -1){\n\t\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t};\n\n\t// given a persons name return the corresponding d3 tree node\n\tpedigree_util.getNodeByName = function(nodes, name) {\n\t\tfor (var i = 0; i < nodes.length; i++) {\n\t\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\t\treturn nodes[i];\n\t\t\telse if (name === nodes[i].name)\n\t\t\t\treturn nodes[i];\n\t\t}\n\t};\n\n\t// given the name of a url param get the value\n\tpedigree_util.urlParam = function(name){\n\t    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);\n\t    if (results===null)\n\t       return null;\n\t    else\n\t       return results[1] || 0;\n\t};\n\t\n\t// get grandparents index\n\tpedigree_util.get_grandparents_idx = function(dataset, midx, fidx) {\n\t\tvar gmidx = midx;\n\t\tvar gfidx = fidx;\n\t\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\n\t\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\n\t\t\tgmidx = pedigree_util.getIdxByName(dataset, dataset[gmidx].mother);\n\t\t\tgfidx = pedigree_util.getIdxByName(dataset, dataset[gfidx].mother);\n\t\t}\n\t\treturn {'midx': gmidx, 'fidx': gfidx};\n\t};\n\n\t// print options and dataset\n\tpedigree_util.print_opts = function(opts){\n    \t$(\"#pedigree_data\").remove();\n    \t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\n    \tvar key;\n    \tfor(var i=0; i<opts.dataset.length; i++) {\n    \t\tvar person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\n    \t\tfor(key in opts.dataset[i]) {\n    \t\t\tif(key === 'name') continue;\n    \t\t\tif(key === 'parent')\n    \t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\n    \t\t\telse if (key === 'children') {\n    \t\t\t\tif (opts.dataset[i][key][0] !== undefined)\n    \t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\n    \t\t\t} else\n    \t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\n    \t\t}\n    \t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\n    \t\t\n    \t}\n    \t$(\"#pedigree_data\").append(\"<br /><br />\");\n    \tfor(key in opts) {\n    \t\tif(key === 'dataset') continue;\n    \t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\n    \t}\n\t};\n}(window.pedigree_util = window.pedigree_util || {}, jQuery));\n\n\n// Pedigree Tree Builder\n(function(ptree, $, undefined) {\n\tptree.roots = {};\n\tptree.build = function(options) {\n        var opts = $.extend({ // defaults\n        \ttargetDiv: 'pedigree_edit',\n        \tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n        \t\t       {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n        \t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\n        \twidth: 600, \n        \theight: 400,\n        \tsymbol_size: 35,\n        \tzoomIn: 1.0,\n        \tzoomOut: 1.0,\n        \tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\n        \t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\n\t\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#4DAA4D'},\n\t\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\n\t\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\n\t\t\tlabels: ['age', 'yob', 'alleles'],\n\t\t\tfont_size: '.75em',\n\t\t\tfont_family: 'Helvetica',\n\t\t\tfont_weight: 700,\n\t\t\tbackground: \"#EEE\",\n\t\t\tnode_background: '#fdfdfd',\n        \tDEBUG: false}, options );\n\n        if ( $( \"#fullscreen\" ).length === 0 ) {\n        \t// add undo, redo, fullscreen buttons and event listeners once\n\t\t\tpbuttons.add(opts);\n\t\t\tio.add(opts);\n        }\n\n        if(pedcache.nstore(opts) == -1)\n        \tpedcache.add(opts);\n\n        pbuttons.updateButtons(opts);\n \n        // group top level nodes by partners\n        opts.dataset = group_top_level(opts.dataset);\n        if(opts.DEBUG)\n        \tpedigree_util.print_opts(opts);\n        var svg_dimensions = get_svg_dimensions(opts);\n        var svg = d3.select(\"#\"+opts.targetDiv)\n\t\t\t\t\t .append(\"svg:svg\")\n\t\t\t\t\t .attr(\"width\", svg_dimensions.width)\n\t\t\t\t\t .attr(\"height\", svg_dimensions.height);\n\n\t\tsvg.append(\"rect\")\n\t\t\t.attr(\"width\", \"100%\")\n\t\t\t.attr(\"height\", \"100%\")\n\t\t\t.attr(\"rx\", 6)\n\t\t\t.attr(\"ry\", 6)\n\t\t\t.style(\"stroke\", \"darkgrey\")\n       \t\t.style(\"fill\", opts.background) // or none\n       \t\t.style(\"stroke-width\", 1);\n\n\t\tvar xytransform = pedcache.getposition(opts);  // cached position\n\t\tvar xtransform = xytransform[0];\n\t\tvar ytransform = xytransform[1];\n\t\tvar zoom = 1;\n\t\tif(xytransform.length == 3){\n\t\t\tzoom = xytransform[2];\n\t\t}\n\n\t\tif(xtransform === null) {\n\t\t\txtransform = opts.symbol_size/2;\n\t\t\tytransform = (-opts.symbol_size*2.5);\n\t\t}\n\t\tvar ped = svg.append(\"g\")\n\t\t\t\t .attr(\"class\", \"diagram\")\n\t             .attr(\"transform\", \"translate(\"+xtransform+\",\" + ytransform + \") scale(\"+zoom+\")\");\n\n\t\tvar top_level = $.map(opts.dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t\tvar hidden_root = {\n\t\t\tname : 'hidden_root',\n\t\t\tid : 0,\n\t\t\thidden : true,\n\t\t\tchildren : top_level\n\t\t};\n\n\t\tvar partners = pedigree_util.buildTree(opts, hidden_root, hidden_root)[0];\n\t\tvar root = d3.hierarchy(hidden_root);\n\t\tptree.roots[opts.targetDiv] = root;\n\t\t\n\t\t/// get score at each depth used to adjust node separation\n\t\tvar tree_dimensions = ptree.get_tree_dimensions(opts);\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\n\t\t\t\t\t    ' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\n\n\t\tvar treemap = d3.tree().separation(function(a, b) {\n\t\t\t\tif(a.data.hidden || b.data.hidden)\n\t\t\t\t\treturn 1.2;\n\t\t\t\tif(a.parent === b.parent && ('noparents' in a.data || 'noparents' in b.data || 'top_level' in a.data))\n\t\t\t\t\treturn 1.2;\t\t\t\n\t\t\t\treturn a.parent === b.parent ? 1 : 1.2;\n\t\t}).size([tree_dimensions.width, tree_dimensions.height]);\n\n\t\tvar nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\n\t\tvar flattenNodes = nodes.descendants();\n\n\t\t// check the number of visible nodes equals the size of the pedigree dataset\n\t\tvar vis_nodes = $.map(opts.dataset, function(p, i){return p.hidden ? null : p;});\n\t\tif(vis_nodes.length != opts.dataset.length) {\n\t\t\tvar err = 'NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET';\n\t\t\tconsole.error(err, vis_nodes.length, opts.dataset.length);\n\t\t\tthrow new Error(err);\n\t\t}\n\n\t\tpedigree_util.adjust_coords(opts, nodes, flattenNodes);\n\n\t\tvar ptrLinkNodes = pedigree_util.linkNodes(flattenNodes, partners);\n\n\t\tcheck_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines\n\t\tvar unconnected = ptree.unconnected(opts.dataset);\n\t\tif(unconnected.length > 0)\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", unconnected);\n\n\t\tvar node = ped.selectAll(\".node\")\n\t\t\t\t\t  .data(nodes.descendants())\n\t\t\t\t\t  .enter()\n\t\t\t\t\t   \t.append(\"g\")\n\t\t\t\t\t   \t.attr(\"transform\", function(d, i) {\n\t\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\n\t\t\t\t\t\t});\n\n\t\t// provide a border to the node\n\t\tnode.append(\"path\")\n\t\t\t.filter(function (d) {return !d.data.hidden;})\n\t\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\n\t\t\t.attr(\"transform\", function(d) {return d.data.sex == \"U\"? \"rotate(45)\" : \"\";})\n\t\t\t.attr(\"d\", d3.symbol().size(function(d) { return (opts.symbol_size * opts.symbol_size) + 2;})\n\t\t\t.type(function(d) {return d.data.sex == \"F\" ? d3.symbolCircle :d3.symbolSquare;}))\n\t\t\t.style(\"stroke\", function (d) {\n\t\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t\t})\n\t\t\t.style(\"stroke-width\", function (d) {\n\t\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".3em\" : \".1em\";\n\t\t\t})\n\t\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t\t.style(\"fill\", \"none\");\n\n\t\t// set a clippath\n\t\tnode.append(\"clipPath\")\n\t\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\n\t\t\t.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\n\t\t\t.attr(\"class\", \"node\")\n\t\t\t.attr(\"transform\", function(d) {return d.data.sex == \"U\"? \"rotate(45)\" : \"\";})\n\t\t\t.attr(\"d\", d3.symbol().size(function(d) {\n\t\t\t\tif (d.data.hidden)\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\n\t\t\t})\n\t\t\t.type(function(d) {return d.data.sex == \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\n\n\t\t// pie plots for disease colours\n\t\tvar pienode = node.selectAll(\"pienode\")\n\t\t   .data(function(d) {     \t\t// set the disease data for the pie plot\n\t\t\t   var ncancers = 0;\n\t\t\t   var cancers = $.map(opts.diseases, function(val, i){\n\t\t\t\t   if(prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\n\t\t\t   });\n\t\t\t   if(ncancers === 0) cancers = [1];\n\t\t\t   return [$.map(cancers, function(val, i){ \n\t\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\n\t\t\t\t\t   \t   'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\n\t\t\t\t\t   \t   'affected': d.data.affected,\n\t\t\t\t\t   \t   'exclude': d.data.exclude};})];\n\t\t   })\n\t\t   .enter()\n\t\t    .append(\"g\");\n\n\t\tpienode.selectAll(\"path\")\n\t\t    .data(d3.pie().value(function(d) {return d.cancer;}))\n\t\t    .enter().append(\"path\")\n\t\t    \t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\n\t\t\t    .attr(\"class\", \"pienode\")\n\t\t\t    .attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\n\t\t\t    .style(\"fill\", function(d, i) {\n\t\t\t    \tif(d.data.exclude)\n\t\t\t    \t\treturn 'lightgrey';\n\t\t\t    \tif(d.data.ncancers === 0) {\n\t\t\t    \t\tif(d.data.affected)\n\t\t\t    \t\t\treturn 'darkgrey';\n\t\t\t\t    \treturn opts.node_background;\n\t\t\t    \t}\n\t\t\t    \treturn opts.diseases[i].colour; \n\t\t\t    });\n\n\t\t// alive status = 0; dead status = 1\n\t\tvar status = node.append('line')\n\t\t.filter(function (d) {return d.data.status == 1;})\n\t\t    .style(\"stroke\", \"black\")\n\t\t    .attr(\"x1\", function(d, i) {return -0.6*opts.symbol_size;})\n\t\t    .attr(\"y1\", function(d, i) {return 0.6*opts.symbol_size;})\n\t\t    .attr(\"x2\", function(d, i) {return 0.6*opts.symbol_size;})\n\t\t    .attr(\"y2\", function(d, i) {return -0.6*opts.symbol_size;});\n\n\t\t// names of individuals\n\t\taddLabel(opts, node, \".25em\", -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\n\t\t\t\tfunction(d) {\n\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\n\t\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';});\n\t\n/*\t\tvar warn = node.filter(function (d) {\n    \t\treturn (!d.data.age || !d.data.yob) && !d.data.hidden;\n\t\t}).append(\"text\")\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.attr(\"x\", \".25em\")\n\t\t.attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size))\n\t\t.html(\"\\uf071\");\n\t\twarn.append(\"svg:title\").text(\"incomplete\");*/\n\n\t\tvar font_size = parseInt(getPx(opts.font_size)) + 4;\n\t\t// display label defined in opts.labels e.g. alleles/genotype data\n\t\tfor(var ilab=0; ilab<opts.labels.length; ilab++) {\n\t\t\tvar label = opts.labels[ilab];\n\t\t\taddLabel(opts, node, \".25em\", -(0.7 * opts.symbol_size),\n\t\t\t\tfunction(d) {\n\t\t\t\t\tif(!d.data[label])\n\t\t\t\t\t\treturn;\n\t\t\t\t\td.y_offset = (ilab === 0 || !d.y_offset ? font_size*2.25 : d.y_offset+font_size);\n\t\t\t\t\treturn d.y_offset;\n\t\t\t\t},\n\t\t\t\tfunction(d) {\n\t\t\t\t\tif(d.data[label]) {\n\t\t\t\t\t\tif(label === 'alleles') {\n\t\t\t\t\t\t\tvar alleles = \"\";\n\t\t\t\t\t\t\tvar vars = d.data.alleles.split(';');\n\t\t\t\t\t\t\tfor(var ivar = 0;ivar < vars.length;ivar++) {\n\t\t\t\t\t\t\t\tif(vars[ivar] !== \"\") alleles += vars[ivar] + ';';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn alleles;\t\n\t\t\t\t\t\t} else if(label === 'age') {\n\t\t\t\t\t\t\treturn d.data[label] +'y';\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn d.data[label];\t\t\t\t\n\t\t\t\t}\n\t\t\t}, 'indi_details');\n\t\t}\n\n\t\t// individuals disease details\n\t\tfor(var i=0;i<opts.diseases.length; i++) {\n\t\t\tvar disease = opts.diseases[i].type;\n\t\t\taddLabel(opts, node, \".25em\", -(opts.symbol_size),\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tvar y_offset = (d.y_offset ? d.y_offset+font_size: font_size*2.2);\n\t\t\t\t\t\tfor(var j=0;j<opts.diseases.length; j++) {\n\t\t\t\t\t\t\tif(disease === opts.diseases[j].type)\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tif(prefixInObj(opts.diseases[j].type, d.data))\n\t\t\t\t\t\t\t\ty_offset += font_size-1;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn y_offset;\n\t\t\t\t\t},\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tvar dis = disease.replace('_', ' ').replace('cancer', 'ca.');\n\t\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\n\t\t\t\t\t}, 'indi_details');\n\t\t}\n\n\t\t//\n\t\twidgets.addWidgets(opts, node);\n\n\t\t// links between partners\n\t\tvar clash_depth = {};\n\t\tpartners = ped.selectAll(\".partner\")\n\t\t  \t.data(ptrLinkNodes)\n\t\t  \t.enter()\n\t\t  \t\t.insert(\"path\", \"g\")\n\t\t  \t\t.attr(\"fill\", \"none\")\n\t\t  \t\t.attr(\"stroke\", \"#000\")\n\t\t  \t\t.attr(\"shape-rendering\", \"auto\")\n\t\t  \t\t.attr('d', function(d, i) {\n\t\t  \t\t\tvar x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\n\t  \t\t\t\tvar x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\n\t  \t\t\t\tvar dy1 = d.mother.y;\n\n\t  \t\t\t\t// identify clashes with other nodes at the same depth\n\t\t  \t\t\tvar clash = ptree.check_ptr_link_clashes(opts, d);\n\t\t  \t\t\tvar path = \"\";\n\t\t  \t\t\tif(clash) {\n\t\t  \t\t\t\tif(d.mother.depth in clash_depth)\n\t\t  \t\t\t\t\tclash_depth[d.mother.depth] += 4;\n\t\t  \t\t\t\telse\n\t\t  \t\t\t\t\tclash_depth[d.mother.depth] = 4;\n\n\t\t  \t\t\t\tdy1 -= clash_depth[d.mother.depth];\n\t\t  \t\t\t\tvar dx = clash_depth[d.mother.depth] + opts.symbol_size/2 + 2;\n\n\t\t  \t\t\t\tvar parent_nodes = d.mother.data.parent_node;\n\t\t  \t\t\t\tvar parent_node_name = parent_nodes[0];\n\t\t  \t\t\t\tfor(var ii=0; ii<parent_nodes.length; ii++) {\n\t\t  \t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\n\t\t  \t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\n\t\t  \t\t\t\t\t\t parent_node_name = parent_nodes[ii].name;\n\t\t  \t\t\t\t}\n\t\t  \t\t\t\tvar parent_node = pedigree_util.getNodeByName(flattenNodes, parent_node_name);\n\t\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\n\t\t  \t\t\t\tclash.sort(function (a,b) {return a - b;});\n\n\t\t  \t\t\t\textend = function(i, l) {\n\t\t  \t\t\t\t\tif(i+1 < l)   //  && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\n\t\t  \t\t\t\t\t\treturn extend(++i);\n\t\t  \t\t\t\t\treturn i;\n\t\t  \t\t\t\t};\n\n\t\t  \t\t\t\tvar dy2 = (dy1-opts.symbol_size/2-3);\n\t\t  \t\t\t\t// loop over node(s)\n\t\t  \t\t\t\tfor(var j=0; j<clash.length; j++) {\n\t\t  \t\t\t\t\tvar k = extend(j, clash.length);\n\t\t  \t\t\t\t\tvar dx1 = clash[j] - dx;\n\t\t  \t\t\t\t\tvar dx2 = clash[k] + dx;\n\t\t  \t\t\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\n\t\t  \t\t\t\t\t\tparent_node.y = dy2;\n\n\t  \t\t\t\t\t\tpath += \"L\" + dx1 + \",\" +  dy1 +\n\t\t  \t\t\t\t\t        \"L\" + dx1 + \",\" +  dy2 +\n\t\t  \t\t\t\t\t        \"L\" + dx2 + \",\" +  dy2 +\n\t\t  \t\t\t\t\t        \"L\" + dx2 + \",\" +  dy1;\n\t  \t\t\t\t\t\tj = k;\n\t\t  \t\t\t\t}\n\t\t  \t\t\t}\n\t\t  \t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1;\n\t\t  \t\t});\n\n\t\t// links to children\n\t\tvar links = ped.selectAll(\".link\")\n\t\t\t.data(root.links(nodes.descendants()))\n\t\t\t.enter()\n\t\t\t\t.filter(function (d) {\n\t\t\t\t\t// filter unless debug is set\n\t\t\t\t\treturn (opts.DEBUG ||\n\t\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\n\t\t\t\t})\n\t\t\t\t.insert(\"path\", \"g\")\n\t\t\t\t.attr(\"fill\", \"none\")\n\t\t\t\t.attr(\"stroke-width\", function(d, i) {\n\t\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\t\treturn 1;\n\t\t\t\t\treturn (opts.DEBUG ? 2 : 1);\n\t\t\t\t})\n\t\t\t\t.attr(\"stroke\", function(d, i) {\n\t\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\t\treturn 'pink';\n\t\t\t\t\treturn \"#000\";\n\t\t\t\t})\n\t\t\t\t.attr(\"shape-rendering\", function(d, i) {\n\t\t\t\t\tif(d.target.data.mztwin) \n\t\t\t\t\t\treturn \"geometricPrecision\";\n\t\t\t\t\treturn \"auto\";\n\t\t\t\t})\n\t\t\t\t.attr(\"d\", function(d, i) {\n\t\t\t\t\tif(!opts.DEBUG &&\n\t\t\t\t\t   (d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden))\n\t\t\t\t\t\treturn;\n\t\t\t\t\tif(d.target.data.mztwin) {\n\t\t\t\t\t\t// get twin position\n\t\t\t\t\t\tvar twins = pedigree_util.getMzTwins(opts.dataset, d.target.data);\n\t\t\t\t\t\tif(twins.length >= 1) {\n\t\t\t\t\t\t\tvar twinx = 0;\n\t\t\t\t\t\t\tfor(var t=0; t<twins.length; t++) {\n\t\t\t\t\t\t\t\ttwinx += pedigree_util.getNodeByName(flattenNodes, twins[t].name).x;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t\t           \"V\" + ((d.source.y + d.target.y) / 2) +\n\t\t\t\t\t\t           \"H\" + ((d.target.x + twinx) / (twins.length+1)) +\n\t\t\t\t\t\t           \"L\" + (d.target.x) + \" \" + (d.target.y-opts.symbol_size/2) ;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t       \"V\" + ((d.source.y + d.target.y) / 2) +\n\t\t\t\t\t       \"H\" + (d.target.x) +\n\t\t\t\t\t       \"V\" + (d.target.y);\n\t\t\t\t});\n\n\t\t// draw proband arrow\n\t\tvar probandIdx  = pedigree_util.getProbandIndex(opts.dataset);\n\t\tif(probandIdx) {\n\t\t\tvar probandNode = pedigree_util.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\n\t\n\t\t\tped.append(\"svg:defs\").append(\"svg:marker\")    // arrow head\n\t\t\t    .attr(\"id\", \"triangle\")\n\t\t\t    .attr(\"refX\", 6)\n\t\t\t    .attr(\"refY\", 6)\n\t\t\t    .attr(\"markerWidth\", 20)\n\t\t\t    .attr(\"markerHeight\", 20)\n\t\t\t    .attr(\"orient\", \"auto\")\n\t\t\t    .append(\"path\")\n\t\t\t    .attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\n\t\t\t    .style(\"fill\", \"black\");\n\t\t\t\n\t\t\tped.append(\"line\")\n\t\t        .attr(\"x1\", probandNode.x-opts.symbol_size)\n\t\t        .attr(\"y1\", probandNode.y+opts.symbol_size)\n\t\t        .attr(\"x2\", probandNode.x-opts.symbol_size/2)\n\t\t        .attr(\"y2\", probandNode.y+opts.symbol_size/2)\n\t\t        .attr(\"stroke-width\", 1)\n\t\t        .attr(\"stroke\", \"black\")\n\t\t        .attr(\"marker-end\", \"url(#triangle)\");\n\t\t}\n\t\t// drag and zoom\n\t\tzoom = d3.zoom()\n\t\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\n\t\t  .on('zoom', zoomFn);\n\n\t\tfunction zoomFn() {\n\t\t\tvar t = d3.event.transform;\n\t\t\tvar pos = [(t.x + parseInt(xtransform)), (t.y + parseInt(ytransform))];\n\t\t\tif(t.k == 1)\n\t\t\t\tpedcache.setposition(opts, pos[0], pos[1]);\n\t\t\telse\n\t\t\t\tpedcache.setposition(opts, pos[0], pos[1], t.k);\n\t\t\tped.attr('transform', 'translate(' + pos[0] + ',' + pos[1] + ') scale(' + t.k + ')');\n\t\t}\n\t\tsvg.call(zoom);\n\t\treturn opts;\n\t};\n\t\n\t// check if the object contains a key with a given prefix\n\tfunction prefixInObj(prefix, obj) {\n\t\tvar found = false;\n\t\tif(obj)\n\t\t\t$.each(obj, function(k, n){\n\t\t\t    if(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\n\t\t\t    \tfound = true;\n\t\t\t    \treturn found;\n\t\t\t    }\n\t\t\t});\n\t\treturn found;\n\t}\n\n\t// return a list of individuals that aren't connected to the target\n\tptree.unconnected = function(dataset){\n\t\tvar target = dataset[ pedigree_util.getProbandIndex(dataset) ];\n\t\tif(!target){\n\t\t\tconsole.warn(\"No target defined\");\n\t\t\ttarget = dataset[0];\n\t\t}\n        var connected = [target.name];\n        var change = true;\n        var ii = 0;\n        while(change && ii < 200) {\n        \tii++;\n        \tvar nconnect = connected.length;\n            $.each(dataset, function( idx, p ) {\n            \tif($.inArray( p.name, connected ) != -1) {\n            \t\t// check if this person or a partner has a parent\n            \t\tvar ptrs = get_partners(dataset, p);\n            \t\tvar has_parent = (p.name === target.name || !p.noparents);\n            \t\tfor(var i=0; i<ptrs.length; i++){\n            \t\t\tif(!pedigree_util.getNodeByName(dataset, ptrs[i]).noparents)\n            \t\t\t\thas_parent = true;\n            \t\t}\n\n            \t\tif(has_parent){\n\t            \t\tif(p.mother && $.inArray( p.mother, connected ) == -1)\n\t            \t\t\tconnected.push(p.mother);\n\t            \t\tif(p.father && $.inArray( p.father, connected ) == -1)\n\t            \t\t\tconnected.push(p.father);\n            \t\t}\n            \t} else if( !p.noparents &&\n            \t\t\t  ((p.mother && $.inArray( p.mother, connected ) != -1) ||\n            \t\t\t   (p.father && $.inArray( p.father, connected ) != -1))){\n            \t\tconnected.push(p.name);\n            \t}\n        \t\t// include any children\n            \tinclude_children(connected, p, dataset);\n            });\n            change = (nconnect != connected.length);\n        }\n        var names = $.map(dataset, function(val, i){return val.name;});\n        return $.map(names, function(name, i){return $.inArray(name, connected) == -1 ? name : null;});\n\t};\n\n\tfunction include_children(connected, p, dataset) {\n\t\tif($.inArray( p.name, connected ) == -1)\n\t\t\treturn;\n\t\tcombineArrays(connected, get_partners(dataset, p));\n\t\tvar children = pedigree_util.getAllChildren(dataset, p);\n    \t$.each(children, function( child_idx, child ) {\n    \t\tif($.inArray( child.name, connected ) == -1) {\n    \t\t\tconnected.push(child.name);\n    \t\t\tcombineArrays(connected, get_partners(dataset, child));\n    \t\t}\n    \t});\n\t}\n\n\t// combine arrays ignoring duplicates\n\tfunction combineArrays(arr1, arr2) {\n\t    for(var i=0; i<arr2.length; i++)\n\t    \tif($.inArray( arr2[i], arr1 ) == -1) arr1.push(arr2[i]);\n\t}\n\t\n\t// check for crossing of partner lines\n\tfunction check_ptr_links(opts, ptrLinkNodes){\n\t\tfor(var a=0; a<ptrLinkNodes.length; a++) {\n\t\t\tvar clash = ptree.check_ptr_link_clashes(opts, ptrLinkNodes[a]);\n\t\t\tif(clash)\n\t\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\n\t\t}\n\t}\n\t\n\tptree.check_ptr_link_clashes = function(opts, anode) {\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar flattenNodes = pedigree_util.flatten(root);\n\t\tvar mother, father;\n\t\tif('name' in anode) {\n\t\t\tanode = pedigree_util.getNodeByName(flattenNodes, anode.name);\n\t\t\tif(!('mother' in anode.data))\n\t\t\t\treturn null;\n\t\t\tmother = pedigree_util.getNodeByName(flattenNodes, anode.data.mother);\n\t\t\tfather = pedigree_util.getNodeByName(flattenNodes, anode.data.father);\n\t\t} else {\n\t\t\tmother = anode.mother;\n\t\t\tfather = anode.father;\n\t\t}\n\n\t\tvar x1 = (mother.x < father.x ? mother.x : father.x);\n\t\tvar x2 = (mother.x < father.x ? father.x : mother.x);\n\t\tvar dy = mother.y;\n\n\t\t// identify clashes with other nodes at the same depth\n  \t\tvar clash = $.map(flattenNodes, function(bnode, i){\n  \t\t\treturn !bnode.data.hidden &&\n  \t\t\t\t    bnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name && \n  \t\t\t\t    bnode.y == dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\n  \t\t});\n  \t\treturn clash.length > 0 ? clash : null;\n\t};\n\t\n\tfunction get_svg_dimensions(opts) {\n        return {'width' : (pbuttons.is_fullscreen()? window.innerWidth  : opts.width),\n        \t    'height': (pbuttons.is_fullscreen()? window.innerHeight : opts.height)};\n\t}\n\t\n\tptree.get_tree_dimensions = function(opts) {\n\t\t/// get score at each depth used to adjust node separation\n\t\tvar svg_dimensions = get_svg_dimensions(opts);\n\t\tvar maxscore = 0;\n\t\tvar generation = {};\n\t\tfor(var i=0; i<opts.dataset.length; i++) {\n\t\t\tvar depth = pedigree_util.getDepth(opts.dataset, opts.dataset[i].name);\n\t\t\tvar children = pedigree_util.getAllChildren(opts.dataset, opts.dataset[i]);\n\n\t\t\t// score based on no. of children and if parent defined\n\t\t\tvar score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\n\t\t\tif(depth in generation)\n\t\t\t\tgeneration[depth] += score;\n\t\t\telse\n\t\t\t\tgeneration[depth] = score;\n\n\t\t\tif(generation[depth] > maxscore)\n\t\t\t\tmaxscore = generation[depth];\n\t\t}\n\n\t\tvar max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\n\t\tvar tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\n\t\t\t\t           svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\n\t\tvar tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\n\t\t      \t\t       svg_dimensions.height - opts.symbol_size : max_depth);\n\t\treturn {'width': tree_width, 'height': tree_height};\n\t};\n\t\n\t// get the partners for a given node\n\tfunction get_partners(dataset, anode) {\n\t\tvar ptrs = [];\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tvar bnode = dataset[i];\n\t\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) == -1)\n\t\t\t\tptrs.push(bnode.father);\n\t\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) == -1)\n\t\t\t\tptrs.push(bnode.mother);\n\t\t}\t\t\n\t\treturn ptrs;\n\t}\n\t\n\t// group top_level nodes by their partners\n\tfunction group_top_level(dataset) {\n\t\t// var top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t\t// calculate top_level nodes\n\t\tfor(var i=0;i<dataset.length;i++) {\n\t\t\tif(pedigree_util.getDepth(dataset, dataset[i].name) == 2)\n\t\t\t\tdataset[i].top_level = true;\n\t\t}\n\n\t\tvar top_level = [];\n        var top_level_seen = [];\n        for(i=0;i<dataset.length;i++) {\n        \tvar node = dataset[i];\n        \tif('top_level' in node && $.inArray(node.name, top_level_seen) == -1){\n        \t\ttop_level_seen.push(node.name);\n        \t\ttop_level.push(node);\n        \t\tvar ptrs = get_partners(dataset, node);\n        \t\tfor(var j=0; j<ptrs.length; j++){\n        \t\t\tif($.inArray(ptrs[j], top_level_seen) == -1) {\n\t        \t\t\ttop_level_seen.push(ptrs[j]);\n\t        \t\t\ttop_level.push(pedigree_util.getNodeByName(dataset, ptrs[j]));\n        \t\t\t}\n        \t\t}\n        \t}\n        }\n\n        var newdataset = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? null : val;});\n        for (i = top_level.length; i > 0; --i)\n        \tnewdataset.unshift(top_level[i-1]);\n        return newdataset;\n\t}\n\t\n\t// get height in pixels\n\tfunction getPx(emVal){\n\t\tif (emVal === parseInt(emVal, 10)) // test if integer\n\t\t\treturn emVal;\n\n\t\tif(emVal.indexOf(\"px\") > -1)\n\t\t\treturn emVal.replace('px', '');\n\t\telse if(emVal.indexOf(\"em\") === -1)\n\t\t\treturn emVal;\n\t\tvar adiv = $('<div style=\"display: none; font-size: '+emVal+'; margin: 0; padding:0; height: auto; line-height: 1; border:0;\">&nbsp;</div>').appendTo('body');\n\t\tvar hgt = adiv.height();\n\t\tadiv.remove();\n\t\treturn hgt;\n\t};\n\n\t// Add label\n\tfunction addLabel(opts, node, size, fx, fy, ftext, class_label) {\n\t\tnode.filter(function (d) {\n    \t\treturn d.data.hidden && !opts.DEBUG ? false : true;\n\t\t}).append(\"text\")\n\t\t.attr(\"class\", class_label + ' ped_label' || \"ped_label\")\n\t\t.attr(\"x\", fx)\n\t\t.attr(\"y\", fy)\n\t\t//.attr(\"dy\", size)\n\t\t.attr(\"font-family\", opts.font_family)\n\t\t.attr(\"font-size\", opts.font_size)\n\t\t.attr(\"font-weight\", opts.font_weight)\n\t\t.text(ftext);\t\n    }\n\n\tptree.rebuild = function(opts) {\n\t\t$(\"#\"+opts.targetDiv).empty();\n\t\tpedcache.add(opts);\n\t\ttry {\n\t\t\tptree.build(opts);\n\t\t} catch(e) {\n\t\t\tconsole.error(e);\n\t\t}\n\n\t\ttry {\n\t\t\ttemplates.update(opts);\n\t\t} catch(e) {\n\t\t\t// templates not declared \n\t\t}\n\t};\n\n\tptree.copy_dataset = function(dataset) {\n\t\tif(dataset[0].id) { // sort by id\n\t\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\n\t\t}\n\n\t\tvar disallowed = [\"id\", \"parent_node\"];\n\t\tvar newdataset = [];\n\t\tfor(var i=0; i<dataset.length; i++){\n\t\t\tvar obj = {};\n\t\t\tfor(var key in dataset[i]) {\n\t\t\t\tif(disallowed.indexOf(key) == -1)\n\t\t\t\t\tobj[key] = dataset[i][key];\n\t\t\t}\n\t\t\tnewdataset.push(obj);\n\t\t}\n\t\treturn newdataset;\n\t};\n\t\n\t// add children to a given node\n\tptree.addchild = function(dataset, node, sex, nchild, mztwin) {\n\t\tif (typeof nchild === typeof undefined)\n\t\t\tnchild = 1;\n\t\tvar children = pedigree_util.getAllChildren(dataset, node);\n\t\tvar ptr_name, idx;\n\t\tif (children.length === 0) {\n\t\t\tvar partner = ptree.addsibling(dataset, node, node.sex === 'F' ? 'M': 'F');\n\t\t\tpartner.noparents = true;\n\t\t\tptr_name = partner.name;\n\t\t\tidx = pedigree_util.getIdxByName(dataset, node.name)+1;\n\t\t} else {\n\t\t\tvar c = children[0];\n\t\t\tptr_name = (c.father === node.name ? c.mother : c.father);\n\t\t\tidx = pedigree_util.getIdxByName(dataset, c.name);\n\t\t}\n\n\t\tif(mztwin)\n\t\t\tmztwin = getUniqueTwinID(dataset);\n\t\tfor (var i = 0; i < nchild; i++) {\n\t\t\tvar child = {\"name\": ptree.makeid(4), \"sex\": sex,\n\t\t\t\t\t     \"mother\": (node.sex === 'F' ? node.name : ptr_name),\n\t\t\t\t         \"father\": (node.sex === 'F' ? ptr_name : node.name)};\n\t\t\tdataset.splice(idx, 0, child);\n\n\t\t\tif(mztwin)\n\t\t\t\tchild.mztwin = mztwin;\n\t\t}\n\t};\n\n\t//\n\tptree.addsibling = function(dataset, node, sex, add_lhs, mztwin) {\n\t\tvar newbie = {\"name\": ptree.makeid(4), \"sex\": sex};\n\t\tif(node.top_level) {\n\t\t\tnewbie.top_level = true;\n\t\t} else {\n\t\t\tnewbie.mother = node.mother;\n\t\t\tnewbie.father = node.father;\n\t\t}\n\t\tvar idx = pedigree_util.getIdxByName(dataset, node.name);\n\t\t\n\t\tif(mztwin) {\n\t\t\tsetMzTwin(dataset, dataset[idx], newbie);\n\t\t}\n\n\t\tif(add_lhs) { // add to LHS\n\t\t\tif(idx > 0) idx--;\n\t\t} else\n\t\t\tidx++;\n\t\tdataset.splice(idx, 0, newbie);\n\t\treturn newbie;\n\t};\n\n\t// set two siblings as twins \n\tfunction setMzTwin(dataset, d1, d2) {\n\t\tif(!d1.mztwin) {\n\t\t\td1.mztwin = getUniqueTwinID(dataset);\n\t\t\tif(!d1.mztwin)\n\t\t\t\treturn false;\n\t\t}\n\t\td2.mztwin = d1.mztwin;\n\t\tif(d1.yob)\n\t\t\td2.yob = d1.yob;\n\t\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\t\td2.age = d1.age;\n\t\treturn true;\n\t}\n\t\n\t// get a new unique twins ID, max of 10 twins in a pedigree\n\tfunction getUniqueTwinID(dataset) {\n\t\tvar mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tif(dataset[i].mztwin) {\n\t\t\t\tvar idx = mz.indexOf(dataset[i].mztwin);\n\t\t\t\tif (idx > -1)\n\t\t\t\t\tmz.splice(idx, 1);\n\t\t\t}\n\t\t}\n\t\tif(mz.length > 0)\n\t\t\treturn mz[0];\n\t\treturn undefined;\n\t}\n\n\t// sync attributes of twins\n\tptree.syncTwins = function(dataset, d1) {\n\t\tif(!d1.mztwin)\n\t\t\treturn;\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tvar d2 = dataset[i];\n\t\t\tif(d2.mztwin && d1.mztwin == d2.mztwin && d2.name !== d1.name) {\n\t\t\t\td2.sex = d1.sex;\n\t\t\t\tif(d1.yob)\n\t\t\t\t\td2.yob = d1.yob;\n\t\t\t\tif(d1.age && (d1.status == 0 || !d1.status))\n\t\t\t\t\td2.age = d1.age;\n\t\t\t}\n\t\t}\n\t};\n\n\t// check integrity twin settings\n\tfunction checkTwins(dataset) {\n\t\tfor(var i=0; i<dataset.length; i++) {\n\t\t\tif(dataset[i].mztwin) {\n\t\t\t\tvar count = 0;\n\t\t\t\tfor(var j=0; j<dataset.length; j++) {\n\t\t\t\t\tif(dataset[j].mztwin == dataset[i].mztwin)\n\t\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t\tif(count < 2)\n\t\t\t\t\tdelete dataset[i].mztwin;\n\t\t\t}\n\t\t}\n\t}\n\n\t// add parents to the 'node'\n\tptree.addparents = function(opts, dataset, name) {\n\t\tvar mother, father;\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar flat_tree = pedigree_util.flatten(root);\n\t\tvar tree_node = pedigree_util.getNodeByName(flat_tree, name);\n\t\tvar node  = tree_node.data;\n\t\tvar depth = tree_node.depth;   // depth of the node in relation to the root (depth = 1 is a top_level node)\n\n\t\tvar pid = -101;\n\t\tvar ptr_name;\n\t\tvar children = pedigree_util.getAllChildren(dataset, node);\n\t\tif(children.length > 0){\n\t\t\tptr_name = children[0].mother == node.name ? children[0].father : children[0].mother;\n\t\t\tpid = pedigree_util.getNodeByName(flat_tree, ptr_name).data.id;\n\t\t}\n\n\t\tvar i;\n\t\tif(depth == 1) {\n\t\t\tmother = {\"name\": ptree.makeid(4), \"sex\": \"F\", \"top_level\": true};\n\t\t\tfather = {\"name\": ptree.makeid(4), \"sex\": \"M\", \"top_level\": true};\n\t\t\tdataset.splice(0, 0, father);\n\t\t\tdataset.splice(0, 0, mother);\n\n\t\t\tfor(i=0; i<dataset.length; i++){\n\t\t\t\tif(dataset[i].top_level && dataset[i].name !== mother.name && dataset[i].name !== father.name){\n\t\t\t\t\tdelete dataset[i].top_level;\n\t\t\t\t\tdataset[i].noparents = true;\n\t\t\t\t\tdataset[i].mother = mother.name;\n\t\t\t\t\tdataset[i].father = father.name;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tvar node_mother = pedigree_util.getNodeByName(flat_tree, tree_node.data.mother);\n\t\t\tvar node_father = pedigree_util.getNodeByName(flat_tree, tree_node.data.father);\n\t\t\tvar node_sibs = pedigree_util.getAllSiblings(dataset, node);\n\n\t\t\t// lhs & rhs id's for siblings of this node\n\t\t\tvar rid = 10000;\n\t\t\tvar lid = tree_node.data.id;\n\t\t\tfor(i=0; i<node_sibs.length; i++){\n\t\t\t\tvar sid = pedigree_util.getNodeByName(flat_tree, node_sibs[i].name).data.id;\n\t\t\t\tif(sid < rid && sid > tree_node.data.id)\n\t\t\t\t\trid = sid;\n\t\t\t\tif(sid < lid)\n\t\t\t\t\tlid = sid;\n\t\t\t}\n\t\t\tvar add_lhs = (lid >= tree_node.data.id || (pid == lid && rid < 10000));\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\n\t\t\tvar midx;\n\t\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\n\t\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\n\t\t\t\tmidx = pedigree_util.getIdxByName(dataset, node.father);\n\t\t\telse\n\t\t\t\tmidx = pedigree_util.getIdxByName(dataset, node.mother);\n\n\t\t\tvar parent = dataset[midx];\n\t\t\tmother = ptree.addsibling(dataset, parent, 'F', add_lhs);\n\t\t\tfather = ptree.addsibling(dataset, parent, 'M', add_lhs);\n\n\t\t\tvar orphans = pedigree_util.getAdoptedSiblings(dataset, node);\n\t\t\tvar nid = tree_node.data.id;\n\t\t\tfor(i=0; i<orphans.length; i++){\n\t\t\t\tvar oid = pedigree_util.getNodeByName(flat_tree, orphans[i].name).data.id;\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\n\t\t\t\tif((add_lhs || nid < oid) && oid < rid){\n\t\t\t\t\tvar oidx = pedigree_util.getIdxByName(dataset, orphans[i].name);\n\t\t\t\t\tdataset[oidx].mother = mother.name;\n\t\t\t\t\tdataset[oidx].father = father.name;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif(depth == 2) {\n\t\t\tmother.top_level = true;\n\t\t\tfather.top_level = true;\n\t\t} else if(depth > 2) {\n\t\t\tmother.noparents = true;\n\t\t\tfather.noparents = true;\n\t\t}\n\t\tvar idx = pedigree_util.getIdxByName(dataset, node.name);\n\t\tdataset[idx].mother = mother.name;\n\t\tdataset[idx].father = father.name;\n\t\tdelete dataset[idx].noparents;\n\n\t\tif('parent_node' in node) {\n\t\t\tvar ptr_node = dataset[pedigree_util.getIdxByName(dataset, ptr_name)];\n\t\t\tif('noparents' in ptr_node) {\n\t\t\t\tptr_node.mother = mother.name;\n\t\t\t\tptr_node.father = father.name;\n\t\t\t}\n\t\t}\n\t};\n\t\n\t// add partner\n\tptree.addpartner = function(opts, dataset, name) {\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar flat_tree = pedigree_util.flatten(root);\n\t\tvar tree_node = pedigree_util.getNodeByName(flat_tree, name);\n\n\t\tvar partner = ptree.addsibling(dataset, tree_node.data, tree_node.data.sex=== 'F' ? 'M' : 'F');\n\t\tpartner.noparents = true;\n\n\t\tvar child = {\"name\": ptree.makeid(4), \"sex\": \"M\"};\n\t\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\n\t\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\n\n\t\tvar idx = pedigree_util.getIdxByName(dataset, tree_node.data.name)+2;\n\t\tdataset.splice(idx, 0, child);\n\t};\n\t\n\t// get adjacent nodes at the same depth\n\tfunction adjacent_nodes(root, node, excludes) {\n\t\tvar dnodes = pedigree_util.getNodesAtDepth(pedigree_util.flatten(root), node.depth, excludes);\n\t\tvar lhs_node, rhs_node;\n\t\tfor(var i=0; i<dnodes.length; i++) {\n\t\t\tif(dnodes[i].x < node.x)\n\t\t\t\tlhs_node = dnodes[i];\n\t\t\tif(!rhs_node && dnodes[i].x > node.x)\n\t\t\t\trhs_node = dnodes[i];\n\t\t}\n\t\treturn [lhs_node, rhs_node];\n\t}\n\t\n\t// delete a node and descendants\n\tptree.delete_node_dataset = function(dataset, node, opts) {\n\t\tvar root = ptree.roots[opts.targetDiv];\n\t\tvar fnodes = pedigree_util.flatten(root);\n\t\tvar deletes = [];\n\t\tvar i, j;\n\n\t\tif(node.parent_node) {\n\t\t\tfor(i=0; i<node.parent_node.length; i++){\n\t\t\t\tvar parent = node.parent_node[i];\n\t\t\t\tvar ps = [pedigree_util.getNodeByName(dataset, parent.mother.name),\n\t\t\t\t\t      pedigree_util.getNodeByName(dataset, parent.father.name)];\n\t\t\t\t// delete parents\n\t\t\t\tfor(j=0; j<ps.length; j++) {\n\t\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\n\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, ps[j].name), 1);\n\t\t\t\t\t\tdeletes.push(ps[j]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvar children = parent.children;\n\t\t\t\tvar children_names = $.map(children, function(p, i){return p.name;}); \n\t\t\t\tfor(j=0; j<children.length; j++) {\n\t\t\t\t\tvar child = pedigree_util.getNodeByName(dataset, children[j].name);\n\t\t\t\t\tif(child){\n\t\t\t\t\t\tchild.noparents = true;\n\t\t\t\t\t\tptrs = get_partners(dataset, child);\n\t\t\t\t\t\tvar ptr;\n\t\t\t\t\t\tif(ptrs.length > 0)\n\t\t\t\t\t\t\tptr = pedigree_util.getNodeByName(dataset, ptrs[0]);\n\t\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\n\t\t\t\t\t\t\tchild.mother = ptr.mother;\n\t\t\t\t\t\t\tchild.father = ptr.father;\n\t\t\t\t\t\t} else if(ptr) {\n\t\t\t\t\t\t\tvar child_node  = pedigree_util.getNodeByName(fnodes, child.name);\n\t\t\t\t\t\t\tvar adj = adjacent_nodes(root, child_node, children_names);\n\t\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\n\t\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, child.name), 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, node.name), 1);\n\t\t}\n\n\t\t// delete ancestors\n\t\tconsole.log(deletes);\n\t\tfor(i=0; i<deletes.length; i++) {\n\t\t\tvar del = deletes[i];\n\t\t\tvar sibs = pedigree_util.getAllSiblings(dataset, del);\n\t\t\tconsole.log('DEL', del.name, sibs);\n\t\t\tif(sibs.length < 1) {\n\t\t\t\tconsole.log('del sibs', del.name, sibs);\n\t\t\t\tvar data_node  = pedigree_util.getNodeByName(fnodes, del.name);\n\t\t\t\tvar ancestors = data_node.ancestors();\n\t\t\t\tfor(j=0; j<ancestors.length; j++) {\n\t\t\t\t\tconsole.log(ancestors[i]);\n\t\t\t\t\tif(ancestors[j].data.mother){\n\t\t\t\t\t\tconsole.log('DELETE ', ancestors[j].data.mother, ancestors[j].data.father);\n\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, ancestors[j].data.mother.name), 1);\n\t\t\t\t\t\tdataset.splice(pedigree_util.getIdxByName(dataset, ancestors[j].data.father.name), 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\t\n\t\t}\n\t\t// check integrity of mztwins settings\n\t\tcheckTwins(dataset);\n\n\t\t// check if pedigree is split\n\t\tvar unconnected = ptree.unconnected(dataset);\n\t\tif(unconnected.length > 0) {\n\t\t\t// check & warn only if this is a new split\n\t\t\tif(ptree.unconnected(opts.dataset).length === 0) {\n\t\t\t\tconsole.error(\"individuals unconnected to pedigree \", unconnected);\n\t\t\t\tif(!confirm(\"Deleting this will split the pedigree. Continue?\"))\n\t\t\t\t\tdataset = ptree.copy_dataset(opts.dataset);\n\t\t\t}\n\t\t}\n\t\treturn dataset;\n\t};\n\n\tptree.makeid = function(len) {\n\t    var text = \"\";\n\t    var possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n\t    for( var i=0; i < len; i++ )\n\t        text += possible.charAt(Math.floor(Math.random() * possible.length));\n\t    return text;\n\t};\n\n}(window.ptree = window.ptree || {}, jQuery));\n","\n// pedigree form\n(function(pedigree_form, $, undefined) {\n\n\tpedigree_form.update = function(opts) {\n\t\t$('.node_save').click(function() {\n\t\t\tpedigree_form.save(opts);\n\t\t});\n\t\t\n\t\t$('#id_proband, #id_exclude').click(function(e) {\n\t\t\tvar dataset = pedcache.current(opts);\n\t\t\topts.dataset = ptree.copy_dataset(dataset);\n\n\t\t\tvar name = $('#id_name').val();\n\t\t\tif($(this).attr(\"id\") === 'id_proband') {\n\t\t\t\tpedigree_util.setProband(opts.dataset, name, $(this).is(':checked'));\n\t\t\t} else {\n\t\t\t\tvar idx = pedigree_util.getIdxByName(opts.dataset, name);\n\t\t\t\tif($(this).is(':checked'))\n\t\t\t\t\topts.dataset[idx].exclude = true;\n\t\t\t\telse\n\t\t\t\t\tdelete opts.dataset[idx].exclude;\n\t\t\t}\n\t\t\tpedcache.add(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\tptree.build(opts);\n\t\t});\n\n\t\t// advanced options - model parameters\n\t\t$(\"input[id$='_mut_sensitivity'], input[id$='_mut_frequency']\").prop('disabled', true);\n\t\t$('#id_use_custom_mutation_sensitivities').change(function() {\n\t\t\t$(\"input[id$='_mut_sensitivity']\").prop('disabled', !$(this).is(\":checked\"));\n\t\t});\n\n\t\t$('#id_mutation_frequencies').change(function() {\n\t\t\t$(\"input[id$='_mut_frequency']\").prop('disabled', (this.value !== 'Custom'));\n\t\t\t// note pedigree_form.mutation_frequencies is set in the view see pedigree.html\n\t\t\tif(pedigree_form.mutation_frequencies && this.value !== 'Custom') {\n\t\t\t\tvar mfreq = pedigree_form.mutation_frequencies[this.value];\n\t\t\t\tfor (var gene in mfreq)\n\t\t\t\t\t$('#id_'+gene.toLowerCase()+'_mut_frequency').val(mfreq[gene]);\n\t\t\t}\n\t\t});\n\t};\n\t\n\tpedigree_form.nodeclick = function(node) {\n\t\t$('form > fieldset').removeAttr('disabled');\n\t\t// clear values\n\t\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\n\t\t$('#person_details select').val('').prop('selected', true);\n\n\t\t// assign values to input fields in form\n\t\tif(node.sex === 'M' || node.sex === 'F')\n\t\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\n\t\telse\n\t\t\t$('input[name=sex]').prop('checked', false);\n\t\tupdate_cancer_by_sex(node);\n\t\t\n\t\tif(!('status' in node))\n\t\t\tnode.status = 0;\n\t\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\n\n\t\tif('proband' in node) {\n\t\t\t$('#id_proband').prop('checked', node.proband);\n\t\t} else {\n\t\t\t$('#id_proband').prop('checked', false);\n\t\t}\n\t\t\n\t\tif('exclude' in node) {\n\t\t\t$('#id_exclude').prop('checked', node.exclude);\n\t\t} else {\n\t\t\t$('#id_exclude').prop('checked', false);\n\t\t}\n\t\t\n/*\t\tif('ashkenazi' in node) {\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\n\t\t} else {\n\t\t\t$('#id_ashkenazi').prop('checked', false);\n\t\t}*/\n\t\t\n\t\t// year of both\n\t\tif('yob' in node) {\n\t\t\t$('#id_yob_0').val(node.yob);\n\t\t} else {\n\t\t\t$('#id_yob_0').val('-');\n\t\t}\n\n\t\t// clear pathology\n\t\t$('select[name$=\"_bc_pathology\"]').val('-');\n\t\t// clear gene tests\n\t\t$('select[name*=\"_gene_test\"]').val('-');\n\n\t\t// disable sex radio buttons if the person has a partner\n\t\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\n\n\t\t// disable pathology for male relatives (as not used by model)\n\t\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\", (node.sex === 'M' ? true : false));\n\n\t\t// approximate diagnosis age\n\t\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\n\t\tpedigree_form.update_diagnosis_age_widget();\n\n\t\tfor(var key in node) {\n\t\t\tif(key !== 'proband' && key !== 'sex') {\n\t\t\t\tif($('#id_'+key).length) {\t// input value\n\t\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\n\t\t\t\t\t\t$('#id_'+key).val(node[key].type);\n\t\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$('#id_'+key).val(node[key]);\n\t\t\t\t\t}\n\t\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\n\t\t\t\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\t$('#person_details').find('form').valid();\n\t\t} catch(err) {\n\t\t\tconsole.warn('valid() not found');\n\t\t}\n\t};\n\t\n    pedigree_form.save = function(opts) {\n\t\tvar dataset = pedcache.current(opts);\n\t\tvar name = $('#id_name').val();\n\t\tvar newdataset = ptree.copy_dataset(dataset);\n\t\tvar person = pedigree_util.getNodeByName(newdataset, name);\n\t\tif(!person) {\n\t\t\tconsole.warn('person not found when saving details');\n\t\t\treturn;\n\t\t}\n\t\t$(\"#\"+opts.targetDiv).empty();\n\n\t\t// individual's personal and clinical details\n\t\tvar yob = $('#id_yob_0').val();\n\t\tif(yob && yob !== '') {\n\t\t\tperson.yob = yob;\n\t\t} else {\n\t\t\tdelete person.yob;\n\t\t}\n\n\t\t// current status: 0 = alive, 1 = dead\n\t\tvar status = $('#id_status').find(\"input[type='radio']:checked\");\n\t\tif(status.length > 0){\n\t\t\tperson.status = status.val();\n\t\t}\n\n\t\t// current sex\n\t\tvar sex = $('#id_sex').find(\"input[type='radio']:checked\");\n\t\tif(sex.length > 0){\n\t\t\tperson.sex = sex.val();\n\t\t\tupdate_cancer_by_sex(person);\n\t\t}\n\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n/*\t\tif($('#id_ashkenazi').is(':checked'))\n\t\t\tperson.ashkenazi = 1;\n\t\telse\n\t\t\tdelete person.ashkenazi;*/\n\n\t\tif($('#id_approx').is(':checked')) // approximate diagnosis age\n\t\t\tperson.approx_diagnosis_age = true;\n\t\telse\n\t\t\tdelete person.approx_diagnosis_age;\n\n\t\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\n\t\t\tvar name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\n\n\t\t\tif($(this).val()) {\n\t\t\t\tvar val = $(this).val();\n\t\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\n\t\t\t\t\tval = round5(val);\n\t\t\t\tperson[name] = val;\n\t\t\t} else {\n\t\t\t\tdelete person[name];\n\t\t\t}\n        });\n\t\t\n\t\t// cancer checkboxes\n\t\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\n\t\t\tif(this.checked)\n\t\t\t\tperson[$(this).attr('name')] = true;\n\t\t\telse\n\t\t\t\tdelete person[$(this).attr('name')];\n\t\t});\n\n\t\t// pathology tests\n\t\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\n\t\t\tif($(this).val() !== '-') {\n\t\t\t\tperson[$(this).attr('name')] = $(this).val();\n\t\t\t} else {\n\t\t\t\tdelete person[$(this).attr('name')];\n\t\t\t}\n\t\t});\n\n\t\t// genetic tests\n\t\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\n\t\t\tif($(this).val() !== '-') {\n\t\t\t\tvar tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\n\t\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\n\t\t\t} else {\n\t\t\t\tdelete person[$(this).attr('name')];\n\t\t\t}\n\t\t});\n\t\t\n\t\ttry {\n\t\t\t$('#person_details').find('form').valid();\n\t\t} catch(err) {\n\t\t\tconsole.warn('valid() not found');\n\t\t}\n\t\t\n\n\t\tptree.syncTwins(newdataset, person);\n\t\topts.dataset = newdataset;\n\t\tptree.rebuild(opts);\n    };\n\n    pedigree_form.update_diagnosis_age_widget = function() {\n\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t$(\"[id$='_diagnosis_age_0']\").each(function( index ) {\n\t\t\t\tif($(this).val() !== '') {\n\t\t\t\t\tvar name = this.name.substring(0, this.name.length-2);\n\t\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$(\"[id$='_diagnosis_age_0']\").hide();\n\t\t\t$(\"[id$='_diagnosis_age_1']\").show();\n\t\t} else {\n\t\t\t$(\"[id$='_diagnosis_age_1']\").each(function( index ) {\n\t\t\t\tif($(this).val() !== '') {\n\t\t\t\t\tvar name = this.name.substring(0, this.name.length-2);\n\t\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$(\"[id$='_diagnosis_age_0']\").show();\n\t\t\t$(\"[id$='_diagnosis_age_1']\").hide();\n\t\t}\n    };\n \n    // males should not have ovarian cancer and females should not have prostate cancer\n    function update_cancer_by_sex(node) {\n\t\t$('#cancer .row').show();\n\t\tif(node.sex === 'M') {\n\t\t\tdelete node.ovarian_cancer_diagnosis_age;\n\t\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t} else if(node.sex === 'F') {\n\t\t\tdelete node.prostate_cancer_diagnosis_age;\n\t\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t}\n    }\n    \n    // round to 5, 15, 25, 35 ....\n    function round5(x1) {\n    \tvar x2 = (Math.round((x1-1) / 10) * 10);\n    \treturn (x1 < x2 ? x2 - 5 : x2 + 5);\n    }\n\n}(window.pedigree_form = window.pedigree_form || {}, jQuery));\n","//\n// undo, redo, reset buttons\n(function(pbuttons, $, undefined) {\n\n\tpbuttons.add = function(options) {\n\t\tvar opts = $.extend({\n            // defaults\n\t\t\tbtn_target: 'pedigree_history'\n        }, options );\n\n\t\tvar btns = [{\"fa\": \"fa-undo\", \"title\": \"undo\"},\n\t\t\t\t\t{\"fa\": \"fa-repeat\", \"title\": \"redo\"},\n\t\t\t\t\t{\"fa\": \"fa-refresh\", \"title\": \"reset\"},\n\t\t\t\t\t{\"fa\": \"fa-arrows-alt\", \"title\": \"fullscreen\"}];\n\t\tvar lis = \"\";\n\t\tfor(var i=0; i<btns.length; i++) {\n\t\t\tlis += '<li\">';\n\t\t\tlis += '&nbsp;<i class=\"fa fa-lg ' + btns[i].fa + '\" ' +\n\t\t\t               (btns[i].fa == \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : '') +\n\t\t\t               ' aria-hidden=\"true\" title=\"'+ btns[i].title +'\"></i>';\n\t\t\tlis += '</li>';\n\t\t}\n\t\t$( \"#\"+opts.btn_target ).append(lis);\n\t\tclick(opts);\n\t};\n\n\tpbuttons.is_fullscreen = function(){\n\t\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement);\n\t};\n\n\tfunction click(opts) {\n\t\t// fullscreen\n\t    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(e)  {\n\t\t\tvar local_dataset = pedcache.current(opts);\n\t    \tif (local_dataset !== undefined && local_dataset !== null) {\n\t    \t\topts.dataset = local_dataset;\n\t    \t}\n\t\t\tptree.rebuild(opts);\n\t    });\n\n\t\t$('#fullscreen').on('click', function(e) {\n\t\t\tif (!document.mozFullScreen && !document.webkitFullScreen) {\n\t\t\t\tvar target = $(\"#\"+opts.targetDiv)[0];\n\t\t\t\tif(target.mozRequestFullScreen)\n\t\t\t\t\ttarget.mozRequestFullScreen();\n\t\t\t    else\n\t\t\t    \ttarget.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);\n\t\t\t} else {\n\t\t\t\tif(document.mozCancelFullScreen)\n\t\t\t        document.mozCancelFullScreen();\n\t\t\t    else\n\t\t\t    \tdocument.webkitCancelFullScreen();\n\t\t\t}\n\t\t});\n\n\t\t// undo/redo/reset\n\t\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\n\t\t\te.stopPropagation();\n\t\t\tif($(e.target).hasClass(\"disabled\"))\n\t\t\t\treturn false;\n\n\t\t\tif($(e.target).hasClass('fa-undo')) {\n\t\t\t\topts.dataset = pedcache.previous(opts);\n\t\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t\tptree.build(opts);\t\t\t\t\n\t\t\t} else if ($(e.target).hasClass('fa-repeat')) {\n\t\t\t\topts.dataset = pedcache.next(opts);\n\t\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t\tptree.build(opts);\t\t\t\t\n\t\t\t} else if ($(e.target).hasClass('fa-refresh')) {\n\t\t\t\tpedcache.clear(opts);\n\t\t\t\tdelete opts.dataset;\n\n\t\t\t\tvar selected = $(\"input[name='default_fam']:checked\");\n\t\t\t\tif(selected.length > 0 && selected.val() == 'extended2') {    // secondary relatives\n\t\t        \topts.dataset = [\n\t\t        \t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\n\t\t        \t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\n\t\t        \t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\n\t\t        \t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\n\t\t        \t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\n\t\t        \t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\n\t\t        \t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\n\t\t        \t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\n\t\t        \t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t        \t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t        \t\t{\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"},\n\t\t        \t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t        \t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t        \t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\n\t\t        \t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\n\t\t        \t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"}];\n\t\t\t\t} else if(selected.length > 0 && selected.val() == 'extended1') {    // primary relatives\n\t\t\t\t\topts.dataset = [\n\t\t\t\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\n\t\t\t\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\n\t\t\t\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t\t\t\t{\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"},\n\t\t\t\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\t\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"}];\n\t\t\t\t} else {\n\t\t\t\t\topts.dataset = [ \n\t\t\t\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t        \t\t    {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t        \t\t\t{\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}];\n\t\t\t\t}\n\t\t\t\tptree.rebuild(opts);\n\t\t\t}\n\t\t});\n\t}\n\n\tpbuttons.updateButtons = function(opts) {\n\t\tvar current = pedcache.get_count(opts);\n\t\tvar nstore = pedcache.nstore(opts);\n\t\tvar id = \"#\"+opts.btn_target;\n\t\tif(nstore <= current)\n\t\t\t$(id+\" .fa-repeat\").addClass('disabled');\n\t\telse\n\t\t\t$(id+\" .fa-repeat\").removeClass('disabled');\n\n\t\tif(current > 1)\n\t\t\t$(id+\" .fa-undo\").removeClass('disabled');\n\t\telse\n\t\t\t$(id+\" .fa-undo\").addClass('disabled');\n\t};\n}(window.pbuttons = window.pbuttons || {}, jQuery));\n\n//\n//store a history of pedigree\n(function(pedcache, $, undefined) {\n\tvar count = 0;\n\tvar max_limit = 25;\n\tvar dict_cache = {};\n\n\t// test if local storage is supported\n\tfunction has_local_storage(opts) {\n\t    try {\n\t    \tvar mod = 'test';\n\t        localStorage.setItem(mod, mod);\n\t        localStorage.removeItem(mod);\n\t        return (opts.store_type === undefined || opts.store_type === 'local');\n\t    } catch(e) {\n\t        return false;\n\t    }\n\t}\n\n\tfunction get_prefix(opts) {\n\t\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\n\t}\n\n\t// use dict_cache to store cache as an array\n\tfunction get_arr(opts) {\n\t\treturn dict_cache[get_prefix(opts)];\n\t}\n\n\tpedcache.get_count = function(opts) {\n\t\tvar count;\n\t\tif (has_local_storage(opts))\n\t\t\tcount = localStorage.getItem(get_prefix(opts)+'COUNT');\n\t\telse\n\t\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\n\t\tif(count !== null && count !== undefined)\n\t\t\treturn count;\n\t\treturn 0;\n\t};\n\n\tfunction set_count(opts, count) {\n\t\tif (has_local_storage(opts))\n\t\t\tlocalStorage.setItem(get_prefix(opts)+'COUNT', count);\n\t\telse\n\t\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\n\t}\n\n\tpedcache.add = function(opts) {\n\t\tif(!opts.dataset)\n\t\t\treturn;\n\t\tvar count = pedcache.get_count(opts);\n\t\tif (has_local_storage(opts)) {   // local storage\n\t\t\tlocalStorage.setItem(get_prefix(opts)+count, JSON.stringify(opts.dataset));\n\t\t} else {   // TODO :: array cache\n\t\t\tconsole.warn('Local storage not found/supported for this browser!');\n\t\t\tmax_limit = 500;\n\t\t\tif(get_arr(opts) === undefined)\n\t\t\t\tdict_cache[get_prefix(opts)] = [];\n\t\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\n\t\t}\n\t\tif(count < max_limit)\n\t\t\tcount++;\n\t\telse\n\t\t\tcount = 0;\n\t\tset_count(opts, count);\n\t};\n\n\tpedcache.nstore = function(opts) {\n\t\tif(has_local_storage(opts)) {\n\t\t\tfor(var i=max_limit; i>0; i--) {\n\t\t\t\tif(localStorage.getItem(get_prefix(opts)+(i-1)) !== null)\n\t\t\t\t\treturn i;\n\t\t\t}\n\t\t} else {\n\t\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\n\t\t}\n\t\treturn -1;\n\t};\n\n\tpedcache.current = function(opts) {\n\t\tvar current = pedcache.get_count(opts)-1;\n\t\tif(current == -1)\n\t\t\tcurrent = max_limit-1;\n\t\tif(has_local_storage(opts))\n\t\t\treturn JSON.parse(localStorage.getItem(get_prefix(opts)+current));\n\t\telse if(get_arr(opts))\n\t\t\treturn JSON.parse(get_arr(opts)[current]);\n\t};\n\n\tpedcache.last = function(opts) {\n\t\tif(has_local_storage(opts)) {\n\t\t\tfor(var i=max_limit; i>0; i--) {\n\t\t\t\tvar it = localStorage.getItem(get_prefix(opts)+(i-1));\n\t\t\t\tif(it !== null) {\n\t\t\t\t\tset_count(opts, i);\n\t\t\t\t\treturn JSON.parse(it);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tvar arr = get_arr(opts);\n\t\t\tif(arr)\n\t\t\t\treturn JSON.parse(arr(arr.length-1));\n\t\t}\n\t\treturn undefined;\n\t};\n\n\tpedcache.previous = function(opts, previous) {\n\t\tif(previous === undefined)\n\t\t\tprevious = pedcache.get_count(opts) - 2;\n\n\t\tif(previous < 0) {\n\t\t\tvar nstore = pedcache.nstore(opts);\n\t\t\tif(nstore < max_limit)\n\t\t\t\tprevious = nstore - 1;\n\t\t\telse\n\t\t\t\tprevious = max_limit - 1;\n\t\t}\n\t\tset_count(opts, previous + 1);\n\t\tif(has_local_storage(opts))\n\t\t\treturn JSON.parse(localStorage.getItem(get_prefix(opts)+previous));\n\t\telse\n\t\t\treturn JSON.parse(get_arr(opts)[previous]);\n\t};\n\n\tpedcache.next = function(opts, next) {\n\t\tif(next === undefined)\n\t\t\tnext = pedcache.get_count(opts);\n\t\tif(next >= max_limit)\n\t\t\tnext = 0;\n\n\t\tset_count(opts, parseInt(next) + 1);\n\t\tif(has_local_storage(opts))\n\t\t\treturn JSON.parse(localStorage.getItem(get_prefix(opts)+next));\n\t\telse\n\t\t\treturn JSON.parse(get_arr(opts)[next]);\n\t};\n\n\tpedcache.clear = function(opts) {\n\t\tif(has_local_storage(opts))\n\t\t\tlocalStorage.clear();\n\t\tdict_cache = {};\n\t};\n\n\t// zoom - store translation coords\n\tpedcache.setposition = function(opts, x, y, zoom) {\n\t\tif(has_local_storage(opts)) {\n\t\t\tlocalStorage.setItem(get_prefix(opts)+'_X', x);\n\t\t\tlocalStorage.setItem(get_prefix(opts)+'_Y', y);\n\t\t\tif(zoom)\n\t\t\t\tlocalStorage.setItem(get_prefix(opts)+'_ZOOM', zoom);\n\t\t} else {\n\t\t\t//TODO\n\t\t}\n\t};\n\n\tpedcache.getposition = function(opts) {\n\t\tif(!has_local_storage(opts) || localStorage.getItem(get_prefix(opts)+'_X') === null)\n\t\t\treturn [null, null];\n\t\tvar pos = [parseInt(localStorage.getItem(get_prefix(opts)+'_X')),\n\t\t\t   \t   parseInt(localStorage.getItem(get_prefix(opts)+'_Y'))];\n\t\tif(localStorage.getItem(get_prefix(opts)+'_ZOOM') !== null)\n\t\t\tpos.push(parseFloat(localStorage.getItem(get_prefix(opts)+'_ZOOM')));\n\t\treturn pos;\n\t};\n\n}(window.pedcache = window.pedcache || {}, jQuery));\n","\n// pedigree widgets\n(function(widgets, $, undefined) {\n\n\tfunction getTranslation(transform) {\n    \t  // Create a dummy g for calculation purposes only. This will never\n    \t  // be appended to the DOM and will be discarded once this function \n    \t  // returns.\n    \t  var g = document.createElementNS(\"http://www.w3.org/2000/svg\", \"g\");\n\n    \t  // Set the transform attribute to the provided string value.\n    \t  g.setAttributeNS(null, \"transform\", transform);\n\n    \t  // consolidate the SVGTransformList containing all transformations\n    \t  // to a single SVGTransform of type SVG_TRANSFORM_MATRIX and get\n    \t  // its SVGMatrix. \n    \t  var matrix = g.transform.baseVal.consolidate().matrix;\n\n    \t  // As per definition values e and f are the ones for the translation.\n    \t  return [matrix.e, matrix.f];\n    \t}\n    \n\tvar dragging;\n\tvar last_mouseover;\n\t//\n\t// Add widgets to nodes and bind events\n    widgets.addWidgets = function(opts, node) {\n\n    \t// popup gender selection box\n    \tvar font_size = parseInt($(\"body\").css('font-size'));\n    \tvar popup_selection = d3.select('.diagram');\n    \tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\n    \t\t\t\t\t\t\t.attr(\"rx\", 6)\n    \t\t\t\t\t\t\t.attr(\"ry\", 6)\n    \t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n    \t\t\t\t\t\t\t.style(\"opacity\", 0)\n    \t\t\t\t\t\t\t.attr(\"width\",  font_size*6.2)\n    \t\t\t\t\t\t\t.attr(\"height\", font_size*2)\n    \t\t\t\t\t\t\t.style(\"stroke\", \"darkgrey\")\n    \t\t\t\t\t\t\t.attr(\"fill\", \"white\");\n\n\t\tvar square = popup_selection.append(\"text\")  // male\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-size', '1.em' )\n\t\t\t.attr(\"class\", \"popup_selection fa-lg fa-square persontype\")\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"x\", font_size/3)\n\t\t\t.attr(\"y\", font_size*1.5)\n\t\t\t.text(\"\\uf096 \");\n\t\tvar square_title = square.append(\"svg:title\").text(\"add male\");\n\t\t\n\t\tvar circle = popup_selection.append(\"text\")  // female\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-size', '1.em' )\n\t\t\t.attr(\"class\", \"popup_selection fa-lg fa-circle persontype\")\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"x\", font_size*1.7)\n\t\t\t.attr(\"y\", font_size*1.5)\n\t\t\t.text(\"\\uf10c \");\n\t\tvar circle_title = circle.append(\"svg:title\").text(\"add female\");\n\n\t\tvar unspecified = popup_selection.append(\"text\")  // unspecified\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-size', '1.em' )\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"class\", \"popup_selection fa-lg fa-unspecified popup_selection_rotate45 persontype\")\n\t\t\t.text(\"\\uf096 \");\n\t\tvar unspecified_title = unspecified.append(\"svg:title\").text(\"add unspecified\");\n\n\t\tvar mztwin = popup_selection.append(\"text\")  // monozygotic twins\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t.attr(\"class\", \"popup_selection fa-2x fa-angle-up persontype mztwin\")\n\t\t\t.attr(\"x\", font_size*4.6)\n\t\t\t.attr(\"y\", font_size*1.5)\n\t\t\t.text(\"\\uf106 \");\n\t\tvar mztwin_title = mztwin.append(\"svg:title\").text(\"add monozygotic twins\");\n\n\t\tvar add_person = {};\n\t\t// click the person type selection\n\t\td3.selectAll(\".persontype\")\n\t\t  .on(\"click\", function () {\n\t\t\tvar newdataset = ptree.copy_dataset(opts.dataset);\n\t\t\tvar mztwin = d3.select(this).classed(\"mztwin\");\n\t\t\tvar sex;\n\t\t\tif(mztwin)\n\t\t\t\tsex = add_person.node.datum().data.sex;\n\t\t\telse\n\t\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\n\n\t\t\tif(add_person.type === 'addsibling')\n\t\t\t\tptree.addsibling(newdataset, add_person.node.datum().data, sex, false, mztwin);\n\t\t\telse if(add_person.type === 'addchild')\n\t\t\t\tptree.addchild(newdataset, add_person.node.datum().data, (mztwin ? 'U' : sex), (mztwin ? 2 : 1), mztwin);\n\t\t\telse\n\t\t\t\treturn;\n\t\t\topts.dataset = newdataset;\t\n\t\t\tptree.rebuild(opts);\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\t\tadd_person = {};\n\t\t  })\n\t\t  .on(\"mouseover\", function() {\n\t\t\t  if(add_person.node)\n\t\t\t\t  add_person.node.select('rect').style(\"opacity\", 0.2);\n\t\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t\t  // add tooltips to font awesome widgets\n\t\t\t  if(add_person.type === 'addsibling'){\n\t\t\t\t if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t\t  square_title.text(\"add brother\");\n\t\t\t\t  else \n\t\t\t\t\t  circle_title.text(\"add sister\");\n\t\t\t  } else if(add_person.type === 'addchild'){\n\t\t\t\t  if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t\t  square_title.text(\"add son\");\n\t\t\t\t  else\n\t\t\t\t\t  circle_title.text(\"add daughter\");\t\t\t\t  \n\t\t\t  }\n\t\t  });\n\n\t\t// handle mouse out of popup selection\n\t\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\n\t\t\t// hide rect and popup selection\n\t\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) == -1)\n\t\t\t\tadd_person.node.select('rect').style(\"opacity\", 0);\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\t});\n\n\n\t\t// drag line between nodes to create partners \n\t\tdrag_handle(opts);\n\n\t\t// rectangle used to highlight on mouse over\n\t\tnode.append(\"rect\")\n\t\t\t.filter(function (d) {\n\t\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\n\t\t\t})\n\t\t\t.attr(\"class\", 'indi_rect')\n\t\t\t.attr(\"rx\", 6)\n\t\t\t.attr(\"ry\", 6)\n\t\t\t.attr(\"x\", function(d) { return - 0.75*opts.symbol_size; })\n\t\t\t.attr(\"y\", function(d) { return - opts.symbol_size; })\n\t\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\n\t\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\n\t\t\t.style(\"stroke\", \"black\")\n\t\t\t.style(\"stroke-width\", 0.7)\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr(\"fill\", \"lightgrey\");\n\n\t\t// widgets\n\t\tvar fx = function(d) {return off - 0.75*opts.symbol_size;};\n\t\tvar fy = opts.symbol_size -2;\n\t\tvar off = 0;\n\t\tvar widgets = {\n\t\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\n\t\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\n\t\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\n\t\t\t'addparents': {\n\t\t\t\t'text': '\\uf062', 'title': 'add parents',\n\t\t\t\t'fx': - 0.75*opts.symbol_size,\n\t\t\t\t'fy': - opts.symbol_size + 11\n\t\t\t},\n\t\t\t'delete': {\n\t\t\t\t'text': 'X', 'title': 'delete',\n\t\t\t\t'fx': opts.symbol_size/2 - 1,\n\t\t\t\t'fy': - opts.symbol_size + 12,\n\t\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\n\t\t\t}\n\t\t};\n\t\t\n\t\tif(opts.edit) {\n\t\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': -font_size/2+2, 'fy': -opts.symbol_size + 11};\n\t\t}\n\n\t\tfor(var key in widgets) {\n\t\t\tvar widget = node.append(\"text\")\n\t\t\t\t.filter(function (d) {\n\t\t\t    \treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\n\t\t\t    \t       !((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\n\t\t\t    \t       !(d.data.parent_node !== undefined && d.data.parent_node.length > 1 && key === 'addpartner') &&\n\t\t\t    \t       !(d.data.parent_node === undefined && key === 'addchild') &&\n\t\t\t    \t       !((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\n\t\t\t\t})\n\t\t\t\t.attr(\"class\", key)\n\t\t\t\t.style(\"opacity\", 0)\n\t\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t\t.attr(\"xx\", function(d){return d.x;})\n\t\t\t\t.attr(\"yy\", function(d){return d.y;})\n\t\t\t\t.attr(\"x\", widgets[key].fx)\n\t\t\t\t.attr(\"y\", widgets[key].fy)\n\t\t\t\t.attr('font-size', '0.9em' )\n\t\t\t\t.text(widgets[key].text);\n\n\t\t\tif('styles' in widgets[key])\n\t\t\t\tfor(var style in widgets[key].styles){\n\t\t\t\t\twidget.attr(style, widgets[key].styles[style]);\n\t\t\t\t}\n\n\t\t\twidget.append(\"svg:title\").text(widgets[key].title);\n\t\t\toff += 17;\n\t\t}\n\n\t\t// add sibling or child\n\t\td3.selectAll(\".addsibling, .addchild\")\n\t\t  .on(\"mouseover\", function () {\n\t\t\t  var type = d3.select(this).attr('class');\n\t\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\n\n\t\t\t  //var translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\n\t\t\t  var x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\n\t\t\t  var y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\n\t\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\n\t\t\t  d3.selectAll('.popup_selection_rotate45')\n\t\t\t  \t.attr(\"transform\", \"translate(\"+(x+3*font_size)+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\n\t\t  });\n\n\t\t// handle widget clicks\t\n\t\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\n\t\t  .on(\"click\", function () {\n\t\t\tvar opt = d3.select(this).attr('class');\n\t\t\tvar d = d3.select(this.parentNode).datum();\n\t\t\tif(opts.DEBUG) {\n\t\t\t\tconsole.log(opt);\n\t\t\t}\n\n\t\t\tvar newdataset;\n\t\t\tif(opt === 'settings') {\n\t\t\t\tif(typeof opts.edit === 'function') { \n\t\t\t\t\topts.edit();\n\t\t\t\t} else {\n\t\t\t\t\topenEditDialog(opts, d);\n\t\t\t\t}\n\t\t\t} else if(opt === 'delete') {\n\t\t\t\tnewdataset = ptree.copy_dataset(opts.dataset);\n\t\t\t\topts.dataset = ptree.delete_node_dataset(newdataset, d.data, opts);\n\t\t\t\tptree.rebuild(opts);\n\t\t\t} else if(opt === 'addparents') {\n\t\t\t\tnewdataset = ptree.copy_dataset(opts.dataset);\n\t\t\t\topts.dataset = newdataset;\n\t\t\t\tptree.addparents(opts, newdataset, d.data.name);\n\t\t\t\tptree.rebuild(opts);\n\t\t\t} else if(opt === 'addpartner') {\n\t\t\t\tnewdataset = ptree.copy_dataset(opts.dataset);\n\t\t\t\tptree.addpartner(opts, newdataset, d.data.name);\n\t\t\t\topts.dataset = newdataset;\n\t\t\t\tptree.rebuild(opts);\t\t\t\t\n\t\t\t}\n\t\t});\n\t\t\n\t\t// other mouse events\n\t\tvar highlight = [];\n\t\t\n\t\tnode.filter(function (d) { return !d.data.hidden; })\n\t\t.on(\"click\", function (d) {\n\t\t\tif (d3.event.ctrlKey) {\n\t\t\t\tif(highlight.indexOf(d) == -1)\n\t\t\t\t\thighlight.push(d);\n\t\t\t\telse\n\t\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\n\t\t\t} else\n\t\t\t\thighlight = [d];\n\t\t\t\n\t\t\tif('nodeclick' in opts) {\n\t\t\t\topts.nodeclick(d.data);\n\t\t\t\td3.selectAll(\".indi_rect\").style(\"opacity\", 0);\n\t\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) != -1;}).style(\"opacity\", 0.5);\n\t\t\t}\n     \t})\n\t\t.on(\"mouseover\", function(d){\n\t\t\td3.event.stopPropagation();\n\t\t\tlast_mouseover = d;\n\t\t\tif(dragging) {\n\t\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\n\t\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\n\t\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 1);\n\t\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 0);\n\t\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\n\t\t})\n\t\t.on(\"mouseout\", function(d){\n\t\t\tif(dragging)\n\t\t\t\treturn;\n\n\t\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 0);\n\t\t\tif(highlight.indexOf(d) == -1)\n\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0);\n\t\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 1);\n\t\t\t// hide popup if it looks like the mouse is moving north\n\t        if(d3.mouse(this)[1] < 0.8*opts.symbol_size)\n\t        \td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t        if(!dragging) {\n\t        \t// hide popup if it looks like the mouse is moving north, south or west\n\t        \tif(Math.abs(d3.mouse(this)[1]) > 0.25*opts.symbol_size ||\n\t        \t   Math.abs(d3.mouse(this)[1]) < -0.25*opts.symbol_size ||\n\t        \t   d3.mouse(this)[0] < 0.2*opts.symbol_size){\n\t        \t\tsetLineDragPosition(0, 0, 0, 0);\n\t        \t}\n\t        }\n\t\t});\n\t};\n\n\t// drag line between nodes to create partners \n\tfunction drag_handle(opts) {\n\t\tvar line_drag_selection = d3.select('.diagram');\n\t\tline_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\n\t        .attr(\"stroke-width\", 6)\n\t        .style(\"stroke-dasharray\", (\"2, 1\"))\n\t        .attr(\"stroke\",\"black\")\n\t        .call(d3.drag()\n\t                .on(\"start\", dragstart)\n\t                .on(\"drag\", drag)\n\t                .on(\"end\", dragstop));\n\t\tsetLineDragPosition(0, 0, 0, 0);\n\n\t\tfunction dragstart(d) {\n\t\t\td3.event.sourceEvent.stopPropagation();\n\t\t\tdragging = last_mouseover;\n\t\t\td3.selectAll('.line_drag_selection')\n\t\t\t\t.attr(\"stroke\",\"darkred\");\n\t\t}\n\n\t\tfunction dragstop(d) {\n\t\t\tif(last_mouseover &&\n\t\t\t   dragging.data.name !== last_mouseover.data.name &&\n\t\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\n\t\t\t\t// make partners\n\t\t\t\tvar child = {\"name\": ptree.makeid(4), \"sex\": 'U',\n\t\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\n\t\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\n\t\t\t\tnewdataset = ptree.copy_dataset(opts.dataset);\n\t\t\t\topts.dataset = newdataset;\n\t\t\t\t\n\t\t\t\tvar idx = pedigree_util.getIdxByName(opts.dataset, dragging.data.name)+1;\n\t\t\t\topts.dataset.splice(idx, 0, child);\n\t\t\t\tptree.rebuild(opts);\n\t\t\t}\n\t\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\t\td3.selectAll('.line_drag_selection')\n\t\t\t\t.attr(\"stroke\",\"black\");\n\t\t\tdragging = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tfunction drag(d) {\n\t\t\td3.event.sourceEvent.stopPropagation();\n\t\t\tvar dx = d3.event.dx;\n            var xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\n            setLineDragPosition(opts.symbol_size-10, 0, xnew, 0);\n\t\t}\n\t}\n\t\n\tfunction setLineDragPosition(x1, y1, x2, y2, translate) {\n\t\tif(translate)\n\t\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\n\t\td3.selectAll('.line_drag_selection')\n\t    \t.attr(\"x1\", x1)\n\t    \t.attr(\"y1\", y1)\n\t    \t.attr(\"x2\", x2)\n\t        .attr(\"y2\", y2);\n\t}\n\n\tfunction capitaliseFirstLetter(string) {\n\t    return string.charAt(0).toUpperCase() + string.slice(1);\n\t}\n\t\n    // if opt.edit is set true (rather than given a function) this is called to edit node attributes\n    function openEditDialog(opts, d) {\n\t\t$('#node_properties').dialog({\n\t\t    autoOpen: false,\n\t\t    title: d.data.display_name,\n\t\t    width: ($(window).width() > 400 ? 430 : $(window).width()- 30)\n\t\t});\n\n\t\tvar table = \"<table id='person_details' class='table'>\";\n\n\t\ttable += \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\"+\n\t\t(d.data.name ? d.data.name : \"\")+\"></td></tr>\";\n\t\ttable += \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\"+\n\t\t\t\t(d.data.display_name ? d.data.display_name : \"\")+\"></td></tr>\";\n\n\t\ttable += \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:5em' value=\"+\n\t\t\t\t(d.data.age ? d.data.age : \"\")+\"></td></tr>\";\n\n\t\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\n\t\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" '+(d.data.sex === 'M' ? \"checked\" : \"\")+'>Male</label>' +\n\t\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" '+(d.data.sex === 'F' ? \"checked\" : \"\")+'>Female</label>' +\n\t\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"U\">Unknown</label>' +\n\t\t\t\t '</td></tr>';\n\n\t\t// alive status = 0; dead status = 1\n\t\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\n\t\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" '+(d.data.status === 0 ? \"checked\" : \"\")+'>&thinsp;Alive</label>' +\n\t\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" '+(d.data.status === 1 ? \"checked\" : \"\")+'>&thinsp;Deceased</label>' +\n\t\t\t\t '</td></tr>';\n\t\t$(\"#id_status input[value='\"+d.data.status+\"']\").prop('checked', true);\n\t\t\n\t\tvar exclude = [\"children\", \"name\", \"parent_node\", \"top_level\", \"id\", \"level\", \"age\", \"sex\", \"status\", \"display_name\", \"mother\", \"father\"];\n\t\ttable += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\n\t\t$.each(opts.diseases, function(k, v) {\n\t\t\texclude.push(v.type+\"_diagnosis_age\");\n\n\t\t\tvar disease_colour = '&thinsp;<span style=\"padding-left:5px;background:'+opts.diseases[k].colour+'\"></span>';\n\t\t\tvar diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\n\n\t\t\ttable += \"<tr><td style='text-align:right'>\"+capitaliseFirstLetter(v.type.replace(\"_\", \" \"))+\n\t\t\t\t\t\tdisease_colour+\"&nbsp;</td><td>\" +\n\t\t\t\t\t\t\"<input class='form-control' id='id_\" + \n\t\t\t\t\t\tv.type + \"_diagnosis_age_0' max='110' min='0' name='\" + \n\t\t\t\t\t\tv.type + \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\n\t\t\t\t\t\t(diagnosis_age !== undefined ? diagnosis_age : \"\") +\"'></td></tr>\";\n\t\t});\n\n\t\ttable += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\n\t\t$.each(d.data, function(k, v) {\n\t\t\tif($.inArray(k, exclude) == -1) {\n\t\t\t\tvar kk = capitaliseFirstLetter(k);\n\t\t\t\tif(v === true || v === false) {\n\t\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='checkbox' id='id_\" + k + \"' name='\" +\n\t\t\t\t\t\t\tk+\"' value=\"+v+\" \"+(v ? \"checked\" : \"\")+\"></td></tr>\";\n\t\t\t\t} else if(k.length > 0){\n\t\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='text' id='id_\" +\n\t\t\t\t\t\t\tk+\"' name='\"+k+\"' value=\"+v+\"></td></tr>\";\n\t\t\t\t}\n\t\t\t}\n\t    });\n\t\ttable += \"</table>\";\n\n\t\t$('#node_properties').html(table);\n\t\t$('#node_properties').dialog('open');\n\n\t\t//$('#id_name').closest('tr').toggle();\n\t\t$('#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]').change(function() {\n\t    \tpedigree_form.save(opts);\n\t    });\n\t\tpedigree_form.update(opts);\n\t\treturn;\n    }\n\n}(window.widgets = window.widgets || {}, jQuery));\n"]}